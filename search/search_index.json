{"config":{"lang":["ja"],"separator":"[\\s\\-\uff0c\u3002]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u8fdc\u7a0b\u6559\u5b66\u4e91\u684c\u9762\u5e73\u53f0","text":"<p>\u6ce8\u610f</p> <p>\u672c\u6587\u6863\u662f\u5e73\u53f0\u7684\u6280\u672f\u6027\u6587\u6863\uff0c\u5185\u5bb9\u4e3b\u8981\u5bf9\u7ef4\u62a4\u5de5\u4f5c\u6709\u7528\uff0c\u7528\u6237\u8bf7\u770b\u7528\u6237\u6587\u6863\u3002</p> <p>\u4e3a\u4e86\u4f7f\u5185\u5bb9\u7b80\u6d01\u7cbe\u70bc\u3001\u5c3d\u91cf\u4fdd\u6301\u4e0e\u4e3b\u9898\u76f8\u5173\uff0c\u672c\u6587\u6863\u65e0\u6cd5\u63d0\u4f9b\u8fc7\u4e8e\u8be6\u5c3d\u7684 Linux \u57fa\u7840\u77e5\u8bc6\uff0c\u5982\u679c\u9047\u5230\u95ee\u9898\uff0c\u8bf7\u5584\u7528 Google \u7b49\u5de5\u5177\u3002</p> <p>Linux \u5165\u95e8\u53ef\u4ee5\u53c2\u8003\u6821 Linux \u7528\u6237\u534f\u4f1a\u7684 Linux 101 \u8bfe\u7a0b\u8bb2\u4e49\u6216\u5176\u4ed6\u5728\u7ebf\u6559\u7a0b\u3002</p> <p>When in doubt, ask.</p> <p>\u6587\u6863\u7f3a\u5931</p> <p>\u4ee5\u4e0b\u5185\u5bb9\u7f3a\u4e4f\u5bf9\u5e94\u7684\u7ef4\u62a4\u6587\u6863\uff1a</p> <ul> <li>Django \u524d\u7aef</li> <li>VNC \u7f51\u5173</li> <li>SSH \u7f51\u5173</li> <li>noVNC \u7f51\u9875</li> <li>Grafana \u9762\u677f\u53ca\u5176\u540e\u7aef</li> </ul>"},{"location":"#resources","title":"\u8d44\u6e90","text":"<ul> <li> GitHub \u8ba8\u8bba\u5217\u8868</li> <li> Telegram \u5f00\u53d1\u5c0f\u7ec4\u8ba8\u8bba\u7fa4 </li> </ul>"},{"location":"changelog/","title":"\u66f4\u65b0\u8bb0\u5f55","text":"<p>\u8bb0\u5f55\u6211\u4eec\u4e0a\u7ebf\u90e8\u7f72\u65b0\u529f\u80fd\uff08\u6216 bug fix \u7b49\uff09\u7684\u5386\u53f2\u3002</p> <p>\u7f16\u5199\u65f6\u8bf7\u6309\u65f6\u95f4\u5012\u5e8f\u6392\u5e8f\uff0c\u5373\u6700\u65b0\u7684\u65e5\u671f\u5728\u6700\u4e0a\u9762\u3002\u6709\u4e13\u95e8\u7684\u5de5\u4f5c\u8bb0\u5f55\u9875\u9762\u7684\u8bf7\u628a\u65f6\u95f4\u94fe\u63a5\u5230\u5bf9\u5e94\u7684\u9875\u9762\u3002</p> <p>Note</p> <p>\u672c\u9875\u9762\u4e8e 2020 \u5e74 9 \u6708\u521d\u521b\u5efa\uff0c\u56e0\u6b64 2020 \u5e74 8 \u6708\u53ca\u4ee5\u524d\u7684\u66f4\u65b0\u8bb0\u5f55\u662f\u4e0d\u5b8c\u6574\u7684\u3002\u5c3d\u7ba1\u7f16\u8005\u5df2\u4ece\u8ba8\u8bba\u7fa4\u7684\u804a\u5929\u8bb0\u5f55\u7b49\u5730\u5c3d\u53ef\u80fd\u6062\u590d\uff08\u8865\u5199\uff09\u51fa\u4e86\u4e00\u4e9b\uff0c\u4f46\u8bb8\u591a\u7ec6\u8282\u4ecd\u7136\u96be\u4ee5\u4fdd\u8bc1\u5b8c\u6574\u6027\u53ca\u51c6\u786e\u6027\u3002</p>"},{"location":"changelog/#\u66f4\u65b0\u8bb0\u5f55_1","title":"\u66f4\u65b0\u8bb0\u5f55","text":""},{"location":"changelog/#2023-\u5e74","title":"2023 \u5e74","text":"2 \u6708 17 \u65e5 <p>\u66f4\u65b0\u4e86 Django\uff0c\u9650\u5236\u5e76\u884c\u6267\u884c\u7684\u521b\u5efa\u5bb9\u5668\u4efb\u52a1\uff0c\u52a0\u5feb\u5bb9\u5668\u521b\u5efa\uff0c\u5e76\u6539\u8fdb\u4e86\u865a\u62df\u673a\u7ba1\u7406\u9875\u9762\u7684\u7528\u6237\u4f53\u9a8c\u3002\u540c\u65f6\u5728\u4e2a\u4eba\u4fe1\u606f\u9875\u9762\u663e\u793a\u4ece CAS \u83b7\u53d6\u7684\u7528\u6237\u90ae\u7bb1\u3002</p> <p>\u66f4\u65b0\u4e86 Filestash\uff0c\u6dfb\u52a0\u4e86\u4e00\u4e9b\u63d0\u793a\uff0c\u4f7f\u64cd\u4f5c\u66f4\u76f4\u89c2\u3002</p> 2 \u6708 1 \u65e5 <p>\u5c06\u5bb9\u5668\u955c\u50cf\u7684\u6784\u5efa\u81ea\u52a8\u5316\uff0c\u4e0d\u518d\u9700\u8981\u5728\u81ea\u5df1\u7684\u673a\u5668\u4e0a\u624b\u52a8\u8fd0\u884c\u6784\u5efa\u811a\u672c\u3002</p>"},{"location":"changelog/#2022-\u5e74","title":"2022 \u5e74","text":"9 \u6708 20 \u65e5 <p>\u5c06 post creation \u4ece\u521b\u5efa\u65f6\u6267\u884c\u6539\u4e3a\u9996\u6b21\u542f\u52a8\u65f6\u6267\u884c\uff0c\u4f7f\u5f97\u521b\u5efa\u5bb9\u5668\u7684\u754c\u9762\u4e0d\u518d\u963b\u585e\u3002</p> 4 \u6708 11 \u65e5 <p>\u6dfb\u52a0\u4e86\u7f51\u9875 SSH \u767b\u5f55\u7684\u529f\u80fd\uff0c\u4ee5\u53ca\u5728 Chrome \u4e0e Edge \u6d4f\u89c8\u5668\u4e0b noVNC \u81ea\u52a8\u526a\u8d34\u677f\u7684\u529f\u80fd\uff0c\u65b9\u4fbf\u7528\u6237\u4f7f\u7528\u3002</p> 2 \u6708 14 \u65e5 <p>\u5bf9 LXC \u865a\u62df\u673a\u63d0\u4f9b\u201c\u6062\u590d\u6a21\u5f0f SSH\u201d\u63a5\u53e3\uff0c\u4f7f\u7528\u6237\u53ef\u4ee5\u5728\u865a\u62df\u673a\u65ad\u7f51\u7684\u60c5\u51b5\u4e0b\u901a\u8fc7 SSH \u767b\u5f55\u83b7\u5f97\u865a\u62df\u673a\u7684 shell\uff0c\u81ea\u4e3b\u8fdb\u884c\u6062\u590d\u5de5\u4f5c\u3002</p> 1 \u6708 28 \u65e5 <p>\u4fee\u6539\u7248 Filestash \u6d4b\u8bd5\u4e0a\u7ebf\u3002\u672c\u6b21\u66f4\u65b0\u4e3b\u8981\u6dfb\u52a0\u4e86\u81ea\u52a8\u767b\u5f55\u529f\u80fd\uff0c\u5e76\u4e14\u4fee\u6b63\u4e86\u5927\u91cf\u95ee\u9898\u3002</p> 1 \u6708 26 \u65e5 <p>\u7d27\u6025\u5b89\u5168\u66f4\u65b0\uff0c\u540c\u65f6\u66f4\u65b0\u4e86\u7528\u6237\u5bb9\u5668\u7684 <code>sshd_config</code> \u4e3a\u63a5\u4e0b\u6765\u4e3a\u6240\u6709 username \u542f\u7528 SSH \u8bc1\u4e66\u767b\u5f55\u505a\u597d\u51c6\u5907\u3002</p>"},{"location":"changelog/#2021-\u5e74","title":"2021 \u5e74","text":"10 \u6708 27 \u65e5 <p><code>vlab.ustc.edu.cn</code> \u914d\u7f6e\u7684 HSTS \u4ece 1 \u5c0f\u65f6\u5347\u7ea7\u81f3 1 \u5468\uff08<code>max-age=604800</code>\uff09\u3002</p> 10 \u6708 22 \u65e5 <p>\u4fee\u590d\u4e86 Grafana \u663e\u793a\u7684 VNC \u5728\u7ebf\u65f6\u957f\u6bcf\u4e2a\u6708\u4f1a\u6709\u4e00\u4e2a\u5f02\u5e38\u9ad8\u5cf0\u7684\u60c5\u51b5\uff08MySQL \u65e5\u671f\u65f6\u95f4\u8ba1\u7b97\u95ee\u9898\uff09\u3002</p> <p>\u539f\u6765\u4f7f\u7528\u7684 SELECT \u9879\u76ee\u662f <code>SUM(disconnect_time - connect_time)</code>\uff0c\u6539\u4e3a <code>SUM(TIME_TO_SEC(TIMEDIFF(disconnect_time, connect_time)))</code> \u540e\u6b63\u5e38\u4e86\u3002</p> 10 \u6708 1 \u65e5 <p>\u66f4\u65b0\u4e86 01 \u53f7\u955c\u50cf\uff0c\u5347\u7ea7\u4e86\u6240\u6709\u8f6f\u4ef6\u5305\uff0c\u6e05\u7406\u4e86\u591a\u4f59\u7684\u8f6f\u4ef6\u5305\uff0c\u5e76\u5c06 apt \u6e90\u6362\u56de\u4e86\u79d1\u5927\u955c\u50cf\u7ad9\u3002</p> 8 \u6708 21 \u65e5 <p>\u5c06\u96c6\u7fa4\u5168\u90e8\u5347\u7ea7\u81f3 Proxmox VE 7.0</p> 8 \u6708 12 \u65e5 <p>\u4fee\u590d\u4e86\u62e5\u6709\u591a\u4e2a\u5b66\u53f7\u6216\u5de5\u53f7\u7684\u7528\u6237\u901a\u8fc7\u4e0d\u540c\u5b66\u5de5\u53f7\u767b\u5f55\u65f6\u6570\u636e\u4e0d\u4e92\u901a\u7684\u95ee\u9898\u3002</p> 4 \u6708 11 \u65e5 <p>\u901a\u8fc7 Vlab Software \u63d0\u4f9b\u4e86 RISC-V \u7684 GCC \u5de5\u5177\u94fe\uff0c\u4ee5\u53ca RARS \u6a21\u62df\u5668\uff08\u5df2\u7f16\u5199 <code>.desktop</code> \u6587\u4ef6\u4f7f\u7528 Vlab Software \u63d0\u4f9b\u7684 JDK 14 \u8fd0\u884c\uff09</p> 3 \u6708 30 \u65e5 <p>\u901a\u8fc7 Vlab Software \u63d0\u4f9b\u4e86 Xilinx Vivado 2016.3 \u7248\u672c\uff0c\u4e3a 2019.1 \u7248\u672c\u7684\u517c\u5bb9\u6027\u95ee\u9898\u63d0\u4f9b\u4e00\u4e2a\u5907\u9009\u9879\u3002</p>"},{"location":"changelog/#2020-\u5e74","title":"2020 \u5e74","text":"11 \u6708 18 \u65e5 <p>\u5c06\u6545\u969c\u635f\u6bc1\u7684 CT 100 \u6062\u590d\u5e76\u91cd\u5efa\u3002</p> 11 \u6708 14 \u65e5 <p>Vivado \u4eff\u771f\u7684\u62a5\u9519\u5df2\u7ecf\u5728\u955c\u50cf\u4e2d\u4fee\u590d\uff0c\u65b0\u521b\u5efa\u7684\u865a\u62df\u673a\uff08ID \u5927\u4e8e 2266\uff09\u4e0d\u518d\u53d7\u6b64\u5f71\u54cd\u3002</p> <p>\u5728\u7ebf VSCode \u7f16\u7a0b\u5e73\u53f0\u5f00\u653e\u6d4b\u8bd5\u3002</p> 10 \u6708 29 \u65e5 <p>\u7528\u6237\u53ef\u4ee5\u9009\u62e9\u5173\u95ed VNC \u767b\u5f55\u65f6\u663e\u793a\u7684\u52a0\u5165 QQ \u7fa4\u7684\u901a\u77e5\u3002</p> 9 \u6708 8 \u65e5 <p>\u5b8c\u6210\u4e86\u5728\u5bb9\u5668\u4e4b\u95f4\u5171\u4eab\u5b9e\u9a8c\u8f6f\u4ef6\u7684\u8bbe\u8ba1\uff08\u955c\u50cf 01 \u5df2\u7ecf\u66ff\u6362\u4e3a\u65b0\u7248\u672c\uff09\uff0c\u8fd9\u53ef\u4ee5\u51cf\u5c11\u76f8\u540c\u7684\u5b9e\u9a8c\u8f6f\u4ef6\u91cd\u590d\u5b58\u50a8\u7684\u95ee\u9898\uff0c\u5e76\u4e14\u5c06\u8f6f\u4ef6\u653e\u7f6e\u5728 SSD \u4e0a\uff0c\u4e5f\u9884\u671f\u53ef\u4ee5\u63d0\u9ad8\u6027\u80fd\u3002\u540c\u65f6\uff0c\u65b0\u521b\u5efa\u7684\u5bb9\u5668\u4e5f\u652f\u6301\u5d4c\u5957\u5bb9\u5668\u4e86\u3002</p> 9 \u6708 5 \u65e5 <p>\u865a\u62df\u673a\u7ba1\u7406\u754c\u9762\u7684\u684c\u9762\u8fde\u63a5\u529f\u80fd\u73b0\u5728\u53ef\u4ee5\u81ea\u52a8\u8fde\u63a5\u5bf9\u5e94\u865a\u62df\u673a\uff08\u4f7f\u7528 URL parameters \u4f20\u9012\u4fe1\u606f\uff09</p> 9 \u6708 3 \u65e5 <p>SSH \u7edf\u4e00\u767b\u5f55\u53ef\u4ee5\u4f7f\u7528\u4e86\u3002\u9884\u8ba1\u5c06\u5728\u4e00\u6bb5\u65f6\u95f4\u4e4b\u540e\u5173\u95ed\u65e7\u7684\u767b\u5f55\u65b9\u5f0f\uff08\u7aef\u53e3\u8f6c\u53d1\uff09\uff0c\u5177\u4f53\u65f6\u95f4\u5f85\u5b9a</p> 8 \u6708 4 \u65e5 <p>\u57fa\u4e8e Grafana + InfluxDB / MySQL \u7684\u7528\u91cf\u6570\u636e\u7edf\u8ba1\u9875\u9762</p> 8 \u6708 1 \u65e5 <p>\u5149\u7ea4\u7f51\u7edc\uff08ens1f0\u3001ens1f1\uff09\u7684 MTU \u73b0\u5728\u662f 1550 \u5b57\u8282\u4e86</p> <p>\u4fee\u590d\u4e86 pv8 \u7684\u5149\u7ea4\u7f51\u7edc</p> <p>noVNC \u652f\u6301\u57fa\u4e8e\u6d4f\u89c8\u5668 cookie \u7684\u4e00\u952e\u767b\u5f55\uff0c\u51cf\u5c11\u91cd\u590d\u8f93\u5165\u7528\u6237\u540d\u5bc6\u7801\u7684\u9ebb\u70e6</p> <p>\u914d\u7f6e\u5e76\u6253\u5305\u597d\u4e86 Ubuntu 20.04 \u7684\u955c\u50cf\uff0c\u6682\u65f6\u4ee5\u7f16\u53f7 99 \u63d0\u4f9b</p> 3 \u6708 31 \u65e5 <p>\u5411 pv0 \u52a0\u88c5\u4e86 32 GB \u5185\u5b58\uff0c\u5411 pv2~pv8 \u52a0\u88c5\u4e86 64 GB \u5185\u5b58\uff0c\u5411 pv2~pv5 \u52a0\u88c5\u4e86 Netronome Agilio \u7cfb\u5217\u7f51\u5361</p> 3 \u6708 25 \u65e5 <p>2019 \u5e74\u79cb\u5b63\u5b66\u671f\u63d0\u4f9b\u670d\u52a1\u7684\u5355\u53f0\u670d\u52a1\u5668\u5df2\u683c\u5f0f\u5316\u91cd\u88c5\u4e3a Proxmox VE 6.1 \u64cd\u4f5c\u7cfb\u7edf\uff0c\u547d\u540d\u4e3a pv0</p> 2 \u6708 <p>\u5185\u7f51\u7f51\u5173\uff08CT 100\uff09\u521d\u6b65\u914d\u7f6e\u5b8c\u6210</p> <p>Web \u670d\u52a1\u5668\uff08CT 101\uff09\u5207\u6362\u5230\u65b0\u7684\u96c6\u7fa4\u4e2d\u7684\u5bb9\u5668\u4e0a\uff0c2019 \u5e74\u79cb\u5b63\u7684\u65e7\u673a\u5668\u6682\u65f6\u95f2\u7f6e</p> <p>pdlan \u4f7f\u7528 C++ \u7f16\u5199\u7684 VNC \u7f51\u5173\u6d4b\u8bd5\u5b8c\u6210</p> <p>\u7f51\u9875\u865a\u62df\u673a\u7ba1\u7406\u5668\uff08Django\uff09\u9002\u914d\u4e86 Proxmox VE API\uff0c\u5220\u9664\u4e86 LXC / LXD \u76f8\u5173\u7684\u4ee3\u7801</p> <p>\u4fee\u6539\u4e86\u5f00\u6e90\u8f6f\u4ef6 noVNC\uff0c\u63d0\u4f9b\u4e86\u6d4f\u89c8\u5668\u767b\u5f55\u865a\u62df\u673a\u7684\u65b9\u5f0f</p> <p>\u91cd\u65b0\u6253\u5305\u4e86\u51e0\u4e2a\u65b0\u955c\u50cf\uff0c\u4f9b\u7528\u6237\u5728\u521b\u5efa\u865a\u62df\u673a\u65f6\u9009\u62e9</p> <ul> <li> <p>\u7ecf\u8fc7\u591a\u756a\u6d4b\u8bd5\uff0c\u9009\u5b9a\u4e86 LightDM + TigerVNC\uff0c\u517c\u5bb9\u6027\u6700\u597d\u4e14\u6700\u5bb9\u6613\u914d\u7f6e</p> </li> <li> <p>\u6d4b\u8bd5\u4e86 fcitx \u4e0e ibus\uff0c\u914d\u7f6e\u597d\u4e86\u4e2d\u6587\u8f93\u5165\u6cd5</p> </li> </ul> <p>\u901a\u8fc7\u955c\u50cf\u5185\u7f6e SSH CA \u7684\u65b9\u5f0f\u5b9e\u73b0\u5bb9\u5668\u5185\u8fdc\u7a0b\u547d\u4ee4\u6267\u884c</p> <p>\u66f4\u65b0\u4e86\u7528\u6237\u6587\u6863\u9879\u76ee\uff0c\u66f4\u5bb9\u6613\u7f16\u5199\u3001\u9605\u8bfb\u4f53\u9a8c\u66f4\u597d\uff0c\u5e76\u4e14\u66f4\u65b0\u4e86\u6587\u6863\u5185\u5bb9</p> <p>\u521b\u5efa\u4e86\u7ef4\u62a4\u8005\u6587\u6863\uff08\u5373\u672c\u6587\u6863\uff09</p> <p>\u2026\u2026\u8fd8\u6709\u66f4\u591a\uff08\u5f53\u524d\u4e00\u4ee3\u7684 vlab \u57fa\u672c\u90fd\u5728\u8fd9\u4e2a\u6708\u914d\u7f6e\u90e8\u7f72\u5b8c\u6210\uff0c\u65f6\u95f4\u201c\u4e45\u8fdc\u201d\u96be\u4ee5\u4ed4\u7ec6\u8003\u8bc1\uff09</p>"},{"location":"changelog/#2019-\u5e74","title":"2019 \u5e74","text":"9 \u6708 <p>\u521d\u7248 vlab \u5b9e\u9a8c\u5e73\u53f0\u5728\u300a\u6570\u5b57\u7535\u8def\u5b9e\u9a8c\u300b\u8bfe\u7a0b\u9009\u5b9a\u7684 30 \u4eba\u5de6\u53f3\u4e2d\u8fdb\u884c\u6d4b\u8bd5</p>"},{"location":"overview/","title":"Vlab \u7b2c\u4e8c\u4ee3\u670d\u52a1\u5668\u96c6\u7fa4","text":""},{"location":"overview/#compute-server","title":"\u8ba1\u7b97\u670d\u52a1\u5668","text":"<p>\u7b2c\u4e8c\u4ee3 Vlab \u7684\u8ba1\u7b97\u670d\u52a1\u5668\u5171\u6709 10 \u53f0\uff0c\u5176\u4e2d 8 \u53f0\u4e3a\u666e\u901a\u670d\u52a1\u5668\uff0c2 \u53f0\u4e3a GPU \u670d\u52a1\u5668\uff0c\u53e6\u6709\u4e00\u53f0\u5b58\u50a8\u670d\u52a1\u5668\u3002</p>"},{"location":"overview/#compute-server-cpu","title":"\u666e\u901a\u8ba1\u7b97\u670d\u52a1\u5668","text":"<p>8 \u53f0\u666e\u901a\u8ba1\u7b97\u670d\u52a1\u5668\u5206\u522b\u547d\u540d\u4e3a pv1 \u5230 pv8\uff0c\u6bcf\u53f0\u670d\u52a1\u5668\u5305\u542b\u53cc\u8def Intel Xeon Scalable Silver 4110 \u5904\u7406\u5668\uff08\u5171 16 \u6838\u5fc3\u300132 \u7ebf\u7a0b\uff09\uff0c\u9884\u88c5\u5185\u5b58 32 GB\uff082 x 16 GB DDR4 2400 ECC\uff09\uff0c\u786c\u76d8\u914d\u7f6e\u4e3a\u4e24\u5757 HPE SSD 480GB \u548c\u4e09\u5757 2.4 TB 10K SAS \u786c\u76d8\uff08\u53d6\u51fa\u6765\u653e\u8fdb\u5b58\u50a8\u670d\u52a1\u5668\u7684\u989d\u5916\u786c\u76d8\u7b3c\uff09</p> <p>\u6240\u6709\u670d\u52a1\u5668\u7684\u5185\u5b58\u5728\u8d2d\u5165\u65f6\u5747\u5347\u7ea7\u81f3 160 GB\uff082 x 16 GB + 4 x 32 GB\uff09\uff0c\u5176\u4e2d pv2 ~ pv8 \u7684\u5185\u5b58\u5728 2020 \u5e74 3 \u6708\u5e95\u518d\u6b21\u5347\u7ea7\u81f3 224 GB\uff082 x 16 GB + 6 x 32 GB\uff09\u3002</p> <p>\u7f51\u7edc\u65b9\u9762\uff0c\u8fd9\u6b3e\u670d\u52a1\u5668\u81ea\u5e26\u4e00\u4e2a\u56db\u53e3\u5343\u5146\u7f51\u5361\uff08\u7cfb\u7edf\u5185\u540d\u79f0\u4e3a <code>eno1</code> \u5230 <code>eno4</code>\uff09\uff0c\u4e00\u4e2a\u767e\u5146\u53e3\u8fde\u63a5 HPE iLO 5\uff08\u5373 HPE \u7684 IPMI \u8fdc\u7a0b\u7ba1\u7406\u5361\uff09\u3002\u53e6\u5916\u6bcf\u53f0\u670d\u52a1\u5668\u6269\u5c55\u4e86\u4e24\u4e2a 10 Gbps \u7684\u5149\u7ea4\u63a5\u53e3\uff08\u5206\u522b\u4e3a <code>ens1f0</code> \u548c <code>ens1f1</code>\uff09\uff0c\u901a\u8fc7\u4e00\u4e2a\u5149\u4ea4\u6362\u673a\u5728\u6240\u6709\u8ba1\u7b97\u670d\u52a1\u5668\u548c\u5b58\u50a8\u670d\u52a1\u5668\u7684 iSCSI \u7aef\u53e3\u5b9e\u73b0\u4e00\u4e2a\u5185\u7f51\u4e92\u8054\u3002</p> <p>\u7b2c\u4e00\u4ee3 Vlab \u7684\u552f\u4e00\u4e00\u53f0\u670d\u52a1\u5668\u5728\u91cd\u88c5\u540e\u6709\u9650\u63d0\u4f9b\u670d\u52a1\uff0c\u547d\u540d\u4e3a pv0\uff0c\u56e0\u6b64\u96c6\u7fa4\u5171\u6709 11 \u53f0\u8ba1\u7b97\u670d\u52a1\u5668\u3002\u4e0e 2019 \u5e74\u79cb\u5b63\u65f6\u76f8\u6bd4\uff0c\u5b83\u591a\u4e86 32 GB \u7684\u5185\u5b58\uff08NUMA \u4e0d\u5747\u8861\uff09\u548c\u4e00\u5757 Intel X520-DA2 \u5149\u7ea4\u5361\u7528\u4e8e\u63a5\u5165\u5149\u7ea4\u7f51\u7edc\uff08\u4f46\u662f\u6700\u540e\u6ca1\u63a5\u4e0a\uff0c\u76ee\u524d\u7528\u4e8e\u6d4b\u8bd5\u5e73\u53f0\uff09\u3002</p> <p>\u4e3b\u673a\u7684 IPMI \u5730\u5740\u4e3a 10.38.79.100 \u81f3 10.38.79.108\uff0c\u6700\u540e\u4e00\u4f4d\u6570\u5b57\u548c\u4e3b\u673a\u540d\u4e00\u81f4\uff0c\u8be6\u89c1 IP \u5730\u5740\u5217\u8868\u3002</p>"},{"location":"overview/#compute-server-gpu","title":"GPU \u8ba1\u7b97\u670d\u52a1\u5668","text":"<p>2 \u53f0 GPU \u670d\u52a1\u5668\uff0c\u547d\u540d\u4e3a pvg1 \u548c pvg2\uff0c\u6bcf\u53f0\u670d\u52a1\u5668\u5305\u542b\u53cc\u8def Intel Xeon Scalable Gold 5218 \u5904\u7406\u5668\uff08\u5171 32 \u6838\u5fc3\u300164 \u7ebf\u7a0b\uff09\uff0c\u5185\u5b58\u5bb9\u91cf\u4e3a 192 GB\uff08\u7ec4\u5408\u53ca NUMA \u60c5\u51b5\u672a\u77e5\uff09\u3002\u786c\u76d8\u914d\u7f6e\u4e3a\u4e24\u5757 HPE SSD 480GB\uff08pvg1 \u53e6\u6709\u56db\u5757 Intel DC4500 480GB\uff09\uff0c\u7f51\u5361\u914d\u7f6e\u4e0e CPU \u8ba1\u7b97\u670d\u52a1\u5668\u4e00\u81f4\u3002</p> <p>\u5176\u4e2d pvg1 \u5b89\u88c5\u6709\u4e24\u5757 RTX 2070 Super GPU\uff08\u53ef\u80fd\u4e3a\u6280\u5609\uff09\uff0cpvg2 \u5b89\u88c5\u6709\u4e00\u5757 RTX 2070 Super GPU\uff08\u578b\u53f7\u672a\u77e5\uff09\u548c\u4e00\u5757 Quadro RTX 6000 GPU\u3002</p> <p>\u4e3b\u673a\u7684 IPMI \u5730\u5740\u5206\u522b\u4e3a 10.38.79.181 \u548c 10.38.79.182\uff0c\u8be6\u89c1 IP \u5730\u5740\u5217\u8868\u3002</p>"},{"location":"overview/#operating-system","title":"\u64cd\u4f5c\u7cfb\u7edf","text":"<p>\u8fd9\u6279\u670d\u52a1\u5668\u5168\u90e8\u5b89\u88c5 Proxmox VE \u7cfb\u7edf\uff0c\u57fa\u4e8e Debian\u3002\u672c\u5e73\u53f0\u4f7f\u7528 Proxmox VE \u7ba1\u7406\u5bb9\u5668\uff0c\u4ec5\u5728 GPU \u5b9e\u4f8b\u4f7f\u7528 KVM \u865a\u62df\u673a\u3002</p>"},{"location":"overview/#storage-server","title":"\u5b58\u50a8\u670d\u52a1\u5668","text":"<p>\u5b58\u50a8\u670d\u52a1\u5668\u4e3a HPE MSA 1050\uff0c\u6709 24 \u4e2a 2.5 \u5bf8 SAS \u76d8\u4f4d\u548c\u4e24\u4e2a iSCSI \u63a7\u5236\u5668\u3002\u8d2d\u4e70\u65f6\u5e26\u6709 18 \u5757 1.2 TB \u7684\u786c\u76d8\uff0c\u540e\u6765\u90a2\u51ef\u8001\u5e08\u63d0\u4f9b\u4e86\u4e00\u4e2a\u989d\u5916\u7684\u786c\u76d8\u7b3c\uff0c\u6269\u5c55\u4e86 24 \u4e2a\u76d8\u4f4d\uff0c\u6b63\u597d\u653e\u4e0b 8 \u53f0\u8ba1\u7b97\u670d\u52a1\u5668\u5404\u81ea\u5e26\u7684 3 \u5757\u673a\u68b0\u786c\u76d8\u3002</p> <p>\u8be5\u5b58\u50a8\u670d\u52a1\u5668\u6709\u4e24\u4e2a\u63a7\u5236\u5668\uff0c\u6bcf\u4e2a\u63a7\u5236\u5668\u5404\u6709\u4e00\u4e2a\u4ee5\u592a\u7f51\u53e3\uff08\u7528\u4e8e\u7ba1\u7406\u754c\u9762\uff09\u548c\u4e24\u4e2a\u5149\u7ea4\u63a5\u53e3\uff0810 Gbps\uff0c\u7528\u4e8e\u6570\u636e\u4f20\u8f93\uff09\u3002\u76ee\u524d\u4e24\u4e2a\u63a7\u5236\u5668\u7684\u7ba1\u7406\u63a5\u53e3\u90fd\u63a5\u5165\u6821\u56ed\u7f51\uff0c\u5730\u5740\u5206\u522b\u4e3a 10.38.79.98 \u548c 10.38.79.99\u3002</p>"},{"location":"overview/#location","title":"\u673a\u623f","text":"<p>\u673a\u623f\u5728\u7535\u4e09\u697c 524\uff0c\u9664 pv0 \u4ee5\u5916\u7684\u6240\u6709\u8bbe\u5907\u90fd\u5728\u540c\u4e00\u4e2a\u673a\u67dc\u4e2d\uff0c\u4e0a\u9762\u8d34\u6709\u6807\u7b7e\u3002\u4ece\u4e0b\u5f80\u4e0a\u5206\u522b\u4e3a\uff1a</p> <ul> <li>\u5b58\u50a8\u670d\u52a1\u5668\u7684\u4e24\u4e2a\u786c\u76d8\u7b3c\uff08\u6807\u7b7e VLAB S0 \u548c VLAB S1\uff09</li> <li>\u516b\u53f0\u8ba1\u7b97\u670d\u52a1\u5668\uff0c\u4e3b\u673a\u540d\u4e3a pv1, pv2 \u5230 pv8\uff0c\u6807\u7b7e\u4e3a VLAB 1 \u5230 VLAB 8</li> <li>\u673a\u623f\u7684\u7f51\u7ebf\u63a5\u53e3</li> </ul> <p>\u673a\u67dc\u80cc\u540e\u6700\u4e0a\u65b9\u662f\u534e\u4e3a\u7684\u5149\u4ea4\u6362\u673a\uff0c\u53c2\u89c1\u7f51\u7edc\u914d\u7f6e\u3002</p> <p>pv0 \u5728\u4e0a\u8ff0\u673a\u67dc\u5de6\u4fa7\u7d27\u6328\u7684\u673a\u67dc\u6700\u4e0b\u65b9\u3002</p>"},{"location":"overview/#resources","title":"\u5176\u4ed6\u8d44\u6e90","text":"<p>\u5b66\u6821\u5b98\u65b9\u57df\u540d <code>vlab.ustc.edu.cn</code> \u5c5e\u4e8e\u672c\u9879\u76ee\uff0c\u6307\u5411 A 202.38.75.226 \u53ca AAAA 2001:da8:d800:75::226\u3002\u53e6\u6709\u9759\u6001 IP \u5730\u5740 202.38.75.252 \u7528\u4f5c\u5b66\u751f\u673a\u7f51\u5173\uff0c\u6ca1\u6709\u57df\u540d\u3002\u5173\u4e8e IP \u5730\u5740\u8be6\u89c1\u8fd9\u4e2a\u9875\u9762\u3002</p> <p>\u6240\u6709\u8ba1\u7b97\u670d\u52a1\u5668\u7684 IPMI \u7f51\u9875\u3001\u5b58\u50a8\u670d\u52a1\u5668\u7684\u4e24\u4e2a\u7ba1\u7406\u63a5\u53e3\u4ee5\u53ca\u6211\u4eec\u7684\u6d4b\u8bd5\u73af\u5883\u90fd\u4f7f\u7528\u81ea\u5df1\u7684 CA \u7b7e\u53d1\u7684\u8bc1\u4e66\u3002\u8be5 CA \u76ee\u524d\u7531 iBug \u7ba1\u7406\uff0cCA \u8bc1\u4e66\u5728\u8fd9\u91cc\uff0c\u53ef\u4ee5\u6dfb\u52a0\u5230\u7cfb\u7edf\u7684\u8bc1\u4e66\u4fe1\u4efb\u5217\u8868\u4e2d\uff0c\u65b9\u4fbf\u540e\u7eed\u7ba1\u7406\u673a\u5668\u3002</p>"},{"location":"ssh-ca/","title":"SSH \u8bc1\u4e66\u8ba4\u8bc1","text":"<p>\u6240\u6709 Proxmox VE \u4e3b\u673a\u53ca\u51e0\u4e2a\u7279\u6b8a\u5bb9\u5668\uff08CT100 gateway\uff0cCT101 web \u548c\u5176\u4ed6 ID \u4e3a 1xx \u7684\u5bb9\u5668/\u865a\u62df\u673a\uff09\u7684 SSH \u767b\u5f55\u5747\u4f7f\u7528\u8bc1\u4e66\u3002</p> <p>\u5173\u4e8e OpenSSH \u7684\u8bc1\u4e66\u8ba4\u8bc1\u65b9\u5f0f\uff0c\u53ef\u4ee5\u53c2\u8003 iBug \u7684\u535a\u5ba2\uff08\u82f1\u6587\uff09\u3001totoro \u7684\u535a\u5ba2\u4ee5\u53ca\u6821 Linux \u7528\u6237\u534f\u4f1a\u7684\u670d\u52a1\u5668\u7ef4\u62a4\u6587\u6863\u3002</p> <p>CA \u516c\u94a5\uff1a</p> <pre><code>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQD6KdAJzKLswXyjf4SipNL1dlK1Vq0KNOit/MTDLiamkqvHJDiKceLYmN97y3Chdx8ofXwW6sRUBJRrjmYq6M0JZSGc8roUtUnSai1P5q1kZQ59x1IhsduTg4WENSteSB6vIvpyoSmcIhi3v9UHgUsl4MsnHxffxx5BiyW7UHPY3MzzkRZL96A4QXUOFd9P+NED3zHmEZ9B2Q66+s2ep2FmNralK4XwRaVxBO2r9san8vYU5pH2TzYZLYxNZ/AFX3bLV5M+AmZytaSNLcuIzZHyqbYawvD+Lee00VB9A3JcaqsjDUCtHZ5gQsZMmqw2r7gj9lDqM6Fw6A8y5rWNJP3Q+FOEEYvzGnQ/SnzU0MpMvGpYWrm/uCJ8pFdbYTYkxAJ+VO0lJ5mAIN664cX0DQ3OyGH/xmCNWGGCfGfmvWqwMwD6Kzo06xcqzsoqaMxwgBuVyICE+VvVCf3pcX4HERDrZY0TMjZxaTc8Ws2xQHJbqekv6nIjQWUgH7LIjkYvycQkxXE2dWfDy/c2SRiKWuxW9n8Hymmfp3lbBHzlCa/LtHeuPIzmBUHUoGya0feWFjrbGnKcPs3etNqpvyIGngMaecTAsbrf5v+J1M0VLCfwzwLt13/G1BCb+BK22vYzMTusrR+6A68Fm6OWSFlBYp31uVLxPg0nqtiW8bi1FbD0hQ== Vlab-CA\n</code></pre> <p>\u53ef\u4ee5\u5728\u670d\u52a1\u5668\u4e0a\u76f4\u63a5\u4f7f\u7528 Wget \u6216 cURL \u83b7\u53d6\uff1a</p> <pre><code>wget -O /etc/ssh/ssh_user_ca https://vlab.ibugone.com/assets/vlab_ca.pub\n</code></pre> <p>\u7136\u540e\u51c6\u5907 <code>/etc/ssh/sshd_config.d/vlab.conf</code>\uff1a</p> <pre><code>HostKey /etc/ssh/ssh_host_rsa_key\nHostCertificate /etc/ssh/ssh_host_rsa_key-cert.pub\nTrustedUserCAKeys /etc/ssh/ssh_user_ca\n\nAuthorizedKeysFile none  # \u5c4f\u853d\u4e0d\u5e26\u8bc1\u4e66\u7684\u516c\u94a5\u8ba4\u8bc1\nPermitRootLogin prohibit-password\nPasswordAuthentication no\n</code></pre>"},{"location":"ssh-ca/#\u7528\u6237-ca","title":"\u7528\u6237 CA","text":"<p>\u7531\u4e8e Proxmox VE \u6ca1\u6709\u63d0\u4f9b\u76f4\u63a5\u5728\u5bb9\u5668\u5185\u6267\u884c\u547d\u4ee4\u7684 API\uff0c\u56e0\u6b64\u6211\u4eec\u901a\u8fc7\u5185\u5d4c SSH CA \u7684\u65b9\u5f0f\u81ea\u5df1\u9020\u4e2a\u8f6e\u5b50\u3002</p> <p>\u51fa\u4e8e\u7ba1\u7406\u7684\u8003\u8651\uff0c\u7528\u6237 CA \u548c\u4e3b\u673a CA \u72ec\u7acb\u3002\u516c\u94a5\uff1a</p> <pre><code>ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1MjEAAACFBAH3ZHisQY0iMpUNDQNaxcnRSqDbauE8ih6/MrEENJZa7FHKINOPi+bunK1wEXPqlKfu8INEBWCf95+t86z+jXVxmQE176xenS92wiLvR4MZyCBfD5DXAB0mK5iV1eQug5P/cD8Pohr/3wywFbKgKzsix9unky9sJGr86RunSwJbAkMGlw== Vlab-User-CA\n</code></pre> <p>\u53ef\u4ee5\u5728\u865a\u62df\u673a\u4e2d\u76f4\u63a5\u4f7f\u7528 Wget \u6216 cURL \u83b7\u53d6\uff1a</p> <pre><code>wget -O /etc/ssh/ssh_user_ca https://vlab.ibugone.com/assets/vlab_user_ca.pub\n</code></pre> <p>\u5c06 CA \u6dfb\u52a0\u81f3\u5bb9\u5668\u6216\u865a\u62df\u673a\u7684\u64cd\u4f5c\u4e0e\u4e0a\u9762\u7c7b\u4f3c\uff0c\u4f46\u662f\u4e0d\u9700\u8981\u5bf9\u4e3b\u673a\u516c\u94a5\u8fdb\u884c\u7b7e\u540d\uff0c\u56e0\u6b64\u53ea\u9700\u8981</p> <ul> <li>\u5c06\u4ee5\u4e0a\u516c\u94a5\u4fdd\u5b58\u81f3\u67d0\u4e2a\u6587\u4ef6\uff0c\u5982 <code>/etc/ssh/ssh_user_ca</code></li> <li> <p>\u5728 <code>sshd_config</code> \u4e2d\u8ffd\u52a0\uff0c\u6216\u8005\u521b\u5efa <code>/etc/ssh/sshd_config.d/vlab.conf</code> \u5e76\u5199\u5165</p> <pre><code>TrustedUserCAKeys /etc/ssh/ssh_user_ca\n</code></pre> <p>\u6ce8\u610f\u4f7f\u7528 <code>sshd_config.d</code> \u524d\u8981\u786e\u8ba4\u8f6f\u4ef6\u5305\u63d0\u4f9b\u7684 <code>sshd_config</code> \u5305\u542b\u4e86 Include \u8bed\u53e5\uff0c\u5426\u5219\u8bf7\u76f4\u63a5\u4fee\u6539 <code>sshd_config</code>\u3002</p> </li> </ul>"},{"location":"traps/","title":"\u8e29\u5751\u8bb0\u5f55","text":""},{"location":"traps/#proxmox-ve","title":"Proxmox VE","text":""},{"location":"traps/#\u5728\u5411\u96c6\u7fa4\u6dfb\u52a0\u8282\u70b9\u65f6\u9700\u8981\u4fdd\u8bc1\u96c6\u7fa4\u4e2d\u5df2\u6709\u7684\u8282\u70b9\u5168\u90e8\u5f00\u542f\u5e76\u6b63\u5e38\u8fde\u63a5","title":"\u5728\u5411\u96c6\u7fa4\u6dfb\u52a0\u8282\u70b9\u65f6\uff0c\u9700\u8981\u4fdd\u8bc1\u96c6\u7fa4\u4e2d\u5df2\u6709\u7684\u8282\u70b9\u5168\u90e8\u5f00\u542f\u5e76\u6b63\u5e38\u8fde\u63a5","text":"<p>\u5426\u5219\uff0c\u672a\u5f00\u542f\u7684\u8282\u70b9\u7531\u4e8e\u6ca1\u6709\u6536\u5230\u66f4\u65b0\u901a\u77e5\uff0c\u53ef\u80fd\u5728\u52a0\u5165\u96c6\u7fa4\u65f6\u51fa\u73b0\u9519\u8bef\u3002</p> <p>\u5728\u51fa\u73b0\u9519\u8bef\u7684\u8282\u70b9\u4e0a\u7684\u75c7\u72b6\uff1a</p> <ul> <li><code>pvesr.service</code> \u65e0\u6cd5\u8fd0\u884c\uff0c\u9519\u8bef\u4fe1\u606f\u5305\u542b \"error with cfs lock 'file-replication_cfg': no quorum!\"</li> <li><code>pvecm status</code> \u663e\u793a \"Cannot initialize CMAP service\"</li> <li><code>corosync.service</code> \u672a\u5728\u8fd0\u884c</li> </ul> <p>\u89e3\u51b3\u65b9\u6cd5\uff1a</p> <ol> <li>\u5173\u95ed <code>pve-cluster.service</code></li> <li>\u6267\u884c <code>pmxcfs -l</code>\uff0c\u5c06\u96c6\u7fa4\u6587\u4ef6\u7cfb\u7edf\u4ee5 local mode \u542f\u52a8</li> <li>\u4ece\u6b63\u5e38\u8fd0\u884c\u7684\u8282\u70b9\u4e0a\u590d\u5236 <code>/etc/pve/corosync.conf</code>\uff0c\u8986\u76d6\u9519\u8bef\u8282\u70b9\u7684\u76f8\u5e94\u6587\u4ef6</li> <li><code>killall pmxcfs</code></li> <li>\u91cd\u542f <code>pve-cluster.service</code> \u548c <code>corosync.service</code></li> </ol>"},{"location":"traps/#ha-\u63d0\u793a-service-ct100-in-error-state-must-be-disabled-and-fixed-first","title":"HA \u63d0\u793a <code>service 'ct:100' in error state, must be disabled and fixed first</code>","text":"<p>\u9700\u8981\u5148 disable\uff1a<code>ha-manager set ct:100 --state disabled</code>\uff08<code>ct:100</code> \u66ff\u6362\u4e3a\u62a5\u9519\u63d0\u793a\u4e2d\u5bf9\u5e94\u7684\u540d\u5b57\uff09</p>"},{"location":"traps/#migrate-\u63d0\u793a-error-migration-aborted-duration-000000-ct-is-locked-migrate","title":"Migrate \u63d0\u793a <code>ERROR: migration aborted (duration 00:00:00): CT is locked (migrate)</code>","text":"<p>\u5bb9\u5668\uff1a<code>pct unlock &lt;ID \u53f7&gt;</code></p> <p>\u865a\u62df\u673a\uff1a<code>qm unlock &lt;ID \u53f7&gt;</code></p> <p>HA \u6ce8\u610f\u4e8b\u9879</p> <p>\u8bf7\u52ff bind mount \u6216\u6302\u8f7d ISO\uff0c\u5426\u5219\u8282\u70b9\u4e0b\u7ebf\u65f6\u65e0\u6cd5\u8fdb\u884c\u81ea\u52a8 migrate\u3002</p>"},{"location":"traps/#\u624b\u52a8\u8fc1\u79fb\u542f\u7528\u4e86-ha-\u7684\u865a\u62df\u673a\u6216\u5bb9\u5668\u53c8\u88ab\u81ea\u52a8\u8fc1\u79fb\u56de\u6765\u4e86","title":"\u624b\u52a8\u8fc1\u79fb\u542f\u7528\u4e86 HA \u7684\u865a\u62df\u673a\u6216\u5bb9\u5668\u53c8\u88ab\u81ea\u52a8\u8fc1\u79fb\u56de\u6765\u4e86","text":"<p>PVE \u7684 HA \u592a\u656c\u4e1a\u4e86\uff0c\u8fd0\u884c\u865a\u62df\u673a\u65f6\u4f1a\u4e25\u683c\u6309\u7167 HA \u914d\u7f6e\u597d\u7684\u8282\u70b9\u4f18\u5148\u7ea7\u6765\u8fd0\u884c\u865a\u62df\u673a\u3002</p> \u65e7\u89e3\u51b3\u65b9\u6cd5 <p>\u8981\u60f3 HA \u201c\u542c\u8bdd\u201d\uff0c\u529e\u6cd5\u5c31\u662f\u76f4\u63a5\u6539\u5404\u8282\u70b9\u7684\u4f18\u5148\u7ea7\uff0c\u8ba9\u542c\u8bdd\u7684 HA \u5e2e\u4f60\u8fc1\u79fb\u3002</p> <p>\u7ef4\u62a4\u8282\u70b9\u524d\u8bf7\u5c06\u5176\u4f18\u5148\u7ea7\u8c03\u4f4e\u6216\u5220\u6389\uff08\u9ed8\u8ba4\u4e3a\u96f6\uff0c\u6570\u503c\u8d8a\u9ad8\u8d8a\u4f18\u5148\uff09\uff0c\u4ee5\u514d\u91cd\u542f\u8fc7\u7a0b\u4e2d HA \u5c06\u865a\u62df\u673a\u9891\u7e41\u8fc1\u79fb\u3002</p> <p>HA group \u6709\u4e00\u4e2a\u9009\u9879\u662f nofailback\uff0c\u5373\u7981\u7528\u201c\u6709\u66f4\u9ad8\u4f18\u5148\u7ea7\u8282\u70b9\u5728\u7ebf\u65f6\u4f18\u5148\u8fc1\u79fb\u5230\u66f4\u9ad8\u8282\u70b9\u201d\u8fd9\u4e2a\u9ed8\u8ba4\u884c\u4e3a\u3002\u542f\u7528 nofailback \u540e HA \u4f1a\u5c3d\u91cf\u907f\u514d\u8fc1\u79fb\u865a\u62df\u673a\u800c\u4e0d\u662f\u5c3d\u91cf\u5f80\u9ad8\u4f18\u5148\u7ea7\u8282\u70b9\u4e0a\u8fc1\u79fb\u3002</p>"},{"location":"traps/#proxmox-backup-server-\u65e0\u6cd5\u8fde\u63a5\u63d0\u793a-error-fetching-datastores---fingerprint-xxxxxx","title":"Proxmox Backup Server \u65e0\u6cd5\u8fde\u63a5\uff0c\u63d0\u793a Error fetching datastores - fingerprint XX:XX:XX:\u2026","text":"<p>PVE \u4f1a\u9a8c\u8bc1 PBS \u7684\u8bc1\u4e66\uff0c\u5982\u679c\u8bc1\u4e66\u4e0e\u914d\u7f6e\u7684 fingerprint \u4e0d\u5339\u914d\uff08\u6216\u8005\u5728\u6ca1\u6709 fingerprint \u7684\u65f6\u5019\u4e0d\u4fe1\u4efb\u8bc1\u4e66\uff09\uff0c\u5219\u4f1a\u63d0\u793a\u9519\u8bef\u3002</p> <p>\u7531\u4e8e\u6211\u4eec\u7684\u8bc1\u4e66\u4f7f\u7528 acme.sh \u81ea\u52a8\u66f4\u65b0\uff0c\u6bcf\u6b21\u66f4\u65b0\u540e\u8bc1\u4e66\u7684 fingerprint \u5c31\u4f1a\u53d8\u5316\uff0c\u800c\u6211\u4eec\u4f7f\u7528\u5185\u7f51\u5730\u5740\u8fde\u63a5 PBS \u4e5f\u4e0d\u53ef\u80fd\u83b7\u5f97\u516c\u7f51\u53ef\u4fe1\u4efb\u7684\u8bc1\u4e66\uff0c\u56e0\u6b64\u89e3\u51b3\u65b9\u6cd5\u662f\u6bcf\u6b21\u66f4\u65b0\u8bc1\u4e66\u65f6\u540c\u6b65\u66f4\u65b0 fingerprint\u3002</p> <p>\u5728 pv1 \u7684\u66f4\u65b0\u8bc1\u4e66\u7684 cron \u811a\u672c\u6700\u540e\u52a0\u5165\u4ee5\u4e0b\u5185\u5bb9\uff0c\u4f7f\u7528 OpenSSL \u83b7\u53d6\u8bc1\u4e66 fingerprint \u5e76\u7528 pvesm \u547d\u4ee4\u767b\u8bb0\u4fee\u6539\uff1a</p> <pre><code>FP=\"$(openssl x509 -noout -fingerprint -sha256 -inform pem -in \"$SRC/pveproxy-ssl.pem\")\"\nFP=\"${FP##*=}\"\npvesm set pbs --fingerprint \"$FP\"\n</code></pre>"},{"location":"traps/#lvm","title":"LVM","text":""},{"location":"traps/#\u5f00\u673a\u663e\u793a-cannot-process-volume-group-pve-\u7b49\u9519\u8bef\u4fe1\u606f","title":"\u5f00\u673a\u663e\u793a Cannot process volume group pve \u7b49\u9519\u8bef\u4fe1\u606f","text":"<p>\u8fd9\u4e00\u6b65\u6bd4\u8f83\u9ebb\u70e6\uff0c\u4e3b\u8981\u662f\u56e0\u4e3a IPMI \u63d0\u4f9b\u7684\u90a3\u4e2a\u8fdc\u7a0b\u7ec8\u7aef\u7ecf\u5e38\u5361\u3002</p> <p>\u539f\u56e0\u662f\u7cfb\u7edf\u4e2d\u6709 <code>/dev/sda</code> \u548c <code>/dev/sdb</code> \u4e24\u4e2a\u8bbe\u5907\uff0c\u5176\u4e2d\u4e00\u4e2a\u662f SSD\uff0c\u53e6\u4e00\u4e2a\u4e0d\u77e5\u9053\u662f\u54ea\u6765\u7684\uff08\u53ef\u80fd\u662f IPMI \u7684\u865a\u62df\u8bbe\u5907\uff0c\u901a\u8fc7 USB \u603b\u7ebf\u63a5\u5165\uff09\uff0c\u4e3a\u4e86\u4e0d\u8ba9 LVM \u6bcf\u6b21\u8fd0\u884c\u65f6\u90fd\u5410\u69fd\u4e00\u904d <code>open /dev/sdX failed: no medium found</code>\uff0c\u5c06\u62a5\u9519\u7684\u90a3\u4e2a\u8bbe\u5907\u5c4f\u853d\uff0c\u65b9\u6cd5\u662f\u5728 <code>/etc/lvm/lvm.conf</code> \u4e2d\u7684 <code>global_filters</code> \u4e2d\u52a0\u5165 <code>\"r|/dev/disk/by-id/usb.*|\"</code>\uff0c\u4f7f LVM \u626b\u63cf PV \u65f6\u5ffd\u7565\u8fd9\u4e2a\u8bbe\u5907\u53ca\u5176\u4ed6\u7ecf\u8fc7 USB \u603b\u7ebf\u8fde\u63a5\u7684\u8bbe\u5907\u3002</p> <p>\u5751\u70b9 1\uff08\u5df2\u89e3\u51b3\uff09</p> <p>\u66fe\u7ecf\u7684\u8fc7\u6ee4\u89c4\u5219\u662f <code>r|/dev/sdb|</code>\uff0c\u8fd9\u6837\u5c31\u628a\u4efb\u4f55\u6620\u5c04\u5230 sdb \u7684\u8bbe\u5907\u90fd\u5ffd\u7565\u4e86\uff0c\u4f46\u662f\u5728\u4e0d\u660e\u60c5\u51b5\u4e0b\u8fd9\u4e24\u4e2a\u8bbe\u5907\u4f1a\u4e92\u6362\uff0c\u5bfc\u81f4\u539f\u5148\u7684\u8fc7\u6ee4\u89c4\u5219\u628a\u771f\u6b63\u7684\u7cfb\u7edf\u76d8\u7ed9\u8fc7\u6ee4\u6389\u4e86\uff0c\u7559\u4e0b\u4e00\u4e2a\u7a7a\u8bbe\u5907\uff0c\u65e0\u6cd5\u5f00\u673a\u542f\u52a8\uff08rootfs \u5728 LV \u5377 pve/root \u4e0a\uff09</p> <p>\u597d\u5728\u76ee\u524d\u6ca1\u6709\u53d1\u73b0\u7a7a\u8bbe\u5907\u4ece sdb \u53d8\u6210 sda \u7684\u60c5\u51b5\uff0c\u56e0\u6b64\u6bcf\u4e2a\u4e3b\u673a\u6700\u591a\u53ea\u9700\u8981\u5904\u7406\u4e00\u6b21\u5c31\u884c\uff08\u5176\u5b9e\u5230\u73b0\u5728\u4e00\u5171\u5c31\u53d1\u751f\u8fc7\u4e00\u6b21\uff09\u3002</p> <p>\u5751\u70b9 2</p> <p>LVM \u662f\u5f00\u673a\u542f\u52a8\u5fc5\u987b\u7684\u529f\u80fd\uff0c\u56e0\u6b64 LVM \u76f8\u5173\u7684\u5de5\u5177\uff08<code>lvm</code> \u547d\u4ee4\uff09\u548c\u914d\u7f6e\u6587\u4ef6\uff08\u5373 <code>/etc/lvm/lvm.conf</code>\uff09\u4f1a\u6253\u5305\u8fdb initramfs \u91cc\uff0c\u8fd9\u65f6\u5019\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6\u5728\u7cfb\u7edf\u91cc\u548c initramfs \u91cc\u5c31\u6709\u72ec\u7acb\u7684\u4e24\u4efd\u4e86\uff0c\u8981\u4fee\u6539\u5f97\u628a\u4e24\u4efd\u90fd\u4fee\u6539\u6389\u3002</p>"},{"location":"traps/#\u89e3\u51b3\u6b65\u9aa4","title":"\u89e3\u51b3\u6b65\u9aa4","text":"<ol> <li>\u5f00\u673a\u5931\u8d25\uff0c\u8fdb\u5165 initramfs\uff0c\u8fd9\u91cc\u6709\u4e2a busybox \u548c <code>lvm</code> \u5de5\u5177</li> <li>\u7f16\u8f91 <code>/etc/lvm/lvm.conf</code>\uff0c\u627e\u5230 <code>global_filters</code>\uff0c\u628a\u5176\u4e2d\u7684 <code>r|/dev/sda|</code> \u6362\u6210 <code>r|/dev/sdb|</code>\uff08\u6216\u8005\u53cd\u8fc7\u6765\u6539\uff0c\u53d6\u51b3\u4e8e\u539f\u5148\u5185\u5bb9\u662f\u4ec0\u4e48\u4ee5\u53ca\u524d\u9762\u62a5 no medium found \u7684\u662f\u54ea\u4e2a\u8bbe\u5907\uff09</li> <li><code>lvm vgscan</code>\uff0c\u8fd9\u65f6\u5019\u518d <code>lvm vgs</code> \u5e94\u8be5\u5c31\u80fd\u770b\u5230 pve \u8fd9\u4e2a VG \u4e86</li> <li><code>lvm lvchange -ay pve/root</code> \u6fc0\u6d3b rootfs \u5377\uff0c\u627e\u4e2a\u5730\u65b9\u6302\u8f7d\u8d77\u6765</li> <li>chroot \u8fdb\u53bb\uff0c\u628a <code>/etc/lvm/lvm.conf</code> \u518d\u6539\u4e00\u904d\uff08\u548c\u7b2c 2 \u6b65\u76f8\u540c\uff09</li> <li> <p><code>update-initramfs -u -k all</code> \u66f4\u65b0 initramfs\uff0c\u91cd\u542f</p> <p>\u5176\u5b9e\u7b2c 5 \u6b65\u4e0d\u4e00\u5b9a\u9700\u8981 chroot\uff0c\u4f46\u662f\u8fd9\u4e00\u6b65\u662f\u9700\u8981\u7684</p> </li> </ol>"},{"location":"traps/#ct-100-\u548c-ct-101-\u65e0\u6cd5\u542f\u52a8","title":"CT 100 \u548c CT 101 \u65e0\u6cd5\u542f\u52a8","text":"<p>LVM \u5377\u4e0d\u80fd\u591a\u4e2a\u4e3b\u673a\u540c\u65f6\u4f7f\u7528\uff08active \u72b6\u6001\uff09\uff0c\u5982\u679c\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\u4f1a\u5bfc\u81f4 LVM \u62d2\u7edd\u4f7f\u7528\u53d7\u5f71\u54cd\u7684\u5377\u3002</p> <p>\u76ee\u524d\u6211\u4eec\u7684 VG <code>user-data</code> \u662f\u5171\u4eab\u7684\uff0c\u800c VG <code>pve</code> \u662f\u6bcf\u4e2a\u4e3b\u673a\u81ea\u5df1\u7684 SSD\uff08\u5373\u4e0e\u672c\u95ee\u9898\u65e0\u5173\uff09\u3002</p> <p>Proxmox VE \u4f7f\u7528 LVM</p> <p>Proxmox VE \u5728\u542f\u52a8\u5bb9\u5668\u6216\u865a\u62df\u673a\u65f6\u4f1a\u5c1d\u8bd5\u5360\u7528\u76f8\u5173\u7684\u5377\uff08\u8bbe\u4e3a active\uff09\uff0c\u5e76\u5728\u5173\u95ed\u5bb9\u5668\u6216\u865a\u62df\u673a\u65f6\u53d6\u6d88 active \u72b6\u6001\uff0c\u56e0\u6b64\u6b63\u5e38\u60c5\u51b5\u4e0b\u4e0d\u4f1a\u51fa\u73b0\u8de8\u4e3b\u673a\u5360\u7528\u7684\u60c5\u51b5\u3002</p> <p>\u8be5\u5751\u70b9\u53ef\u80fd\u5df2\u4fee\u590d\uff0c\u5c1a\u672a\u6d4b\u8bd5</p> <p>\u51fa\u4e8e\u4e0d\u660e\u539f\u56e0\uff0c\u624b\u52a8\u6302\u8f7d iSCSI \u8bbe\u5907\u4f1a\u5bfc\u81f4\u4e0a\u9762\u6240\u6709\u7684 LV \u90fd\u53d8\u6210 active\u3002</p> <p>\u89e3\u51b3\u65b9\u6cd5\uff1a\u6839\u636e Server Fault \u4e0a\u7684\u8fd9\u4e2a\u56de\u7b54\uff0c\u5728 <code>/etc/lvm/lvm.conf</code> \u4e2d\u5199\u5165\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>auto_activation_volume_list = [ \"pve\", \"data\" ]\n</code></pre> <p>\u4fdd\u5b58\u540e LVM \u5c31\u4e0d\u4f1a\u5728\u68c0\u6d4b\u5230\u65b0 VG \u65f6\u81ea\u52a8\u542f\u7528\u5168\u90e8\u5377\u4e86\u3002\u53ef\u80fd\u9700\u8981\u66f4\u65b0 initramfs \u548c/\u6216\u91cd\u542f\u3002</p> <p>\u89e3\u51b3\u6b65\u9aa4\uff1a</p> <ul> <li>\u5982\u679c\u53d7\u5f71\u54cd\u7684\u5377\u4e0d\u591a\uff0c\u53ef\u4ee5\u624b\u52a8 SSH \u8fdb\u5165\u6240\u6709\u4e3b\u673a\uff0c\u5168\u90e8\u6765\u4e00\u904d <code>lvchange -an &lt;vg/lv&gt;</code>\uff0c\u8fd9\u6837\u5c31\u5728\u5168\u90e8\u4e3b\u673a\u4e0a\u628a\u8fd9\u4e2a\u5377\u53d6\u6d88\u4e86 active \u72b6\u6001\uff0c\u7136\u540e\u5176\u4e2d\u4e00\u4e2a\u4e3b\u673a\u5c31\u53ef\u4ee5\u5f00\u59cb\u4f7f\u7528\u5b83\uff08\u542f\u52a8\u5bb9\u5668\uff09\u4e86\u3002</li> <li> <p>\u5982\u679c\u53d7\u5f71\u54cd\u7684\u5377\u5f88\u591a\uff08\u5e38\u89c1\u60c5\u51b5\uff09\uff0c\u8f83\u4e3a\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u628a\u6240\u6709\u865a\u62df\u673a\u5bb9\u5668\u90fd\u5173\u6389\uff0c\u7136\u540e <code>vgchange -an &lt;vg&gt;</code>\uff0c\u4e00\u6b21\u6027\u628a\u6574\u4e2a VG \u91cc\u7684\u5168\u90e8 LV \u53d6\u6d88 active \u72b6\u6001\uff08\u5f53\u7136\u6bcf\u4e2a\u4e3b\u673a\u90fd\u8981\u91cd\u590d\u4e00\u904d\uff09\uff0c\u7136\u540e\u4e00\u5207\u6062\u590d\u6b63\u5e38\u3002</p> <ul> <li> <p>\u53e6\u4e00\u79cd\u9ad8\u7ea7\u529e\u6cd5\u662f\u4f7f\u7528\u6587\u5b57\u5904\u7406\u6280\u5de7\uff0c\u89e3\u6790 <code>lvs</code> \u7684\u8f93\u51fa\u5e76\u5173\u95ed\u5168\u90e8 active \u4f46\u4e0d\u662f open \u7684\u5377\uff08\u5373 flags \u4e3a <code>-wi-a-----</code> \u7684\u5377\uff09\u3002\u53c2\u8003\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>lvs | awk '$2 == \"user-data\" &amp;&amp; substr($3, 5, 1) == \"a\" { print $2 \"/\" $1 }' | xargs lvchange -an\n</code></pre> </li> </ul> </li> </ul>"},{"location":"traps/#\u5c06-pveroot-\u6539\u4e3a-lvm-mirror-\u5377\u540e\u5f00\u673a\u5361\u5728-loading-initial-ramdisk","title":"\u5c06 pve/root \u6539\u4e3a LVM mirror \u5377\u540e\u5f00\u673a\u5361\u5728 Loading initial ramdisk","text":"<p>\u91cd\u542f\u8fdb Live CD\uff0c\u6302\u8f7d\u4e00\u5806\u4e1c\u897f\uff0c\u7136\u540e chroot \u8fdb\u539f\u7cfb\u7edf\u7684 rootfs\u3002</p> <pre><code>vgscan\nvgchange -ay pve/root\nmount /dev/pve/root /mnt\nmount -o rbind /run /mnt/run  # For systemd-udevd\nchroot /mnt\nmount -t devtmpfs devtmpfs dev\nmount -t proc proc proc\nmount -t sysfs sysfs sys\nmount /dev/sda1 /boot/efi\n</code></pre> <p>\u7136\u540e\u5728\u4ee5\u4e0b\u65b9\u6cd5\u4e2d\u4e8c\u9009\u4e00\uff08\u4e24\u4e2a\u90fd\u505a\u4e5f\u6ca1\u95ee\u9898\uff09\uff1a</p> <ol> <li>\u7f16\u8f91 <code>/etc/initramfs-tools/modules</code>\uff0c\u6dfb\u52a0\u4e24\u884c <code>dm_raid</code> \u548c <code>raid1</code>\uff0c\u8fd0\u884c <code>update-initramfs -u -k all</code></li> <li>\u76f4\u63a5\u5b89\u88c5 <code>mdadm</code> \u8f6f\u4ef6\u5305</li> </ol> <p>\u4ee5\u4e0a\u64cd\u4f5c\u5b8c\u6210\u540e\u91cd\u542f\u5373\u53ef\u3002</p> <p>\u53c2\u8003\uff1ahttps://askubuntu.com/q/292092/612877</p>"},{"location":"traps/#\u5bb9\u5668\u4ecd\u5728\u90e8\u5206\u8fd0\u884c\u4f46\u662f-rootfs-\u672a\u5728-lvs-\u4e2d\u663e\u793a","title":"\u5bb9\u5668\u4ecd\u5728\uff08\u90e8\u5206\uff09\u8fd0\u884c\uff0c\u4f46\u662f rootfs \u672a\u5728 <code>lvs</code> \u4e2d\u663e\u793a","text":"<p>\u75c7\u72b6\uff1a</p> <ul> <li>\u5bb9\u5668\u7684 rootfs \u795e\u79d8\u6d88\u5931</li> <li><code>journalctl</code> \u7684\u9519\u8bef\u65e5\u5fd7\u63d0\u793a ext4\uff08\u6216\u8005\u5176\u4ed6\u6587\u4ef6\u7cfb\u7edf\uff09\u8bfb\u5199\u5bb9\u5668 rootfs \u65f6\u51fa\u73b0\u9519\u8bef</li> <li>\u5bb9\u5668\u65e0\u6cd5\u6b63\u5e38\u64cd\u4f5c</li> </ul> <p>\u8fd9\u4e2a\u95ee\u9898\u5f53\u65f6\u5728 CT 100 \u4e0a\u51fa\u73b0\uff0c\u539f\u56e0\u4e3a\u5728\u540c\u5b66\u64cd\u4f5c\u6d4b\u8bd5\u8282\u70b9\u65f6\uff0c\u4f7f\u7528\u4e86\u548c\u6b63\u5f0f\u73af\u5883\u76f8\u540c\u7684 LVM \u5b58\u50a8\uff0c\u4f46\u662f\u672a\u52a0\u5165\u96c6\u7fa4\uff0c\u5bfc\u81f4\u9501\u5931\u6548\u3002\u8fd9\u79cd\u60c5\u51b5\u662f\u6781\u5176\u5371\u9669\u7684\uff0c\u6700\u574f\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u80fd\u4f1a\u7834\u574f LVM \u7684\u5206\u533a\u8868\u3002</p> <p>\u76ee\u524d\uff0c\u6d4b\u8bd5\u8282\u70b9\u5df2\u52a0\u5165\u96c6\u7fa4\uff0c\u5e76\u4e14\u5bf9\u91cd\u8981\u5bb9\u5668\u7684\u5907\u4efd\u6b63\u5728\u64cd\u4f5c\u4e2d\u3002</p>"},{"location":"traps/#networking","title":"\u7f51\u7edc","text":""},{"location":"traps/#pve-7-ifupdown2","title":"Proxmox VE 7 \u7f51\u7edc\u914d\u7f6e","text":"<p>PVE 7 \u9ed8\u8ba4\u4f7f\u7528 ifupdown2\uff0c\u662f ifupdown \u7684\u4e00\u4e2a Python \u66ff\u4ee3\u54c1\uff0c\u914d\u7f6e\u6587\u4ef6 <code>/etc/network/interfaces</code> \u51e0\u4e4e\u517c\u5bb9\u3002</p> <p>ifupdown2 \u7684 bond \u8bed\u6cd5\u6709\u4e00\u70b9\u4e0d\u4e00\u6837\uff08\u5e76\u4e14\u4f1a\u70b8\uff09\uff0c\u5c31\u662f bond \u7684 slave \u662f\u5199\u5728 bond \u8bbe\u5907\u4e0b\u7684\uff0c\u800c\u4e0d\u662f\u50cf ifupdown \u4e00\u6837\u5728 slave \u8bbe\u5907\u4e0b\u5199 <code>bond-master</code>\uff0c\u6240\u4ee5\u4ece ifupdown \u6362\u5230 ifupdown2 \u540e\u91cd\u542f\u524d\u52a1\u5fc5\u4fee\u6539\u914d\u7f6e\u3002\u5efa\u8bae\u4e0d\u8981\u7740\u6025\u5220\u6389 <code>bond-master</code>\uff0c\u56e0\u4e3a\u5c3d\u7ba1\u4e24\u79cd\u5199\u6cd5\u4e92\u4e0d\u517c\u5bb9\uff0c\u4f46\u662f\u5b83\u4eec\u4e5f\u4e92\u4e0d\u51b2\u7a81\uff08ifupdown / ifupdown2 \u4f1a\u4e92\u76f8\u65e0\u89c6\u53e6\u4e00\u79cd\u5199\u6cd5\uff09\u3002</p> <p>\u5347\u7ea7 PVE 7 \u4e0d\u4e00\u5b9a\u4f1a\u81ea\u52a8\u66ff\u6362\u8f6f\u4ef6</p> <p>\u5982\u679c\u66f4\u65b0\u5230 PVE 7 \u7684\u65f6\u5019\u6ca1\u6709\u81ea\u52a8\u5c06 ifupdown \u66ff\u6362\u4e3a ifupdown2\uff0c\u8bf7\u624b\u52a8\u66ff\u6362\u5e76\u66f4\u65b0\u914d\u7f6e\u6587\u4ef6\u3002</p> <p>\u8bed\u6cd5\u6bd4\u8f83\uff1a</p> ifupdownifupdown2 <pre><code>auto eno1\niface eno1 inet manual\n    bond-master bond0\n\nauto eno2\niface eno2 inet manual\n    bond-master bond0\n\nauto bond0\niface bond0 inet manual\n    bond-mode balance-alb\n    bond-miimon 100\n    bond-downdelay 200\n    bond-updelay 200\n</code></pre> <pre><code>auto eno1\niface eno1\n\nauto eno2\niface eno2\n\nauto bond0\niface bond0\n    bond-slaves eno1 eno2\n    bond-mode balance-alb\n    bond-miimon 100\n    bond-downdelay 200\n    bond-updelay 200\n</code></pre> <p>\u66f4\u591a\u4fe1\u606f\u8bf7\u89c1\u4e3b\u673a\u7f51\u5361\u3002</p> <p>\u6ce8\u610f\u4e0b\u5212\u7ebf</p> <p>ifupdown2 \u91cc\u4e0d\u518d\u4f7f\u7528\u4e0b\u5212\u7ebf\u4f5c\u4e3a key\uff0c\u6240\u6709 ifupdown \u91cc\u4f7f\u7528\u4e0b\u5212\u7ebf\u7684 key \u90fd\u88ab\u6362\u6210\u4e86\u51cf\u53f7\uff0c\u4f8b\u5982 <code>bridge_ports</code> \u5df2\u7ecf\u6362\u6210\u4e86 <code>bridge-ports</code>\u3002   </p>"},{"location":"traps/#linux-arp","title":"ARP \u95ee\u9898","text":"<p>\u8be5\u95ee\u9898\u5df2\u4e8e 2020 \u5e74 7 \u6708 31 \u65e5\u89e3\u51b3\uff0c\u89c1\u4e0b</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b Linux \u4f1a\u5bf9\u672c\u673a\u7684\u6240\u6709 IP \u5730\u5740\u5728\u6240\u6709\u754c\u9762\u4e0a\u54cd\u5e94 ARP \u8bf7\u6c42\uff08\u5f53\u7136 127.0.0.0/8 \u662f\u9664\u5916\u7684\uff09\uff0c\u4f8b\u5982\u4e00\u4e2a\u4e3b\u673a\u62e5\u6709\u4e24\u4e2a\u754c\u9762 ifA \u548c ifB\uff0c\u5b83\u4eec\u5206\u522b\u5177\u6709 IP \u5730\u5740 ipA \u548c ipB\uff0c\u90a3\u4e48 Linux \u4f1a\u5728 ifA \u4e0a\u54cd\u5e94 who-has ipB \u7684\u8bf7\u6c42\uff0c\u53cd\u4e4b\u4ea6\u7136\u3002</p> <p>\u8fd9\u5728 2020 \u5e74\u4e0a\u534a\u5e74\u7814\u7a76 pv8 \u4e3a\u4ec0\u4e48\u8fde\u4e0d\u4e0a VXLAN \u7684\u65f6\u5019\u9020\u6210\u4e86\u5f88\u5927\u7684\u56f0\u60d1\uff0c\u56e0\u4e3a\u5b9e\u9645\u4e0a pv8 \u7684 ens1f1 \u754c\u9762\u662f\u574f\u7684\uff08\u53ef\u80fd\u662f\u5149\u7ea4\u6ca1\u63d2\u597d\u4e4b\u7c7b\u7684\uff09\uff0c\u7136\u540e\u7cfb\u7edf\u5728 ens1f0 \u754c\u9762\u4e0a\u54cd\u5e94\u4e86\u5b9e\u9645\u5c5e\u4e8e ens1f1 \u7684 IP \u5730\u5740\uff0c\u5728\u5176\u4ed6\u673a\u5668\u4e0a\u770b\u8d77\u6765\u5c31\u50cf\u662f ens1f1 \u80fd\u8fde\u901a\u4f46 vxlan0 \u8fde\u4e0d\u901a\uff0c\u800c\u5b9e\u9645\u4e0a\u662f 10.0.0.28 \u88ab\u89e3\u6790\u5230\u4e86 pv8 \u7684 ens1f0 \u4e0a\uff0c\u6ca1\u6545\u969c\u5f53\u7136\u5c31\u80fd\u8fde\u901a\u4e86\u3002</p> <p>iBug \u5907\u6ce8</p> <p>\u8fd9\u4e2a\u5730\u65b9\u6211\u4e5f\u6ca1\u60f3\u5230\uff0c\u5176\u5b9e\u53ea\u8981\u5728\u5176\u4ed6\u673a\u5668\u4e0a\u770b\u770b ARP \u7f13\u5b58\u8868\uff08<code>arp -a</code>\uff09\u5c31\u80fd\u53d1\u73b0\u4e24\u4e2a IP \u89e3\u6790\u51fa\u6765\u7684 MAC \u4e00\u6837\u4e86</p> <p>\u89e3\u51b3\u529e\u6cd5\u5c31\u662f\u8bbe\u7f6e Linux \u53c2\u6570\u8ba9\u5176\u53ea\u5728\u201c\u6b63\u786e\u7684\u201d\u754c\u9762\u4e0a\u54cd\u5e94\uff0c\u8be6\u7ec6\u89e3\u91ca\u53c2\u89c1 Server Fault \u4e0a\u7684\u8fd9\u4e2a\u56de\u7b54\u3002\u6211\u4eec\u7684\u505a\u6cd5\u662f\u5411 <code>/etc/sysctl.d/arp.conf</code> \u91cc\u5199\u5165\u4e86\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>net.ipv4.conf.all.arp_ignore=1\nnet.ipv4.conf.all.arp_announce=2\n</code></pre>"},{"location":"traps/#vxlan-mtu","title":"VXLAN MTU","text":"<p>\u8be5\u5751\u70b9\u5df2\u4e8e 2020 \u5e74 8 \u6708 1 \u65e5\u4fee\u590d</p> <p>\u5728\u6b64\u6b21\u7ef4\u62a4\u5de5\u4f5c\u4e2d\uff0c\u4e0b\u5c42\u627f\u8f7d\u7f51\u5361 ens1f1 \u7684 MTU \u5df2\u88ab\u8c03\u6574\u4e3a 1550 \u5b57\u8282\uff0c\u4ece\u800c\u6b64\u540e\u7684 VXLAN \u7f51\u7edc\u90fd\u5177\u6709\u201c\u6b63\u5e38\u201d\u7684 1500 \u5b57\u8282\u7684\u8bbe\u7f6e\u3002</p> <p>\u6ce8\u610f\u4ee5\u540e\u82e5\u6709\u65b0\u589e\u7684\u673a\u5668\u8fd8\u662f\u9700\u8981\u989d\u5916\u8bbe\u7f6e\u4e00\u904d\u7684\u3002</p> <p>VXLAN \u662f\u4e00\u79cd overlay \u7f51\u7edc\u5b9e\u73b0\uff0c\u5c06\u5e27\u5305\u88c5\u5728 UDP \u5305\u4e2d\u4f20\u8f93\u3002\u7531\u4e8e\u4e00\u4e2a UDP \u5305\u5bf9\u5e94\u4e00\u4e2a\u5e27\uff0c\u56e0\u6b64 VXLAN \u7f51\u7edc\u7684 MTU \u4e3a\u4e0b\u5c42\u627f\u8f7d\u7f51\u7684 MTU \u51cf\u6389 50 \u5b57\u8282\uff08\u5404\u79cd\u5934\u4e4b\u7c7b\u7684\uff09\uff0c\u6240\u4ee5\u5728\u4e0b\u5c42\u7f51\u7edc\u4f7f\u7528\u9ed8\u8ba4\u914d\u7f6e\uff08MTU 1500\uff09\u7684\u60c5\u51b5\u4e0b VXLAN \u7f51\u7edc\u7684 MTU \u4e3a 1450\uff0c\u8fd9\u662f\u4e00\u4e2a\u975e\u6807\u51c6\u7684\u503c\uff0c\u800c\u4ece\u8be5 VXLAN \u7f51\u7edc\u4e2d\u6865\u63a5\u51fa\u6765\u7684\u754c\u9762\u5e76\u4e0d\u77e5\u9053\u5176\u7f51\u7edc\u7684\u771f\u5b9e MTU \u5c0f\u4e8e 1500\uff0c\u7ed3\u679c\u5c31\u662f\u4f20\u8f93\u7684\u5185\u5bb9\u7a0d\u5fae\u591a\u4e00\u70b9\uff08\u5355\u4e2a\u5e27\u8d85\u8fc7 1450 \u5b57\u8282\uff09\u7684\u65f6\u5019\u5c31\u4f1a\u88ab\u6574\u4e2a\u4e22\u6389\uff0c\u9020\u6210\u65e0\u6cd5\u8054\u7f51\u7684\u60c5\u51b5\u3002</p> <p>\u89e3\u51b3\u65b9\u6cd5\u5012\u4e5f\u4e0d\u96be\uff0c\u5728\u7cfb\u7edf\u91cc\u8bbe\u7f6e\u7f51\u7edc\u7684 MTU \u4e3a 1450 \u5c31\u884c\u3002Proxmox VE \u521b\u5efa\u5bb9\u5668\u7684\u65f6\u5019\u53ef\u4ee5\u76f4\u63a5\u5728\u7f51\u7edc\u53c2\u6570\u4e2d\u6307\u5b9a <code>mtu=1450</code>\uff0c\u4f46 KVM \u865a\u62df\u673a\u5c31\u5fc5\u987b\u6bcf\u4e2a\u865a\u62df\u673a\u8bbe\u7f6e\u4e86\uff0c\u8fd9\u5728 Windows \u4e0b\u5c24\u5176\u9ebb\u70e6\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u8ba1\u5212\u5728 2020 \u5e74\u6691\u5047\u628a\u8fd9\u4e2a\u95ee\u9898\u5f7b\u5e95\u89e3\u51b3\uff0c\u529e\u6cd5\u662f\u628a\u4e0b\u5c42\u627f\u8f7d\u7f51\u7684 MTU \u8c03\u5927 50 \u5b57\u8282\uff08\u53d8\u6210 1550 \u5b57\u8282\uff0c\u4fee\u6539 pv1 \u5230 pv8 \u7684 ens1f1 \u754c\u9762\uff09\uff0c\u8fd9\u6837 VXLAN \u5c31\u80fd\u62e5\u6709\u201c\u6b63\u5e38\u201d\u7684 1500 \u5b57\u8282\u7684 MTU \u4e86\uff0c\u80fd\u4e3a\u4ee5\u540e\u51cf\u5c11\u4e0d\u5c11\u9ebb\u70e6\u3002</p>"},{"location":"traps/#vm","title":"\u865a\u62df\u673a","text":""},{"location":"traps/#systemd-logind-\u542f\u52a8\u5931\u8d25","title":"systemd-logind \u542f\u52a8\u5931\u8d25","text":"<p>\u5c24\u5176\u662f\u5728\u5bb9\u5668\u4ece Debian buster \u5347\u7ea7\u5230 bullseye \u540e\u5bb9\u6613\u51fa\u73b0\u3002</p> <p>\u75c7\u72b6\uff1a</p> <p>SSH \u767b\u5f55\u5df2\u8fde\u63a5\uff0c\u4f46\u957f\u65f6\u95f4\u4e0d\u5f39\u51fa shell\uff0c<code>/var/log/auth.log</code> \u663e\u793a <code>pam_systemd(sshd:session): Failed to create session: Failed to activate service 'org.freedesktop.login1': timed out</code>\uff0c<code>systemctl status systemd-logind</code> \u663e\u793a <code>failed</code> / <code>code=226/NAMESPACE</code>\u3002</p> <p>\u539f\u56e0\uff1a</p> <p>Systemd \u4ece\u7248\u672c 242 \u5f00\u59cb\u91c7\u7528\u66f4\u591a\u6280\u672f\u6765\u9650\u5236\u8fd0\u884c\u670d\u52a1\u7684\u6743\u9650\uff0c\u800c\u9ed8\u8ba4\u6ca1\u5f00 nesting \u7684\u5bb9\u5668\u7f3a\u5c11\u5fc5\u8981\u6743\u9650\uff0c\u5bfc\u81f4 systemd-logind \u65e0\u6cd5\u542f\u52a8\u3002</p> <p>\u89e3\u51b3\u65b9\u6cd5\uff1a</p> <p>\u4e3a\u5bb9\u5668\u5f00\u542f nesting\uff08\u548c keyctl\uff0c\u5982\u679c\u4f60\u60f3\u7684\u8bdd\uff09\u3002\u6211\u4eec\u5df2\u7ecf\u9ed8\u8ba4\u4e3a\u7528\u6237\u5bb9\u5668\u5f00\u542f\u4e86\u8fd9\u4e24\u9879\u6743\u9650\uff0c\u6240\u4ee5\u4e3a\u6211\u4eec\u81ea\u5df1\u7684\u670d\u52a1\u5bb9\u5668\u5f00\u542f\u5b83\u4eec\u4e0d\u4f1a\u6709\u989d\u5916\u7684\u95ee\u9898\u3002</p> <pre><code>pvesh set /nodes/&lt;node_name&gt;/lxc/&lt;vmid&gt;/config -features keyctl=1,nesting=1\n</code></pre> <p>\u53c2\u8003\u8d44\u6599\uff1ahttps://discuss.linuxcontainers.org/t/apparmor-blocks-systemd-services-in-container/9812</p>"},{"location":"traps/#user1000service-\u542f\u52a8\u5931\u8d25","title":"user@1000.service \u542f\u52a8\u5931\u8d25","text":"<p>\u68c0\u67e5\u73af\u5883\u53d8\u91cf <code>XDG_RUNTIME_DIR</code> \u662f\u5426\u8bbe\u7f6e\u6b63\u786e\uff0c\u5e94\u4e3a <code>/run/user/&lt;uid&gt;</code>\u3002</p> <p>\u53e6\u5916\u5728\u672a\u77e5\u60c5\u51b5\u4e0b\u8be5\u76ee\u5f55\u6709\u53ef\u80fd\u4e0d\u5b58\u5728\uff0c\u9700\u8981\u5148\u521b\u5efa\u4e00\u4e2a\uff08\u4fdd\u9669\u8d77\u89c1\uff0c\u540c\u65f6 chown \u4e00\u4e0b\uff09\uff1a</p> <pre><code>UID=\"$(id -u)\"\nmkdir -p \"/run/user/$UID\"\nchown \"$UID.$UID\" \"/run/user/$UID\"\n</code></pre> <p>Ref: https://github.com/systemd/systemd/issues/9461#issuecomment-409929860</p>"},{"location":"traps/#docker-in-lxc-\u542f\u52a8\u5931\u8d25","title":"Docker in LXC \u542f\u52a8\u5931\u8d25","text":"<p>\u75c7\u72b6\uff1a</p> <p>\u5c1d\u8bd5\u8fd0\u884c Docker \u5bb9\u5668\u65f6\u51fa\u73b0\u5982\u4e0b\u9519\u8bef\uff1a</p> <p>docker: Error response from daemon: OCI runtime create failed: container_linux.go:349: starting container process caused \"process_linux.go:449: container init caused \\\"join session keyring: create session key: disk quota exceeded\\\"\": unknown.</p> <p>\u89e3\u51b3\u65b9\u6cd5\uff1a</p> <p>\u53c2\u8003 https://github.com/docker/compose/issues/7295#issuecomment-657475590\u3002</p> <p>Docker \u9700\u8981\u83b7\u53d6\u5230 kernel session key \u624d\u80fd\u6b63\u5e38\u8fd0\u884c\u3002\u9996\u5148\u67e5\u770b <code>/proc/key-users</code> \u6587\u4ef6\uff0c\u5206\u6790\u9650\u989d\u5361\u5728\u4e86\u54ea\u91cc\u3002\u6587\u4ef6\u5185\u5bb9\u7c7b\u4f3c\u4e8e\uff1a</p> <pre><code>     0:   336 335/335 238/1000000 4597/25000000\n   100:     1 1/1 1/50000 9/20000\n   998:     1 1/1 1/50000 9/20000\n100000:  1198 1198/1198 1198/50000 19871/20000\n100101:     2 2/2 2/50000 18/20000\n</code></pre> <p>\u5176\u4e2d\uff1a</p> <ul> <li>\u7b2c\u4e00\u5217\uff1aUID\u3002</li> <li>\u7b2c\u4e8c\u5217\uff1a\u76ee\u524d\u5bf9\u5e94 UID \u7684 key \u6570\u91cf\u3002</li> <li>\u7b2c\u4e09\u5217\uff1a\u5b9e\u4f8b\u5316\u7684 key \u6570\u91cf\u548c\u603b key \u6570\u91cf\u3002\uff08\u5e94\u8be5\u53ef\u4ee5\u5ffd\u7565\uff09</li> <li>\u7b2c\u56db\u5217\uff1akey \u6570\u91cf\u4e0e\u603b key \u6570\u91cf\u9650\u989d\u3002\uff08\u5173\u6ce8\uff09</li> <li>\u7b2c\u4e94\u5217\uff1akey \u5927\u5c0f\u4e0e\u603b key \u5927\u5c0f\u9650\u989d\u3002\uff08\u5173\u6ce8\uff09</li> </ul> <p>\u6ce8\u610f\u6700\u540e\u4e24\u5217\u3002\u5982\u679c\u51fa\u73b0\u5f88\u8d34\u8fd1\u9650\u989d\u7684\u60c5\u51b5\uff0c\u9700\u8981\u8c03\u6574 <code>/proc/sys/kernel/keys/maxbytes</code> \u548c <code>/proc/sys/kernel/keys/maxkeys</code> \u7684\u503c\u3002root \u4e0b echo \u4e00\u4e2a\u66f4\u5927\u7684\u6570\u8fdb\u53bb\u5373\u53ef\u3002</p> <p><code>root_maxbytes</code> \u548c <code>root_maxkeys</code> \u4e00\u822c\u90fd\u975e\u5e38\u5927\uff08\u89c1 <code>key-users</code> \u7684\u7b2c\u4e00\u884c\uff09\uff0c\u53ef\u4ee5\u4e0d\u7528\u7ba1\u3002</p> <p>\u5982\u679c\u9700\u8981\u6301\u4e45\u5316\u914d\u7f6e\uff0c\u8bf7\u6dfb\u52a0 <code>/etc/sysctl.d/20-keys.conf</code>\uff0c\u5199\u5165\u4e0b\u9762\u7684\u5185\u5bb9\uff1a</p> <pre><code>kernel.keys.maxbytes = 500000\nkernel.keys.maxkeys = 5000\n</code></pre> <p>\u7136\u540e\u6267\u884c <code>sysctl --system</code>\u3002</p>"},{"location":"traps/#docker-in-lxc-\u542f\u52a8\u5931\u8d25-proxmox-ve-7","title":"Docker in LXC \u542f\u52a8\u5931\u8d25 (Proxmox VE 7)","text":"<p>\u4ece Proxmox VE 6 \u5347\u7ea7\u5230 Proxmox VE 7 \u540e\u914d\u7f6e\u4e86 <code>keyctl=1,nesting=1</code> \u7684\u5bb9\u5668\u65e0\u6cd5\u542f\u52a8 <code>docker.service</code>\uff0cjournalctl \u8f93\u51fa\u6709 <code>Devices cgroup isn't mounted</code>\u3002</p> <p>\u539f\u56e0\uff1aProxmox VE 7 \u9ed8\u8ba4\u5f00\u542f\u4e86 unified cgroup hierarchy\uff08\u5373 cgroup v2\uff09\uff0c\u800c\u65e7\u7248\u672c\u7684 Docker \u9700\u8981\u539f\u6765\u7684 cgroup v1 \u7ed3\u6784\u3002</p> <p>\u89e3\u51b3\u65b9\u6cd5\uff1a\u5728\u5185\u6838\u53c2\u6570\u4e2d\u52a0\u4e0a <code>systemd.unified_cgroup_hierarchy=0</code>\uff0c\u7136\u540e\u91cd\u542f\u4e3b\u673a\u3002\u5177\u4f53\u64cd\u4f5c\u662f\u5728 <code>/etc/default/grub</code> \u7684 <code>GRUB_CMDLINE_LINUX_DEFAULT</code> \u540e\u9762\u8865\u4e0a <code>systemd.unified_cgroup_hierarchy=0</code>\uff0c\u7136\u540e\u6267\u884c <code>update-grub</code> \u5e76\u91cd\u542f\u3002</p> <p>Note</p> <p>Docker Engine 20.10 \u5f00\u59cb\u652f\u6301 cgroup v2\uff0c\u4f46\u662f\u5230\u5168\u9762\u5e94\u7528\u8fd8\u6709\u70b9\u65e9\uff0c\u6240\u4ee5\u8fd9\u4e2a\u517c\u5bb9\u8bbe\u7f6e\u5148\u5f00\u7740\u3002</p>"},{"location":"traps/#systemd-\u670d\u52a1\u56e0\u7a7a\u95f4\u4e0d\u8db3\u542f\u52a8\u5931\u8d25","title":"Systemd \u670d\u52a1\u56e0\u300c\u7a7a\u95f4\u4e0d\u8db3\u300d\u542f\u52a8\u5931\u8d25\u3002","text":"<p>\u75c7\u72b6\uff1a\u91cd\u8981\u670d\u52a1\u65e0\u6cd5\u542f\u52a8\uff0c\u63d0\u793a <code>Failed to add /run/systemd/ask-password to directory watch: No space left on device</code>\uff0c\u4f46\u662f <code>df</code> \u663e\u793a\u5269\u4f59\u7a7a\u95f4\u8fd8\u6709\u5f88\u591a\u3002</p> <p>\u53ef\u80fd\u7684\u89e3\u51b3\u65b9\u6cd5\uff1a\u8bbe\u7f6e sysctl:</p> <pre><code>fs.inotify.max_user_watches = 1048576\n</code></pre> <p>\u56e0\u4e3a\u51fa\u95ee\u9898\u7684\u5bb9\u5668\u88ab\u540c\u5b66\u5220\u6389\u4e86\uff0c\u6240\u4ee5\u672a\u9a8c\u8bc1\u662f\u5426\u80fd\u591f\u89e3\u51b3\u95ee\u9898\u3002</p>"},{"location":"traps/#\u56fe\u5f62\u754c\u9762\u4e2d\u8fd0\u884c\u7684\u8fdb\u7a0b\u6570\u6700\u591a\u53ea\u80fd\u8dd1-4915-\u4e2a","title":"\u56fe\u5f62\u754c\u9762\u4e2d\u8fd0\u884c\u7684\u8fdb\u7a0b\u6570\u6700\u591a\u53ea\u80fd\u8dd1 4915 \u4e2a","text":"<p>\u6240\u6709\u56fe\u5f62\u754c\u9762\u8fdb\u7a0b cgroup \u90fd\u6302\u5728 lightdm.service \u7684\u9650\u5236\u4e0b\u9762\uff0c\u800c systemd \u9ed8\u8ba4\u914d\u7f6e\u9650\u989d\u4e3a 4915\u3002</p> <p>\u7b80\u5355\u5feb\u901f\u7684\u4fee\u6539\u547d\u4ee4\uff1a<code>systemctl set-property lightdm.service TasksMax=18000</code></p> <p>\u66f4\u8be6\u7ec6\u7684\u6307\u5bfc\u53c2\u89c1 https://www.suse.com/support/kb/doc/?id=000015901</p>"},{"location":"traps/#\u4f7f\u7528-ubuntu-cloud-image-\u955c\u50cf-import-\u7684\u865a\u62df\u673a\u542f\u52a8\u5361\u6b7b","title":"\u4f7f\u7528 Ubuntu cloud-image \u955c\u50cf import \u7684\u865a\u62df\u673a\u542f\u52a8\u5361\u6b7b","text":"<p>\u89e3\u51b3\u65b9\u6cd5\uff1a\u624b\u52a8\u6302\u8f7d\uff08<code>lvchange -ay \u78c1\u76d8\u540d</code>\uff09\uff0c\u4f7f\u7528 <code>fdisk -l</code> \u68c0\u67e5\u5206\u533a\u8868\u662f\u5426\u6709\u95ee\u9898\u3002\u5982\u679c\u6709\uff08\u63d0\u793a The primary GPT table is corrupt, but the backup appears OK, so that will be used\uff09\uff0c\u4f7f\u7528 <code>fdisk</code> \u6253\u5f00\uff0c\u518d\u6267\u884c <code>w</code> \u5229\u7528\u5907\u4efd\u5206\u533a\u8868\u5199\u5165\u4fee\u590d\u3002</p>"},{"location":"traps/#tcpdump-\u8fd0\u884c\u65e0\u8f93\u51fa","title":"<code>tcpdump</code> \u8fd0\u884c\u65e0\u8f93\u51fa","text":"<p>2021/12/19 \u51cc\u6668\u6709\u540c\u5b66\u53cd\u9988\u8be5\u95ee\u9898\uff0c\u7ecf\u68c0\u67e5\u95ee\u9898\u4e3a\u5bb9\u5668\u4e2d\u7684 apparmor \u89c4\u5219\u963b\u6b62\u4e86 <code>tcpdump</code> \u5411 <code>stdout</code>/<code>stderr</code> \u5bfc\u81f4\u7684\u3002\u7b80\u5355\u7684\u89e3\u51b3\u65b9\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>cd /etc/apparmor.d\nsudo mv usr.sbin.tcpdump disable/\nsudo apparmor_parser -R /etc/apparmor.d/disable/\n</code></pre> <p>\u4e4b\u540e\u9700\u8981\u4fee\u6539\u955c\u50cf\uff0c\u79fb\u9664 <code>usr.sbin.tcpdump</code> \u89c4\u5219\u3002</p>"},{"location":"traps/#\u5904\u7406-fork-bomb","title":"\u5904\u7406 fork bomb","text":"<ol> <li>\u627e\u5230\u95ee\u9898\u4e3b\u673a\uff0c\u4ece <code>/proc/&lt;\u5f88\u5927\u7684 PID&gt;/mounts</code> \u83b7\u5f97 VMID</li> <li><code>echo 1 &gt; /sys/fs/cgroup/lxc/&lt;VMID&gt;/cgroup.kill</code></li> <li>\u7b49\u4e00\u6bb5\u65f6\u95f4\uff0c\u8ba9 kernel \u6162\u6162\u6740\uff08<code>cgroup.kill</code> \u4f1a\u963b\u6b62 cgroup \u5185\u90e8\u8fdb\u7a0b\u521b\u5efa\u65b0\u8fdb\u7a0b\uff0c\u5e76\u4e14\u53d1\u9001 SIGKILL\uff09\u3002\u5982\u679c\u6709\u9700\u8981\uff0c\u5355\u72ec\u6dfb\u52a0\u66f4\u4e25\u683c\u7684\u9650\u989d\uff08\u5728\u6587\u4ef6 <code>/etc/pve/lxc/&lt;VMID&gt;.conf</code> \u6dfb\u52a0 <code>lxc.cgroup2.pids.max: 2000</code>\uff09</li> </ol>"},{"location":"traps/#web-\u53ca\u7528\u6237\u754c\u9762","title":"Web \u53ca\u7528\u6237\u754c\u9762","text":""},{"location":"traps/#\u521b\u5efa\u865a\u62df\u673a\u51fa\u73b0-connection-aborted-remotedisconnectedremote-end-closed-connection-without-response","title":"\u521b\u5efa\u865a\u62df\u673a\u51fa\u73b0 Connection aborted, RemoteDisconnected('Remote end closed connection without response')","text":"<p>\u67e5\u770b pv1 \u4e0a\u7684 <code>systemctl status pveproxy</code> \u53ef\u89c1\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>Oct 27 17:13:56 pv1 pveproxy[34382]: problem with client ::ffff:172.30.0.2; rsa_padding_check_pkcs1_type_1: invalid padding\n</code></pre> <p>\u89e3\u51b3\u65b9\u6cd5\uff1a\u76f4\u63a5 reload django \u5e94\u7528\u5373\u53ef\uff0c\u539f\u56e0\u53ca\u590d\u73b0\u65b9\u6cd5\u672a\u77e5\u3002</p>"},{"location":"traps/#hpe-\u670d\u52a1\u5668-ipmihpe-ilo","title":"HPE \u670d\u52a1\u5668 IPMI\uff08HPE iLO\uff09","text":"<p>HPE iLO \u56fa\u4ef6\u4e0b\u8f7d\uff08\u5b98\u65b9\u94fe\u63a5\uff0c\u514d\u767b\u5f55\uff09\uff1ahttps://pingtool.org/latest-hp-ilo-firmwares/</p> <p>P.S. \u5982\u679c\u94fe\u63a5\u6302\u4e86\uff0c\u8bf7\u5584\u7528\u5404\u79cd Internet Archive \u4ee5\u53ca Google Web Cache\u3002</p>"},{"location":"traps/#\u66f4\u65b0-ilo-\u56fa\u4ef6\u62a5\u9519-the-file-signature-is-invalid","title":"\u66f4\u65b0 iLO \u56fa\u4ef6\u62a5\u9519 The file signature is invalid.","text":"<p>\u66f4\u65b0 iLO \u56fa\u4ef6\u65f6\u62a5\u9519 The file signature is invalid. Make sure you are using a valid, signed flash file and try again.</p> <p>\u539f\u56e0\uff1a\u8de8\u7248\u672c\u7684 iLO \u56fa\u4ef6\u6709\u65f6\u5019\u9700\u8981\u5148\u66f4\u65b0\u5230\u67d0\u4e2a\u201c\u4e2d\u95f4\u7248\u672c\u201d\uff0c\u4f8b\u5982 iLO 5 1.40 \u4ee5\u524d\u7684\u7248\u672c\u4e0d\u80fd\u76f4\u63a5\u66f4\u65b0\u5230 2.10 \u4ee5\u540e\uff0c\u9700\u8981\u5148\u66f4\u65b0\u5230 1.40 \u624d\u80fd\u518d\u66f4\u65b0\u5230 2.10\u3002</p> <p>\u53c2\u8003\u8d44\u6599\uff1ahttps://community.hpe.com/t5/ProLiant-Servers-ML-DL-SL/ILO5-firware-update-fails-quot-the-file-siganture-is-invalid/td-p/7085862</p>"},{"location":"backup/","title":"\u5907\u4efd","text":"<p>\u6211\u4eec\u914d\u7f6e\u4e86\u4e00\u4e2a\u865a\u62df\u673a\uff08pbs\uff0cID \u4e3a 104\uff09\u5b89\u88c5 Proxmox Backup Server \u63d0\u4f9b\u865a\u62df\u673a\u7684\u5907\u4efd\u670d\u52a1\u3002</p> <p>\u76ee\u524d\u8be5\u865a\u62df\u673a\u8fd0\u884c\u5728 pv8 \u4e0a\uff0c\u4ece user-data \u5206\u914d\u4e86 16 GB \u7684 rootfs\uff08PBS \u4e0e PVE \u540c\u6837\u9ed8\u8ba4\u4f7f\u7528 LVM\uff09\u548c 128 GB \u7684\u6570\u636e\u76d8\uff0c\u6302\u5728 <code>/mnt/data</code> \u4e0b\uff0c\u5bf9\u5e94\u7684 Datastore \u540d\u79f0\u5c31\u53eb <code>data</code>\u3002</p> <p>\u7531\u4e8e PBS \u4e0d\u80fd\u52a0\u5165 PVE \u96c6\u7fa4\uff0c\u53ea\u80fd\u6dfb\u52a0\u4e3a\u4e00\u4e2a Storage location\uff0c\u81ea\u7136\u4e5f\u65e0\u6cd5\u4f7f\u7528 PVE \u7684\u8d26\u53f7\u7cfb\u7edf\u3002\u6211\u4eec\u76ee\u524d\u7684\u505a\u6cd5\u662f\u6bcf\u6b21\u9700\u8981\u767b\u5f55 web \u754c\u9762\u65f6\u5148 SSH \u4e0a\u53bb\u5c06 root \u5bc6\u7801\u6539\u6389\uff0c\u7136\u540e\u4f7f\u7528 root \u767b\u5f55\uff0c\u5728\u64cd\u4f5c\u5b8c\u6210\u540e\u518d <code>passwd -d root</code>\u3002</p>"},{"location":"history/gen1/","title":"Vlab \u7b2c\u4e00\u4ee3\u670d\u52a1\u5668","text":"<p>\u7b2c\u4e00\u4ee3 Vlab \u8fdc\u7a0b\u865a\u62df\u684c\u9762\u5e73\u53f0\u5728 2019 \u5e74 6 \u6708\u7531\u674e\u5b50\u5929\u5b66\u957f\u521d\u6b65\u914d\u7f6e\u597d\uff0c\u7ecf\u8fc7 @iBug \u548c @taoky \u7b49\u4eba\u8fdb\u4e00\u6b65\u8c03\u6574\u5e76\u7f16\u5199\u524d\u7aef\u7ba1\u7406\u7cfb\u7edf\u540e\uff0c\u4e8e 2019 \u5e74\u79cb\u5b63\u5b66\u671f\u5f00\u59cb\u5c0f\u8303\u56f4\u6d4b\u8bd5\uff08\u6b63\u5f0f\u4e0a\u7ebf\uff09\u3002</p>"},{"location":"history/gen1/#hardware","title":"\u786c\u4ef6","text":"<p>\u7b2c\u4e00\u4ee3 Vlab \u670d\u52a1\u5668\u5305\u542b\u53cc\u8def Intel Xeon E5-2630 v4 \u5904\u7406\u5668\uff08\u5171 20 \u6838\u5fc3\u300140 \u7ebf\u7a0b\uff09\uff0c\u5b89\u88c5\u5185\u5b58 128 GB\uff088 x 16 GB DDR4 2400 ECC\uff09\u3002\u786c\u76d8\u914d\u7f6e\u4e3a\u4e00\u5757 Intel Optane 905P 480GB\uff08\u7cfb\u7edf\u76d8\uff0cswap \u548c\u7f13\u5b58\uff09\u548c\u56db\u5757 HPE 2.4TB SAS \u786c\u76d8\u3002</p> <p>\u53e6\u5916\u8be5\u670d\u52a1\u5668\u4e0a\u8fd8\u6709\u4e00\u5757 NVIDIA Tesla P4 GPU\uff0c\u539f\u672c\u8ba1\u5212\u7528\u4e8e\u52a0\u901f\u6df1\u5ea6\u5b66\u4e60\u7b49\u8d1f\u8f7d\uff0c\u5b9e\u9645\u4e0a\u7531\u4e8e\u627f\u62c5\u7684\u8bfe\u7a0b\u5b9e\u9a8c\u4efb\u52a1\u7c7b\u578b\u4e0d\u540c\uff0c\u5e76\u672a\u6d3e\u4e0a\u7528\u573a\u3002</p>"},{"location":"history/gen1/#operating-system","title":"\u64cd\u4f5c\u7cfb\u7edf","text":"<p>\u642d\u5efa\u8fd9\u53f0\u670d\u52a1\u5668\u7684\u5b66\u957f\u9009\u62e9\u4e86 Ubuntu 18.04 LTS\uff0c\u4f46\u662f\u5c06\u5185\u6838\u66ff\u6362\u4e3a <code>3.10.0-514.61.1.el7.x86_64</code>\uff08\u6765\u81ea RHEL 7.3 EUS\uff09\uff0c\u539f\u56e0\u662f NVIDIA \u7684\u9a71\u52a8\uff08\u5185\u6838\u6a21\u5757\uff09\u9700\u8981\u7f16\u8bd1\uff0c\u800c\u4e14\u5bf9\u5185\u6838\u7248\u672c\u975e\u5e38\u654f\u611f\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u8fd9\u4e2a\u96be\u6574\u7684\u9a71\u52a8\u80fd\u6b63\u5e38\u4f7f\u7528\uff0c\u4e0d\u65b9\u4fbf\u5c06\u5185\u6838\u4ea4\u7531 apt \u7ba1\u7406\u5347\u7ea7\u3002</p>"},{"location":"history/gen1/#containerization","title":"\u865a\u62df\u5316","text":"<p>\u91c7\u7528 LXD \u5bb9\u5668\uff0c\u8fd0\u884c\u4e00\u4e2a\u5b9a\u5236\u7684\u955c\u50cf\uff08Ubuntu Minimal \u5b89\u88c5\u4e86 Xfce \u548c Xilinx Vivado\uff09\uff0c\u4e3a 2019 \u5e74\u79cb\u5b63\u5b66\u671f\u7684\u300a\u6570\u5b57\u7535\u8def\u5b9e\u9a8c\u300b\u8bfe\u7a0b\u63d0\u4f9b\u670d\u52a1\u3002</p>"},{"location":"history/gen1/#storage","title":"\u5b58\u50a8","text":"<p>\u6700\u5f00\u59cb\uff082019 \u5e74\u6691\u5047\u671f\u95f4\uff09\u6ca1\u6709\u4efb\u4f55\u7279\u522b\u7684\u5b58\u50a8\u67b6\u6784\uff0c\u76f4\u63a5\u7528\u7684 LXD \u7684 Directory\uff08\u4e5f\u5c31\u662f\u7eaf\u76ee\u5f55\uff09\u5b58\u50a8\uff0c\u540e\u6765\u5728\u6b63\u5f0f\u4e0a\u7ebf\u524d\u7531 iBug \u66ff\u6362\u6210\u4e86 ZFS\uff0c\u5e76\u4e00\u76f4\u8fd0\u884c\u4e0b\u53bb\u3002</p>"},{"location":"history/gen1/#follow-ups","title":"\u540e\u7eed","text":"<p>\u8fd9\u53f0\u673a\u5668\u5728 2020 \u5e74 3 \u6708\u5e95\u88ab\u91cd\u88c5\u4e3a Proxmox VE \u7cfb\u7edf\uff0c\u5185\u5b58\u7531 128 GB \u5347\u7ea7\u5230 160 GB\uff0c\u91cd\u65b0\u6307\u6d3e hostname \u4e3a pv0\uff0c\u8ba1\u5212\u662f\u63d0\u4f9b GPU \u5bb9\u5668\u670d\u52a1\uff0c\uff0c\u4e0d\u8fc7\u540e\u6765\u53d1\u73b0\u7b2c\u4e8c\u4ee3\u7684\u673a\u5668\u65e0\u6cd5\u52a0\u88c5 GPU \u4e4b\u540e\u5c31\u6539\u4e3a\u7528\u4f5c\u6211\u4eec\u7684\u5f00\u53d1\u6d4b\u8bd5\u73af\u5883\u4e86\uff0c\u4e0d\u63d0\u4f9b\u4efb\u4f55\u6b63\u5f0f\u670d\u52a1\uff08\u4e5f\u6ca1\u6709\u63a5\u5165\u5149\u7ea4\u5185\u7f51\uff09\u3002</p>"},{"location":"kvm/cloud-init/","title":"\u865a\u62df\u673a cloud-init \u914d\u7f6e\u548c\u4f7f\u7528","text":""},{"location":"kvm/cloud-init/#\u914d\u7f6e\u5e26\u6709-cloud-init-\u7684\u955c\u50cf","title":"\u914d\u7f6e\u5e26\u6709 cloud-init \u7684\u955c\u50cf","text":""},{"location":"kvm/cloud-init/#\u521b\u5efa\u865a\u62df\u673a\u5e76\u5b89\u88c5-cloud-init","title":"\u521b\u5efa\u865a\u62df\u673a\uff0c\u5e76\u5b89\u88c5 cloud-init","text":"<p>\u4ece\u672c\u5730\u9009\u62e9 iso \u521b\u5efa\u865a\u62df\u673a\uff0c\u88c5\u597d\u7cfb\u7edf\u540e\u8fdb\u5165\u865a\u62df\u673a\uff0c\u5b89\u88c5 cloud-init\u3002\u5982\u679c\u5728\u88c5\u7cfb\u7edf\u65f6\u6ca1\u6709\u6362\u6e90\uff0c\u5c31\u5148\u6362\u6e90\u3002</p> <pre><code>sudo apt install cloud-init  # Ubuntu\nsudo yum install cloud-init  # CentOS\n</code></pre> <p>cloud-init \u7684\u914d\u7f6e\u4fe1\u606f\u5728\u6587\u4ef6 <code>/etc/cloud/cloud.cfg.d/*.cfg</code> \u548c <code>/etc/cloud/cloud.cfg</code> \u4e2d\u3002cloud-init \u4ee5\u5b57\u6bcd\u987a\u5e8f\u8bfb\u53d6\u6240\u6709\u7684 <code>*.cfg</code> \u6587\u4ef6\uff0c\u76f8\u540c\u53c2\u6570\u540e\u9762\u7684\u6587\u4ef6\u4f1a\u8986\u76d6\u524d\u9762\u7684\u6587\u4ef6\u3002</p> <p>\u5728 cloud.cfg \u6587\u4ef6\u4e2d\uff0c\u4efb\u52a1\u4ee5 module \u5f62\u5f0f\u7ec4\u7ec7. \u4f8b\u5982\u6307\u5b9a <code>set_hostname</code> \u7684 moudle \u65f6\uff0ccloud-init \u4f1a\u6267\u884c hostname \u4efb\u52a1\uff0c\u5177\u4f53\u7684\u914d\u7f6e\u53c2\u6570\u7531 metadata \u6307\u5b9a\u3002</p> <p>\u6211\u4eec\u9700\u8981\u5728\u6b64\u6587\u4ef6\u4e2d\u5220\u9664\u4e0d\u9700\u8981\u7684\u6a21\u5757, \u4f8b\u5982 <code>disable-ec2-metadata</code> \u548c <code>byobu</code> \u7b49\u3002 </p> <pre><code>cloud_config_modules:\n- snap\n- snap_config\n- ubuntu-advantage\n- disable-ec2-metadata\n- byobu\n\ncloud_final_modules:\n- snappy\n- fan\n- landscape\n- lxd\n- puppet\n- chef\n- mcollective\n- salt-minion\n- rightscale_userdata\n</code></pre> <p>cloud-init \u7684\u6570\u636e\u6587\u4ef6\u653e\u5728 <code>/var/lib/cloud/data</code> \u4e2d\uff0c \u65e5\u5fd7\u6587\u4ef6\u653e\u5728 <code>/var/log/cloud-init-output.log</code> (\u6bcf\u9636\u6bb5\u8f93\u51fa)\uff0c <code>/var/log/cloud-init.log</code> (\u6bcf\u4e00\u4e2a\u64cd\u4f5c\u66f4\u8be6\u7ec6\u7684\u8c03\u8bd5\u65e5\u5fd7)\uff0c <code>/run/cloud-init</code> \u51b3\u5b9a\u5f00\u542f\u548c\u5173\u95ed\u81ea\u8eab\u7684\u67d0\u4e9b\u529f\u80fd\u3002</p>"},{"location":"kvm/cloud-init/#\u89e3\u51b3\u4ece\u540c\u4e00\u6a21\u677f\u4e2d\u521b\u5efa\u7684\u865a\u62df\u673a\u6709\u76f8\u540c\u7684-machine-id-\u95ee\u9898","title":"\u89e3\u51b3\u4ece\u540c\u4e00\u6a21\u677f\u4e2d\u521b\u5efa\u7684\u865a\u62df\u673a\u6709\u76f8\u540c\u7684 machine-id \u95ee\u9898","text":""},{"location":"kvm/cloud-init/#\u65b9\u6cd5-1","title":"\u65b9\u6cd5 1","text":"<p>Proxmox \u4f1a\u5bf9\u521b\u5efa\u7684\u65b0\u865a\u62df\u673a\u81ea\u52a8\u5206\u914d\u4e0d\u540c\u7684 MAC \u5730\u5740\u3002</p> <p>\u4f46\u662f\u5bf9\u4e8e Ubuntu\uff0c\u4ece\u7edf\u4e00\u6a21\u677f\u4e2d\u521b\u5efa\u7684\u865a\u62df\u673a\u6709\u548c\u6a21\u677f\u76f8\u540c\u7684 machine-id\uff0c\u865a\u62df\u673a\u4f7f\u7528\u6b64 machine-id \u6765\u83b7\u53d6 DHCP \u7684 lease\uff0c\u4ece\u5bfc\u81f4\u591a\u4e2a\u865a\u62df\u673a\u7ade\u4e89\u540c\u4e00\u4e2a IP \u5730\u5740\u3002</p> <p>\u89e3\u51b3\u6b64\u95ee\u9898\u7684\u65b9\u6cd5\u662f\u6587\u4ef6 <code>/etc/machine-id</code> \u5220\u9664\uff0c\u91cd\u65b0\u521b\u5efa\u4e00\u4e2a\u540c\u540d\u7a7a\u767d\u6587\u4ef6</p> <pre><code>sudo rm /etc/machine-id\nsudo touch /etc/machine-id\n</code></pre> <p>\u4e4b\u540e\uff0c\u8f6c\u5230\u6587\u4ef6 <code>/var/lib/dbus/machine-id</code>\uff0c\u6b64\u6587\u4ef6\u4f1a\u5728\u6bcf\u6b21\u865a\u62df\u673a\u91cd\u542f\u4e4b\u540e\u5c06 machine-id \u590d\u5236\u5230 <code>/etc/machine-id</code> \u4e2d\u3002 \u6240\u4ee5\u5c06\u6b64\u6587\u4ef6\u5220\u9664\uff0c\u521b\u5efa\u4e00\u4e2a <code>/etc/machine-id</code> \u7684\u7b26\u53f7\u94fe\u63a5\u5230\u6b64\u5904\u3002</p> <pre><code>sudo rm /var/lib/dbus/machine-id\nsudo ln -s /etc/machine-id /var/lib/dbus/machine-id\n</code></pre> <p>\u7136\u540e\u5c06\u6b64\u865a\u62df\u673a\u5173\u673a\uff08\u4e0d\u662f\u91cd\u542f\uff0c\u5426\u5219\u4f1a\u751f\u6210\u65b0\u7684 machine-id\uff09\uff0c\u5236\u4f5c\u4e3a\u6a21\u677f\u3002</p>"},{"location":"kvm/cloud-init/#\u65b9\u6cd5-2","title":"\u65b9\u6cd5 2","text":"<p>\u4fee\u6539 DHCP \u7684 identifier\uff0c<code>/etc/netplan/</code> \u4e0b\u6587\u4ef6\uff0c\u5728 network \u4e0b\u7684 ethernets \u4e0b\u7684\u6761\u76ee\u589e\u52a0 <code>dhcp-identifier: mac</code>\uff0c\u5373\u53ef\u4f7f\u7528 MAC \u4f5c\u4e3a DHCP \u5206\u914d IP \u7684\u552f\u4e00\u6807\u5fd7\u3002 \u4f46 SSH \u4e5f\u4f7f\u7528 machine-id\uff0c\u6240\u4ee5\u6b64\u65b9\u6cd5\u53ea\u89e3\u51b3\u4e86 ip \u7684\u95ee\u9898\u3002</p>"},{"location":"kvm/cloud-init/#\u5b89\u88c5\u5fc5\u8981\u8f6f\u4ef6\u5305","title":"\u5b89\u88c5\u5fc5\u8981\u8f6f\u4ef6\u5305","text":"<p>\u5b89\u88c5 net-tools, openssh-server \u7b49\u5de5\u5177</p>"},{"location":"kvm/cloud-init/#\u8bbe\u7f6e-username-\u548c-password-\u5931\u8d25\u65e0\u6cd5\u4f7f\u7528\u5728-proxmox-web-\u9875\u9762\u4e0a\u8bbe\u7f6e\u7684-username-\u548c-password-\u767b\u5f55\u865a\u62df\u673a","title":"\u8bbe\u7f6e username \u548c password (\u5931\u8d25\uff0c\u65e0\u6cd5\u4f7f\u7528\u5728 proxmox web \u9875\u9762\u4e0a\u8bbe\u7f6e\u7684 username \u548c password \u767b\u5f55\u865a\u62df\u673a)","text":"<p>\u5b8c\u6210\u4e0a\u9762\u7684\u5de5\u4f5c\u540e\u5c06\u865a\u62df\u673a\u5173\u673a\uff0c\u5728 proxmox web \u754c\u9762 hardware \u680f\u4e2d add cloudinit Drive\uff0c\u7136\u540e\u5728 Cloud-init \u680f\u4e2d\u8bbe\u7f6e\u7528\u6237\u540d\u548c\u5bc6\u7801\uff08\u5fc5\u987b\u8bbe\u7f6e\uff0c\u5426\u5219\u65e0\u6cd5\u8fdb\u5165\u7531\u6b64\u6a21\u677f\u521b\u5efa\u7684\u865a\u62df\u673a\uff09\u3002</p>"},{"location":"kvm/cloud-init/#cloud-init-\u7b80\u4ecb\u548c\u914d\u7f6e\u89e3\u91ca","title":"cloud-init \u7b80\u4ecb\u548c\u914d\u7f6e\u89e3\u91ca","text":""},{"location":"kvm/cloud-init/#\u9636\u6bb5","title":"\u9636\u6bb5","text":"<p>cloud-init.cfg \u6587\u4ef6\u4e2d\u6709\u4e94\u4e2a stage\uff0ccloud-init \u5206\u4e3a\u4e94\u4e2a\u9636\u6bb5\u8fdb\u884c\uff0c\u5177\u4f53\u4ee5\u670d\u52a1\u7684\u5f62\u5f0f\u6ce8\u518c\u5230\u7cfb\u7edf\u4e2d\u6309\u5982\u4e0b\u6b21\u5e8f\u6267\u884c\uff1a</p> <ol> <li> <p>generator</p> <p>\u6b64\u9636\u6bb5\u68c0\u6d4b ci \u662f\u5426\u88ab\u7981\u7528</p> </li> <li> <p>local:cloud-init-local.service </p> <p>\u5f53/\u6302\u8f7d\u65f6\u6267\u884c\uff0c\u6b64\u9636\u6bb5\u7684\u4efb\u52a1\u4e3b\u8981\u662f\u5b9a\u4f4d\u672c\u5730\u6570\u636e\uff0c\u5c06\u7f51\u7edc\u914d\u7f6e\u5e94\u7528\u5230\u672c\u5730\u3002</p> <p>\u9700\u8981\u5c06\u7f51\u7edc block</p> <p>\u6b64\u9636\u6bb5\u6ca1\u6709\u7528\u5230\u7684\u6a21\u5757</p> </li> <li> <p>network:cloud-init.service</p> <p>\u5904\u7406\u6240\u6709\u7684 user-data, \u5305\u62ec\u4efb\u4f55 <code>#include</code> or <code>#include-once</code>, \u89e3\u538b\u7f29\u6240\u6709\u538b\u7f29\u6587\u4ef6, \u8fd0\u884c\u6240\u6709\u7684 <code>part-handler</code></p> </li> <li> <p>config:cloud.config.service</p> <p>\u6b64\u9636\u6bb5\u4ec5\u8fd0\u884c config module, \u5176\u4ed6\u9636\u6bb5\u4e0d\u8d77\u4f5c\u7528\u7684\u6a21\u5757\u90fd\u5728\u8fd9\u4e2a\u9636\u6bb5\u8fd0\u884c</p> </li> <li> <p>final:cloud-final.service</p> <p>\u6b64\u9636\u6bb5\u8fd0\u884c\u7528\u6237\u81ea\u5b9a\u4e49\u7684\u9700\u8981\u5728\u767b\u5f55\u7cfb\u7edf\u540e\u6267\u884c\u7684\u811a\u672c\u5728\u6b64\u5904\u8fd0\u884c\u3002</p> </li> </ol> <p>\u6bcf\u4e2a\u9636\u6bb5\u4e2d\u6267\u884c\u7684\u4efb\u52a1\u4ee5\u6a21\u5757\u7684\u5f62\u5f0f\u5b9a\u4e49, \u6a21\u5757\u6267\u884c\u7684\u5177\u4f53\u4efb\u52a1\u7531 metadata \u51b3\u5b9a</p>"},{"location":"kvm/cloud-init/#user-data","title":"User-Data","text":"<p>cloud-init \u901a\u8fc7\u547d\u4ee4\u884c <code>--cicustom</code> \u5c06\u7528\u6237\u81ea\u5b9a\u4e49\u7684 config \u6587\u4ef6\u8fdb\u884c\u914d\u7f6e </p> <pre><code># Syntax\nqm set &lt;vid&gt; --cicustom \"user=&lt;volume&gt;, network=&lt;volume&gt;, meta=&lt;volume&gt;\" # Example\nqm set 9000 --cicustom \"user=local:snippets/userconfig.yaml\" </code></pre> <p>cicustom \u6587\u4ef6\u9700\u8981\u5728\u652f\u6301 snippets \u5e76\u4e14\u6240\u6709\u7684 VM \u90fd\u80fd access \u7684\u8282\u70b9\u4e0a\u3002</p> <p>\u521b\u5efa\u4e00\u4e2a snippets: \u5728 proxmox \u7684 web \u754c\u9762\u4e0a\u7684 datacenter \u4e2d\u70b9\u51fb\u5b58\u50a8 - add-directory, \u8bbe\u7f6e id, \u9009\u62e9\u76ee\u5f55 content \u9009\u62e9 snippets, node \u9009 ALL (No restrictions)\u3002</p>"},{"location":"kvm/cloud-init/#\u5173\u4e8e-volumes","title":"\u5173\u4e8e volumes","text":"<p>local \u9ed8\u8ba4\u4f4d\u7f6e\u4e3a <code>/var/lib/vz</code>\uff08\u5b9a\u4e49\u5728\u914d\u7f6e\u6587\u4ef6 <code>/etc/pve/storage.cfg</code> \u4e2d\uff09</p> <p>cloudinit \u65e5\u5fd7\u6587\u4ef6\u5728 <code>/var/log/cloud-init-ouput.log</code> \u4e2d </p>"},{"location":"kvm/cloud-init/#user-data-\u683c\u5f0f","title":"User-Data \u683c\u5f0f","text":""},{"location":"kvm/cloud-init/#user-data-script","title":"User-Data Script","text":"<p>\u901a\u5e38\u7528\u4e8e\u4ec5\u9700\u8981\u6267\u884c\u4e00\u4e2a shell \u811a\u672c\u7684\u65f6\u5019 </p> <p>\u683c\u5f0f\uff1a\u4ee5 <code>#!</code> \u5f00\u59cb\u6216\u8005\u5f53\u4f7f\u7528 MIME \u5f52\u6863\u65f6\u4ee5 <code>Content-Type: text/x-shellscript</code> \u5f00\u59cb</p> <p>\u793a\u4f8b</p> <pre><code>#!/bin/sh\necho \"Hello World. The time is now $(date -R)!\" | tee /root/output.txt\n</code></pre> <p>\u5728\u865a\u62df\u673a\u7684 <code>/var/lib/cloud/scripts</code> \u76ee\u5f55\u4e0b\u5b58\u653e\u8981\u6267\u884c\u7684\u811a\u672c\u6587\u4ef6\u3002</p>"},{"location":"kvm/cloud-init/#cloud-config-data","title":"Cloud Config Data","text":"<p>\u5fc5\u987b\u662f\u5408\u6cd5\u7684 yaml \u683c\u5f0f</p> <p>local \u76ee\u5f55\u5728 <code>/var/lib/vz</code> \u4e0b\uff08\u5728 <code>/etc/pve/storage.cfg</code> \u4e2d\u914d\u7f6e\uff09</p> <p>\u683c\u5f0f: \u4ee5 <code>#cloud-config</code> \u5f00\u59cb\u6216\u8005\u5f53\u4f7f\u7528 MIME \u65f6\u4ee5 <code>Content-Type: text/cloud-config</code> \u5f00\u59cb</p> <p>\u5404 module \u5bf9\u5e94\u4e0b config data \u683c\u5f0f\u53ca\u529f\u80fd\u8bf4\u660e\uff1ahttps://cloudinit.readthedocs.io/en/latest/topics/modules.html</p> <p>\u793a\u4f8b</p> <pre><code>bootcmd:\n- echo 192.168.1.130 us.archive.com &gt; /etc/hosts\n- [ cloud-init-per, one, mymkfs, mkfs, /dev/vdb ]\n</code></pre>"},{"location":"kvm/cloud-init/#config-\u793a\u4f8b","title":"config \u793a\u4f8b:","text":"<p>\u914d\u7f6e\u5b9e\u4f8b\u7684 SSH key\uff1ahttps://cloudinit.readthedocs.io/en/latest/topics/modules.html#ssh</p> <p>\u6269\u5bb9\uff1ahttps://cloudinit.readthedocs.io/en/latest/topics/modules.html#growpart</p>"},{"location":"kvm/cloud-init/#kernel-command-line","title":"Kernel Command Line","text":"<p>\u4f7f\u7528 NoCloud \u65f6\uff0c\u7528\u6237\u53ef\u4ee5\u5c06\u7528\u6237\u6570\u636e\u901a\u8fc7\u5185\u6838\u547d\u4ee4\u884c\u53c2\u6570\u4f20\u9012\u3002</p>"},{"location":"kvm/cloud-init/#\u5176\u4ed6","title":"\u5176\u4ed6","text":"<p>\u5176\u4ed6\u683c\u5f0f\u8fd8\u6709 include, upstart job, cloud boothook, part handler \u7b49</p> <p>ci \u6709\u4e00\u4e2a\u811a\u672c <code>make-mime.py</code> \u53ef\u4ee5\u5c06\u4e0d\u540c\u7c7b\u578b\u7684\u7528\u6237\u6570\u636e\u7efc\u5408\u5728\u4e00\u8d77\uff0c\u4f8b\u5982\u5c06 cloud-config \u7c7b\u578b\u7684 config.yaml \u548c x-shellscript \u7c7b\u578b\u7684 script.sh \u7ec4\u5408\u5728\u4e00\u8d77\u5f62\u6210 user-data \u6570\u636e:</p> <pre><code>./tools/make-mime.py -a config.yaml:cloud-config -a script.sh:x-shellscript &gt; user-data\n</code></pre>"},{"location":"kvm/cloud-init/#\u90e8\u7f72","title":"\u90e8\u7f72","text":""},{"location":"kvm/cloud-init/#\u90e8\u7f72\u6587\u4ef6\u5f62\u5f0f","title":"\u90e8\u7f72\u6587\u4ef6\u5f62\u5f0f","text":"<ul> <li>\u901a\u8fc7 .cfg \u6587\u4ef6:</li> </ul> <p>\u5728\u865a\u62df\u673a <code>/etc/cloud/cloud.cfg.d/</code> \u4e0b\u6709\u591a\u4e2a <code>.cfg</code> \u7ed3\u5c3e\u7684\u6587\u4ef6\uff0c\u8fd9\u4e9b ci \u914d\u7f6e\u6587\u4ef6\u5c06\u6309\u7167\u5b57\u6bcd\u987a\u5e8f\u6267\u884c\uff0c\u540e\u9762\u7684 cfg \u6587\u4ef6\u4f1a\u8986\u76d6\u524d\u9762\u7684 cfg \u6587\u4ef6\u4e2d\u76f8\u540c\u7684\u914d\u7f6e\u3002</p> <p>\u901a\u8fc7\u6d4b\u8bd5\uff0c\u65b0\u5efa\u4e00\u4e2a cfg \u6587\u4ef6\uff0c\u4f7f\u7528\u6a21\u5757 bootcmd\uff0c\u5728\u6b64\u6a21\u5757\u4e0b\u7f16\u5199\u7684\u811a\u672c\u7a0b\u5e8f\u5c06\u4f1a\u88ab\u6267\u884c\uff0c\u4f8b\u5982\u65b0\u5efa\u6587\u4ef6 <code>/etc/cloud/cloud.cfg.d/test.cfg</code>\uff0c\u5199\u5165\u5185\u5bb9</p> <p><pre><code>bootcmd:\n- [ sh, -xc, \"echo 'hello world' &gt;&gt; testfile\" ]\n</code></pre>    \u5c31\u5c06\u4f1a\u5728\u5f53\u524d .cfg \u6587\u4ef6\u76ee\u5f55\u4e0b\u5efa\u7acb\u4e00\u4e2a\u5185\u5bb9\u4e3a \"hello world\" \u7684\u540d\u4e3a testfile \u7684\u6587\u4ef6\u3002</p> <p>\u865a\u62df\u673a\u6bcf\u6b21\u542f\u52a8\u90fd\u4f1a\u6267\u884c bootcmd \u5176\u540e\u7684\u547d\u4ee4\uff0c\u901a\u8fc7\u5c06\u914d\u7f6e\u8fc7\u7a0b\u5199\u6210\u811a\u672c\u7684\u5f62\u5f0f\u518d\u4f5c\u4e3a bootcmd \u7684\u53c2\u6570\u5199\u5165 .cfg \u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u865a\u62df\u673a\u4fbf\u80fd\u591f\u5b8c\u6210\u914d\u7f6e\u4efb\u52a1\u3002</p> <p>\u6b64\u5916\uff0cbootcmd \u662f\u6bcf\u6b21\u865a\u62df\u673a\u542f\u52a8\u90fd\u4f1a\u6267\u884c\uff0c\u5982\u679c\u9700\u8981\u865a\u62df\u673a\u53ea\u6267\u884c\u4e00\u6b21\u547d\u4ee4\uff0c\u53ef\u4ee5\u4f7f\u7528 runcmd \u9009\u9879\u3002</p> <ul> <li>\u901a\u8fc7 userdata script \u6587\u4ef6:</li> </ul> <p>\u6b64\u5916\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5c06\u914d\u7f6e\u8fc7\u7a0b\u4ee5\u811a\u672c\u7684\u5f62\u5f0f\u5448\u73b0\uff0c\u5c06\u5176\u5b58\u50a8\u5728 <code>/var/lib/cloud/scripts/</code> \u4e0b\uff0c\u865a\u62df\u673a\u6bcf\u6b21\u542f\u52a8\u90fd\u4f1a\u6267\u884c\u6b64\u811a\u672c\u4e2d\u7684\u547d\u4ee4\u3002</p>"},{"location":"kvm/cloud-init/#\u90e8\u7f72\u65b9\u5f0f","title":"\u90e8\u7f72\u65b9\u5f0f","text":"<ol> <li> <p>\u865a\u62df\u673a\u672c\u5730</p> <p>\u5c06 <code>.cfg</code> \u548c <code>script</code> \u6587\u4ef6\u5b58\u50a8\u5728\u76f8\u5e94\u76ee\u5f55\u4e0b\uff0c\u7531\u865a\u62df\u673a\u5728\u542f\u52a8\u7684\u65f6\u5019\u8bfb\u53d6\u5e76\u6267\u884c\u914d\u7f6e\u8fc7\u7a0b</p> </li> <li> <p>qm \u547d\u4ee4\u4ece\u6570\u636e\u4e2d\u5fc3\u7684\u547d\u4ee4\u884c\uff08\u672a\u5b9e\u73b0\uff09</p> <p>\u4ece\u6570\u636e\u4e2d\u5fc3\u7684\u7ec8\u7aef\u4e0a\u6267\u884c\u547d\u4ee4\u8fdb\u884c\u90e8\u7f72</p> <pre><code># \u683c\u5f0f\nqm set &lt;vmid&gt; --cicustom \"user=&lt;volume&gt;\"\n\n# \u793a\u4f8b\nqm set 101 --cicustom \"user=local:snippets/userconfig.yaml\"\n</code></pre> </li> </ol>"},{"location":"kvm/cloud-init/#\u5176\u4ed6\u95ee\u9898","title":"\u5176\u4ed6\u95ee\u9898","text":"<p>\u4fee\u590d\u62a5\u9519:</p> <ol> <li> <p>\u9519\u8bef\u8868\u73b0\u5982\u4e0b</p> <pre><code>perl: warning: Setting locale failed.\nperl: warning: Please check that your locale settings:\n   LANGUAGE = (unset),\n   LC_ALL = (unset),\n   LC_ADDRESS = \"zh_CN.UTF-8\",\n   .....\n   are supported and installed on your system.\nperl: warning: Falling back to a fallback locale (\"en_US.UTF-8\").\n</code></pre> <p>\u89e3\u51b3\u65b9\u6cd5\uff1a\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf <code>LC_ALL=C</code> \u6216 <code>LC_ALL=C.UTF-8</code></p> </li> </ol>"},{"location":"networking/","title":"\u7f51\u7edc\u914d\u7f6e","text":"<p>\u4e0e\u672c\u4ee3 Vlab \u96c6\u7fa4\u76f8\u5173\u7684\u7f51\u7edc\u6709\u4e09\u4e2a\uff0c\u4e0b\u9762\u5206\u522b\u4ecb\u7ecd\u3002</p>"},{"location":"networking/#ustcnet","title":"\u6821\u56ed\u7f51","text":"<p>\u6240\u6709\u673a\u5668\u90fd\u5728\u7535\u4e09\u697c 524 \u673a\u623f\uff0c\u901a\u8fc7\u94dc\u7ebf\u76f4\u63a5\u63a5\u5165\u7535\u4e09\u697c\u7684 VLAN\uff0c\u8be5 VLAN \u6709\u4e09\u4e2a\u516c\u7f51 IP \u5730\u5740\u6bb5 202.38.75.254/24, 202.38.79.254/24, 202.38.86.254/24\uff0c\u53e6\u6709\u4e00\u4e2a\u4ec5\u6821\u56ed\u7f51\u7684\u5730\u5740\u6bb5 10.38.79.254/24\uff0c\u76ee\u524d\u90e8\u7f72\u4e86\u6240\u6709\u4e3b\u673a\u7684 IPMI \u754c\u9762\u3002</p> <p>\u9664 pv8 \u5916\u6240\u6709\u673a\u5668\u7684\u56db\u4e2a\u7f51\u53e3\u505a\u4e00\u4e2a bond\uff0c\u7136\u540e\u5c06\u8fd9\u4e2a bond \u6865\u63a5\uff0c\u7cfb\u7edf\u4e2d\u663e\u793a\u7684\u754c\u9762\u540d\u79f0\u4e3a <code>vmbr0</code>\u3002\u65b9\u4fbf\u8d77\u89c1\u6240\u6709\u4e3b\u673a\u7684\u6821\u56ed\u7f51 IP \u90fd\u4ece 202.38.75.0/24 \u7f51\u6bb5\u4e2d\u53d6\uff0c\u8bb0\u5f55\u5728\u57df\u540d <code>pv#.vlab.ibugone.net</code> \u4e2d\u3002</p> <p>pv8 \u7684 eno4 \u63a5\u5728\u5149\u4ea4\u6362\u673a\u7684\u7ba1\u7406\u7aef\u53e3\u4e0a\uff0c\u56e0\u6b64 pv8 \u53ea\u6709\u4e09\u4e2a\u7f51\u53e3\u505a bond\u3002</p>"},{"location":"networking/#fibre-intranet","title":"\u5149\u7ea4\u5185\u7f51","text":"<p>\u5149\u7ea4\u754c\u9762\u4e3a <code>ens1f0</code> \u548c <code>ens1f1</code>\uff08\u4e24\u53f0 GPU \u670d\u52a1\u5668\u4e3a <code>ens4f0</code> \u548c <code>ens4f1</code>\uff09\uff0c\u901a\u8fc7\u4e00\u4e2a\u534e\u4e3a\u5149\u4ea4\u6362\u673a\u4e92\u8054\uff0c\u56e0\u6b64\u53ea\u6709\u670d\u52a1\u5668\u96c6\u7fa4\u5185\u90e8\u8fde\u901a\uff0c\u7531\u4e8e\u6bcf\u53f0\u8ba1\u7b97\u670d\u52a1\u5668\u5404\u81ea\u63a5\u5165\u6821\u56ed\u7f51\uff0c\u6240\u4ee5\u5149\u7ea4\u5185\u7f51\u53ea\u7528\u4e8e\u4e92\u8054\uff08\u5305\u62ec\u8fde\u63a5 iSCSI\uff09\uff0c\u4e0d\u7528\u4e8e\u8f6c\u53d1\u3002</p> <p>IP \u5206\u914d\u60c5\u51b5\u89c1 IP \u5730\u5740\u5217\u8868\u3002</p> <p>\u8fd0\u884c\u5728\u8fd9\u4e2a\u7f51\u7edc\u4e0a\u7684\u8bbe\u65bd\u6709 iSCSI \u548c NFS\uff08\u7528\u4e8e\u5171\u4eab\u5bb9\u5668\u955c\u50cf\uff0cLVM \u5e26\u9501\u4e0d\u80fd\u76f4\u63a5\u591a\u673a\u540c\u65f6\u6302\u8f7d\uff09\u3002</p>"},{"location":"networking/#overlay-intranet","title":"\u5bb9\u5668\u5185\u7f51","text":"<p>\u5bb9\u5668\u4e4b\u95f4\u7684\u8fde\u63a5\u57fa\u4e8e\u8fd0\u884c\u5728\u5149\u7ea4\u4e4b\u4e0a\u7684 overlay \u7f51\u7edc\uff0coverlay \u5b9e\u73b0\u91c7\u7528 VXLAN\uff0c\u66f4\u591a\u4fe1\u606f\u53c2\u89c1 \u5bb9\u5668\u5185\u7f51 \u4e00\u9875\u3002</p>"},{"location":"networking/#vm-network","title":"\u5b66\u751f\u673a\u7f51\u7edc","text":"<p>CT100 \u4e3a\u7f51\u5173\uff0c\u5c06\u6240\u6709\u5b66\u751f\u673a\u7684\u4e0a\u884c\u6d41\u91cf NAT \u540e\u8fde\u63a5\u5230\u6821\u56ed\u7f51\uff0c\u8be6\u89c1 CT100 \u5bb9\u5668\u7684\u6587\u6863\u3002</p> <p>CT101 \u4e3a web \u670d\u52a1\u5668\uff0c\u63d0\u4f9b web \u754c\u9762\uff08Nginx, Django\uff09\u548c VNC \u7edf\u4e00\u63a5\u5165\uff08\u7a0b\u5e8f\u5728 pdlan \u7684\u4e00\u4e2a\u79c1\u6709\u4ed3\u5e93\u4e2d\uff0c\u7531\u4e8e\u6f5c\u5728\u7684\u7248\u6743\u95ee\u9898\u4e0d\u80fd\u516c\u5f00\uff09\u3002\u5177\u4f53\u5185\u5bb9\u8be6\u89c1 CT101 \u5bb9\u5668\u7684\u6587\u6863\u3002</p>"},{"location":"networking/#structure","title":"\u7f51\u7edc\u67b6\u6784","text":""},{"location":"networking/firewall/","title":"\u670d\u52a1\u5668\u9632\u706b\u5899\u914d\u7f6e","text":"<p>\u9632\u706b\u5899\u4f7f\u7528 Linux \u81ea\u5e26\u7684 iptables \u7ba1\u7406\uff0c\u9ed8\u8ba4\u7b56\u7565\u4e3a <code>INPUT DROP</code>, <code>FORWARD ACCEPT</code>, <code>OUTPUT ACCEPT</code>\u3002\u65b9\u4fbf\u8d77\u89c1\u4f7f\u7528 <code>iptables-persistent</code> \u8ba9\u9632\u706b\u5899\u89c4\u5219\u5f00\u673a\u81ea\u52a8\u52a0\u8f7d\u3002</p> <p>\u4ee5\u4e0b\u4e3a pv1 \u4e0a\u7684\u9632\u706b\u5899\u914d\u7f6e\uff08<code>/etc/iptables/rules.v4</code> \u548c <code>rules.v6</code> \u6587\u4ef6\u5185\u5bb9\u4e00\u6837\uff09\uff1a</p> <p>pv1 \u7684\u989d\u5916\u914d\u7f6e</p> <p>pv1 \u9700\u8981\u4fee\u6539\u4ee5\u4e0b\u914d\u7f6e\uff0c\u989d\u5916\u653e\u884c 8090 \u7aef\u53e3\uff0c\u4ee5\u7528\u4e8e\u865a\u62df\u673a\u521b\u5efa\u65f6\u7684\u989d\u5916\u521d\u59cb\u5316\uff08post-creation-agent\uff09\u3002</p> <pre><code>*filter\n:INPUT ACCEPT [0:0]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [0:0]\n:VLAB - [0:0]\n-A INPUT -i lo -j ACCEPT\n-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT\n-A INPUT -p icmp -j ACCEPT\n-A INPUT -i vmbr+ -j VLAB\n-A INPUT -i ens1f0 -j ACCEPT\n-A INPUT -i ens1f1 -j ACCEPT\n-A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT\n-A FORWARD -i vmbr+ -j DROP\n-A VLAB -p tcp -m state --state NEW -m tcp --sport 1024:65535 -m multiport --dports 22,80,443,8006 -j ACCEPT\n-A VLAB -j DROP\nCOMMIT\n\n\n*nat\n:PREROUTING ACCEPT [0:0]\n:INPUT ACCEPT [0:0]\n:OUTPUT ACCEPT [0:0]\n:POSTROUTING ACCEPT [0:0]\n-A PREROUTING -m addrtype --dst-type LOCAL -p tcp --dport 443 -j REDIRECT --to-ports 8006\nCOMMIT\n</code></pre>"},{"location":"networking/firewall/#explanations","title":"\u90e8\u5206\u9632\u706b\u5899\u89c4\u5219\u89e3\u91ca","text":"<pre><code>-A INPUT -i lo -j ACCEPT\n-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT\n</code></pre> <p>\u8fd9\u4e24\u4e2a\u653e\u6700\u524d\u9762\uff0c\u8ba9\u672c\u673a\u6d41\u91cf <code>-i lo</code> \u548c\u5df2\u7ecf\u5efa\u7acb\u8d77\u6765\u7684 TCP / UDP \u8fde\u63a5\u7ecf\u8fc7\u6700\u5c11\u7684\u94fe\u9879\uff0c\u63d0\u9ad8\u6027\u80fd\u964d\u4f4e CPU \u4f7f\u7528\u91cf\uff0c\u8fd9\u662f\u56e0\u4e3a iptables \u89c4\u5219\u662f\u6309\u987a\u5e8f\u9010\u6761\u5339\u914d\u7684\u3002</p> <pre><code>-I INPUT -i ens1f0 -j ACCEPT\n-I INPUT -i ens1f1 -j ACCEPT\n</code></pre> <p>\u5149\u7ea4\u5185\u7f51\u4e0d\u8bbe\u9632\u3002</p>"},{"location":"networking/host/","title":"\u4e3b\u673a\u7f51\u5361","text":"<p>Proxmox VE \u4e0d\u652f\u6301 ifupdown \u4ee5\u5916\u7684\u7f51\u7edc\u7ba1\u7406\u7cfb\u7edf\uff08PVE 7 \u5f00\u59cb\u9ed8\u8ba4\u4f7f\u7528 ifupdown2\uff09\uff0c\u5982 NetworkManager \u548c systemd-networkd \u7b49\uff0c\u56e0\u6b64\u7f51\u7edc\u914d\u7f6e\u53ea\u80fd\u4f7f\u7528 <code>/etc/network/interfaces</code> \u6587\u4ef6\u3002</p> <p>\u4ee5\u4e0b\u662f pv2 \u7684\u914d\u7f6e\u4f9b\u53c2\u8003\uff0c\u6279\u91cf\u4fee\u6539\u8bf7\u89c1\u8fd9\u4e2a Gist\u3002\u5173\u4e8e ifupdown \u548c ifupdown2 \u7684\u533a\u522b\u89c1\u8fd9\u4e2a\u9875\u9762\uff0c\u4ee5\u53ca ifupdown2 \u7684\u6587\u6863\u5728\u8fd9\u3002</p> ifupdown2ifupdown <pre><code>auto lo\niface lo inet loopback\n\nauto eno1\niface eno1\nauto eno2\niface eno2\nauto eno3\niface eno3\nauto eno4\niface eno4\n\nauto ens1f0\niface ens1f0\n    mtu 1550\nauto ens1f1\niface ens1f1\n    mtu 1550\n\nauto bond0\niface bond0\n    bond-slaves eno1 eno2 eno3 eno4\n    bond-mode balance-alb\n    bond-miimon 100\n    bond-downdelay 200\n    bond-updelay 200\n\nauto bond1\niface bond1\n    address 10.0.0.12/24\n    bond-slaves ens1f0 ens1f1\n    bond-mode 802.3ad\n    bond-miimon 100\n    bond-downdelay 200\n    bond-updelay 200\n\nauto vmbr0\niface vmbr0\n    address 202.38.75.97/24\n    gateway 202.38.75.254\n    dns-nameservers 202.38.64.1\n    bridge-ports bond0\n    bridge-stp off\n    bridge-fd 0\niface vmbr0 inet6 static\n    address 2001:da8:d800:75::a2/64\n    gateway 2001:da8:d800:75::1\n\n# Overlay network for VMs\nauto vxlan1\niface vxlan1\n    pre-up ip link add $IFACE type vxlan id 1 group 239.1.1.1 dev bond1 || true\n    post-down ip link delete $IFACE || true\n    mtu 1500\nauto vmbr1\niface vmbr1\n    bridge-ports vxlan1\n    bridge-stp off\n    bridge-fd 0\n\n# Overlay network for management\nauto vxlan2\niface vxlan2\n    pre-up ip link add $IFACE type vxlan id 2 group 239.1.1.1 dev bond1 || true\n    post-down ip link delete $IFACE || true\n    mtu 1500\nauto vmbr2\niface vmbr2\n    address 172.30.0.102/24\n    bridge-ports vxlan1\n    bridge-stp off\n    bridge-fd 0\n</code></pre> <p>:fontawesome-solid-exclamation-triangle:{: .orangered } \u4ee5\u4e0b\u914d\u7f6e\u6587\u4ef6\u4e3a\u8fc1\u79fb\u81f3 ifupdown2 \u524d\u7684\u6700\u540e\u914d\u7f6e\uff0c\u5b9e\u9645\u60c5\u51b5\u5df2\u53d1\u751f\u53d8\u5316\uff0c\u5185\u5bb9\u4ec5\u4f9b\u53c2\u8003</p> <pre><code>auto lo\niface lo inet loopback\n\nauto eno1\niface eno1 inet manual\n    bond-master bond0\nauto eno2\niface eno2 inet manual\n    bond-master bond0\nauto eno3\niface eno3 inet manual\n    bond-master bond0\nauto eno4\niface eno4 inet manual\n    bond-master bond0\n\nauto ens1f0\niface ens1f0 inet manual\n    bond-master bond1\n    mtu 1550\nauto ens1f1\niface ens1f1 inet manual\n    bond-master bond1\n    mtu 1550\n\nauto bond0\niface bond0 inet manual\n    bond-mode balance-alb\n    bond-miimon 100\n    bond-downdelay 200\n    bond-updelay 200\n\nauto bond1\niface bond1 inet static\n    address 10.0.0.12/24\n    bond-mode 802.3ad\n    bond-miimon 100\n    bond-downdelay 200\n    bond-updelay 200\n\nauto vmbr0\niface vmbr0 inet static\n    address 202.38.75.97/24\n    gateway 202.38.75.254\n    dns-nameservers 202.38.64.1\n    bridge_ports bond0\n    bridge_stp off\n    bridge_fd 0\niface vmbr0 inet6 static\n    address 2001:da8:d800:75::a2/64\n    gateway 2001:da8:d800:75::1\n\n# Overlay network for VMs\nauto vxlan0\niface vxlan0 inet manual\n    pre-up ip link add vxlan0 type vxlan id 10 group 239.1.1.1 dev bond1 || true\n    up ip link set vxlan0 up\n    down ip link set vxlan0 down\n    post-down ip link delete vxlan0 || true\n    mtu 1500\nauto vmbr1\niface vmbr1 inet static\n    address 172.30.0.102/24\n    bridge_ports vxlan0\n    bridge_stp off\n    bridge_fd 0\n</code></pre> <p>\u5176\u4e2d ens1f1 \u7684 <code>mtu 1550</code> \u548c vxlan0 \u7684 <code>mtu 1500</code> \u8bbe\u7f6e\u89c1\u8e29\u5751\u8bb0\u5f55\u4e2d\u7684\u89e3\u91ca\u3002</p>"},{"location":"networking/intranet/","title":"\u5bb9\u5668\u5185\u7f51","text":"<p>\u5bb9\u5668\u5185\u7f51\u4f7f\u7528 VXLAN \u5b9e\u73b0\uff0c\u5728\u6240\u6709\u8ba1\u7b97\u670d\u52a1\u5668\u4e0a\u5747\u4f7f\u7528 bond1 \u754c\u9762\u8fde\u63a5\uff0c\u521b\u5efa\u547d\u4ee4\u4e3a</p> <pre><code>ip link add vxlan0 type vxlan id 1 group 239.1.1.1 dev bond1\n</code></pre> <p>RFC 7348 \u6307\u51fa VXLAN \u63a5\u6536\u7aef\u53e3\u4e3a UDP 4789\uff0c\u4f46\u7531\u4e8e\u5386\u53f2\u539f\u56e0\u5305\u62ec Linux \u5728\u5185\u7684\u4e00\u4f17\u5382\u5546\u90fd\u5728\u4f7f\u7528 UDP 8472\uff0c\u56e0\u6b64\u8be5\u7aef\u53e3\u5fc5\u987b\u5728 bond1 \u4e0a\u5f00\u653e\u3002\u5b9e\u9645\u4e0a\u7531\u4e8e\u5149\u7ea4\u754c\u9762\u6ca1\u6709\u5916\u90e8\u63a5\u5165\uff0c\u6545\u4e0d\u8bbe\u9632\u3002</p>"},{"location":"networking/intranet/#ip-\u5730\u5740\u5206\u914d","title":"IP \u5730\u5740\u5206\u914d","text":"<p>\u5185\u5bb9\u5df2\u79fb\u81f3 IP \u5730\u5740\u5206\u914d\u3002</p>"},{"location":"networking/ips/","title":"IP \u5730\u5740\u5217\u8868","text":""},{"location":"networking/ips/#\u6821\u56ed\u7f51-ipv4","title":"\u6821\u56ed\u7f51 IPv4","text":"IP \u5730\u5740 \u4e3b\u673a\u6216\u7528\u9014 10.38.79.9810.38.79.99 \u5b58\u50a8\u670d\u52a1\u5668\u7684\u7ba1\u7406\u7aef\u53e3 10.38.79.100 pv0 IPMI 10.38.79.101 pv1 IPMI 10.38.79.102 pv2 IPMI 10.38.79.103 pv3 IPMI 10.38.79.104 pv4 IPMI 10.38.79.105 pv5 IPMI 10.38.79.106 pv6 IPMI 10.38.79.107 pv7 IPMI 10.38.79.108 pv8 IPMI 10.38.79.181 pvg1 IPMI 10.38.79.182 pvg2 IPMI 202.38.75.4 web0\uff08\u6d4b\u8bd5\u73af\u5883\u7684 CT 101\uff09 202.38.75.24 gateway0\uff08\u6d4b\u8bd5\u73af\u5883\u7684 CT 100\uff09 202.38.75.85 pv0 202.38.75.86 pv1 202.38.75.97 pv2 202.38.75.98 pv3 202.38.75.99 pv4 202.38.75.100 pv5 202.38.75.102 pv6 202.38.75.103 pv7 202.38.75.104 pv8 202.38.75.105 pvg1 202.38.75.108 pvg2 202.38.75.226 CT 101\uff08Web \u670d\u52a1\u5668\uff09 202.38.75.250 VM 104\uff08\u5907\u4efd\u670d\u52a1\u5668\uff09 202.38.75.252 CT 100\uff08\u5185\u7f51\u7f51\u5173\u51fa\u53e3\uff09 <p>Info</p> <p>\u53e6\u5916\u6709\u4e00\u4e2a\u7279\u6b8a\u7684 IPv4 \u5730\u5740 202.38.84.252 \u6302\u5728 CT 100 \u4e0a\uff0c\u5b9e\u9645\u5e76\u4e0d\u5c5e\u4e8e\u7535\u4e09\u697c\uff0c\u7528\u6765\u901a\u8fc7 NAT \u4f9b\u7535\u4e09\u697c 420 \u623f\u95f4\u4e0a\u7f51\u3002</p>"},{"location":"networking/ips/#\u6821\u56ed\u7f51-ipv6","title":"\u6821\u56ed\u7f51 IPv6","text":"IP \u5730\u5740 \u4e3b\u673a\u6216\u7528\u9014 2001:da8:d800:75::4 web0\uff08\u6d4b\u8bd5\u73af\u5883\u7684 CT 101\uff09 2001:da8:d800:75::226 CT 101\uff08Web \u670d\u52a1\u5668\uff09 2001:da8:d800:75::aaaa CT 100\uff08\u5185\u7f51\u7f51\u5173\u51fa\u53e3\uff09 2001:da8:d800:75::bbbb gateway0\uff08\u6d4b\u8bd5\u73af\u5883\u7684 CT 100\uff09"},{"location":"networking/ips/#\u5185\u7f51-ipv4","title":"\u5185\u7f51 IPv4","text":"IP \u5730\u5740\u6bb5 \u7528\u9014 10.0.0.0/24 \u4e3b\u673a\u95f4\u5149\u7ea4\u901a\u4fe1\uff08\u5305\u62ec\u5b58\u50a8\u8bbe\u65bd\u7684 iSCSI\uff09 172.31.0.0/16 \u7528\u6237\u7f51\u7edc\uff08vmbr1\uff09 172.31.0.0 - 172.31.3.255 \u4fdd\u7559\u81ea\u7528\uff0c\u5982\u7f51\u5173\u548c\u6258\u7ba1\u7684\u670d\u52a1\u7b49 172.31.4.0 - 172.31.255.254 \u5206\u914d\u7ed9\u7528\u6237\u865a\u62df\u673a 172.30.0.0/24 \u5185\u90e8\u8bbe\u65bd\u95f4\u7684\u901a\u4fe1\uff0c\u5305\u62ec\u865a\u62df\u673a\u548c\u4e3b\u673a\uff08\u4e0d\u5305\u542b iSCSI\uff0c\u5b89\u5168\u8d77\u89c1\u9700\u8981\u9694\u79bb\uff09\uff08vmbr2\uff09 192.168.252.0/24 WireGuard \u5916\u90e8\u63a5\u5165\uff08\u901a\u8fc7 CT 100 \u7f51\u5173\uff09 IP \u5730\u5740 \u4e3b\u673a 10.0.0.110.0.0.11 pv1 10.0.0.12 pv2 10.0.0.13 pv3 10.0.0.14 pv4 10.0.0.15 pv5 10.0.0.16 pv6 10.0.0.17 pv7 10.0.0.18 pv8 10.0.0.81 pvg1 10.0.0.82 pvg2 172.30.0.1172.31.0.1 CT 100 \u7f51\u5173 172.30.0.2172.31.0.2 CT 101 \u670d\u52a1\u5668 172.30.0.3 CT 102 (monitor, InfluxDB) 172.30.0.4 VM 103 Wireguard\u73b0\u5728\u6ca1\u7528\u4e86 172.30.0.5 VM 104 PBS 172.30.0.101 pv1 172.30.0.102 pv2 172.30.0.103 pv3 172.30.0.104 pv4 172.30.0.105 pv5 172.30.0.106 pv6 172.30.0.107 pv7 172.30.0.108 pv8 172.30.0.181 pvg1 172.30.0.182 pvg2 172.31.0.3 CT 802 Foresyn (iGEM 2019) 172.31.1.3 VM 803 (Verilog OJ) 172.31.1.4 VM 804 (FPGAOL Compile) 172.31.1.5 VM 805 (iBug \u7684\u865a\u62df\u673a) 172.31.1.199 VM 999 (iBug \u7684\u865a\u62df\u673a) 172.31.1.198 VM 998 (iBug \u7684\u865a\u62df\u673a)"},{"location":"networking/ips/#\u5206\u914d\u89c4\u5219","title":"\u5206\u914d\u89c4\u5219","text":"<ul> <li>172.31.0.1-?\uff1aVlab \u7684\u670d\u52a1\uff0c\u5373\u5e73\u53f0\u7684\u57fa\u7840\u8bbe\u65bd\u548c\u4ee5 Vlab \u540d\u4e49\u63d0\u4f9b\u7684\u670d\u52a1</li> <li>172.31.1.0-199\uff1a\u5bf9\u5e94 VM 800-999\uff0c\u5176\u4e2d IP \u5730\u5740\u6700\u540e\u4e00\u7ec4\u6570\u5b57\u4e3a VMID - 800\uff0c\u5e76\u4e14\uff1a<ul> <li>8xx \u7528\u4e8e\u6258\u7ba1\u5728 Vlab \u4e0a\u7684\u3001\u7531\u7b2c\u4e09\u65b9\u8fd0\u884c\u548c\u7ef4\u62a4\u7684\u670d\u52a1\uff08\u5373 Vlab IaaS\uff09</li> <li>9xx \u7528\u4e8e\u5404\u79cd\u6d4b\u8bd5\u7528\u9014\u7684\u865a\u62df\u673a\uff0c\u8bf7\u6807\u660e\u6240\u6709\u8005</li> </ul> </li> <li>172.31.2.0-3.255\uff1a\u6682\u672a\u4f7f\u7528</li> <li>172.31.4.0-255.254\uff1a\u7528\u6237\u865a\u62df\u673a</li> </ul>"},{"location":"networking/ips/#\u5185\u7f51-ipv6","title":"\u5185\u7f51 IPv6","text":"<p>\u6211\u4eec\u6ca1\u6709\u5185\u7f51\u670d\u52a1\u8fd0\u884c\u5728 IPv6 \u4e0a\u3002</p> IP \u5730\u5740\u6bb5 \u5206\u914d\u7528\u9014 2001:da8:d800:4bfc::/64 \u901a\u8fc7 SLAAC \u4f9b\u7528\u6237\u865a\u62df\u673a\u8bbf\u95ee IPv6 2001:da8:d800:4b18::/64 \u540c\u4e0a\uff0c\u4f46\u662f\u662f\u6d4b\u8bd5\u73af\u5883"},{"location":"records/2020-03-31/","title":"2020 \u5e74 3 \u6708 31 \u65e5\u5de5\u4f5c\u603b\u7ed3","text":""},{"location":"records/2020-03-31/#\u5df2\u5b8c\u6210","title":"\u5df2\u5b8c\u6210","text":"<ul> <li>\u56db\u5757 Agilio \u667a\u80fd\u7f51\u5361\u5df2\u5b89\u88c5\u5728 2~5 \u53f7\u670d\u52a1\u5668\u4e0a</li> <li>15 \u6761\u5185\u5b58\u5df2\u5206\u522b\u6dfb\u52a0\u81f3\u4e5d\u53f0\u670d\u52a1\u5668\u4e0a\uff080 \u53f7\u4e00\u6761\uff0c2~8 \u53f7\u5404\u4e24\u6761\uff0c1 \u53f7\u672a\u6539\u52a8\uff09</li> <li>7 \u53f7\u548c 8 \u53f7\u670d\u52a1\u5668\u5df2\u914d\u7f6e\u5b8c\u6bd5\u5e76\u6295\u5165\u4f7f\u7528</li> <li>\u5e73\u53f0\u5df2\u6062\u590d\u6b63\u5e38\u8fd0\u884c\uff083 \u6708 31 \u65e5\u4e0b\u5348 5:00 \u81f3 4 \u6708 1 \u65e5\u65e9\u4e0a\u505c\u7535\u524d\uff0c\u4ee5\u53ca 4 \u6708 1 \u65e5\u505c\u7535\u6062\u590d\u540e\uff09</li> </ul>"},{"location":"records/2020-03-31/#\u672a\u5b8c\u6210","title":"\u672a\u5b8c\u6210","text":"<ul> <li>\u667a\u80fd\u7f51\u5361\u7684\u8f6f\u4ef6\u8c03\u7814\u4e0e\u914d\u7f6e\uff0c\u5728\u667a\u80fd\u7f51\u5361\u53ef\u4ee5\u63d0\u4f9b\u7ed9\u5ba2\u6237\uff08\u5b66\u751f\uff09\u4f7f\u7528\u524d\u8fd8\u9700\u8981\u4e00\u4e9b\u7814\u7a76\u5de5\u4f5c</li> <li>GPU \u7684\u8f6f\u4ef6\u8c03\u7814\u4e0e\u914d\u7f6e\uff0c\u6211\u4eec\u8ba1\u5212\u4f7f\u7528 0 \u53f7\u670d\u52a1\u5668\u8fdb\u884c\u7814\u7a76\u5b9e\u9a8c\uff08\u4e0a\u9762\u6709\u4e00\u5757 Tesla P4\uff09<ul> <li>\u56e0\u6b64 0 \u53f7\u670d\u52a1\u5668\u6682\u4e0d\u6295\u5165\u4f7f\u7528</li> </ul> </li> </ul>"},{"location":"records/2020-03-31/#\u9047\u5230\u95ee\u9898","title":"\u9047\u5230\u95ee\u9898","text":"<ul> <li>\u6ca1\u6709\u5b89\u88c5 GPU\uff0c\u56e0\u4e3a\u673a\u8eab\u7f3a\u5c11 GPU \u6240\u9700\u7684\u989d\u5916\u4f9b\u7535\u8bbe\u65bd<ul> <li>\u7ecf\u8fc7\u8c03\u7814\uff0c\u8fd9\u516b\u53f0\u670d\u52a1\u5668\u65e0\u6cd5\u6dfb\u52a0 GPU \u6240\u9700\u7535\u6e90\uff0c\u56e0\u6b64\u65e0\u6cd5\u5b89\u88c5 GPU</li> </ul> </li> <li>8 \u53f7\u670d\u52a1\u5668\u7684\u4e24\u5757\u56fa\u6001\u786c\u76d8\u6709\u4e00\u5757\u6545\u969c\uff0c\u8003\u8651\u8d70\u4fdd\u4fee</li> </ul>"},{"location":"records/2020-03-31/#\u7f3a\u5c11\u7269\u8d44\u9700\u8981\u91c7\u8d2d","title":"\u7f3a\u5c11\u7269\u8d44\uff08\u9700\u8981\u91c7\u8d2d\uff09","text":"<ul> <li>\u5149\u4ea4\u6362\u673a\u4e00\u53f0\uff08\u7528\u4e8e\u667a\u80fd\u7f51\u5361\u95f4\u7684\u4e92\u8054\uff0c\u81f3\u5c11 8 \u53e3\uff09</li> <li>\u5149\u6a21\u5757 22 \u4e2a\uff08\u667a\u80fd\u7f51\u5361 16 \u4e2a\uff0c0 \u53f7\u670d\u52a1\u5668 2 \u4e2a\uff0c\u5b58\u50a8\u670d\u52a1\u5668 4 \u4e2a\uff09</li> <li>\u5149\u7f06 12 \u5bf9\uff08\u667a\u80fd\u7f51\u5361 8 \u5bf9\uff0c0 \u53f7\u670d\u52a1\u5668 2 \u5bf9\uff0c\u5b58\u50a8\u670d\u52a1\u5668 2 \u5bf9\uff09</li> <li>2.4 TB \u5907\u7528\u786c\u76d8\u81f3\u5c11 4 \u5757\uff08\u53c2\u8003\u578b\u53f7 EG002400JWJNN\uff09</li> </ul>"},{"location":"records/2020-08-01/","title":"2020 \u5e74 8 \u6708 1 \u65e5\u5de5\u4f5c\u603b\u7ed3","text":""},{"location":"records/2020-08-01/#\u7cfb\u7edf\u7ef4\u62a4mtu-\u8bbe\u7f6e","title":"\u7cfb\u7edf\u7ef4\u62a4\uff08MTU \u8bbe\u7f6e\uff09","text":"<p>VXLAN \u7684 MTU \u4e3a\u4e0b\u5c42\u627f\u8f7d\u7f51\u7edc\u7684\u51cf\u53bb 50 \u5b57\u8282\uff0c\u8003\u8651\u5230 1450 \u5b57\u8282\u8fd9\u79cd\u975e\u6807\u51c6\u7684\u8bbe\u5b9a\u65e9\u665a\u4f1a\u5bfc\u81f4\u66f4\u591a\u7684\u9ebb\u70e6\uff08\u4f8b\u5982 KVM \u865a\u62df\u673a\u9700\u8981\u5355\u72ec\u8bbe\u7f6e\u7b49\uff09\uff0c\u51b3\u5b9a\u627e\u673a\u4f1a\u8fdb\u884c\u7cfb\u7edf\u7ef4\u62a4\uff0c\u628a\u8fd9\u4e2a\u8bbe\u7f6e\u6539\u6389\uff0c\u628a\u4e0b\u5c42\u627f\u8f7d\u7f51\u5361\u7684 MTU \u589e\u52a0 50 \u5b57\u8282\u4ee5\u4f9b VXLAN \u586b\u8865\u3002</p> <p>\u5177\u4f53\u7684\u8c03\u6574\u65b9\u6cd5\u5c31\u662f\u5728 <code>/etc/network/interfaces</code> \u4e2d\u7684 <code>iface ens1f1 inet static</code> \u540e\u9762\u52a0\u5165\u4e00\u884c <code>mtu 1550</code>\uff0c\u540c\u6837\uff08\u4fdd\u9669\u8d77\u89c1\uff09\u5728 <code>iface vxlan0</code> \u540e\u9762\u52a0\u5165\u4e00\u884c <code>mtu 1500</code>\u3002</p> <p>\u6539\u8fc7\u4e4b\u540e\u7684 interfaces \u6587\u4ef6\u7c7b\u4f3c\u8fd9\u6837\uff1a</p> <pre><code>auto ens1f1\niface ens1f1 inet static\n    address 10.0.0.1\n    netmask 255.255.255.0\n    mtu 1550\n\nauto vxlan0\niface vxlan0 inet manual\n    pre-up ip link add vxlan0 type vxlan id 10 group 239.1.1.1 dstport 0 dev ens1f1 || true\n    up ip link set vxlan0 up\n    down ip link set vxlan0 down\n    post-down ip link delete vxlan0 || true\n    mtu 1500\n</code></pre> <p>\u5bf9\u4e8e\u8fd0\u884c\u4e86\u5bb9\u5668\u7684\u4e3b\u673a\uff0c\u76f4\u63a5\u91cd\u542f\u66f4\u52a0\u65b9\u4fbf\uff08\u5f53\u7136 iSCSI \u7684\u81ea\u52a8\u6302\u8f7d\u53c8\u51fa\u95ee\u9898\u4e86\uff0c\u89c1\u8e29\u5751\u8bb0\u5f55\u7684 LVM \u4e00\u8282\uff09\u3002\u5bf9\u4e8e\u6ca1\u6709\u8fd0\u884c\u5bb9\u5668\u7684\u4e3b\u673a\uff0c\u53ef\u4ee5\u76f4\u63a5\u628a\u4f9d\u8d56\u7684\u7f51\u5361\u4e00\u4e2a\u4e2a down \u6389\u518d up \u56de\u6765\uff1a</p> <pre><code>ifdown vmbr1 vxlan0 ens1f1\nifup ens1f1 vxlan0 vmbr1\n</code></pre> <p>\u63a5\u4e0b\u6765\u7531\u4e8e\u73b0\u6709\u5bb9\u5668\u5df2\u7ecf\u8bbe\u7f6e\u4e86 MTU = 1450\uff0c\u8981\u628a\u8bbe\u7f6e\u5220\u6389\uff0c\u505a\u6cd5\u7b80\u5355\u7c97\u66b4\uff1a</p> <pre><code>cd /etc/pve/nodes\ngrep -lwirF mtu=1450 | xargs sed -Ei 's/,mtu=1450//'\n</code></pre> <p>Proxmox \u4f1a\u81ea\u52a8\u5c06\u4fee\u6539\u8fc7\u7684\u914d\u7f6e\u6587\u4ef6\u540c\u6b65\u81f3\u96c6\u7fa4\u4e2d\u7684\u5176\u4ed6\u4e3b\u673a\uff08\u6ce8\u610f\u9700\u8981\u5168\u90e8\u4fdd\u6301\u5728\u7ebf\uff0c\u5426\u5219\u540c\u6b65\u4f1a\u6302\uff0c\u8e29\u5751\u8bb0\u5f55\u6709\u5199\uff09\u3002</p> <p>\u6700\u540e\u628a Django \u524d\u7aef\u7684 <code>config.py</code> \u6539\u4e00\u4e0b\uff0c\u8ba9\u65b0\u521b\u5efa\u7684\u5bb9\u5668\u4f7f\u7528\u9ed8\u8ba4\u7684 MTU \u5c31\u884c\u4e86\u3002</p>"},{"location":"records/2020-08-01/#pv8-\u5149\u7ea4\u7f51\u7edc\u95ee\u9898","title":"pv8 \u5149\u7ea4\u7f51\u7edc\u95ee\u9898","text":"<p>\u4e00\u5f00\u59cb\u7684\u8868\u73b0\u662f pv8 \u7684\u4e24\u4e2a\u5149\u7ea4\u5185\u7f51 IP \u90fd\u80fd\u8fde\u901a\uff0c\u4f46\u662f VXLAN \u6b7b\u6d3b\u8fde\u4e0d\u4e0a\u3002</p> <p>\u9996\u5148\u8fd9\u91cc\u6709\u53e6\u4e00\u4e2a\u5751\uff0c\u89e3\u51b3\u4e4b\u540e\u91cd\u65b0\u68c0\u67e5\uff0c\u786e\u5b9a\u5b9e\u9645\u95ee\u9898\u662f ens1f1 \u754c\u9762\u4e0d\u8fde\u901a\uff0c\u8054\u7cfb\u5362\u5efa\u826f\u8001\u5e08\u524d\u5f80\u673a\u623f\u5b9e\u5730\u6392\u67e5\uff0c\u6700\u7ec8\u786e\u8ba4\u6545\u969c\u90e8\u4ef6\u662f\u8be5\u7f51\u8def\u5728\u4ea4\u6362\u673a\u4e00\u7aef\u7684\u5149\u6a21\u5757\u6709\u95ee\u9898\uff0c\u66ff\u6362\u6210\u65c1\u8fb9\u4e00\u4e2a\u95f2\u7f6e\u7684\u5149\u6a21\u5757\u540e\u7f51\u7edc\u8fde\u901a\u6027\u6062\u590d\u3002</p> <p>\u63a5\u4e0b\u6765\u7684\u5f85\u529e\u4e8b\u9879\u5c31\u662f\u8bf7\u4eba\u68c0\u67e5\u8fd9\u4e2a\u5149\u6a21\u5757\u6709\u4ec0\u4e48\u95ee\u9898\u4e86\uff08\u8fd9\u4e2a\u5c31\u4ea4\u7ed9\u8001\u5e08\u5904\u7406\u4e86\uff09\u3002</p>"},{"location":"records/2020-08-01/#\u5f85\u529e\u4e8b\u9879","title":"\u5f85\u529e\u4e8b\u9879","text":"<p>\u89c1\u4e0a</p>"},{"location":"records/2021-03-18/","title":"2021 \u5e74 3 \u6708 18 \u65e5\u8ba8\u8bba\u603b\u7ed3","text":""},{"location":"records/2021-03-18/#\u5de5\u4f5c\u6c47\u62a5","title":"\u5de5\u4f5c\u6c47\u62a5","text":""},{"location":"records/2021-03-18/#page-2---\u5df2\u5b8c\u6210\u7684\u5185\u5bb9","title":"Page 2 - \u5df2\u5b8c\u6210\u7684\u5185\u5bb9","text":"<ul> <li>\u7528\u91cf\u7edf\u8ba1\u4fe1\u606f\u9875\u9762\uff08Grafana\uff09</li> <li>SSH \u7edf\u4e00\u767b\u5f55</li> <li>Vlab \u8f6f\u4ef6\u7ec4\u5408</li> <li>Xilinx Vivado</li> <li>MATLAB</li> <li>Wolfram Mathematica</li> <li>Logisim</li> <li>\u6d4f\u89c8\u5668 Visual Studio Code</li> <li>\u4f9b\u6211\u4eec\u81ea\u5df1\u9605\u8bfb\u4f7f\u7528\u7684\u7ef4\u62a4\u6587\u6863</li> </ul>"},{"location":"records/2021-03-18/#page-3---\u7528\u91cf\u7edf\u8ba1","title":"Page 3 - \u7528\u91cf\u7edf\u8ba1","text":"<p>https://vlab.ustc.edu.cn/grafana/d/2</p>"},{"location":"records/2021-03-18/#page-4---ssh-\u7edf\u4e00\u767b\u5f55","title":"Page 4 - SSH \u7edf\u4e00\u767b\u5f55","text":"<ul> <li>\u66ff\u4ee3\u4e86\u539f\u6765\u7684\u5f00\u653e SSH \u7aef\u53e3\u7684\u505a\u6cd5</li> <li>\u53ef\u4ee5\u8fdb\u884c\u767b\u5f55\u7edf\u8ba1</li> <li>\u66f4\u5b89\u5168\uff0c\u9632\u6b62\u626b\u63cf\u7206\u7834\u5165\u4fb5</li> <li>\u9632\u6b62\u6ee5\u7528</li> </ul>"},{"location":"records/2021-03-18/#page-5---vlab-\u8f6f\u4ef6\u7ec4\u5408","title":"Page 5 - Vlab \u8f6f\u4ef6\u7ec4\u5408","text":"<ul> <li>\u4f5c\u4e3a\u6253\u5305\u9884\u88c5\u8f6f\u4ef6\u7684\u66ff\u4ee3</li> <li>\u51cf\u5c0f\u955c\u50cf\u5bb9\u91cf\uff0c\u52a0\u5feb\u65b0\u865a\u62df\u673a\u521b\u5efa</li> <li>\u53ef\u4ee5\u900f\u660e\u66f4\u65b0\u53ca\u6dfb\u52a0\u65b0\u8f6f\u4ef6</li> <li>\u5171\u4eab\u8f6f\u4ef6\u5bb9\u91cf\uff0c\u51cf\u5c11\u91cd\u590d\u5185\u5bb9\u548c\u786c\u76d8\u5360\u7528</li> </ul>"},{"location":"records/2021-03-18/#page-6---\u6d4f\u89c8\u5668-vs-code","title":"Page 6 - \u6d4f\u89c8\u5668 VS Code","text":"<ul> <li>Visual Studio Code \u662f\u5fae\u8f6f\u5f00\u53d1\u7684\u5e7f\u53d7\u6b22\u8fce\u7684\u4ee3\u7801\u7f16\u8f91\u5668\uff0c\u6709\u4e30\u5bcc\u7684\u5185\u7f6e\u529f\u80fd\u548c\u63d2\u4ef6\u5e02\u573a</li> <li>\u6d4f\u89c8\u5668\u4fbf\u4e8e\u4f7f\u7528\u53ca\u914d\u7f6e</li> <li>\u65b9\u4fbf\u4e86\u7528\u6237\u5728 Vlab \u5e73\u53f0\u4e0a\u8fdb\u884c\u4ee3\u7801\u7f16\u8f91\u4e0e\u8f6f\u4ef6\u5f00\u53d1</li> <li>\u501f\u52a9 web \u524d\u7aef\u5b9e\u73b0\u7edf\u4e00\u63a5\u53e3\u767b\u5f55\u4f7f\u7528</li> </ul>"},{"location":"records/2021-03-18/#page-7---\u5f00\u53d1\u6587\u6863\u7ef4\u62a4\u6587\u6863","title":"Page 7 - \u5f00\u53d1\u6587\u6863/\u7ef4\u62a4\u6587\u6863","text":"<p>https://vlab.ibugone.com/</p>"},{"location":"records/2021-03-18/#page-8---\u540e\u7eed\u5de5\u4f5c\u8ba1\u5212","title":"Page 8 - \u540e\u7eed\u5de5\u4f5c\u8ba1\u5212","text":"<ul> <li>\u91cd\u6784 web \u524d\u7aef\u7ba1\u7406\u5668</li> <li>\u529f\u80fd\u4e0a\u4fdd\u6301\u4e00\u81f4\uff0c\u66f4\u5229\u4e8e\u4ee5\u540e\u7ef4\u62a4\u548c\u5f00\u53d1</li> <li>\u6dfb\u52a0 KVM \u652f\u6301</li> <li>\u5b8c\u5584\u7528\u6237\u6587\u6863\u4e0e\u7ef4\u62a4\u6587\u6863</li> </ul>"},{"location":"records/2021-03-18/#\u4f1a\u8bae\u7b14\u8bb0\u6539\u8fdb\u5efa\u8bae--\u63a8\u5e7f\u8ba1\u5212","title":"\u4f1a\u8bae\u7b14\u8bb0\uff08\u6539\u8fdb\u5efa\u8bae &amp; \u63a8\u5e7f\u8ba1\u5212\uff09","text":"<ul> <li>\u672c\u5b66\u671f\uff1a\u7ec4\u539f\u5b9e\u9a8c\uff08Vlab + FPGAOL\uff09</li> <li>\u6570\u7535\u5b9e\u9a8c\u95ee\u9898\uff1aVivado \u7684\u7a33\u5b9a\u6027<ul> <li>\u7528\u91cf\u591a\u7684\u65f6\u5019\u4f1a\u9047\u5230\u5404\u79cd\u62a5\u9519\uff0c\u6709\u4e9b\u62a5\u9519\u4e0d\u4fee\u6539\u4ee3\u7801\u76f4\u63a5\u91cd\u65b0\u8fd0\u884c\u5c31\u597d\u4e86</li> <li>Vivado \u672c\u8eab\u4ea7\u751f\u7684\u4e00\u4e9b\u96be\u4ee5\u7406\u89e3\u7684\u62a5\u9519</li> <li>\u5c1d\u8bd5\u6362\u4e2a\u7248\u672c\uff08Current: 2019.1, Target: 2016.2 / 2018.2 ?\uff09\uff0c\u4f8b\u5982\u56de\u9000</li> </ul> </li> <li>\u4e24\u5468\u540e\u5f00\u59cb\u672c\u5b66\u671f\uff082021 Spring\uff09\u7ec4\u539f\u5b9e\u9a8c\uff0c\u51c6\u5907\u5168\u9762\u91c7\u7528 RISC-V\uff08<code>!important</code>\uff09<ul> <li>\u8ba1\u5212\u76ee\u6807\u5f62\u5f0f\uff08\u5b8c\u6210\u72b6\u6001\uff09\uff1aC to RISC-V\uff0c\u8fd0\u884c\u5728\u81ea\u5df1\u5199\u7684\uff08\u7ec4\u539f\u5b9e\u9a8c\u6210\u679c\uff09RV SoC / CPU \u4e0a</li> <li>\u9884\u5907 RV \u4ea4\u53c9\u5de5\u5177\u94fe\uff08GCC / binutils\uff0camd64 to riscv\uff09\u4ee5\u65b9\u4fbf\u5b66\u751f\u5b9e\u9a8c</li> <li>Chisel \u5de5\u5177\u94fe\uff08\u53ef\u9009\uff09</li> <li>RARS \u6c47\u7f16\u53ca\u6a21\u62df\u5668\uff08TheThirdOne/rars\uff09</li> <li>https://mirrors.ustc.edu.cn/ \u63d0\u4f9b\u76f8\u5173 GitHub \u4ed3\u5e93\u7684 Releases \u7684\u955c\u50cf</li> </ul> </li> <li>Vlab \u7684 UX</li> <li>\uff08FAQ?\uff09\uff08Embedded docs?\uff09\uff08\"Quick links\"?\uff09</li> <li>\u590d\u6742\u5185\u5bb9\uff1anavbar \u7684\u7f51\u9875\u767b\u5f55\u8981\u5220\u6389</li> <li>\u300c\u6587\u4ef6\u4f20\u8f93\u300d\u7684\u6613\u7528\u6027\u4e0e\u6587\u6863<ul> <li>\u76f4\u63a5\u4e0d\u7528\u586b\u5bc6\u7801\u4e86\uff08\u5df2\u7ecf\u7ecf\u8fc7 CAS \u8ba4\u8bc1\u4e86\uff09</li> </ul> </li> <li>\u300cSSH \u5bc6\u94a5\u7ba1\u7406\u300d\u7684\u79c1\u94a5\u53ef\u4ee5\u91cd\u590d\u4e0b\u8f7d\uff08<code>status-bydesign</code>\uff09<ul> <li>\u5bc6\u94a5\u7ba1\u7406\u9875\u9762\u6dfb\u52a0\u4f7f\u7528\u5e2e\u52a9\uff08jump link / <code>&lt;iframe&gt;</code> ?\uff09</li> </ul> </li> <li>\u7cfb\u7edf\u548c\u6570\u636e\u5206\u79bb<ul> <li>\uff08EBS / EFS \u6302\u8f7d\uff1f\uff09</li> </ul> </li> <li>\u591a\u7cfb\u7edf<ul> <li>Depends: KVM support</li> <li>Windows \u7684\u652f\u6301\u4e0e\u5bf9\u63a5\uff08\u96be\uff09</li> </ul> </li> <li>\u628a \u201c\u5173\u95ed VNC \u901a\u77e5\u201d \u63a5\u53e3\u516c\u5f00</li> <li>\u5f00\u53d1\u8fc7\u7a0b</li> <li>\u4eba\u5458\u5206\u5de5\uff08\uff1f\uff09\u4efb\u52a1\u8981\u660e\u786e</li> <li>\u63a8\u5e7f\u8ba1\u5212</li> <li>\u6559\u52a1\u5904 / \u5b9e\u9a8c\u4e2d\u5fc3 / \u8ba1\u7b97\u673a\u5b66\u9662\u9886\u5bfc\u90fd\u770b\u597d<ul> <li>\u4e09\u6559\u7684\u8bb2\u53f0\u7535\u8111\uff08<code>!?!?</code>\uff09</li> </ul> </li> <li>\u5185\u5b58\u5f00\u59cb\u7d27\u5f20\u4e86\uff08\u554a\uff09<ul> <li>\u4f8b\u5982\u4e00\u4e2a\u661f\u671f\u6ca1\u8fde\u63a5\u5c31\u5173\u673a</li> <li>\u6bd5\u4e1a\u56de\u6536\u5f97\u5f00\u59cb\u8d76\u4e86\uff08x\uff09</li> </ul> </li> </ul>"},{"location":"records/2021-06-13/","title":"2021 \u5e74 6 \u6708 13 \u65e5\u5de5\u4f5c\u603b\u7ed3","text":""},{"location":"records/2021-06-13/#\u79fb\u9664-django-\u4ee3\u7801\u91cc\u7684\u865a\u62df\u673a-id-\u504f\u79fb\u91cf","title":"\u79fb\u9664 Django \u4ee3\u7801\u91cc\u7684\u201c\u865a\u62df\u673a ID \u504f\u79fb\u91cf\u201d","text":"<p>\u540c\u65f6\u6539\u6570\u636e\u5e93\u548c Django \u4ee3\u7801\uff0c\u6e05\u7406\u6389 <code>VMID_INCR</code> \u8fd9\u4e2a\u5386\u53f2\u5305\u88b1\u3002</p> <pre><code>-- Drop foreign key\n-- https://stackoverflow.com/posts/comments/32882353\nALTER TABLE vm_sshkey DROP CONSTRAINT `vm_sshkey_ct_id_8bfb3d03_fk_vm_pvect_id`;\n\n-- Remove auto increment and PK\n-- https://stackoverflow.com/a/6741189/5958455\nALTER TABLE vm_pvect MODIFY COLUMN id INT(11);\nALTER TABLE vm_pvect DROP PRIMARY KEY;\n\n-- Work data\nUPDATE vm_pvect SET id = id + 1000;\nUPDATE vm_sshkey SET ct_id = ct_id + 1000;\n\n-- Add back AI and PK\nALTER TABLE vm_pvect ADD PRIMARY KEY (`id`);\nALTER TABLE vm_pvect MODIFY COLUMN id INT(11) AUTO_INCREMENT;\n\n-- Add back FK\nALTER TABLE vm_sshkey ADD CONSTRAINT `vm_sshkey_ct_id_8bfb3d03_fk_vm_pvect_id` FOREIGN KEY (`ct_id`) REFERENCES `vm_pvect` (`id`);\n</code></pre> <p>\u4ee3\u7801\u90e8\u5206\u89c1 Pull Request #1</p>"},{"location":"records/2021-06-13/#\u5176\u4ed6","title":"\u5176\u4ed6","text":"<ul> <li> <p>\u5c06 <code>/mnt/container-template</code> \u91cd\u547d\u540d\u4e3a\u4e86\u66f4\u7b80\u6d01\u7684 <code>/mnt/vz</code>\u3002\u7531\u4e8e PVE \u7684\u4e00\u4e9b\u8bbe\u5b9a\uff0c\u64cd\u4f5c\u987a\u5e8f\u5982\u4e0b\uff1a</p> <ul> <li>\u5728\u6240\u6709\u673a\u5668\u4e0a <code>mkdir /mnt/vz</code>\uff0c\u66f4\u65b0 <code>/etc/fstab</code> \u7136\u540e\u6302\u8f7d\u65b0\u8def\u5f84</li> <li>\u7f16\u8f91 <code>/etc/pve/storage.cfg</code> \u4f7f\u7528\u65b0\u8def\u5f84</li> <li>\u5728\u6240\u6709\u673a\u5668\u4e0a <code>umount /mnt/container-template</code> \u5378\u8f7d\u65e7\u8def\u5f84\u5e76 <code>rmdir -p</code></li> </ul> </li> <li> <p>\u5728 pv1-pv8 \u4ee5\u53ca web \u5bb9\u5668\u4e2d\u8fdb\u884c\u4e86\u7cfb\u7edf\u66f4\u65b0\uff08\u4e0a\u6e38\u5747\u66f4\u6362\u4e3a\u4e86\u79d1\u5927\u6e90\uff09\uff0c\u5e76\u5728 pv1, pv7, pv8 \u4e0a\u5b89\u88c5\u4e86 <code>apt-listbugs</code>\uff08\u5b89\u88c5\u65f6\u4f7f\u7528 <code>--no-install-recommends</code> \u51cf\u5c11\u9644\u5e26\u7684\u5783\u573e\uff09</p> </li> <li>\u66f4\u65b0\u4e86 iptables \u9632\u706b\u5899\u89c4\u5219</li> <li>\u66f4\u65b0\u4e86 <code>lvm.conf</code> \u91cc\u7684\u6392\u9664\u89c4\u5219 <code>global_filters</code>\uff0c\u4f7f\u7528 <code>/dev/disk/by-id/usb.*</code> \u6765\u6392\u9664\u90a3\u4e2a\u6c38\u8fdc No medium found \u7684\u8bbe\u5907\uff0c\u4ee5\u907f\u514d\u6f5c\u5728\u7684\u91cd\u542f\u540e sda/sdb \u4ea4\u6362\u5bfc\u81f4\u7684\u95ee\u9898\uff08\u89c1\u8e29\u5751\u8bb0\u5f55\uff09</li> </ul>"},{"location":"records/2021-08-21/","title":"2021 \u5e74 8 \u6708 21 \u65e5\u5de5\u4f5c\u603b\u7ed3","text":""},{"location":"records/2021-08-21/#\u89e3\u9664\u56fa\u6001\u786c\u76d8\u7684-raid","title":"\u89e3\u9664\u56fa\u6001\u786c\u76d8\u7684 RAID","text":"<p>\u91cd\u542f\u524d\u5148\u88c5 <code>mdadm</code>\u3002</p> <p>\u53ef\u4ee5\u5728 IPMI KVM \u4e2d\u64cd\u4f5c\u3002\u91cd\u542f\u540e\u51fa\u73b0\u63d0\u793a\u754c\u9762\u65f6\u6309 F9 \u8fdb\u5165 HPE UEFI \u8bbe\u7f6e\u9875\u9762\u3002\u8bbe\u7f6e\u9875\u9762\u53ef\u4ee5\u4f7f\u7528\u9f20\u6807\u64cd\u4f5c\uff0c\u9009\u62e9 RAID 1\uff0c\u5728\u63a7\u5236\u5668\u8bbe\u7f6e\u7684 manage arrays \u4e2d\u627e\u5230 delete array \u89e3\u9664\u9635\u5217\u3002</p> <p>\u89e3\u9664\u540e\uff0c\u9700\u8981\u6302\u8f7d iso\uff08HPE IPMI \u4e0d\u652f\u6301 DNS\uff0c\u6240\u4ee5\u76ee\u524d\u4f7f\u7528 iBug \u7684\u5185\u7f51\u5c0f\u673a\u5668\uff0c\u5730\u5740\u4e3a https://10.38.79.2/iso/\uff0c\u5728\u5176\u4e2d\u9009\u62e9\u9002\u7528\u7684 Debian \u7248\u672c\u6302\u8f7d\uff09\u3002</p>"},{"location":"records/2021-08-21/#\u7f29\u5c0f\u4e3b\u673a\u7684-rootfs-\u5e76\u6dfb\u52a0-lvm-mirror","title":"\u7f29\u5c0f\u4e3b\u673a\u7684 rootfs \u5e76\u6dfb\u52a0 LVM mirror","text":"<p>\u53c2\u8003 iBug \u7684\u535a\u5ba2\u3002</p> <p>\u4e3b\u8981\u51e0\u6b65\uff08\u5047\u8bbe\u62c6\u5b8c\u4e4b\u540e\u662f <code>/dev/sda</code> \u548c <code>/dev/sdb</code>\uff09\uff1a</p> <ol> <li>\u4f7f\u7528 testdisk \u627e\u5230 <code>/dev/sda</code> \u5206\u533a\u8868\uff0c\u5e76\u4e14\u5199\u5165\u6b63\u786e\u7684\u5206\u533a\u8868\u5230\u78c1\u76d8\u4e2d\u3002</li> <li>\u4f7f\u7528 <code>vgscan</code> \u52a0\u8f7d LVM \u4fe1\u606f\u3002\u5047\u8bbe <code>rootfs</code> \u662f <code>/dev/pve/root</code></li> <li>\u8fd0\u884c <code>e2fsck -f /dev/pve/root</code> \u68c0\u67e5\u4e00\u81f4\u6027\uff0c\u8fd0\u884c <code>resize2fs -M -p /dev/pve/root</code> \u5c06 rootfs \u6587\u4ef6\u7cfb\u7edf\u7f29\u5c0f\u5230\u6700\u5c0f\uff0c\u786e\u4fdd\u7f29\u5c0f\u5f97\u5230\u7684\u5927\u5c0f\u5c0f\u4e8e 16GB\uff0c\u5426\u5219\u63a5\u4e0b\u6765\u7684\u64cd\u4f5c\u4f1a\u7834\u574f rootfs!\u3002</li> <li>\u8fd0\u884c <code>lvresize -L 16G pve/root</code> \u5c06 LVM rootfs \u903b\u8f91\u5206\u533a\u7f29\u5c0f\u5230 16GB\uff0c\u7136\u540e\u8fd0\u884c <code>resize2fs -p /dev/pve/root</code> \u5c06\u6587\u4ef6\u7cfb\u7edf\u6269\u5927\u5230 16GB\u3002</li> <li>\u4f7f\u7528 testdisk \u627e\u5230 <code>/dev/sdb</code> \u5206\u533a\u8868\uff0c\u5e76\u4e14\u5199\u5165\u6b63\u786e\u7684\u5206\u533a\u8868\u5230\u78c1\u76d8\u4e2d\u3002</li> <li>\u4f7f\u7528 <code>fdisk -l /dev/sdb</code> \u786e\u8ba4\u539f\u6765 LVM \u5728 <code>/dev/sdb</code> \u4e0a\u7684\u5206\u533a\u540d\uff0c\u5047\u8bbe\u662f <code>/dev/sdb2</code>\uff0c\u8fd0\u884c <code>dd if=/dev/zero of=/dev/sdb2 bs=1M count=1</code> \u64e6\u9664 LVM metadata\uff0c\u7136\u540e <code>pvcreate /dev/sdb2</code>, <code>vgextend pve /dev/sdb2</code> \u52a0\u5165\u5230\u73b0\u5728\u7684 LVM \u5377\u7ec4\u4e2d\u3002</li> <li><code>lvconvert -m1 pve/root</code>\uff0c\u8bbe\u7f6e rootfs \u4e3a RAID 1.</li> <li>\u6309\u7167 https://ibug.io/blog/2021/08/proxmox-disassemble-hardware-raid1/#fix-grub \u7684\u8bf4\u660e\u6302\u8f7d\u5fc5\u8981\u7684\u5377\uff0c\u7136\u540e <code>chroot</code> \u8fdb\u5165 rootfs\u3002\u5b89\u88c5 <code>grub-efi</code> \u540e\u8fd0\u884c <code>grub-install</code>\u3002\u8bf7\u786e\u4fdd LiveCD Debian \u548c\u7cfb\u7edf Debian \u7248\u672c\u5c3d\u53ef\u80fd\u4e00\u81f4\uff0c\u5426\u5219\u53ef\u80fd\u4f1a\u65e0\u6cd5\u5f15\u5bfc\u3002\uff08\u4f8b\u5982\uff0c\u4f7f\u7528 Debian 11 ISO \u8dd1 Debian 10 grub-install \u4f1a\u51fa\u73b0\u5173\u4e8e efi variables \u7684\u9519\u8bef\uff0c\u5bfc\u81f4\u5b89\u88c5\u5931\u8d25\uff09\u3002\u5982\u679c\u8fd8\u662f\u65e0\u6cd5\u5f15\u5bfc\uff0c<code>/dev/sda1</code> \u548c <code>/dev/sdb1</code> \u90fd\u5206\u522b\u6302\u5230 <code>/boot/efi</code>\uff0c\u7136\u540e\u8dd1 <code>grub-install</code> \u8bd5\u8bd5\u3002</li> </ol>"},{"location":"records/2021-08-21/#\u5347\u7ea7\u81f3-proxmox-ve-7","title":"\u5347\u7ea7\u81f3 Proxmox VE 7","text":"<p>PVE \u505a\u5f97\u5f88\u597d\uff0c\u5347\u7ea7\u8fc7\u7a0b\u8ddf Debian \u4f53\u9a8c\u5b8c\u5168\u4e00\u81f4\uff0c\u53ef\u4ee5\u53c2\u8003 Debian 10 \u5347\u7ea7\u5230 11 \u7684\u6587\u6863\u6a21\u4eff\u64cd\u4f5c\u3002</p> <p>\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u9700\u8981\u6ce8\u610f\u4e00\u4e9b\u914d\u7f6e\u6587\u4ef6\uff1a</p> <ul> <li><code>/etc/issue</code>\uff1a\u6b64\u6587\u4ef6\u6bcf\u6b21\u5f00\u673a\u65f6 Proxmox \u4f1a\u8986\u76d6\uff0c\u6240\u4ee5\u9009 Y \u548c N \u6ca1\u6709\u533a\u522b</li> <li> <p><code>/etc/ssh/sshd_config</code>\uff1aDebian 11 \u7684 <code>sshd_config</code> \u6587\u4ef6\u5305\u542b\u4e86\u4e00\u6761 <code>Include /etc/ssh/sshd_config.d/*.conf</code>\uff0c\u56e0\u6b64\u6211\u4eec\u7684\u81ea\u5b9a\u4e49\u8bbe\u7f6e\u4e5f\u79fb\u5230\u4e86 <code>sshd_config.d/vlab.conf</code>\uff0c\u4e3a\u4e86\u4ee5\u540e\u66f4\u65b0\u65b9\u4fbf\uff0c\u8fd9\u91cc\u53ef\u4ee5\u9009\u62e9\u8986\u76d6\uff08\u6ce8\u610f reload ssh \u524d\u628a <code>vlab.conf</code> \u51c6\u5907\u597d\uff09</p> <code>vlab.conf</code> \u6587\u4ef6 <pre><code>HostKey /etc/ssh/ssh_host_rsa_key\nHostCertificate /etc/ssh/ssh_host_rsa_key-cert.pub\nTrustedUserCAKeys /etc/ssh/ssh_user_ca\n\nPermitRootLogin prohibit-password\nPasswordAuthentication no\nAuthorizedKeysFile /dev/null\n</code></pre> </li> <li> <p><code>/etc/lvm/lvm.conf</code>\uff1a\u540c\u6837\u4e3a\u4e86\u4ee5\u540e\u66f4\u65b0\u65b9\u4fbf\uff0c\u9009\u62e9\u8986\u76d6\u3002\u6211\u4eec\u81ea\u5df1\u6dfb\u52a0\u7684\u3001\u6709\u7528\u7684\u8bbe\u7f6e\u662f\u8fd9\u4e24\u6761\uff0c\u8986\u76d6\u540e\u52a0\u56de\u53bb\u5373\u53ef\uff08\u6ce8\u610f\u6dfb\u52a0\u5230\u5408\u9002\u7684\u4f4d\u7f6e\uff0c<code>lvm.conf</code> \u662f\u5206 section \u7684\uff09</p> <pre><code>global_filter = [ \"r|/dev/disk/by-id/usb.*|\", \"r|/dev/zd.*|\", \"r|/dev/mapper/pve-.*|\" \"r|/dev/mapper/.*-(vm|base)--[0-9]+--disk--[0-9]+|\"]\n\nauto_activation_volume_list = [ \"pve\", \"data\" ]\n</code></pre> <p>\u4fee\u6539\u5b8c <code>lvm.conf</code> \u540e\u8bb0\u5f97\u8fd0\u884c <code>update-initramfs</code>\u3002</p> </li> </ul> <p>\u5176\u4ed6\u53ef\u4ee5\u8986\u76d6\uff0c\u80fd\u62c6\u5206\u51fa\u6765\u3001\u4e0d\u4fee\u6539\u5305\u7ba1\u7406\u5668\u63d0\u4f9b\u7684\u6587\u4ef6\u7684\u5c31\u5c3d\u91cf\u62c6\u51fa\u6765\uff0c\u4f8b\u5982\u628a sysctl \u8bbe\u7f6e\u653e\u8fdb <code>/etc/sysctl.d</code> \u91cc\u800c\u4e0d\u662f\u76f4\u63a5\u4fee\u6539 <code>sysctl.conf</code>\uff0c\u8bf8\u5982\u6b64\u7c7b\u3002</p>"},{"location":"records/2021-08-21/#\u66f4\u6362-apt-\u6e90\u81f3\u4e2d\u79d1\u5927\u955c\u50cf\u7ad9\u53ca\u7f29\u51cf\u7528\u6237\u78c1\u76d8\u7a7a\u95f4","title":"\u66f4\u6362 APT \u6e90\u81f3\u4e2d\u79d1\u5927\u955c\u50cf\u7ad9\u53ca\u7f29\u51cf\u7528\u6237\u78c1\u76d8\u7a7a\u95f4","text":"<p>\u66f4\u6362 APT \u6e90\u6bd4\u8f83\u7b80\u5355\uff0c\u6302\u8f7d\u78c1\u76d8\u7136\u540e\u8dd1\u4e00\u4e0b <code>sed</code> \u5373\u53ef\u3002</p> <p>\u540c\u65f6\u7531\u4e8e\u6211\u4eec\u4f7f\u7528 /opt/vlab \u6765\u63d0\u4f9b\u5404\u79cd\u5bb9\u91cf\u8f83\u5927\u7684\u5b9e\u9a8c\u8f6f\u4ef6\uff0c\u65b0\u865a\u62df\u673a\u7684\u78c1\u76d8\u4f7f\u7528\u91cf\u53ea\u6709\u4e0d\u5230 3.5 GB\uff0c\u56e0\u6b64\u6211\u4eec\u518d\u6b21\u5c06\u65b0\u865a\u62df\u673a\u7684\u78c1\u76d8\u5bb9\u91cf\u4e0b\u8c03\u5230 16 GB\u3002\u7531\u4e8e LVM \u7684\u7a7a\u95f4\u6bd4\u8f83\u7d27\u5f20\u4e86\uff08\u4f7f\u7528\u91cf &gt; 70%\uff09\uff0c\u6211\u4eec\u8fd8 retroactively \u5c06\u73b0\u6709\u5bb9\u5668\u7684\u78c1\u76d8\u7edf\u4e00\u7f29\u51cf\u3002\u7f29\u51cf\u65b9\u6848\u662f\u5b9e\u9645\u5360\u7528\u91cf\u5c0f\u4e8e 12 GB\uff0812288 MB\uff09\u7684\u7f29\u51cf\u4e3a 16 GB\uff0c\u5b9e\u9645\u5360\u7528\u91cf\u5c0f\u4e8e 24 GB \u7684\u7f29\u51cf\u4e3a 32 GB\uff0c\u5927\u4e8e 24 GB \u7684\u4e0d\u52a8\u3002</p> <p>\u7f29\u51cf\u78c1\u76d8\u7a7a\u95f4\u64cd\u4f5c\u6bd4\u8f83\u590d\u6742\uff0c\u5927\u81f4\u8fc7\u7a0b\u4e0e\u5904\u7406\u4e3b\u673a\u7684 rootfs \u4e00\u6837\uff0c\u5148 resize2fs \u5c0f\u4e00\u70b9\uff0c\u7136\u540e lvresize \u6539\u5206\u533a\uff0c\u518d resize2fs \u6269\u5145\u56de\u6765\u3002\u4f46\u662f\u51fa\u4e8e\u672a\u77e5\u539f\u56e0 e2fsck \u4f1a\u62a5\u4e0b\u9762\u8fd9\u4e2a\u9519\u8bef\uff0c\u56e0\u6b64\u64cd\u4f5c\u524d\u9700\u8981\u989d\u5916\u52a0\u4e00\u4e2a tune2fs\uff0c\u5177\u4f53\u8fc7\u7a0b\u89c1\u4e0b\u9644\u7684\u6279\u5904\u7406\u811a\u672c\u3002</p> <p>e2fsck: MMP: e2fsck being run while checking MMP block</p> \u4f7f\u7528\u7684 <code>change-repo.sh</code> \u811a\u672c <pre><code>#!/bin/bash\n\n[ -n \"$BASH_VERSION\" ] || exit 1\n\nwork() {\nlocal id=\"$1\"\nlocal param=\"$2\"\nlocal lv=user-data/vm-\"$id\"-disk-0\n  local conf=\"$(find /etc/pve/nodes -name \"$id.conf\")\"\nlocal mnt=/tmp/mnt-\"$id\"\nmkdir -p \"$mnt\"\nlocal list=\"$mnt\"/etc/apt/sources.list\n  echo \"******************** WORKING ON VM ID $id ($param remaining) ********************\"\nlvchange -y -ay \"$lv\"\ntune2fs -f -E clear_mmp /dev/\"$lv\"\n#e2fsck -y -f /dev/\"$lv\" || true\nmount /dev/\"$lv\" \"$mnt\"\nif [ -f \"$list\" ]; then\nsed -i 's/mirrors\\.tuna\\.tsinghua\\.edu\\.cn/mirrors.ustc.edu.cn/g' \"$list\" &amp;&amp;\necho \"Run sed on CT $id\"\nelse\necho \"CT $id does not contain /etc/apt/sources.list\"\nfi\nlocal size=\"$(df -BM --output=size \"$mnt\" | awk 'NR==2{print $1+0}')\"\nlocal used=\"$(df -BM --output=used \"$mnt\" | awk 'NR==2{print $1+0}')\"\necho \"Size of VM $id: ${used}M / ${size}M\"\numount \"$mnt\"\nif [ $used -gt 0 -a $used -lt 12288 ]; then\necho \"Shrinking VM $id to 16G\"\ntune2fs -f -E clear_mmp /dev/\"$lv\"\ne2fsck -y -f /dev/\"$lv\"\nresize2fs -p /dev/\"$lv\" 15G\n    lvresize -y -f -L 16G \"$lv\" || true\ntune2fs -f -E clear_mmp /dev/\"$lv\"\nresize2fs -p /dev/\"$lv\"\ntest -n \"$conf\" &amp;&amp; sed -i '/^rootfs:/s/size=[0-9]\\+G/size=16G/' \"$conf\"\nelif [ $used -ge 12288 -a $used -lt 24576 -a $size -gt 32768 ]; then\necho \"Shrinking VM $id to 32G\"\ntune2fs -f -E clear_mmp /dev/\"$lv\"\ne2fsck -y -f /dev/\"$lv\"\nresize2fs -p /dev/\"$lv\" 31G\n    lvresize -y -f -L 32G \"$lv\" || true\ntune2fs -f -E clear_mmp /dev/\"$lv\"\nresize2fs -p /dev/\"$lv\"\ntest -n \"$conf\" &amp;&amp; sed -i '/^rootfs:/s/size=[0-9]\\+G/size=32G/' \"$conf\"\nfi\nlvchange -y -an \"$lv\"\n}\n\ntotal=$(&lt;${1:-disks.txt} wc -l)\nfor id in $(&lt;\"${1:-disks.txt}\"); do\nwork \"$id\" \"$((total-=1))\"\ndone\n</code></pre> <p>\u5176\u4e2d\u751f\u6210 disks.txt \u7684\u4ee3\u7801\u5229\u7528\u4e86 <code>/etc/pve/.vmlist</code> \u8fd9\u4e2a\u53ea\u8bfb\u7684 JSON \u63a5\u53e3\uff1a</p> <pre><code>jq -r '.ids | with_entries(select((.key | tonumber &gt;= 1000) and (.value.type == \"lxc\"))) | keys | map(tonumber) | sort | .[]' /etc/pve/.vmlist &gt; disks.txt\n</code></pre>"},{"location":"records/2021-08-21/#\u5176\u4ed6","title":"\u5176\u4ed6","text":"<ul> <li>\u5c06\u7528\u6237\u5185\u7f51 VXLAN ID \u6539\u4e3a 1\uff08\u539f\u6765\u662f 10\uff0c\u56e0\u4e3a\u521b\u5efa\u7684\u547d\u4ee4\u662f\u7f51\u4e0a\u968f\u4fbf\u6284\u6765\u7684\uff09\uff0c\u5bf9\u5e94\u754c\u9762\u540d\u79f0\u6539\u4e3a vxlan1\uff0c\u65b9\u4fbf\u8bc6\u522b\u548c\u8fa8\u8ba4</li> <li>\u5c06\u5185\u90e8\u8bbe\u65bd\u4f7f\u7528\u7684\u7ba1\u7406\u7f51\u7edc\u5212\u5206\u51fa\u4e00\u4e2a\u5355\u72ec\u7684 VXLAN\uff08ID 2\uff09\uff0c\u547d\u540d\u4e3a vxlan2\uff0c\u6865\u63a5\u4e3a vmbr2\uff08IP \u5730\u5740\u662f 172.30.0.1/24 \u6ca1\u53d8\uff09</li> </ul>"},{"location":"records/2021-08-28/","title":"2021 \u5e74 8 \u6708 28 \u65e5\u5de5\u4f5c\u603b\u7ed3","text":"<p>\u672c\u5468\u672b\u7684\u5de5\u4f5c\u662f\u89e3\u51b3 <code>vzdump</code> \u5907\u4efd\u7684\u76f8\u5173\u95ee\u9898\u3002\u5728 8 \u6708 21 \u65e5\u540e\uff0c\u6211\u4eec\u53d1\u73b0\u6bcf\u5468\u5907\u4efd\u5f00\u59cb\u51fa\u73b0\u95ee\u9898\u3002</p>"},{"location":"records/2021-08-28/#\u5bb9\u5668\u5907\u4efd\u9519\u8bef","title":"\u5bb9\u5668\u5907\u4efd\u9519\u8bef","text":"<p>\u51fa\u73b0\u7684\u9519\u8bef\u7c7b\u4f3c\u4e8e <code>command 'rsync ...' failed: exit code 11</code>\u3002</p> <p>\u89e3\u51b3\u65b9\u6cd5\uff1a<code>vzdump</code> \u4f1a\u5148 rsync \u5bb9\u5668\u7684 rootfs \u5230 <code>/var/tmp</code>\uff0c\u800c\u5728\u7f29\u51cf\u4e3b\u673a rootfs \u7684\u5927\u5c0f\u4e4b\u540e\uff0c\u5269\u4f59\u7a7a\u95f4\u4e0d\u8db3\u4ee5\u627f\u8f7d\u5bb9\u5668\u7684 rootfs\u3002\u6240\u4ee5\u65b0\u5f00\u4e00\u4e2a LVM \u5377\u6302\u8f7d\u5230 <code>/var/tmp</code>\u3002</p> <p>tmpfs \u65e0\u6cd5\u89e3\u51b3\u95ee\u9898</p> <p>\u5bb9\u5668\u91cc Docker overlay \u9700\u8981 userxattr\uff0ctmpfs \u4e0d\u652f\u6301\u8fd9\u4e2a\u7279\u6027\uff0c\u4f1a\u5bfc\u81f4\u5907\u4efd\u5931\u8d25\u3002</p>"},{"location":"records/2021-08-28/#kvm-\u865a\u62df\u673a\u5907\u4efd\u9519\u8bef","title":"KVM \u865a\u62df\u673a\u5907\u4efd\u9519\u8bef","text":"<p>\u51fa\u73b0\u7684\u9519\u8bef\u7c7b\u4f3c\u4e8e <code>job failed with err -5 - Input/output error</code>\u3002\u9605\u8bfb\u4e3b\u673a dmesg\uff0c\u4f1a\u53d1\u73b0\u5927\u91cf <code>connection1:0: detected conn error (1020)</code>\uff0c\u4ee5\u53ca\u6807\u7ea2\u7684 ext4/\u5757\u8bbe\u5907 I/O error \u95ee\u9898\u3002\u6d4b\u8bd5\u53d1\u73b0\u5907\u4efd\u4f1a\u5bfc\u81f4 iSCSI \u95f4\u63a5\u6027\u65ad\u8fde\uff0c\u8bf1\u53d1 I/O error\uff0cI/O error \u6709\u5927\u6982\u7387\u5bfc\u81f4\u4e3b\u673a\u4e0a\u7684\u5bb9\u5668/KVM \u865a\u62df\u673a\u78c1\u76d8\u8fdb\u5165 readonly \u72b6\u6001\u3002</p> <p>\u5468\u672b\u4e24\u5929\u57fa\u672c\u4e0a\u90fd\u5728\u6392\u67e5\u8fd9\u4e2a\u95ee\u9898\uff0c\u76ee\u524d\uff082021/8/30 \u51cc\u6668\uff09\uff0c\u6211\u4eec\u5f97\u5230\u7684\u7ed3\u8bba\u5982\u4e0b\uff1a</p> <ul> <li>\u8fd9\u4e2a\u95ee\u9898\u662f\u5728\u96c6\u7fa4\u5347\u7ea7\u5230 PVE 7 \u540e\u4ea7\u751f\u7684\u3002\u6700\u65e9\u51fa\u73b0\u95ee\u9898\u7684\u8bb0\u5f55\u5728 8 \u6708 21 \u65e5\u51cc\u6668 01:08\u3002</li> <li>\u5982\u679c\u5c06\u865a\u62df\u673a\u8fc1\u79fb\u5230 pvg1, pvg2 \u4e0a\uff0c\u90a3\u4e48\u4e0d\u4f1a\u51fa\u73b0\u6b64\u95ee\u9898\u3002pvg[1-2] \u4e0e pv[1-8] \u7684\u533a\u522b\u9664\u4e86\u591a\u4e86 GPU\uff0c\u5149\u7f51\u5361\u7684\u578b\u53f7\u4e5f\u4e0d\u540c\u3002pv \u4f7f\u7528\u7684\u7f51\u5361\u662f Intel X710-DA2\uff0cpvg \u7684\u7f51\u5361\u662f Broadcom NetXtreme II BCM57810\u3002</li> <li>\u5728\u5176\u4ed6\u8f6f\u4ef6\u7248\u672c\u4e0d\u53d8\u60c5\u51b5\u4e0b\uff0cLinux 5.4 (PVE 6 kernel) \u6bd4 Linux 5.10 \u6709\u53ef\u80fd\u66f4\u7a33\u5b9a\uff08\u4e0d\u6267\u884c\u5907\u4efd\u4efb\u52a1\u65f6\u4e0d\u4f1a\u51fa\u9519\uff09\uff0c\u4f46\u662f\u6267\u884c\u5907\u4efd\u4efb\u52a1\u65f6\u4ecd\u7136\u4f1a\u51fa\u73b0\u95ee\u9898\u3002</li> <li>\u964d\u7ea7 <code>open-iscsi</code> \u65e0\u6548\u3002</li> <li>\u5347\u7ea7\u5b58\u50a8\u670d\u52a1\u5668\u56fa\u4ef6\u3001\u5347\u7ea7 pv8 \u7684 Intel \u7f51\u5361\u56fa\u4ef6\u5747\u65e0\u6548\u3002</li> <li><code>pve-qemu-kvm</code> \u4ece <code>6.0.0-3</code> \u964d\u7ea7\u5230 <code>5.2.0-6</code> \u4e4b\u540e\uff0c\u5907\u4efd\u4efb\u52a1\u6267\u884c\u65f6\u4e0d\u518d\u51fa\u73b0 I/O error\uff0c\u4f46\u662f\u4ecd\u7136\u6709\u53ef\u80fd\u51fa\u73b0 <code>conn error</code>\u3002</li> <li>\u5bf9\u865a\u62df\u78c1\u76d8\u6307\u5b9a <code>aio=io_uring</code>, <code>aio=native</code> \u6216 <code>aio=threads</code> \u5747\u65e0\u6548\u3002</li> <li>\u9650\u5236 <code>vzdump</code> \u7684\u5e26\u5bbd\u6709\u53ef\u80fd\u80fd\u51cf\u5c11 <code>conn error</code> \u51fa\u73b0\u7684\u6b21\u6570\uff0c\u4f46\u662f\u5728 pv1 \u548c pv8 \u4e0a\u6d4b\u8bd5\u7684\u7ed3\u679c\u4e0d\u592a\u4e00\u6837\u3002</li> </ul> <p>\u76ee\u524d\u7684\u4e34\u65f6\u89e3\u51b3\u65b9\u6848\uff1a</p> <ul> <li>pv1, pv8 \u7684 <code>pve-qemu-kvm</code> \u964d\u7ea7\u5230\u4e86 <code>5.2.0-6</code>\u3002\u5176\u4ed6\u8f6f\u4ef6\uff08\u5305\u62ec\u5185\u6838\uff09\u7248\u672c\u4e0d\u53d8\u3002</li> <li>pbs \u865a\u62df\u673a\u8fc1\u79fb\u5230 pvg1\u3002</li> </ul>"},{"location":"records/2021-09-20/","title":"2021 \u5e74 9 \u6708 20 \u65e5\u5de5\u4f5c\u603b\u7ed3","text":"<p>\u8d77\u56e0\uff1a\u901a\u8fc7 PVE \u7684 Web \u754c\u9762\u67e5\u770b\u96c6\u7fa4\u72b6\u6001\uff0c\u53d1\u73b0 pv4 \u7684\u72b6\u6001\u4e3a\u95ee\u53f7\uff0c\u7cfb\u7edf\u8fd0\u884c\u6307\u6807\uff08CPU\u3001\u5185\u5b58\u7b49\uff09\u6298\u7ebf\u56fe\u65e0\u6cd5\u663e\u793a\uff0c\u5404\u79cd\u865a\u62df\u673a\u64cd\u4f5c\u5927\u91cf\u8d85\u65f6\u3002</p> <p>SSH \u767b\u5f55 pv4 \u540e\u5148\u5c1d\u8bd5\u8fd0\u884c <code>apt upgrade</code>\uff0c\u5728\u66f4\u65b0\u5185\u6838\u65f6\u5361\u5728 <code>/etc/kernel/postinst.d/zz-update-grub</code> \u4e00\u884c\uff0c\u8fdb\u4e00\u6b65\u6392\u67e5\u53d1\u73b0 <code>grub-probe</code> \u5361\u4f4f\uff0c<code>lvs user-data</code> \u51fa\u73b0 <code>giving up waiting for lock</code>\uff0c\u6700\u7ec8\u67e5\u5230 iSCSI \u5b58\u50a8\u6389\u7ebf\uff08\u4f46\u662f\u8fc7\u4e86\u4e00\u4f1a\u5b83\u53c8\u81ea\u5df1\u6062\u590d\u4e86\uff09\u3002</p> <p>\u8003\u8651\u5230\u4e0d\u5230\u4e00\u4e2a\u6708\u524d\u624d\u51fa\u73b0\u8fc7\u7531\u865a\u62df\u673a\u5907\u4efd\u89e6\u53d1\u7684 iSCSI \u9519\u8bef\uff0c\u6211\u4eec\u7ee7\u7eed\u68c0\u67e5\u4e86 iSCSI \u4e0e\u7f51\u7edc\u95ee\u9898\u3002</p> <p>\u6211\u4eec\u5728 user-data \u4e2d\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u5377\u7528\u4e8e\u6d4b\u8bd5\u4e3b\u673a\u5230 iSCSI \u7684\u8fde\u63a5\u5e26\u5bbd\u4e0e\u7a33\u5b9a\u6027\uff0c\u53d1\u73b0\u4ece\u5b58\u50a8\u8bfb\u53d6\u65f6\u901f\u5ea6\u5f88\u6162\u4e14\u4e0d\u7a33\u5b9a\uff0c\u4f46\u662f\u5199\u5165\u5b58\u50a8\u7684\u8fde\u63a5\u5f88\u6b63\u5e38\u3002\u8c03\u8bd5\u540e\u53d1\u73b0\u5c06\u4e3b\u673a\u7684\u5149\u7ea4\u7f51\u53e3\u7684 MTU \u4ece 1550 \u8c03\u6574\u81f3 9000 \u5e76\u91cd\u542f\u540e\uff0c\u53ef\u4ee5\u6062\u590d\u6b63\u5e38\u3002\u4e4b\u540e\u5c06\u7ec4\u7ec7\u65f6\u95f4\u4fee\u6539\u6240\u6709\u4e3b\u673a\u7684 MTU \u8bbe\u7f6e\u3002</p>"},{"location":"records/2021-10-31/","title":"2021 \u5e74 10 \u6708 31 \u65e5\u5de5\u4f5c\u603b\u7ed3","text":"<p>\u4eca\u65e5\u53d1\u73b0 pv4 \u4e0e pv5 \u5185\u5b58\u5360\u7528\u8f83\u591a\uff0c\u68c0\u67e5\u8fdb\u7a0b\u540e\u53d1\u73b0 blueman \u76f8\u5173\u8fdb\u7a0b\u5360\u7528\u989d\u5916\u5185\u5b58\u8f83\u591a\uff0c\u53ef\u80fd\u662f\u5728\u5bb9\u5668\u955c\u50cf\u6253\u5305\u65f6\u672a\u5220\u9664\u3002\u6211\u4eec\u5728\u8fd9\u4e24\u53f0\u673a\u5668\u4e0a\u5bf9\u6b63\u5728\u8fd0\u884c\u7684\u5bb9\u5668\u6267\u884c\u4e86\u4ee5\u4e0b\u7684\u547d\u4ee4\uff1a</p> <pre><code>pct list | awk '$2==\"running\"{print $1}' | xargs -I xxx pct exec xxx -- dpkg -P blueman\n</code></pre> <p>\u5220\u9664\u4e86 blueman\uff0c\u5e76\u4e14\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u7ed3\u675f\u76f8\u5173\u8fdb\u7a0b\uff1a</p> <pre><code>killall blueman-tray\nkillall blueman-applet\n</code></pre> <p>\u4e4b\u540e\u9700\u8981\u627e\u65f6\u95f4\u68c0\u67e5\u76f8\u5173\u955c\u50cf\u3002</p>"},{"location":"records/2021-12-20/","title":"2021 \u5e74 12 \u6708 20 \u65e5\u5de5\u4f5c\u603b\u7ed3","text":"<p>\u6628\u65e5\u4e0b\u5348\u6709\u540c\u5b66\u53cd\u9988\u81ea\u5df1\u7684 Vivado \u9879\u76ee\u5728 Vlab \u4e0a\u751f\u6210\u6bd4\u7279\u6d41\u65f6\u603b\u662f\u5931\u8d25\u3002\u6628\u65e5\u665a\u4e0e\u4eca\u65e5\u51cc\u6668\u5bf9\u8be5\u95ee\u9898\u8fdb\u884c\u4e86\u6392\u67e5\u3002</p> <p>\u9996\u5148\u53d1\u73b0\u8be5\u95ee\u9898\u786e\u5b9e\u5b58\u5728\uff0cVivado \u8f93\u51fa\u7684\u5d29\u6e83\u65f6\u9519\u8bef\u6808\u5f00\u5934\u4e00\u90e8\u5206\u5982\u4e0b\uff1a</p> <pre><code>Stack:\n/lib/x86_64-linux-gnu/libc.so.6(+0x46210) [0x7f3cc17f8210]\n/lib/x86_64-linux-gnu/libc.so.6(malloc_usable_size+0x48) [0x7f3cc1851378]\n/lib/x86_64-linux-gnu/libudev.so.1(+0x10319) [0x7f3c77539319]\n/lib/x86_64-linux-gnu/libudev.so.1(+0x167c4) [0x7f3c7753f7c4]\n/lib/x86_64-linux-gnu/libudev.so.1(+0x1b255) [0x7f3c77544255]\n/lib/x86_64-linux-gnu/libudev.so.1(+0x1b4bb) [0x7f3c775444bb]\n/lib/x86_64-linux-gnu/libudev.so.1(udev_enumerate_scan_devices+0x277) [0x7f3c77546d67]\n</code></pre> <p>\u5c1d\u8bd5\u4f7f\u7528 Ubuntu 18.04 Docker \u8fd0\u884c Vivado\uff0c\u751f\u6210\u6b63\u5e38\u3002\u5728\u68c0\u7d22\u76f8\u5173\u8d44\u6599\u540e\uff0c\u6211\u4eec\u8ba4\u4e3a\u8be5\u95ee\u9898\u53ef\u80fd\u662f Ubuntu 20.04 \u7684 libudev.so \u4e0e Vivado 2019.1 \u4e0d\u517c\u5bb9\u5bfc\u81f4\u7684\uff0c\u6216\u4e3a libudev \u5728 LXC \u5bb9\u5668\u4e2d\u89e6\u53d1\u4e86\u67d0\u4e9b corner case\u3002\u5c06 Ubuntu 18.04 \u7684 libudev.so \u63d0\u53d6\u540e\uff0c\u52a0\u5165 <code>LD_PRELOAD</code> \u4e2d\uff0c\u518d\u6b21\u8fd0\u884c Vivado\uff0c\u751f\u6210\u6b63\u5e38\u3002</p> <p>\u76f8\u5173\u4fee\u6539\u5df2\u7ecf\u90e8\u7f72\u5230 Vlab Software \u4e2d\u3002</p>"},{"location":"records/2022-01-26/","title":"2022 \u5e74 1 \u6708 26 \u65e5\u5de5\u4f5c\u603b\u7ed3","text":"<p>\u4eca\u65e5\u8fdb\u884c\u4e86\u505c\u673a\u7ef4\u62a4\uff0c\u64cd\u4f5c\u5185\u5bb9\u5982\u4e0b\uff1a</p> <ol> <li>\u66f4\u65b0\u4e86\u6240\u6709\u8282\u70b9\u7684 Linux \u5185\u6838\u7248\u672c\uff0c\u4ee5\u4fee\u590d CVE-2022-0185 \u5b89\u5168\u6f0f\u6d1e\u3002</li> <li>\u4e3a\u6240\u6709\u5b66\u751f\u5bb9\u5668\u8c03\u6574\u4e86\u4ee5\u4e0b\u914d\u7f6e\uff1a<ol> <li>\u91cd\u65b0\u8bbe\u7f6e\u4e86\u7528\u6237 CA \u8bc1\u4e66\uff0c\u4ee5\u53ca\u76f8\u5e94\u7684\u914d\u7f6e\u9879\uff1b</li> <li>\u8c03\u6574\u4e86 apparmor \u8bbe\u7f6e\uff0c\u4fee\u6b63 tcpdump \u65e0\u6cd5\u6b63\u5e38\u4f7f\u7528\u7684\u95ee\u9898\uff1b</li> <li>\u6dfb\u52a0\u4e86 Vlab \u8f6f\u4ef6\u6e90\uff1b</li> <li>\u5220\u9664\u4e86\u5bb9\u5668\u684c\u9762\u73af\u5883\u4e0d\u9700\u8981\u7684\u8f6f\u4ef6\u5305\u3002</li> </ol> </li> <li>\u5c1d\u8bd5\u4e3a\u5b66\u751f\u5bb9\u5668\u4fee\u590d Policykit-1 \u7684\u672c\u5730\u63d0\u6743\u6f0f\u6d1e\uff0c\u4f46\u662f\u7531\u4e8e <code>apt update</code> \u64cd\u4f5c\u8fc7\u6162\uff0c\u4e2d\u9014\u653e\u5f03\u4e86\u672c\u9879\u76ee\u3002</li> </ol> <p>\u64cd\u4f5c\u811a\u672c\u5982\u4e0b\uff1a</p> <pre><code>#!/bin/bash\n\n[ -n \"$BASH_VERSION\" ] || exit 1\n\ngen_sh() {\ncat &lt;&lt; EOFX\necho 'ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1MjEAAACFBAH3ZHisQY0iMpUNDQNaxcnRSqDbauE8ih6/MrEENJZa7FHKINOPi+bunK1wEXPqlKfu8INEBWCf95+t86z+jXVxmQE176xenS92wiLvR4MZyCBfD5DXAB0mK5iV1eQug5P/cD8Pohr/3wywFbKgKzsix9unky9sJGr86RunSwJbAkMGlw==' &gt; /etc/ssh/ssh_user_ca\nmkdir -p /etc/ssh/sshd_config.d/\ncat &gt; /etc/ssh/sshd_config.d/vlab_ca.conf &lt;&lt; EOF\nTrustedUserCAKeys /etc/ssh/ssh_user_ca\nAuthorizedPrincipalsCommand /usr/bin/printf 'root\\n%u\\n'\nAuthorizedPrincipalsCommandUser nobody\nEOF\nchown 0.0 /etc/ssh/ssh_user_ca /etc/ssh/sshd_config.d/vlab_ca.conf\nmv /etc/apparmor.d/usr.sbin.tcpdump /etc/apparmor.d/disable/\n\nif [ -d /etc/apt/sources.list.d ]; then\n  echo \"deb [trusted=yes] https://vlab.ustc.edu.cn/repo/ ./\" &gt; /etc/apt/sources.list.d/vlab.list\nfi\n\ndpkg -P blueman brltty brltty-x11 sbsigntool secureboot-db speech-dispatcher speech-dispatcher-espeak-ng orca libespeak-ng1 espeak-ng-data gir1.2-gstreamer-1.0 gir1.2-nm-1.0 libao-common libao4 libatk-adaptor libbluetooth3 libbrlapi0.7 libdotconf0 libnm0 libpcaudio0 libpcre2-32-0 libsonic0 libspeechd2 python3-brlapi python3-louis python3-pyatspi python3-speechd sound-icons speech-dispatcher-audio-plugins xbrlapi\n#apt update\n#apt-get install -y --only-upgrade policykit-1 sudo\n\nsystemctl disable cups-browsed.service\nEOFX\n}\n\nwork() {\nlocal id=\"$1\"\nlocal param=\"$2\"\nlocal lv=user-data/vm-\"$id\"-disk-0\n  local mnt=/tmp/mnt-\"$id\"\nmkdir -p \"$mnt\"\necho \"******************** WORKING ON VM ID $id ($param remaining) ********************\"\nlvchange -y -ay \"$lv\"\nmount /dev/\"$lv\" \"$mnt\"\n\ngen_sh &gt; \"$mnt\"/tmp/work.sh\n  # generate /dev/null for \"$mnt\"\nrm -f \"$mnt\"/dev/null\n  mknod \"$mnt\"/dev/null c 1 3\nchmod 666 \"$mnt\"/dev/null\n  lxc-usernsexec -- chroot \"$mnt\" bash /tmp/work.sh\n  rm \"$mnt\"/tmp/work.sh\n  umount \"$mnt\"\nlvchange -y -an \"$lv\"\n}\n\ntotal=$(&lt;\"${1:-disks.txt}\" wc -l)\nfor id in $(&lt;\"${1:-disks.txt}\"); do\nwork \"$id\" \"$((total-=1))\"\ndone\n</code></pre> <p>\u811a\u672c\u5185\u5bb9\u4e0e\u5148\u524d <code>change-repo.sh</code> \u7c7b\u4f3c\u3002\u6709\u4e00\u4e9b\u4e0d\u540c\u7684\u5730\u65b9\uff1a</p> <ul> <li>\u5728\u6700\u5f00\u59cb\u7684\u65f6\u5019\uff0c\u6211\u4eec\u53d1\u73b0\u6dfb\u52a0\u8f6f\u4ef6\u6e90\u540e <code>chroot</code> \u540e <code>apt update</code> \u53ef\u80fd\u4f1a\u5361\u6b7b\u5728 <code>Waiting for header</code> \u63d0\u793a\u4e2d\u3002\u8c03\u8bd5\u7ea6\u4e00\u4e2a\u534a\u5c0f\u65f6\u540e\u53d1\u73b0\u5176\u4f9d\u8d56 <code>/dev/null</code>\u3002\u4e8e\u662f\u811a\u672c\u4f7f\u7528 <code>chroot</code> \u64cd\u4f5c\u524d\u540e\u6dfb\u52a0\u4e86 <code>/dev/null</code> \u7684\u76f8\u5173\u64cd\u4f5c\uff1b</li> <li><code>lxc-usernsexec</code> \u7528\u4e8e\u786e\u4fdd UID \u7684\u6620\u5c04\u6b63\u786e\uff08\u5b9e\u9645\u4ee5\u5bb9\u5668\u91cc\u7684 root \u7684\u8eab\u4efd\u6267\u884c\u7ef4\u62a4\u811a\u672c\uff09\uff1a\u5bb9\u5668\u91cc\u7684 root \u4e8b\u5b9e\u4e0a\u662f 100000 \u53f7\u7528\u6237\uff0c\u76f4\u63a5\u4ee5 host \u7684 root \u8eab\u4efd\u5199\u5165\u4f1a\u51fa\u73b0\u6743\u9650\u95ee\u9898\u3002</li> </ul> <p>\u524d\u671f\u5de5\u4f5c\uff1a2021 \u5e74 8 \u6708 21 \u65e5</p>"},{"location":"records/2022-06-16/","title":"2022 \u5e74 6 \u6708 16 \u65e5\u5de5\u4f5c\u603b\u7ed3","text":"<p>\u4eca\u5929\u6211\u4eec\u7d27\u6025\u5904\u7406\u4e86 LVM metadata \u5df2\u6ee1\u5bfc\u81f4\u65e0\u6cd5\u65b0\u521b\u5efa\u865a\u62df\u673a\u7684\u95ee\u9898\u3002</p> <p>LVM \u7684 metadata \u9ed8\u8ba4\u5b58\u50a8\u5728\u6bcf\u4e2a PV \u7684\u5f00\u5934\u4e0e\u7ed3\u5c3e\u5904\uff08\u4e24\u4efd\uff09\uff0c\u5e76\u4e14 metadata \u7684\u683c\u5f0f\u662f ASCII\u3002\u5f53 metadata area\uff08MDA\uff09\u4e0d\u8db3\u4ee5\u52a0\u5165\u65b0\u7684\u6570\u636e\u65f6\uff0c\u5c31\u4f1a\u51fa\u73b0\u65e0\u6cd5\u65b0\u5efa LV \u7b49\u60c5\u51b5\u3002</p> <p>\u5728 <code>pvcreate</code> \u65f6\uff0cMDA \u7684\u5927\u5c0f\u9ed8\u8ba4\u4e3a 1 MB\uff0c\u6ce8\u610f\u6211\u4eec\u9700\u8981\u5b58\u4e24\u4efd\uff0c\u56e0\u6b64\u5b9e\u9645\u53ef\u7528\u7684\u7a7a\u95f4\u662f 510K\u3002\u8fd9\u5bf9\u4e8e\u9700\u8981\u4e0a\u5343\u4e2a LV \u7684\u573a\u5408\u800c\u8a00\u662f\u4e0d\u8db3\u7684\u3002\u7531\u4e8e LVM \u8fd9\u79cd\u56fa\u5b9a\u5206\u914d\u7684\u8bbe\u8ba1\uff0c\u6211\u4eec\u65e0\u6cd5\u4fee\u6539 PV MDA \u7684\u5927\u5c0f\uff0c\u56e0\u6b64\u4e3a\u4e86\u5904\u7406\u6b64\u95ee\u9898\uff0c\u6211\u4eec\u53ea\u80fd\u591f\u91c7\u53d6\u4ee5\u4e0b\u7684\u63aa\u65bd\uff1a</p> <ol> <li>\u5220\u9664\u5c11\u91cf LV\uff0c\u4f7f\u5f97 MDA \u6709\u5c11\u91cf\u7684\u7a7a\u95f4\u53ef\u4ee5\u8bb0\u5f55\u5728 VG \u4e2d\u52a0\u5165\u65b0\u76d8\u7684\u4fe1\u606f\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\u5220\u6389\u4e00\u4e2a\u5c31\u591f\u4e86\uff08\u4e5f\u53ef\u4ee5\u5c06\u5176\u79fb\u52a8\u81f3\u5176\u4ed6 VG \u4e2d\uff09\u3002</li> <li>\u6dfb\u52a0\u4e00\u5757\u5c0f\u76d8\uff081G\uff0c\u5b58\u50a8\u670d\u52a1\u5668\u66b4\u9732\u4e00\u4e2a\u5c0f LUN\uff09\uff0c\u5728\u5404\u8282\u70b9\u4e0a\u8fd0\u884c <code>iscsiadm -m session --rescan</code>\uff0c\u65e0\u987b\u505c\u673a\u6216\u4e2d\u65ad\u4efb\u4f55\u670d\u52a1\u3002</li> <li><code>pvcreate --metadatasize 64m /dev/XXX</code></li> <li>\u5c06\u65b0\u76d8\u52a0\u5165 VG \u4e2d\uff08<code>vgextend</code>\uff09\u3002</li> <li>\u8bbe\u7f6e\u539f\u78c1\u76d8 <code>metadataignore</code> \u4e3a <code>y</code>\uff0c\u4f7f\u5f97 metadata \u4ec5\u5b58\u50a8\u4e8e\u65b0\u7684 MDA \u8db3\u591f\u5927\u7684\u5c0f\u76d8\u4e0a\u3002</li> </ol> <p>\u6545\u969c\u4e8e\u5f53\u65e5 15:30 \u88ab\u53cd\u9988\uff0c\u5e76\u4e8e\u7ea6 22:30 \u4fee\u590d\u5b8c\u6210\u3002</p> <p>\u5728\u5b58\u50a8\u670d\u52a1\u5668\u4e0a\u521b\u5efa\u65b0 LUN \u7684\u6ce8\u610f\u4e8b\u9879</p> <p>\u6240\u6709 Virtual Disk \u7684 LUN \u7f16\u53f7\u5fc5\u987b\u552f\u4e00\uff0c\u5426\u5219\u65b0\u5efa\u7684 LUN \u65e0\u6cd5\u88ab\u670d\u52a1\u5668\u68c0\u6d4b\u5230\uff0c\u751a\u81f3\u53ef\u80fd\u5728\u670d\u52a1\u5668\u91cd\u542f\u65f6\u4ea7\u751f\u9519\u4e71\u3002</p>"},{"location":"records/2022-09-20/","title":"2022 \u5e74 9 \u6708 20 \u65e5\u5de5\u4f5c\u603b\u7ed3","text":"<p>\u8fd1\u65e5\u4e3b\u8981\u5b8c\u6210\uff1a</p> <ul> <li>\u521b\u5efa\u5bb9\u5668\u7684\u540e\u5904\u7406\u64cd\u4f5c\uff08post creation\uff09\u4ece\u521b\u5efa\u65f6\u79fb\u81f3\u9996\u6b21\u542f\u52a8\uff0c\u8fd9\u4f7f\u5f97\u521b\u5efa\u5bb9\u5668\u7684\u7528\u6237\u4f53\u9a8c\u5927\u5e45\u63d0\u5347\u3002</li> <li>\u7528\u6237\u53cd\u9988\u9700\u8981\u4ece Vlab \u5bb9\u5668\u4f7f\u7528 Forticlient \u8fde\u63a5\u81f3\u5176\u4ed6\u79d1\u7814\u673a\u6784\uff0c\u5bf9\u76f8\u5173\u64cd\u4f5c\u505a\u4e86\u652f\u6301\u3002</li> </ul> <p>\u5173\u4e8e\u540e\u8005\uff1a</p> <ul> <li>Forticlient \u7684\u56fe\u5f62\u754c\u9762\u65e0\u6cd5\u4f7f\u7528\uff0c\u539f\u56e0\u4e0d\u660e\u3002\u9700\u8981\u4f7f\u7528\u5176\u9644\u5e26\u7684\u547d\u4ee4\u884c\u5de5\u5177\u8fde\u63a5\u3002</li> <li>\u9700\u8981\u5411\u5bb9\u5668\u66b4\u9732 /dev/net/tun \u8bbe\u5907\u3002<ul> <li>Vlab software \u6587\u4ef6\u5939\u5df2\u6dfb\u52a0 tun \u8bbe\u5907\u6587\u4ef6\uff0c\u53ef\u4ee5\u4ece\u5bb9\u5668\u5728\u5bf9\u5e94\u4f4d\u7f6e\u521b\u5efa\u8f6f\u94fe\u63a5\u6307\u5411\uff1b</li> <li>\u9700\u8981\u8bbe\u7f6e\u5bb9\u5668\u7684 lxc \u5c5e\u6027\uff1a<code>lxc.cgroup2.devices.allow: c 10:200 rwm</code></li> <li>\u8bbe\u7f6e\u540e\u542f\u52a8\u5bb9\u5668\uff0c\u5982\u679c\u4ee5\u5bb9\u5668\u5185 root cat \u65f6\u663e\u793a <code>File descriptor in bad state</code>\uff0c\u5219\u53ef\u4ee5\u8ba4\u4e3a\u8bbe\u7f6e\u6210\u529f</li> <li>\u53c2\u8003\u8d44\u6599</li> </ul> </li> <li>\u8fde\u63a5\u540e forticlient \u65e0\u6cd5\u6b63\u786e\u4fee\u6539 /etc/resolv.conf \u6587\u4ef6\uff0c\u9700\u8981\u6bcf\u6b21\u8fde\u63a5\u540e\u624b\u52a8\u6dfb\u52a0 <code>nameserver</code> \u9879\u3002</li> </ul>"},{"location":"records/2022-11-21/","title":"2022 \u5e74 11 \u6708 21 \u65e5\u5de5\u4f5c\u603b\u7ed3","text":"<p>\u8d77\u56e0\uff1a\u6709\u5b66\u751f\u53cd\u9988\u5bb9\u5668\u542f\u52a8\u7a0b\u5e8f\u8f83\u6162\uff0c\u7ef4\u62a4\u4eba\u5458\u53d1\u73b0 <code>iowait</code> \u8f83\u9ad8\uff0c\u968f\u540e\u53d1\u73b0\u5b58\u50a8\u9635\u5217\u7ba1\u7406\u754c\u9762\u65e0\u6cd5\u767b\u5f55\u3002</p> <p>\u4eca\u65e5\u8fdb\u884c\u4e86\u505c\u673a\u7ef4\u62a4\uff0c\u64cd\u4f5c\u5185\u5bb9\u5982\u4e0b\uff1a</p> <ol> <li>\u767b\u51fa\u6240\u6709 iSCSI \u4f1a\u8bdd\uff0c\u91cd\u7f6e\u5b58\u50a8\u9635\u5217\u8ba4\u8bc1\u51ed\u636e\u5e76\u91cd\u542f\u9635\u5217\uff1b</li> <li>\u4fee\u6539\u5bb9\u5668 user namespace idmap \u8303\u56f4\u4ee5\u652f\u6301 rootless podman\uff1b</li> <li>\u66f4\u65b0\u6240\u6709\u4e3b\u673a\u8282\u70b9\u8f6f\u4ef6\u5305\u3002</li> </ol>"},{"location":"records/2022-11-21/#\u767b\u51fa-iscsi-\u4f1a\u8bdd\u8fc7\u7a0b","title":"\u767b\u51fa iSCSI \u4f1a\u8bdd\u8fc7\u7a0b","text":"<ol> <li>\u9996\u5148\u505c\u6b62\u6240\u6709\u5b66\u751f\u5bb9\u5668\u53ca\u5176\u4ed6\u4f9d\u8d56\u4e8e\u5b58\u50a8\u9635\u5217\u7684\u670d\u52a1\uff1b</li> <li>\u5728\u5404\u8282\u70b9\u8fd0\u884c <code>iscsiadm -m node -T &lt;target-name&gt; -U all</code> \u767b\u51fa iSCSI \u4f1a\u8bdd\uff1b</li> <li>\u5728\u5404\u8282\u70b9\u8fd0\u884c <code>iscsiadm -m session -P 3</code> \u786e\u8ba4\u4f1a\u8bdd\u6210\u529f\u767b\u51fa\u3002</li> </ol> <p>\u6ce8\uff1a\u505c\u6b62 <code>iscsid.service</code> \u5e76\u4e0d\u4f1a\u767b\u51fa iSCSI \u4f1a\u8bdd\u3002</p>"},{"location":"records/2022-11-21/#\u4fee\u6539\u5bb9\u5668-user-namespace-idmap-\u8303\u56f4","title":"\u4fee\u6539\u5bb9\u5668 user namespace idmap \u8303\u56f4","text":"<p>\u4fee\u6539 <code>/etc/sub{u,g}id</code>\uff0c\u5c06\u7b2c\u4e09\u4e2a\u6570\u5b57\u7531 <code>65536</code> \u6539\u4e3a <code>165536</code>\uff0c\u589e\u5927\u5bb9\u5668\u5141\u8bb8\u4f7f\u7528\u7684 ID \u8303\u56f4\u3002</p>"},{"location":"records/2022-11-21/#\u5b58\u50a8\u9635\u5217","title":"\u5b58\u50a8\u9635\u5217","text":"<p>\u5b58\u50a8\u9635\u5217\u65e0\u6cd5\u767b\u5f55\u539f\u56e0\u4e0d\u660e\uff0c\u4f7f\u7528\u4e32\u53e3\u91cd\u7f6e\u51ed\u636e\u5e76\u91cd\u65b0\u8bbe\u7f6e\u8ba4\u8bc1\u540e\u53ef\u4ee5\u6b63\u5e38\u767b\u5f55\u3002</p> <p>\u67e5\u770b\u9635\u5217\u65e5\u5fd7\uff0c\u4ec5\u53d1\u73b0 2022/11/15 \u51fa\u73b0\u8fc7\u4e00\u4e2a <code>memory allocation failed</code> \u4e8b\u4ef6\uff0c\u65e0\u6cd5\u786e\u8ba4\u662f\u5426\u4e0e\u672c\u6b21\u65e0\u6cd5\u767b\u5f55\u76f8\u5173\u3002</p> <p>\u67e5\u9605 HPE \u8bbe\u5907\u56fa\u4ef6\u53d1\u884c\u6ce8\u8bb0\uff0c\u6ca1\u6709\u53d1\u73b0\u4e0e\u672c\u6b21\u6545\u969c\u76f8\u5173\u7684\u5185\u5bb9\u3002</p> <p>\u53ef\u80fd\u9700\u8981\u5411\u4e0a\u6e38\u53cd\u9988\u672c\u6b21\u6545\u969c\u3002</p>"},{"location":"records/2023-01-28/","title":"2023 \u5e74 1 \u6708 28 \u65e5\u5de5\u4f5c\u603b\u7ed3","text":"<p>\u4eca\u5929\u6211\u4eec\u8fdb\u884c\u4e86 Ubuntu 22.04 \u955c\u50cf\u7684\u6709\u5173\u6d4b\u8bd5\u3002</p>"},{"location":"records/2023-01-28/#firefox-\u7684\u517c\u5bb9\u6027\u95ee\u9898","title":"Firefox \u7684\u517c\u5bb9\u6027\u95ee\u9898","text":"<p>\u7531\u4e8e Ubuntu 22.04 \u4f7f\u7528 snap \u7248\u672c firefox \u66ff\u6362\u7cfb\u7edf\u81ea\u5e26\u7684 firefox \u5305\uff0c\u6211\u4eec\u6dfb\u52a0\u4e86 <code>firefox-vlab</code> \u5305\u7528\u4e8e\u8c03\u7528 Vlab Software \u5957\u4ef6\u4e2d\u7684 firefox \u4e8c\u8fdb\u5236\u7a0b\u5e8f\u3002\u4e3b\u8981\u95ee\u9898\u51fa\u73b0\u5728\u83dc\u5355\u4e2d\uff1a</p> <ul> <li>22.04 \u4e2d\uff0cmate default settings \u5305\u8986\u76d6\u4e86 Firefox.desktop \u7684\u884c\u4e3a\u4e3a\u4e0d\u663e\u793a\u3002\u8be5\u95ee\u9898\u5df2\u7ecf\u5728\u65b0\u7684 <code>firefox-vlab</code> \u5305\u4e2d\u4fee\u590d\uff08divert \u66f4\u6539\u5bf9\u5e94 desktop \u6587\u4ef6\u540d\u79f0\uff09\uff1b</li> <li>\u56fe\u6807\u672a\u663e\u793a\u3002\u8be5\u95ee\u9898\u662f\u56e0\u4e3a\u5728\u6784\u5efa\u955c\u50cf\u65f6\uff0c\u66f4\u65b0\u56fe\u6807\u7f13\u5b58\u7a0b\u5e8f\u672a\u627e\u5230 firefox \u56fe\u6807\u5bfc\u81f4\u7684\u3002\u8be5\u95ee\u9898\u5df2\u7ecf\u7531\u5728\u542f\u52a8\u65f6\u603b\u662f\u91cd\u65b0\u751f\u6210\u56fe\u6807\u7f13\u5b58\u7684\u65b9\u5f0f\u4fee\u590d\u3002</li> </ul>"},{"location":"records/2023-01-28/#vivado-2019-\u4e0e-ubuntu-2204-\u7684\u517c\u5bb9\u6027\u95ee\u9898","title":"Vivado 2019 \u4e0e Ubuntu 22.04 \u7684\u517c\u5bb9\u6027\u95ee\u9898","text":"<p>\u7ecf\u8fc7\u7b80\u5355\u6d4b\u8bd5\uff0cVivado 2016 \u80fd\u591f\u8fdb\u884c\u7efc\u5408\u3001\u5b9e\u73b0\u4e0e\u751f\u6210\u6bd4\u7279\u6d41\uff1bVivado 2019 \u5728\u7efc\u5408\u4e00\u6b65\u5d29\u6e83\uff0cbacktrace \u7c7b\u4f3c\u5982\u4e0b\uff1a</p> <pre><code>#\n# An unexpected error has occurred (11)\n#\nStack:\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/tps/lnx64/jre9.0.4/lib//server/libjvm.so(+0xb6aadb) [0x7f71a4f6aadb]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/tps/lnx64/jre9.0.4/lib//server/libjvm.so(JVM_handle_linux_signal+0xbb) [0x7f71a4f6fe1b]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/tps/lnx64/jre9.0.4/lib//server/libjvm.so(+0xb647b8) [0x7f71a4f647b8]\n/lib/x86_64-linux-gnu/libc.so.6(+0x42520) [0x7f71f2e1a520]\n/lib/x86_64-linux-gnu/libc.so.6(+0xa2d27) [0x7f71f2e7ad27]\n/lib/x86_64-linux-gnu/libc.so.6(free+0x73) [0x7f71f2e7d4d3]\n/lib/x86_64-linux-gnu/libselinux.so.1(selinuxfs_exists+0xd0) [0x7f71f22dfdb0]\n/lib/x86_64-linux-gnu/libselinux.so.1(+0x721c) [0x7f71f22d921c]\n/lib64/ld-linux-x86-64.so.2(+0x647e) [0x7f71f594447e]\n/lib64/ld-linux-x86-64.so.2(+0x6568) [0x7f71f5944568]\n/lib/x86_64-linux-gnu/libc.so.6(_dl_catch_exception+0xe5) [0x7f71f2f4cc85]\n/lib64/ld-linux-x86-64.so.2(+0xdff6) [0x7f71f594bff6]\n/lib/x86_64-linux-gnu/libc.so.6(_dl_catch_exception+0x88) [0x7f71f2f4cc28]\n/lib64/ld-linux-x86-64.so.2(+0xe34e) [0x7f71f594c34e]\n/lib/x86_64-linux-gnu/libc.so.6(+0x906bc) [0x7f71f2e686bc]\n/lib/x86_64-linux-gnu/libc.so.6(_dl_catch_exception+0x88) [0x7f71f2f4cc28]\n/lib/x86_64-linux-gnu/libc.so.6(_dl_catch_error+0x33) [0x7f71f2f4ccf3]\n/lib/x86_64-linux-gnu/libc.so.6(+0x901ae) [0x7f71f2e681ae]\n/lib/x86_64-linux-gnu/libc.so.6(dlopen+0x48) [0x7f71f2e68748]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libXil_lmgr11.so(xilinxd_52bd840d01ca6dc9+0x3c) [0x7f71ea14c90c]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libXil_lmgr11.so(xilinxd_52bd846009c98322+0xa8) [0x7f71ea14cbf8]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libXil_lmgr11.so(+0x146e08) [0x7f71ea146e08]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libXil_lmgr11.so(xilinxd_52bd847e20e6acca+0x9) [0x7f71ea1473c9]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libXil_lmgr11.so(+0xfe457) [0x7f71ea0fe457]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libXil_lmgr11.so(xilinxd_52bd853912de43c2+0xc8) [0x7f71ea0fe248]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libXil_lmgr11.so(+0xeb552) [0x7f71ea0eb552]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libXil_lmgr11.so(xilinxd_52bd995765656b48+0x2a) [0x7f71ea0f578a]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libXil_lmgr11.so(xilinxd_52bd700d1bd3c616+0x73) [0x7f71ea0f5873]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_commonxillic.so(XilReg::Utils::GetHostInfo[abi:cxx11](XilReg::Utils::HostInfoType, bool) const+0x208) [0x7f71edab58f8]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_commonxillic.so(XilReg::Utils::GetHostInfoFormatted[abi:cxx11](XilReg::Utils::HostInfoType, bool) const+0x52) [0x7f71edab84b2]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_commonxillic.so(XilReg::Utils::GetHostInfo[abi:cxx11]() const+0x183) [0x7f71edab8773]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_commonxillic.so(XilReg::Utils::GetRegInfo(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;, bool, bool)+0xc6) [0x7f71edac26b6]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_commonxillic.so(XilReg::Utils::GetRegInfoWebTalk(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;)+0x60) [0x7f71edac2940]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_project.so(HAPRWebtalkHelper::getRegistrationId[abi:cxx11]() const+0x3a) [0x7f71bd006c2a]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_project.so(HAPRWebtalkHelper::HAPRWebtalkHelper(HAPRProject*, HAPRDesign*, HWEWebtalkMgr*, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;)+0xb0) [0x7f71bd0070a0]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_tcltasks.so(+0x1675a16) [0x7f71e4875a16]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_tcltasks.so(+0x16803a8) [0x7f71e48803a8]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_common.so(+0x8068e2) [0x7f71f44068e2]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libtcl8.5.so(+0x334af) [0x7f71ece334af]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libtcl8.5.so(+0x76875) [0x7f71ece76875]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libtcl8.5.so(+0x7e029) [0x7f71ece7e029]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libtcl8.5.so(TclEvalObjEx+0x76) [0x7f71ece35156]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_common.so(+0x804df1) [0x7f71f4404df1]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libtcl8.5.so(Tcl_ServiceEvent+0x7f) [0x7f71ecea7b0f]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libtcl8.5.so(Tcl_DoOneEvent+0x154) [0x7f71ecea7e44]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_commontasks.so(+0x231625) [0x7f71e6e31625]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_commontasks.so(+0x23b163) [0x7f71e6e3b163]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_commontasks.so(+0x23c1fe) [0x7f71e6e3c1fe]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_common.so(+0x8068e2) [0x7f71f44068e2]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libtcl8.5.so(+0x334af) [0x7f71ece334af]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libtcl8.5.so(Tcl_EvalObjv+0x32) [0x7f71ece335e2]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libtcl8.5.so(TclEvalObjEx+0x322) [0x7f71ece35402]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_commonmain.so(+0x7424) [0x7f71f3807424]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/libtcl8.5.so(Tcl_Main+0x1d0) [0x7f71ecea0210]\n/opt/vlab/vivado/Xilinx/Vivado/2019.1/lib/lnx64.o/librdi_common.so(+0x84ac9b) [0x7f71f444ac9b]\n/lib/x86_64-linux-gnu/libc.so.6(+0x94b43) [0x7f71f2e6cb43]\n/lib/x86_64-linux-gnu/libc.so.6(+0x126a00) [0x7f71f2efea00]\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0\u95ee\u9898\u5728 <code>dlopen()</code> \u67d0\u4e2a\u5e93\u65f6\u51fa\u9519\u3002\u6211\u4eec\u7f16\u5199\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u7a0b\u5e8f\u68c0\u67e5 <code>dlopen()</code> \u7684\u60c5\u51b5\uff1a</p> <pre><code>#include &lt;dlfcn.h&gt;\n#include &lt;stdio.h&gt;\n\n#if defined(RTLD_NEXT)\n#define REAL_LIBC RTLD_NEXT\n#else\n#define REAL_LIBC ((void *) -1L)\n#endif\n\nvoid* dlopen(const char *file, int mode)\n{\nstatic void* (*o_dlopen) ( const char *file, int mode )=0;\nfprintf(stderr, \"dlopen was called %s %d\\n\", file, mode );\no_dlopen = (void*(*)(const char *file, int mode)) dlsym(REAL_LIBC, \"dlopen\");\nvoid *res = (*o_dlopen)( file, mode );\nfprintf(stderr, \"dlopen(%s, %d) gets %p\\n\", file, mode, res);\nreturn res;\n}\n</code></pre> <p><code>gcc -Wall -fPIC -shared -o dlopen.so dlopen.c -ldl</code> \u540e <code>LD_PRELOAD</code> \u6267\u884c Vivado 2019 \u8fdb\u7a0b\uff0c\u53d1\u73b0\u5728\u52a0\u8f7d <code>libdbus-glib-1.so.2</code> \u65f6\u7a0b\u5e8f\u5d29\u6e83\u3002\u5c06 Ubuntu 18.04 \u7684\u5bf9\u5e94\u5e93\u4e0b\u8f7d\u5e76 <code>LD_PRELOAD</code> \u6d4b\u8bd5\uff0c\u53d1\u73b0\u5de5\u4f5c\u6b63\u5e38\u3002</p>"},{"location":"records/2023-01-28/#\u5b9a\u65f6\u4efb\u52a1\u5bfc\u81f4\u7684-io-\u62e5\u5835\u95ee\u9898","title":"\u5b9a\u65f6\u4efb\u52a1\u5bfc\u81f4\u7684 I/O \u62e5\u5835\u95ee\u9898","text":"<p>\u6839\u636e\u4ee5\u5f80\u7684\u7cfb\u7edf\u8d44\u6e90\u8bb0\u5f55\uff0c\u6211\u4eec\u53d1\u73b0\u66f4\u65b0 man-db \u4e0e\u7cfb\u7edf\u66f4\u65b0\u64cd\u4f5c\u53ef\u80fd\u5bfc\u81f4 I/O \u62e5\u5835\u3002\u76ee\u524d\u5904\u7406\u4e86\u6240\u6709\u6b63\u5728\u8fd0\u884c\u7684\u5bb9\u5668\uff1a</p> <pre><code># pct list | awk '$2==\"running\"{print $1}' | xargs -I xxx pct exec xxx -- systemctl disable man-db.timer\n# pct list | awk '$2==\"running\"{print $1}' | xargs -I xxx pct exec xxx -- systemctl disable apt-daily-upgrade.timer\n</code></pre> <p>\u4ee5\u53ca\u65b0\u7684 22.04 \u5bb9\u5668\u4e5f\u9884\u671f\u4e0d\u5305\u542b\u8fd9\u4e9b\u5b9a\u65f6\u4efb\u52a1\u3002</p>"},{"location":"records/2023-01-28/#\u5173\u95ed-swap-\u5206\u914d","title":"\u5173\u95ed swap \u5206\u914d","text":"<p>\u9ed8\u8ba4 PVE \u7ed9\u6bcf\u4e2a\u5bb9\u5668\u5206\u914d\u4e86 512M \u7684 swap\uff0c\u4f46\u662f\u4e3b\u673a swap \u4ec5\u6709 8G\uff0c\u56e0\u6b64\u6279\u91cf\u5173\u95ed\u4e86\u6240\u6709\u5bb9\u5668\u7684 swap\uff0c\u5e76\u4e14\u4fee\u6539\u4e86\u7ba1\u7406\u5e73\u53f0\u76f8\u5173\u4ee3\u7801\u3002</p> <pre><code># # inside /etc/pve/lxc\n# for i in *; do echo ${i/.conf/} &amp;&amp; pct set ${i/.conf/} --swap 0; done\n</code></pre>"},{"location":"records/2023-01-28/#\u540e\u7eed\u4f7f\u7528-github-actions-\u6784\u5efa\u955c\u50cf","title":"\u540e\u7eed\uff1a\u4f7f\u7528 GitHub Actions \u6784\u5efa\u955c\u50cf","text":"<p>2023 \u5e74 2 \u6708 1 \u65e5\u66f4\u65b0\uff1a</p> <p>\u6211\u4eec\u5728 labstrap \u4ed3\u5e93\u914d\u7f6e\u4e86 GitHub Actions \u7684\u6784\u5efa\u8fc7\u7a0b\uff0c\u76ee\u524d\u8bbe\u7f6e\u4e3a\u4ec5\u9650\u624b\u52a8\u89e6\u53d1\u3002\u7ba1\u7406\u5458\uff08\u6709\u4ed3\u5e93\u6743\u9650\u7684\u4eba\uff09\u53ef\u4ee5\u5728 Image Build CI \u9875\u9762\u70b9\u51fb Run workflow \u542f\u52a8\u4e00\u6b21\u6784\u5efa\uff0c\u6784\u5efa\u5b8c\u6210\u540e\u4f1a\u81ea\u52a8\u4e0a\u4f20\u5230 Auto builds \u8fd9\u4e2a release\u3002</p>"},{"location":"records/2023-02-17/","title":"2023 \u5e74 2 \u6708 17 \u65e5\u5de5\u4f5c\u603b\u7ed3","text":"<p>\u4eca\u5929\u5bf9\u6240\u6709\u8282\u70b9\u8fdb\u884c\u4e86\u8f6f\u4ef6\u5347\u7ea7\uff0c\u5e76\u4e14\u66f4\u65b0\u4e86 Django web \u4e0e filestash\u3002</p>"},{"location":"records/2023-02-17/#django-web-\u5347\u7ea7","title":"Django web \u5347\u7ea7","text":"<p>\u66f4\u65b0\u5185\u5bb9\u5982\u4e0b\uff1a</p> <ul> <li>\u6dfb\u52a0\u4e86\u57fa\u4e8e redis \u7684\u4e8b\u4ef6\u961f\u5217\uff08django-rq\uff09\uff0c\u7528\u4e8e\u8017\u65f6\u8f83\u957f\u7684\u521b\u5efa\u64cd\u4f5c</li> <li>\u5f02\u6b65\u7684 django messages middleware\uff08\u4ee3\u4ef7\u662f\u6bcf\u6b21\u8bf7\u6c42\u4f1a\u591a\u4e00\u6b21\u6570\u636e\u5e93 select\uff09</li> <li>\u57fa\u4e8e redis \u7684 cache\uff08\u73b0\u5728\u7528\u4e0d\u5230\uff09</li> <li>index.html: \u66f4\u53cb\u597d\u7684\u521b\u5efa\u72b6\u6001\u663e\u793a\uff0c\u4ee5\u53ca\u5f00\u673a/\u5173\u673a/\u91cd\u542f\u4efb\u52a1\u663e\u793a</li> <li>\u4fee\u590d\u4e86 Django Admin \u4e2d\u65e0\u6cd5\u521b\u5efa\u7528\u6237\u7684\u95ee\u9898</li> <li>\u5347\u7ea7 Django \u81f3 3.2 LTS\uff0c\u4ee5\u53ca cryptography \u7684\u5347\u7ea7</li> <li>\u663e\u793a\u4e0a\u6b21 CAS \u767b\u5f55\u72b6\u6001\uff0c\u4ee5\u53ca\u6dfb\u52a0 3 \u4e2a\u6708\u672a\u767b\u5f55 CAS \u7684\u8b66\u544a</li> <li>\u4ece CAS \u8bb0\u5f55\u7528\u6237\u90ae\u7bb1</li> <li>\u5411 403 \u9875\u9762\u6dfb\u52a0\u66f4\u591a\u4fe1\u606f\uff1b\u5bf9\u9996\u6b21\u6ce8\u518c\u7528\u6237\u663e\u793a\u6b22\u8fce\u5185\u5bb9\uff1b\u767b\u5f55\u6210\u529f\u63d0\u793a\u4e2d\u6587\u5316</li> <li>\u7f13\u5b58\u4e86 node\uff0c\u51cf\u5c0f\u7f51\u7edc\u67e5\u8be2\u6570\uff0c\u5e76\u80fd\u5f97\u5230\u66f4\u52a0\u5b9e\u65f6\u7684 VM \u4fe1\u606f</li> <li>\u6dfb\u52a0\u4e86 list_cleanup_users \u547d\u4ee4\u5feb\u901f\u5217\u4e3e\u7b26\u5408\u6e05\u7406\u6761\u4ef6\u7684\u7528\u6237</li> <li>\u66f4\u65b0\u4e86 systemd service\uff0c\u66f4\u597d\u5904\u7406\u65e5\u5fd7\u7b49\u9700\u6c42</li> </ul>"},{"location":"records/2023-02-17/#filestash-\u5347\u7ea7","title":"Filestash \u5347\u7ea7","text":"<p>\u66f4\u65b0\u5185\u5bb9\u5982\u4e0b\uff1a</p> <ul> <li>\u5347\u7ea7\u524d\u7aef\u4f9d\u8d56\u4e0e\u90e8\u5206\u540e\u7aef\u4f9d\u8d56</li> <li>\u767b\u5f55\u9875\u9762\u6dfb\u52a0\u63d0\u793a\u6587\u6848\uff0c\u6587\u4ef6\u7ba1\u7406\u9875\u9762\u6dfb\u52a0\u62d6\u52a8\u4e0a\u4f20\u6587\u6848</li> <li>\u524d\u7aef\u5c11\u91cf\u9519\u8bef\u4fee\u6b63\uff08\u4fee\u590d\u4e86\u90e8\u5206 JS \u5f02\u5e38\u4e0e\u4e0a\u4f20\u6587\u4ef6\u5939\u7684\u95ee\u9898\uff09\u4e0e lint</li> <li>\u7b49\u5f85\u52a0\u8f7d\u9875\u6dfb\u52a0\u5feb\u901f\u6ce8\u9500\u94fe\u63a5</li> </ul>"},{"location":"records/2023-02-17/#\u5176\u4ed6","title":"\u5176\u4ed6","text":"<ul> <li>\u4ece\u901a\u77e5\u4ed3\u5e93\u81ea\u52a8\u540c\u6b65\u901a\u77e5\u5230\u7528\u6237\u6587\u6863\u4e2d</li> </ul>"},{"location":"records/2023-03-05/","title":"2023 \u5e74 3 \u6708 5 \u65e5\u5de5\u4f5c\u603b\u7ed3","text":"<p>\u4eca\u5929\u6839\u636e\u4e4b\u524d\u53d1\u5e03\u7684\u901a\u77e5\u6e05\u7406\u4e86\u957f\u671f\u4e0d\u4f7f\u7528\u53ca\u5df2\u6bd5\u4e1a\u534a\u5e74\u7684\u7528\u6237\u3002</p> <p>\u8003\u8651\u5230\u767b\u5f55\u9875\u9762\u7684\u201c\u7528\u6237\u540d\u5bc6\u7801\u201d\u767b\u5f55\u65b9\u5f0f\u8fc7\u4e8e\u663e\u773c\uff0c\u4ee5\u81f3\u4e8e\u90e8\u5206\u7528\u6237\u6ca1\u6709\u4f7f\u7528 CAS \u767b\u5f55\uff0c\u5bfc\u81f4\u6211\u4eec\u65e0\u6cd5\u53ca\u65f6\u83b7\u53d6\u7528\u6237\u6700\u65b0\u7684\u5728\u6821\u72b6\u6001\u4fe1\u606f\uff0c\u56e0\u6b64\u6211\u4eec\u5728\u7a0b\u5e8f\u5217\u51fa\u7684\u201c\u6e05\u9000\u7528\u6237\u5217\u8868\u201d\u4e2d\u6839\u636e\u5b66\u53f7\u624b\u52a8\u6392\u9664\u4e86\u53ef\u80fd\u8fd8\u5728\u6821\u7684\u540c\u5b66\u3002\u5177\u4f53\u89c4\u5219\u5982\u4e0b\uff1a</p> <ul> <li>2 \u6708 17 \u65e5\u7ef4\u62a4\u540e\u4ecd\u7136\u5728\u4f7f\u7528\u865a\u62df\u673a\u7684\u7528\u6237\uff0c\u4f46\u662f\uff1a<ul> <li>\u7531\u4e8e\u6211\u4eec\u8bb0\u5f55\u7528\u6237\u5bf9\u865a\u62df\u673a\u7684\u8bbf\u95ee\u65f6\u5e76\u6ca1\u6709\u5224\u65ad\u865a\u62df\u673a\u662f\u5426\u5f00\u673a\uff0c\u56e0\u6b64\u7528\u6237\u5c1d\u8bd5\u767b\u5f55\u5931\u8d25\u65f6\u4e5f\u4f1a\u88ab\u8ba4\u4e3a\u201c\u8bbf\u95ee\u4e86\u865a\u62df\u673a\u201d</li> <li>\u6240\u4ee5\u6b64\u6761\u5b9e\u9645\u7684\u5224\u65ad\u6761\u4ef6\u662f\u201c\u6709\u865a\u62df\u673a\u8bbf\u95ee\u8bb0\u5f55\uff0c\u4e14\u865a\u62df\u673a\u662f\u5f00\u673a\u72b6\u6001\u201d</li> </ul> </li> <li>\u6839\u636e\u5b66\u53f7\u5224\u65ad\u53ef\u80fd\u8fd8\u5728\u6821\u7684\u540c\u5b66\uff0c\u5373\u672c\u79d1\u751f\u81f3\u5c11 PB19\uff0c\u7855\u58eb\u7814\u7a76\u751f\u81f3\u5c11 SA20\uff0c\u535a\u58eb\u7814\u7a76\u751f\u81f3\u5c11 BA19</li> </ul> <p>\u5bf9\u4e8e\u540c\u65f6\u7b26\u5408\u4ee5\u4e0a\u89c4\u5219\u7684\u7528\u6237\uff0c\u6211\u4eec\u5c06\u5176\u4ece\u6e05\u9000\u5217\u8868\u4e2d\u79fb\u9664\uff0c\u7136\u540e\u5220\u9664\u4e86\u5217\u8868\u4e2d\u5269\u4f59\u7684\u7528\u6237\u53ca\u5176\u865a\u62df\u673a\u3002</p>"},{"location":"records/2023-03-05/#django-web-\u66f4\u65b0","title":"Django web \u66f4\u65b0","text":"<ul> <li>\u4fee\u590d\u4e86 Django \u6743\u9650\u7ec4\uff0c\u4f7f\u7528 <code>vm.can_cas_login</code> \u4f5c\u4e3a\u201c\u6e05\u9000\u767d\u540d\u5355\u201d\uff0c\u6743\u9650\u7ec4\u4e2d\u7684\u7528\u6237\u4e0d\u4f1a\u5728\u201c\u6e05\u9000\u5217\u8868\u201d\u4e2d\u5217\u51fa\u3002</li> <li>\u6dfb\u52a0\u4e86\u4e00\u4e9b Django command\uff0c\u5217\u51fa\u7b26\u5408\u6e05\u7406\u6761\u4ef6\u7684\u7528\u6237\u53ca\u5176\u865a\u62df\u673a\uff0c\u4f7f\u6b64\u6b21\u53ca\u4ee5\u540e\u7684\u6e05\u9000\u5de5\u4f5c\u66f4\u52a0\u65b9\u4fbf\u8fdb\u884c\u3002</li> <li>\u66f4\u65b0\u4e86\u767b\u5f55\u9875\u9762\uff0c\u63d0\u4f9b\u4e00\u4e2a\u5de8\u5927\u3001\u663e\u773c\u7684\u201c\u7edf\u4e00\u8eab\u4efd\u8ba4\u8bc1\u201d\u6309\u94ae\uff0c\u5e76\u5c06\u7528\u6237\u540d\u5bc6\u7801\u767b\u5f55\u6298\u53e0\u8d77\u6765\u3002</li> </ul>"},{"location":"references/desktop/","title":"X Desktop \u56fe\u6807\u914d\u7f6e","text":""},{"location":"references/desktop/#xilinx-vivado","title":"Xilinx Vivado","text":"<pre><code>[Desktop Entry]\nName=Vivado 2019.1\nExec=/opt/vlab/bin/vivado\nIcon=/opt/vlab/vivado/Xilinx/Vivado/2019.1/doc/images/vivado_logo.png\nTerminal=false\nType=Application\nX-Desktop-File-Install-Version=0.23\n</code></pre>"},{"location":"references/pve-ids/","title":"Proxmox \u865a\u62df\u673a ID \u5206\u914d","text":"ID \u6216 ID \u6bb5 \u5206\u914d\u60c5\u51b5 100-199 vlab \u670d\u52a1\u5982 gateway, web \u7b49 200-799 \u672a\u5206\u914d 800-899 \u6258\u7ba1\u5728 vlab \u4e0a\u7684\u5176\u4ed6\u670d\u52a1\u5982 USTC OJ, Verilog OJ \u7b49 900-999 vlab \u7ef4\u62a4\u5c0f\u7ec4\u81ea\u5df1\u4f7f\u7528\u7684\u865a\u62df\u673a 1000-? \u7528\u6237\u521b\u5efa\u7684\u865a\u62df\u673a"},{"location":"references/ustccas/","title":"\u7edf\u4e00\u8eab\u4efd\u8ba4\u8bc1\u8d44\u6599","text":""},{"location":"references/ustccas/#\u54cd\u5e94\u6837\u4f8b","title":"\u54cd\u5e94\u6837\u4f8b","text":"<p>\u6ce8\uff1a\u975e\u539f\u59cb\u54cd\u5e94\uff0c\u5df2\u89e3\u6790\u4e3a Python <code>dict</code>\uff1a</p> <pre><code>{\n    'xbm': '1',\n    'logintime': '2020-02-30 12:34:56',\n    'gid': '2201234567',\n    'ryzxztdm': '10',\n    'ryfldm': '201030000',\n    'loginip': '192.0.2.0',\n    'name': '\u5f20\u4e09',\n    'login': 'PB17000001',\n    'zjhm': 'PB17000001',\n    'glzjh': 'SA21011000\\tPB17000001',\n    'deptCode': '011',\n    'email': 'noreply@mail.ustc.edu.cn'\n}\n</code></pre> \u539f\u59cb\u54cd\u5e94\u5185\u5bb9\uff08XML example\uff09 <pre><code>&lt;cas:serviceResponse xmlns:cas='http://www.yale.edu/tp/cas'&gt;\n&lt;cas:authenticationSuccess&gt;\n&lt;cas:user&gt;SA21011000&lt;/cas:user&gt;\n&lt;attributes&gt;\n&lt;cas:xbm&gt;1&lt;/cas:xbm&gt;\n&lt;cas:logintime&gt;2020-02-30 12:34:56&lt;/cas:logintime&gt;\n&lt;cas:gid&gt;2201234567&lt;/cas:gid&gt;\n&lt;cas:ryzxztdm&gt;10&lt;/cas:ryzxztdm&gt;\n&lt;cas:ryfldm&gt;201030000&lt;/cas:ryfldm&gt;\n&lt;cas:loginip&gt;192.0.2.0&lt;/cas:loginip&gt;\n&lt;cas:name&gt;\u5f20\u4e09&lt;/cas:name&gt;\n&lt;cas:login&gt;SA21011000&lt;/cas:login&gt;\n&lt;cas:zjhm&gt;SA21011000&lt;/cas:zjhm&gt;\n&lt;cas:glzjh&gt;SA21011000   PB17000001&lt;/cas:glzjh&gt;\n&lt;cas:deptCode&gt;011&lt;/cas:deptCode&gt;\n&lt;cas:email&gt;noreply@mail.ustc.edu.cn&lt;/cas:email&gt;\n&lt;/attributes&gt;\n&lt;/cas:authenticationSuccess&gt;\n&lt;/cas:serviceResponse&gt;\n</code></pre> <p><code>glzjh</code> \u7684\u503c\u4e0d\u5b8c\u5168\u53ef\u9760</p> <p>\u6839\u636e USTCCAS \u7684\u6587\u6863\uff0c\u8fd9\u4e2a\u5c5e\u6027\u4e2d\u5305\u542b\u4e86\u7528\u6237\u6240\u6709\u7684\u5386\u53f2\u8bc1\u4ef6\u53f7\uff08\u5b66\u53f7/\u5de5\u53f7\uff09\uff0c\u4ee5 <code>\\t</code> \u5206\u5272\u3002</p> <p>\u4f46\u662f\u5728\u5b9e\u9645\u64cd\u4f5c\u4e2d\u53d1\u73b0\u8fd9\u4e2a\u5c5e\u6027\u95ee\u9898\u6bd4\u8f83\u591a\uff0c\u4f8b\u5982\uff08\u4ee5\u4e0b\u4f8b\u5b50\u7ecf\u8fc7\u533f\u540d\u5316\u5904\u7406\uff09\uff1a</p> <ol> <li>\u6709\u6559\u5e08\u7684 glzjh \u503c\u4e3a <code>\"BA01000000\\t00000\\tSA97000000\"</code>\uff0c\u7b2c\u4e00\u4e2a\u503c\u662f\u4e8c\u5341\u591a\u5e74\u524d\u7684\u535a\u58eb ID\uff0c\u800c\u6700\u65b0\u7684\u6559\u5e08\u8bc1\u4ef6\u53f7\u662f\u4e2d\u95f4\u7684\u503c</li> <li>\u6709 SA \u65b0\u751f\u7684 glzjh \u503c\u4e3a <code>\"U0000000\"</code></li> <li>\u6709 SA \u65b0\u751f\u7684 glzjh \u503c\u4e3a <code>\"null\"</code></li> </ol>"},{"location":"references/ustccas/#\u4eba\u5458\u5728\u6821\u72b6\u6001\u7801","title":"\u4eba\u5458\u5728\u6821\u72b6\u6001\u7801","text":"<pre><code>id,sfztm,sfzt\n1,10,\u5728\u6821\n2,20,\u79bb\u6821\uff08\u542b\u6821\u5185\u8eab\u4efd\u7ed3\u675f\uff09\n3,30,\u6821\u5185\u8eab\u4efd\u8f6c\u6362\n5,40,\u79bb\u9000\u4f11\n6,50,\"\u6682\u65f6\u79bb\u6821(\u4f11\u5b66/\u51fa\u56fd\u7b49)\"\n7,99,\u5176\u4ed6\n8,91,\u8bc1\u4ef6\u505c\u7528\u6216\u6ce8\u9500\n</code></pre>"},{"location":"references/ustccas/#\u4eba\u5458\u5206\u7c7b\u7801","title":"\u4eba\u5458\u5206\u7c7b\u7801","text":"<pre><code>id,ryflm,ryfl\n1,101010000,\u6559\u5de5-\u6b63\u5f0f\u7f16\u5236\u6559\u5b66\u5c97\n2,101020000,\u6559\u5de5-\u6b63\u5f0f\u7f16\u5236\u79d1\u7814\u5c97\n3,101030000,\u6559\u5de5-\u6b63\u5f0f\u7f16\u5236\u7ba1\u7406\u5c97\n4,101040000,\u6559\u5de5-\u6b63\u5f0f\u7f16\u5236\u652f\u6491\u5c97\n5,101ZZ0000,\u6559\u5de5-\u6b63\u5f0f\u7f16\u5236\u5176\u4ed6\u5c97\u6216\u672a\u660e\u5c97\n6,201010000,\u5b66\u751f-\u6b63\u5f0f\u79d1\u5b66\u5b66\u4f4d\u535a\u58eb\n7,201020000,\u5b66\u751f-\u6b63\u5f0f\u79d1\u5b66\u5b66\u4f4d\u7855\u58eb\n8,201030000,\u5b66\u751f-\u6b63\u5f0f\u672c\u79d1\n9,201040000,\u5b66\u751f-\u6b63\u5f0f\u5b66\u751f\u4e13\u79d1\n10,201ZZ0000,\u5b66\u751f-\u6b63\u5f0f\u5b66\u751f\u5176\u4ed6\u6216\u672a\u77e5\u5c42\u6b21\n11,202010000,\u5b66\u751f-\u4e13\u4e1a\u5b66\u4f4d\u535a\u58eb\n12,202020000,\u5b66\u751f-\u4e13\u4e1a\u5b66\u4f4d\u7855\u58eb\n13,202ZZ0000,\u5b66\u751f-\u4e13\u4e1a\u5b66\u4f4d\u5176\u4ed6\u6216\u672a\u77e5\u5c42\u6b21\n14,240030000,\u5b66\u751f-\u591c\u5927\u51fd\u6388\u57f9\u8bad\u73ed\u672c\u79d1\n15,240040000,\u5b66\u751f-\u591c\u5927\u51fd\u6570\u57f9\u8bad\u73ed\u4e13\u79d1\n16,240ZZ0000,\u5b66\u751f-\u591c\u5927\u51fd\u6570\u57f9\u8bad\u73ed\u5176\u4ed6\u6216\u672a\u77e5\u5c42\u6b21\n17,290ZZ0000,\u77ed\u671f\u57f9\u8bad\u5b66\u751f\n18,2ZZZZ0000,\u5b66\u751f-\u5176\u4ed6\u7c7b\u578b\u5b66\u751f\n19,300000000,\u535a\u58eb\u540e\n20,901000000,\u6765\u8bbf\u4eba\u5458-\u4e0a\u7ea7\u90e8\u95e8\u5404\u79cd\u7c7b\u578b\u6765\u8bbf\u4eba\u5458\n21,902000000,\u4ea4\u6d41\u8bbf\u95ee\u8fdb\u4fee\u4eba\u5458\n22,903000000,\u6765\u8bbf\u4eba\u5458-\u9080\u8bf7\u6765\u7684\u8bb2\u5ea7\u3001\u6f14\u51fa\u3001\u4ea4\u6d41\u4eba\u5458\n23,904000000,\u6765\u8bbf\u4eba\u5458-\u53c2\u52a0\u4f1a\u8bae\u4eba\u5458\n24,905000000,\u6765\u8bbf\u4eba\u5458-\u6765\u6821\u53c2\u89c2\u4eba\u5458\n25,906000000,\u6765\u8bbf\u4eba\u5458-\u5b66\u751f\u5bb6\u957f\n26,9ZZ000000,\u6765\u8bbf\u4eba\u5458-\u5176\u4ed6\u6765\u8bbf\u4eba\u5458\n27,Z01000000,\u6559\u5de5\u5bb6\u5c5e\n28,Z02000000,\u9644\u4e2d\u5b66\u751f\n29,ZZZ000000,\u5176\u4ed6\u4eba\u5458\n30,103ZZ0000,\u6559\u5de5-\u6821\u8058\u7528\u4eba\u5458\u5176\u4ed6\u5c97\u6216\u672a\u660e\u5c97\n31,180ZZ0000,\u5404\u5355\u4f4d\u81ea\u8058\u4eba\u5458\n33,190ZZ0000,\u5404\u5355\u4f4d\u4e34\u65f6\u8058\u7528\u4eba\u5458\n34,301000000,\u6821\u5185\u535a\u58eb\u540e\n35,309000000,\u4f01\u4e1a\u535a\u58eb\u540e\n</code></pre>"},{"location":"servers/ct100/","title":"\u7f51\u5173\u673a (CT 100)","text":"<p>\u7f51\u5173\u673a\u987e\u540d\u601d\u4e49\u5c31\u662f\uff08\u5bb9\u5668\u5185\u7f51\u7684\uff09\u7f51\u5173\uff0c\u540c\u65f6\u63a5\u5165\u4e86\u7ba1\u7406\u5185\u7f51\uff08<code>vmbr2</code> / <code>eth2</code> / <code>172.30.0.1/24</code>\uff09\u3001\u5bb9\u5668\u5185\u7f51\uff08<code>vmbr1</code> / <code>eth1</code> / <code>172.31.0.1/16</code>\uff09\u548c\u6821\u56ed\u7f51\uff08<code>vmbr0</code> / <code>eth0</code> / <code>202.38.75.252/24</code>\uff09\uff0c\u901a\u8fc7 NAT \u63d0\u4f9b\u5185\u7f51\u673a\u5668\u7684\u5bf9\u5916\u8bbf\u95ee\u4ee5\u53ca\u7279\u6b8a\u9700\u6c42\u7684\u7aef\u53e3\u8f6c\u53d1\u3002</p> <p>\u8be5\u5bb9\u5668\u914d\u7f6e\u4e3a\u56db\u6838 8G\uff0c\u4ec5\u8fd0\u884c\u4e86\u57fa\u672c\u7cfb\u7edf\u7ec4\u4ef6\uff08\u4e3b\u8981\u662f iptables\u3001radvd \u548c WireGuard\uff09\u3002</p>"},{"location":"servers/ct100/#\u5185\u7f51\u4e0a\u7f51\u8f6c\u53d1","title":"\u5185\u7f51\u4e0a\u7f51\u8f6c\u53d1","text":"<p>\u5185\u7f51\u865a\u62df\u673a\uff08172.31.0.0/16\uff0c172.30.0.0/24\uff09\u7684\u6240\u6709\u5230\u5916\u7f51\u6d41\u91cf\u90fd\u901a\u8fc7\u672c\u673a\u8f6c\u53d1\uff0c\u8f6c\u53d1\u901a\u8fc7 iptables \u8bbe\u7f6e\uff0c\u7531\u5185\u6838\u5b8c\u6210\uff0c\u56e0\u6b64\u672c\u5bb9\u5668\u4e2d\u7684 iptables \u89c4\u5219\u5341\u5206\u91cd\u8981\u3002\u4e0b\u9762\u89e3\u91ca\u8bbe\u7f6e\u6587\u4ef6 <code>iptables.sh</code>\u3002</p> <p>Tip</p> <p><code>iptables.sh</code> \u66fe\u7ecf\u4f4d\u4e8e <code>/root</code> \u4e0b\uff0c\u5728 2020 \u5e74 11 \u6708 rootfs \u635f\u574f\u540e\u4e22\u5931\u3002</p> <p>\u73b0\u5728\u7684\u505a\u6cd5\u662f\u76f4\u63a5\u5728 <code>/root/iptables/</code> \u76ee\u5f55\u4e0b\u624b\u52a8\u7ef4\u62a4 <code>rules.v4</code> / <code>rules.v6</code> \u7b49\u6587\u4ef6\uff0c\u7136\u540e\u4f7f\u7528 <code>apply.sh</code> \u66f4\u65b0\u89c4\u5219\u3002</p> <p>\u4ee5\u4e0b\u5185\u5bb9\u53ef\u80fd\u8fc7\u65f6\uff0c\u8bf7\u4ee5\u7cfb\u7edf\u5185\u7684\u6587\u4ef6\u4e3a\u51c6</p>"},{"location":"servers/ct100/#\u9632\u706b\u5899\u90e8\u5206","title":"\u9632\u706b\u5899\u90e8\u5206","text":"<pre><code>### IPv4 ###\niptables -P INPUT ACCEPT\niptables -P FORWARD ACCEPT\niptables -P OUTPUT ACCEPT\niptables -F\niptables -X\niptables -N VLAB\n\niptables -A VLAB -i lo -j ACCEPT\niptables -A VLAB -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT\niptables -A VLAB -p tcp --dport 22 -j ACCEPT\niptables -A VLAB -p tcp --dport 1024 ! -s 202.38.75.226 -j DROP\niptables -A INPUT -i vmbr+ -j VLAB\n</code></pre> <p>\u5f00\u5934\u7684\u90e8\u5206 1-6 \u884c\u521d\u59cb\u5316 iptables \u8bbe\u7f6e\uff0c\u6ce8\u610f\u5230\u8f6c\u53d1\u7684\u6d41\u91cf\u8d70\u7684\u662f FORWARD \u94fe\u800c\u4e0d\u662f INPUT \u94fe\uff0c\u6240\u4ee5\u6709 <code>-P FORWARD ACCEPT</code>\u3002\u7b2c 7 \u884c\u521b\u5efa VLAB \u94fe\u653e\u6211\u4eec\u81ea\u5df1\u7684 rules\u3002</p> <p>9-13 \u884c\u8fd9\u90e8\u5206\u540c\u9632\u706b\u5899\u3002\u4e0b\u9762\u7684 15 \u884c\u4e5f\u76f8\u540c\u3002</p>"},{"location":"servers/ct100/#\u8f6c\u53d1\u9632\u706b\u5899\u90e8\u5206","title":"\u8f6c\u53d1\u9632\u706b\u5899\u90e8\u5206","text":"<pre><code>#iptables -A FORWARD -p udp -m state --ctstate NEW -j NFLOG --nflog-prefix '[vlab]'\niptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT\niptables -A FORWARD -p tcp --dport 25 -j DROP  # Block SMTP\niptables -A FORWARD -i eth0 -o eth1 -p tcp --dport 22 -m state --state NEW -j NFLOG --nflog-prefix '[vlab]'\niptables -A FORWARD -i eth0 -o eth1 -p tcp --dport 22 --tcp-flag FIN FIN -j NFLOG --nflog-prefix '[vlab]'\niptables -A FORWARD -i eth0 -o eth1 -p tcp --dport 22 --tcp-flag RST RST -j NFLOG --nflog-prefix '[vlab]'\niptables -A FORWARD -i eth0 -o eth1 -j ACCEPT\niptables -A FORWARD -d 10.0.0.0/8 -j DROP\niptables -A FORWARD -d 172.16.0.0/12 -j DROP\niptables -A FORWARD -d 192.168.0.0/16 -j DROP\niptables -A FORWARD -d 202.38.64.58/31 -j DROP\niptables -A FORWARD -d 202.38.96.193 -j DROP\niptables -A FORWARD -d 210.45.224.65 -j DROP\niptables -Z\n</code></pre> <p>16 \u884c\u5c4f\u853d\u8fde\u63a5\u8fdc\u7aef 25\uff08SMTP\uff09\u7aef\u53e3\uff0c\u9632\u6b62\u6709\u4eba\u53d1\u5783\u573e\u90ae\u4ef6\uff0c\u8fd9\u548c LUG VPN \u4e00\u6837\u3002\u73b0\u5728\u7684\u4e92\u8054\u7f51\u5bf9\u5783\u573e\u90ae\u4ef6\u5f88\u654f\u611f\uff0c\u5f88\u5bb9\u6613\u56e0\u6b64\u7ed9 IP \u5730\u5740\u751a\u81f3\u6821\u56ed\u7f51 AS \u5e26\u6765\u4e0d\u597d\u7684\u58f0\u8a89\uff0c\u6240\u4ee5\u5c4f\u853d\u6389\u3002</p> <p>17-19 \u884c\u5c1d\u8bd5\u8bb0\u5f55\u6bcf\u4e2a TCP \u8fde\u63a5\uff0c\u7531\u4e8e LXC \u91cc\u7684 iptables \u65e0\u6cd5\u8bbf\u95ee rsyslog1\uff0c\u6211\u4eec\u4f7f\u7528 ulogd2 \u7684\u529e\u6cd52\u3002\u4e0d\u8fc7\u60c5\u51b5\u662f\uff0c\u7531\u4e8e\u6570\u636e\u91cf\u592a\u5927\uff0c<code>ulogd2.service</code> \u73b0\u5728\u88ab\u5173\u6389\u4e86\uff08LOL...\uff09</p> <p>21-23 \u884c\u5c4f\u853d\u5185\u7f51\u8bbf\u95ee\uff0c\u867d\u7136\u8fd9\u4e9b IP \u6bb5\u4e5f\u6709\u4e00\u4e9b\u6821\u56ed\u7f51\u8def\u7531\uff0c\u4e0d\u8fc7\u8fd9\u4e0d\u662f vlab \u7684\u670d\u52a1\u76ee\u7684\uff0c\u6240\u4ee5\u4e00\u8d77\u5c4f\u853d\u6389\u4e5f\u65e0\u6240\u8c13\u3002</p> <p>24-26 \u884c\u5c4f\u853d\u7f51\u7edc\u901a\uff0c\u907f\u514d\u6211\u4eec\u7684\u51fa\u53e3 IP \u8bbe\u7f6e\u88ab\u6539\uff08\u8fd9\u4e2a\u53c8\u548c LUG VPN \u4e00\u6837\uff09\u3002\u7f51\u7edc\u901a\u4e00\u5171\u6709 4 \u4e2a IP\uff0c\u5176\u4e2d <code>202.38.64.{58,59}</code> \u662f\u76f8\u90bb\u7684\uff0c\u6240\u4ee5\u5408\u5e76\u8d77\u6765\u7528\u4e00\u4e2a <code>/31</code> \u7684\u7f51\u6bb5\u505a\u89c4\u5219\u3002</p>"},{"location":"servers/ct100/#\u8f6c\u53d1-nat-\u90e8\u5206","title":"\u8f6c\u53d1 NAT \u90e8\u5206","text":"<pre><code>iptables -t nat -F PREROUTING\niptables -t nat -F POSTROUTING\n#iptables -t nat -X\niptables -t nat -N VLAB_STUDENT &gt;/dev/null 2&gt;&amp;1\niptables -t nat -A PREROUTING -i eth1 -d 202.38.64.58/31 -j DNAT --to-destination 202.38.75.226\niptables -t nat -A PREROUTING -i eth1 -d 202.38.96.193/32 -j DNAT --to-destination 202.38.75.226\niptables -t nat -A PREROUTING -i eth1 -d 210.45.224.65/32 -j DNAT --to-destination 202.38.75.226\niptables -t nat -A PREROUTING -i eth0 -p tcp -m tcp --dport 10001:29999 -j VLAB_STUDENT\niptables -t nat -A POSTROUTING -s 172.30.0.0/15 -j MASQUERADE\niptables -t nat -A POSTROUTING -s 10.38.79.0/24 -j MASQUERADE\n#iptables -t nat -Z\niptables-save -f /etc/iptables/rules.v4\n</code></pre> <p>NAT \u90e8\u5206\u6211\u4eec\u53ea\u7528\u5230\u4e86 PREROUTING \u548c POSTROUTING \u4e24\u4e2a\u94fe\uff08\u8fd9\u662f\u5178\u578b\u6a21\u5f0f\uff09\u3002</p> <p>32 \u884c\u521b\u5efa <code>VLAB_STUDENT</code> \u94fe\u7ed9 pfserver \u7a0b\u5e8f\u7528\u3002</p> <p>33-35 \u884c\u628a\u5c1d\u8bd5\u8bbf\u95ee\u7f51\u7edc\u901a\u7684\u6d41\u91cf\u90fd\u52ab\u6301\u5230 web \u5bb9\u5668\u4e2d\uff0c\u8fd9\u6837\u5c31\u80fd\u663e\u793a\u201c\u7f51\u7edc\u901a\u88ab\u5c4f\u853d\u201d\u7684\u6d88\u606f\u4e86\u3002</p> <p>36 \u884c\u63d0\u4f9b <code>VLAB_STUDENT</code> \u94fe\u7684\u5165\u53e3\uff0c\u8be5\u5165\u53e3\u9650\u5236\u4e86\u53ea\u6709 10001:29999 \u4e4b\u95f4\uff08inclusive\uff09\u7684\u7aef\u53e3\u80fd\u591f\u88ab\u8f6c\u53d1\u3002</p> <p>37 \u662f\u51fa\u53e3 NAT\uff0c\u5bf9\u4e8e\u8f6c\u53d1\u51fa\u53bb\u7684\u6d41\u91cf\uff0c\u6839\u636e\u6e90\u5730\u5740\u8fdb\u884c NAT\u3002\uff08POSTROUTING \u94fe\u4e2d\u6ca1\u6709 <code>-i</code> \u53ef\u7528\uff09\uff0c38 \u884c\u7c7b\u4f3c\uff08\u6b64\u5904\u5ffd\u7565\uff09</p>"},{"location":"servers/ct100/#mtu-\u8bbe\u7f6e","title":"MTU \u8bbe\u7f6e","text":"<p><code>ip link set dev eth0 mtu 1500</code>\uff08\u51fa\u4e8e\u672a\u77e5\u539f\u56e0\uff0c\u65b0\u5efa\u65f6\u53ef\u80fd\u4f1a\u662f 1450\uff0c\u914d\u7f6e\u9519\u8bef\u4f1a\u5bfc\u81f4\u5b66\u751f\u5bb9\u5668\u770b\u8d77\u6765\u7f51\u7edc\u6b63\u5e38\uff0c\u4f46\u662f\u7f51\u7edc\u4f1a\u5e38\u5e38\u5361\u4f4f\uff09</p> <p>\u76ee\u524d\u6b64\u670d\u52a1\u5668\u6240\u6709\u7aef\u53e3\u7684 MTU \u90fd\u5e94\u8be5\u4e3a 1500\u3002</p>"},{"location":"servers/ct100/#radvd","title":"radvd","text":"<p>radvd \u662f IPv6 \u7684 Router Advertisement Daemon\uff0c\u7528\u4e8e\u5411\u865a\u62df\u673a\u63d0\u4f9b IPv6 RA \u4f7f\u5f97\u865a\u62df\u673a\u53ef\u4ee5\u4f7f\u7528 SLAAC \u81ea\u52a8\u914d\u7f6e IPv6 \u7f51\u7edc\u3002</p> <p><code>/etc/radvd.conf</code> \u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>interface eth1\n{\n    AdvSendAdvert on;\n    MinRtrAdvInterval 3;\n    MaxRtrAdvInterval 10;\n\n    AdvDefaultPreference medium;\n    AdvHomeAgentFlag off;\n\n    prefix 2001:da8:d800:4bfc::/64\n    {\n        AdvOnLink on;\n        AdvAutonomous on;\n        AdvRouterAddr on;\n    };\n};\n</code></pre>"},{"location":"servers/ct100/#adguardhome","title":"AdGuardHome","text":"<p>\u7f51\u5173\u4e0a\u8fd0\u884c AdGuardHome \u66ff\u4ee3\u66fe\u7ecf\u7684 bind9\uff0c\u56e0\u4e3a bind9 \u5185\u5b58\u5360\u7528\u592a\u9ad8\u4e14\u7ef4\u62a4\u4e0d\u6613\uff0c\u800c AGH \u5c0f\u5de7\u8f7b\u4fbf\uff0c\u4f5c\u4e3a\u5c40\u57df\u7f51\u7684\u9012\u5f52 DNS \u6bd4 bind9 \u66f4\u5408\u9002\u3002</p> <p>\u6211\u4eec\u4f7f\u7528 GitHub \u4e0a\u7684 \u5f00 \u6e90 \u9879 \u76ee \u5728 AGH \u4e0a\u5b9e\u73b0\u4e00\u4e9b\u9ad8\u7ea7\u7684\u89e3\u6790\u529f\u80fd\u3002</p>"},{"location":"servers/ct100/#\u8fc7\u65f6\u5185\u5bb9bind9","title":"\u8fc7\u65f6\u5185\u5bb9\uff1aBind9","text":"<p>\u7f51\u5173\u7684 bind9 \u8d1f\u8d23\u5904\u7406\u5b66\u751f\u673a\u7684 DNS \u8bf7\u6c42\uff0c\u8f6c\u53d1\u7ed9\u5b66\u6821 DNS\uff08\u6709 20 QPS/IP \u7684\u9650\u5236\uff09\uff0c\u5e76\u7f13\u5b58\u76f8\u5173\u7ed3\u679c\u3002</p> <p>\u7279\u522b\u5730\uff0c\u5173\u95ed\u4e86 DNSSEC \u9a8c\u8bc1\uff0c\u56e0\u4e3a\u67d0\u4e9b\u57df\u540d\u628a CNAME \u914d\u7f6e\u5728\u4e86\u6839\u57df\u540d\u4e0a\uff08\u6bd4\u5982\u8bf4 <code>gitee.com</code>\uff09\u4f1a\u5bfc\u81f4 bind9 \u51fa\u9519\u3002\u76f8\u5173\u53c2\u6570\u53ef\u4ee5\u5728 <code>named.conf.options</code> \u4e2d\u8bbe\u7f6e\u3002</p>"},{"location":"servers/ct100/#vlab-dev-vpn","title":"Vlab Dev VPN","text":"<p>\u4e3b\u6761\u76ee\uff1aVlab Dev VPN</p>"},{"location":"servers/ct100/#\u6545\u969c","title":"\u6545\u969c","text":"<p>2020 \u5e74 11 \u6708 16 \u65e5\u53d1\u73b0\u8be5\u5bb9\u5668\u65e0\u6cd5\u767b\u5f55\uff0c\u8fdb\u4e00\u6b65\u68c0\u67e5\u53d1\u73b0\u5176 rootfs \u5df2\u5b8c\u5168\u635f\u574f\u65e0\u6cd5\u6062\u590d\u3002\u7531\u4e8e iptables \u89c4\u5219\u662f\u8fd0\u884c\u5728\u5185\u6838\u4e2d\u7684\uff0c\u5176\u671f\u671b\u529f\u80fd\uff08\u4f5c\u4e3a\u7f51\u5173\uff09\u6ca1\u6709\u53d7\u5230\u5f71\u54cd\u3002\u8003\u8651\u5230\u5931\u63a7\u7684\u5371\u5bb3\uff08\u8be5\u5bb9\u5668\u4e0d\u80fd\u91cd\u542f\uff0c\u5426\u5219\u5c31\u518d\u4e5f\u5f00\u4e0d\u8d77\u6765\u4e86\uff09\uff0c\u5df2\u4ece\u8fd8\u5728\u8fd0\u884c\u7684 namespace \u4e2d\u63d0\u53d6\u51fa iptables \u89c4\u5219\uff0c\u5e76\u91cd\u5efa\u4f5c\u4e3a\u66ff\u4ee3\u3002\u65b0\u7684 CT 100 \u5c06 rootfs \u7f29\u5c0f\u5230\u4e86 4 GB\uff0c\u914d\u7f6e\u597d\u4e86 iptables-persistent \u548c radvd\u3002</p> <p>\u4e8b\u540e\u67e5\u660e\u6545\u969c\u539f\u56e0\u4e3a\uff0cPVE \u6d4b\u8bd5\u8282\u70b9\u672a\u52a0\u5165\u96c6\u7fa4\uff0c\u4f46\u662f\u4f7f\u7528\u4e86\u76f8\u540c\u7684 LVM \u5b58\u50a8\uff0c\u5bfc\u81f4\u5728\u521b\u5efa/\u5220\u9664 LVM \u5377\u65f6\uff0cLVM \u6ca1\u6709\u6b63\u786e\u88ab\u9501\u5b9a\u3002\u5728\u6d4b\u8bd5\u8282\u70b9\u5220\u9664\u5176\u4e0a\u7684 CT 100 \u65f6\uff0c\u51fa\u73b0\u6df7\u4e71\u3002</p> <ol> <li> <p>Logging from iptables to rsyslog inside container fails. - Linux Continers Mailing Lists\u00a0\u21a9</p> </li> <li> <p>iptables logging inside LXC containers - Proxmox Support Forum\u00a0\u21a9</p> </li> </ol>"},{"location":"servers/ct101/","title":"Web \u670d\u52a1\u5668 (CT 101)","text":"<p>\u8fd9\u4e2a\u5bb9\u5668\u662f vlab \u5bf9\u5916\u670d\u52a1\u7684\u4e3b\u8981\u573a\u6240\uff0c\u4e0a\u9762\u8fd0\u884c\u4e86\u6211\u4eec\u7684\u5404\u79cd\u7a0b\u5e8f\u3002</p> <p>\u8be5\u5bb9\u5668\u63a5\u5165\u6821\u56ed\u7f51\uff08<code>vmbr0</code> / <code>eth0</code> / <code>202.38.75.226/24</code>\uff0c\u4e14\u8be5 IP \u662f <code>vlab.ustc.edu.cn</code> \u57df\u540d\u6307\u5411\u7684\uff09\u3001\u5bb9\u5668\u5185\u7f51\uff08<code>vmbr1</code> / <code>eth1</code> / <code>172.31.0.2/16</code>\uff09\u548c\u7ba1\u7406\u5185\u7f51\uff08<code>vmbr2</code> / <code>eth2</code> / <code>172.30.0.2/24</code>\uff09\uff0c\u901a\u8fc7\u6821\u56ed\u7f51\u5bf9\u5916\u63d0\u4f9b Web \u670d\u52a1\u3001VNC \u7edf\u4e00\u767b\u5f55\u670d\u52a1\u548c SSH \u7edf\u4e00\u767b\u5f55\u670d\u52a1\uff0c\u901a\u8fc7\u5bb9\u5668\u5185\u7f51\u8fde\u63a5\u5176\u4ed6\u865a\u62df\u673a\u3002\u5c3d\u7ba1\u672c\u5bb9\u5668\u63a5\u5165\u4e86\u4e09\u4e2a\u7f51\u7edc\uff0c\u4f46\u662f\u4e0d\u7528\u4f5c\u8f6c\u53d1\u3002</p> <p>\u7531\u4e8e\u8fd9\u4e2a\u5bb9\u5668\u7684 22 \u7aef\u53e3\u7528\u4f5c SSH \u7edf\u4e00\u767b\u5f55\u4e86\uff0c\u56e0\u6b64\u5b83\u81ea\u5df1\u7684 sshd \u5f00\u5728 179 \u7aef\u53e3\u4e0a\u3002</p>"},{"location":"servers/ct101/#ssl","title":"SSL \u8bc1\u4e66","text":"<p>\u6211\u4eec\u4f7f\u7528 acme.sh \u7533\u8bf7\u53ca\u66f4\u65b0 SSL \u8bc1\u4e66\u3002</p> <p>acme.sh \u5b89\u88c5\u5728 <code>/etc/acme.sh</code>\uff0c\u5b89\u88c5\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <pre><code>git clone https://github.com/acmesh-official/acme.sh.git\ncd acme.sh\n./acme.sh --install --home /etc/acme.sh --accountemail vlab@ustc.edu.cn\n</code></pre> <p>\u7533\u8bf7\u8bc1\u4e66\u7684\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>cd /etc/acme.sh\n./acme.sh --issue \\\n-d vlab.ustc.edu.cn \\\n-d file.vlab.ustc.edu.cn \\\n-d bbs.vlab.ustc.edu.cn \\\n-w /var/www\n</code></pre> <p>\u5176\u4e2d <code>/var/www/.well-known</code> \u76ee\u5f55\u63d0\u524d\u5efa\u597d\uff0c\u5e76\u4e14\u9700\u8981\u7533\u8bf7\u8bc1\u4e66\u7684\u57df\u540d\u5bf9\u5e94\u7684 Nginx <code>server</code> \u5757\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> /etc/nginx/snippets/well-known<pre><code>location /.well-known {\naccess_log off;\nroot /var/www;\n}\n</code></pre>"},{"location":"servers/ct101/#web","title":"Django web \u5e94\u7528\u4e0e Nginx","text":"<p>\u672a\u5b8c\u5f85\u7eed</p>"},{"location":"servers/ct101/#vnc-unified-login","title":"VNC \u7edf\u4e00\u767b\u5f55","text":"<p>\u672a\u5b8c\u5f85\u7eed</p>"},{"location":"servers/ct101/#ssh-unified-login","title":"SSH \u7edf\u4e00\u767b\u5f55","text":"<p>\u672a\u5b8c\u5f85\u7eed</p>"},{"location":"servers/ct101/#code-server","title":"\u7f51\u9875\u7248 VS Code","text":"<p>\u7f51\u9875\u7248 VS Code \u5b9e\u9645\u4e0a\u662f\u5728\u7528\u6237\u5bb9\u5668\u5185\u8fd0\u884c\u7684 cdr/code-server\uff0c\u5e76\u5728\u524d\u7aef\u901a\u8fc7 Nginx \u53cd\u4ee3\u5728 <code>/vscode/</code> \u4e0b\u3002\u7531\u4e8e\u6240\u6709\u7528\u6237\u8bbf\u95ee\u7684\u90fd\u662f <code>/vscode/</code> \u8fd9\u4e00\u4e2a\u8def\u5f84\uff0c\u56e0\u6b64\u6211\u4eec\u9760 Cookie \u6765\u9274\u6743\u53ca\u533a\u5206\u7528\u6237\u7684\u865a\u62df\u673a\u3002</p> <p>\u7531\u4e8e\u6211\u4eec\u6ca1\u6709\u4f7f\u7528\u5b8c\u6574\u7684 OpenResty \u5957\u88c5\uff0c\u5728 Lua \u811a\u672c\u91cc\u8fdb\u884c HTTP \u8bf7\u6c42\u4e0d\u592a\u73b0\u5b9e\uff0c\u800c\u4e14\u8fd9\u6837\u505a\u6027\u80fd\u4e5f\u5341\u5206\u7cdf\u7cd5\uff0c\u56e0\u6b64\u6211\u4eec\u5c06\u7528\u6237\u7684\u865a\u62df\u673a IP \u548c\u8fc7\u671f\u65f6\u95f4\u6233\u4e00\u8d77\u5b58\u5728 Cookie \u91cc\uff0c\u5e76\u5bf9 Cookie \u7b7e\u540d\u3002\u5f53\u7528\u6237\u8bbf\u95ee Django \u540e\u7aef\u7684\u201c\u4f7f\u7528 VS Code\u201d\u8fd9\u4e2a\u63a5\u53e3\u65f6\uff0c\u63a5\u53e3\u4f1a\u4e3a\u7528\u6237\u8bbe\u7f6e\u4e0a\u8fd9\u6837\u7684\u4e00\u4e2a Cookie \u5e76\u8df3\u8f6c\u5230 <code>/vscode/</code>\uff1a</p> <pre><code>ngt=172.31.0.1/1612345678+0123456789abcdef0123456789abcdef\n</code></pre> <p>\u8be5 Cookie \u53d6\u540d ngt\uff08NGinx Target\uff0c\u5176\u5b9e\u5e76\u4e0d\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u547d\u540d\uff09\uff0c\u683c\u5f0f\u662f <code>IP/timestamp+signature</code>\uff0c\u5176\u4e2d\u7b7e\u540d\u503c\u662f <code>IP/timestamp</code> \u90e8\u5206\u7684 HMAC-SHA1 \u503c\uff0c\u5bf9\u5e94\u7684 secret \u5206\u522b\u4f4d\u4e8e Django \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u548c Nginx \u7684 Lua \u811a\u672c\u4e2d\u3002</p> <p>\u8d1f\u8d23\u9274\u6743\u53ca\u8fd4\u56de Nginx \u53c2\u6570\u7684 Lua \u4ee3\u7801\u5982\u4e0b\uff1a</p> <pre><code>-- vim:filetype=lua:\n\nlocal key = ngx.var.cookie_ngt -- NGinx Target\n\nif key == nil then\n    return \"missing\"\nend\n\nlocal m = ngx.re.match(key, \"^\\\"?([0-9.]*)/([0-9]*)\\\\+([0-9a-f]*)\\\"?$\", \"io\")\nif m == nil then\n    return \"invalid\"\nend\nlocal payload = m[1] .. \"/\" .. m[2]\nlocal signature = m[3]\n\n--local str = require \"resty.string\"\nfunction to_hex(str)\n    return str:gsub(\".\", function(c) return string.format(\"%02x\", c:byte(1)) end)\nend\n\nlocal hmac = to_hex(ngx.hmac_sha1('secret key here', payload))\n\nif hmac ~= signature then\n    --return \"+\" .. payload .. \"+\" .. hmac .. \"+\" .. signature\n    return \"failed\"\nend\n\nlocal valid_until = tonumber(m[2])\nif valid_until &lt; ngx.time() then\n    return \"expired\"\nend\n\nreturn m[1]\n</code></pre> <p>\u4e0e\u4e4b\u5bf9\u5e94\u7684\u8fd9\u90e8\u5206 Nginx \u914d\u7f6e\u5219\u662f\uff1a</p> <pre><code>###########################################################################\n## Code-server reverse proxy\n###########################################################################\nlocation /vscode/ {\nerror_page 502 /_internal/502-vscode.html;\n\nset_by_lua_file $user_host /etc/nginx/lua/user_host.lua;\nif ($user_host = \"missing\") { return 302 /vm/; }\nif ($user_host = \"invalid\") { return 400; }\nif ($user_host = \"failed\") { return 400; }\nif ($user_host = \"expired\") { return 302 /vm/; }\n\nrewrite ^/vscode/(.*)$ /$1 break;\nproxy_pass http://$user_host:1024;\nproxy_http_version 1.1;\nproxy_set_header Host vlab.ustc.edu.cn;\nproxy_set_header X-Forwarded-Proto $scheme;\nproxy_set_header Upgrade $http_upgrade;\nproxy_set_header Connection upgrade;\nproxy_set_header Accept-Encoding gzip;\n}\n</code></pre> <p>\u7528\u6237\u5728\u865a\u62df\u673a\u5185\u4f7f\u7528\u6211\u4eec\u81ea\u5df1\u7f16\u5199\u7684 <code>vscode</code> \u547d\u4ee4\u6765\u7ba1\u7406 code-server \u5bf9\u5e94\u7684\u7cfb\u7edf\u670d\u52a1\uff0c\u8fd9\u662f\u4e00\u4e2a\uff08\u7c97\u5236\u6ee5\u9020\u7684\uff09Bash \u811a\u672c\uff0c\u89c1 vscode\u3002</p>"},{"location":"servers/ct101/#user-docs","title":"Webhook \u4e0e\u7528\u6237\u6587\u6863","text":"<p>\u5bb9\u5668\u91cc\u6709\u4e00\u4e2a webhook \u670d\u52a1\u5668\uff0c\u4ece GitHub \u63a5\u6536\u7528\u6237\u6587\u6863\u4ed3\u5e93 USTC-vlab/docs \u7684\u66f4\u65b0\u901a\u77e5\u5e76\u62c9\u53d6\u66f4\u65b0\u3002</p> <p>\u4ee3\u7801\u66fe\u7ecf\u662f\u7528 Ruby Sinatra \u5199\u7684\uff0c\u540e\u6765\u6362\u6210\u4e86 Go\uff0c\u53c2\u89c1 <code>/root/webhook/main.go</code>\uff08\u6216\u8fd9\u4e2a Gist\uff09</p> <p>\u7531\u4e8e\u8be5 webhook \u8fc7\u4e8e\u7b80\u5355\uff0c\u5b83\u81ea\u5df1\u751a\u81f3\u6ca1\u6709\u4e00\u4e2a Git \u4ed3\u5e93\u505a\u7248\u672c\u7ba1\u7406\uff08</p> <p>\u6ce8\u610f</p> <p>\u8fd9\u4e2a webhook \u524d\u9762\u8fd8\u662f\u5957\u4e86\u4e00\u5c42 Nginx \u7684\uff0c\u4e0d\u662f\u76f4\u8fde\u7684</p>"},{"location":"servers/ct101/#grafana","title":"Grafana \u4e0e\u76d1\u63a7\u3001\u7edf\u8ba1","text":""},{"location":"servers/ct101/#grafana-security","title":"\u5b89\u5168\u7ef4\u62a4","text":"<p>\u6839\u636e\u76f8\u5173\u8981\u6c42\uff0cgrafana \u9650\u5236\u4ec5\u5141\u8bb8\u6821\u56ed\u7f51\u8bbf\u95ee\u3002\u5c3d\u7ba1\u5982\u6b64\uff0c\u6211\u4eec\u4ecd\u7136\u9700\u8981\u4fdd\u8bc1 grafana \u59cb\u7ec8\u5904\u5728\u5b89\u5168\u7684\u6700\u65b0\u7248\u672c\u3002\u5efa\u8bae\u7ef4\u62a4\u8005\u4f7f\u7528 RSS \u8ba2\u9605 https://grafana.com/tags/security/index.xml\uff0c\u5728\u6709\u5b89\u5168\u901a\u77e5\u53d1\u5e03\u540e\u68c0\u67e5\u7248\u672c\u5e76\u53ca\u65f6\u5347\u7ea7\u3002</p> <p>\u5347\u7ea7\u6b65\u9aa4\uff1a</p> <ol> <li>\u68c0\u67e5 https://grafana.com/docs/grafana/latest/setup-grafana/upgrade-grafana \u662f\u5426\u5305\u542b\u53ef\u80fd\u7834\u574f\u5f53\u524d\u529f\u80fd\u7684\u4fee\u6539\u3002</li> <li>\u6267\u884c <code>docker pull grafana/grafana:latest</code></li> <li>\u6267\u884c <code>~/docker/grafana.sh</code></li> </ol> <p>\u5176\u4ed6\u914d\u7f6e\u672a\u5b8c\u5f85\u7eed\u3002</p>"},{"location":"servers/pve/","title":"Proxmox VE \u4e3b\u673a","text":"<p>\u6211\u4eec\u5c3d\u91cf\u4fdd\u8bc1 PVE \u4e3b\u673a\u5e72\u51c0\u6574\u6d01\uff0c\u53ea\u5b89\u88c5\u914d\u7f6e\u5fc5\u987b\u8fd0\u884c\u5728\u4e3b\u673a\u4e0a\u7684\u670d\u52a1\uff0c\u51cf\u8f7b\u7ef4\u62a4\u538b\u529b\u3002</p>"},{"location":"servers/pve/#pv1","title":"pv1","text":""},{"location":"servers/pve/#ssl","title":"\u66f4\u65b0 SSL \u8bc1\u4e66","text":"<p>\u7531\u4e8e Proxmox VE \u4e3b\u673a\u6ca1\u6709\u51fa\u6821\u6743\u9650\uff0c\u56e0\u6b64\u4e3b\u673a\u4f7f\u7528\u7684 SSL \u8bc1\u4e66\uff08<code>*.ibuglab.com</code>\uff09\u9700\u8981\u901a\u8fc7 web \u5bb9\u5668\uff08CT 101\uff09\u66f4\u65b0\uff0c\u518d\u4ece web \u5bb9\u5668\u4e2d\u53d6\u56de\u3002\u6211\u4eec\u914d\u7f6e\u4e86\u5982\u4e0b\u811a\u672c\uff0c\u4f7f\u7528 cron \u6bcf\u5929\u4ece web \u5bb9\u5668\u4e2d\u540c\u6b65\u8bc1\u4e66\uff1a</p> /etc/cron.daily/sync-cert<pre><code>#!/bin/bash -e\n\nSRC=\"/etc/pve/nodes/pv1\"\nDSTROOT=\"/etc/pve/nodes\"\n\nscp web:/etc/acme.sh/ibuglab.com/ibuglab.com.key \"$SRC/pveproxy-ssl.key\"\nscp web:/etc/acme.sh/ibuglab.com/fullchain.cer \"$SRC/pveproxy-ssl.pem\"\nsystemctl reload pveproxy.service\n\nfor DST in \"$DSTROOT\"/*; do\n[ \"$DST\" = \"$SRC\" ] &amp;&amp; continue\nnode=\"$(basename \"$DST\")\"\ncp \"$SRC/pveproxy-ssl.key\" \"$SRC/pveproxy-ssl.pem\" \"$DST/\"\nssh \"$node\" 'systemctl reload pveproxy.service' &amp;\nscp /etc/hosts \"$node\":/etc/hosts &amp;\ndone\nwait\n\n# Proxmox Backup Server\nscp \"$SRC/pveproxy-ssl.key\" pbs:/etc/proxmox-backup/proxy.key\nscp \"$SRC/pveproxy-ssl.pem\" pbs:/etc/proxmox-backup/proxy.pem\nscp /etc/hosts pbs:/etc/hosts\nssh pbs systemctl reload proxmox-backup-proxy.service\n\n#FP=\"$(openssl x509 -noout -fingerprint -sha256 -inform pem -in \"$SRC/pveproxy-ssl.pem\")\"\n#FP=\"${FP##*=}\"\n#pvesm set pbs --fingerprint \"$FP\"\n</code></pre>"},{"location":"servers/pve/#pve-agent","title":"PVE Agent","text":"<p>\u7531\u4e8e LXC \u5bb9\u5668\u7684\u4e00\u4e9b\u8bbe\u7f6e\uff08\u5982 bind mount\uff09\u5fc5\u987b\u901a\u8fc7 root@pam \u7528\u6237\u767b\u5f55\u65f6\u624d\u80fd\u4fee\u6539\uff0c\u800c\u6211\u4eec\u5e76\u4e0d\u60f3\u5728 django \u4e2d\u5b58\u50a8\u4e3b\u673a\u7684 root \u7528\u6237\u5bc6\u7801\uff0c\u56e0\u6b64\u5199\u4e86\u8fd9\u4e2a agent \u653e\u5728\u4e3b\u673a\u4e0a\uff0c\u901a\u8fc7 HTTP API \u63d0\u4f9b\u8fd9\u4e9b\u529f\u80fd\uff0c\u540e\u7aef\u76f4\u63a5\u8c03\u7528\u4e3b\u673a\u4e0a\u7684 <code>pvesh</code> \u547d\u4ee4\u3002pvesh \u547d\u4ee4\u5728\u4e3b\u673a\u4e0a\u6267\u884c\u65f6\u4f1a\u81ea\u52a8\u4ee5\u6267\u884c\u8be5\u547d\u4ee4\u7684 Linux \u7528\u6237\u8ba4\u8bc1\uff0c\u56e0\u6b64\u53ea\u8981\u8be5 agent \u4ee5 root \u8fd0\u884c\uff0c\u5c31\u80fd\u901a\u8fc7 <code>pvesh</code> \u8c03\u7528\u8fd9\u4e9b\u9700\u8981 root@pam \u7528\u6237\u7684 PVE API\u3002</p> <p>\u4ee3\u7801\u5728 vlab-pve-agent \u4ed3\u5e93\u4e2d\uff0c\u914d\u7f6e\u6587\u4ef6\u4e3a <code>/etc/vlab-pve-agent.json</code>\uff0c\u5bf9\u5e94\u7684 systemd service \u4e3a <code>vlab-pve-agent.service</code>\u3002</p>"},{"location":"servers/pve/#recovery-sshd","title":"Recovery SSHd","text":"<p>PVE \u4e3b\u673a\u4e0a\u53ef\u4ee5\u4f7f\u7528 <code>pct enter</code> \u548c <code>pct console</code> \u547d\u4ee4\u83b7\u53d6 LXC \u5bb9\u5668\u4e2d\u7684\u4e00\u4e2a shell \u6216\u8005\u63a5\u5165 /dev/tty0\uff0c\u4f46\u8be5\u201c\u63a5\u53e3\u201d\u4e0d\u5728 PVE API \u4e2d\u63d0\u4f9b\u3002\u8003\u8651\u5230\u8fd9\u4e24\u4e2a\u63a5\u53e3\u7684\u4e3b\u8981\u8fde\u63a5\u65b9\u5f0f\u662f SSH\uff0c\u56e0\u6b64\u6211\u4eec\u5199\u4e86\u8fd9\u4e2a recovery SSHd \u653e\u5728 pv1 \u4e0a\u8fd0\u884c\uff0c\u4f9b sshpiper \u8c03\u7528\u3002</p> <p>\u4ee3\u7801\u5728 recovery-sshd \u4ed3\u5e93\u4e2d\uff0c\u914d\u7f6e\u6587\u4ef6\u4e3a <code>/etc/recovery-sshd.json</code>\uff0c\u5bf9\u5e94\u7684 systemd service \u4e3a <code>recovery-sshd.service</code>\u3002</p>"},{"location":"servers/pve/#extra-settings","title":"\u989d\u5916\u7684\u7cfb\u7edf\u914d\u7f6e","text":""},{"location":"servers/pve/#subuid-\u548c-subgid","title":"Subuid \u548c Subgid","text":"<p>\u4fee\u6539 subuid \u548c subgid\uff0c\u5c06\u7b2c\u4e09\u5217\u7684\u503c\u4ece 65536 \u6539\u4e3a 165536\uff1a</p> /etc/subuid \u548c /etc/subgid<pre><code>root:100000:165536\n</code></pre>"},{"location":"servers/pve/#lxc-\u7279\u6b8a\u8bbe\u7f6e","title":"LXC \u7279\u6b8a\u8bbe\u7f6e","text":"<p>LXC \u7684\u5168\u5c40\u8bbe\u7f6e\u4f4d\u4e8e <code>/usr/share/lxc/config/common.conf.d/</code>\uff0c\u5176\u4e2d\u9664\u4e86 <code>00-lxcfs.conf</code>\uff08lxcfs \u6302\u8f7d\u76f8\u5173\u5185\u5bb9\uff09\u548c <code>01-pve.conf</code>\uff08\u542f\u52a8\u524d\u3001\u7ed3\u675f\u540e\u3001\u8bbe\u5907\u6302\u8f7d\u76f8\u5173 hook\uff09\u4ee5\u5916\uff0c\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e9b\u81ea\u5df1\u7684\u914d\u7f6e\u3002</p> <p>\u8bbe\u7f6e 32768 PID \u4e0a\u9650\uff0c\u907f\u514d\u5bb9\u5668\u5185\u8fd0\u884c fork bomb \u7b49\u7a0b\u5e8f\u5f71\u54cd\u4e3b\u673a\u6216\u4e92\u76f8\u5f71\u54cd</p> /usr/share/lxc/config/common.conf.d/10-pids.conf<pre><code>lxc.cgroup2.pids.max = 32768\n</code></pre> <p>Info</p> <p>\u4ece PVE 7 \u5f00\u59cb\u6b64\u5904\u8bbe\u7f6e\u9700\u8981\u7528 <code>lxc.cgroup2</code>\uff0ccgroup1 \u7684\u914d\u7f6e\u4ec5\u5bf9 PVE 6 \u6709\u6548\u3002</p> <p>\u7279\u522b\u5730\uff0cpv1 \u4e3b\u673a\u4e0a\u8fd9\u4e2a\u914d\u7f6e\u662f 8192\uff08\u6ca1\u6709\u7528\u6237\u5bb9\u5668\uff09\u3002</p> <p>\u8bbe\u7f6e 16 MiB \u7684\u53ef\u9501\u5b9a\u5185\u5b58\uff0c\u4e3a\u5bb9\u5668\u5185\u4f7f\u7528 earlyoom \u505a\u51c6\u5907\u3002\u8ba8\u8bba\u89c1  discussions#19</p> /usr/share/lxc/config/common.conf.d/10-prlimits.conf<pre><code>lxc.prlimit.memlock = 16777216\n</code></pre>"},{"location":"servers/vm104/","title":"\u5907\u4efd\u670d\u52a1\u5668\uff08VM 104\uff09","text":""},{"location":"servers/vm104/#\u53c2\u89c1\u5907\u4efd","title":"\u53c2\u89c1\u5907\u4efd\u3002","text":""},{"location":"testing/","title":"\u6d4b\u8bd5\u73af\u5883","text":"<p>\u6211\u4eec\u7684\u6d4b\u8bd5\u73af\u5883\u8fd0\u884c\u5728\u5355\u673a pv0 \u4e0a\uff0c\u6ca1\u6709\u4f7f\u7528\u96c6\u7fa4\u914d\u7f6e\u3002</p>"},{"location":"testing/#\u4e0e\u751f\u4ea7\u73af\u5883\u7684\u6bd4\u8f83","title":"\u4e0e\u751f\u4ea7\u73af\u5883\u7684\u6bd4\u8f83","text":"<p>\u6d4b\u8bd5\u73af\u5883\u4e3b\u8981\u7528\u4e8e\u5f00\u53d1\u548c\u6d4b\u8bd5\uff0c\u5404\u65b9\u9762\u914d\u7f6e\u90fd\u4e0e\u751f\u4ea7\u73af\u5883\u63a5\u8fd1\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>\u76f8\u540c\u7684 CT 100\uff08gateway\uff09\u548c CT 101\uff08web\uff09</li> <li>\u76f8\u540c\u7684\u7f51\u7edc\u67b6\u6784</li> <li>\u540c\u6837\u7684 bond / vmbr0 / vmbr1</li> <li>\u540c\u6837\u91c7\u7528 VXLAN \u4f5c\u4e3a\u5bb9\u5668\u5185\u7f51\uff08\u4f46\u662f\u6ca1\u6709\u591a\u673a\uff0c\u4e00\u4e9b\u9632\u706b\u5899\u89c4\u5219\u53ef\u80fd\u4e0d\u8d77\u4f5c\u7528\uff09</li> <li>\u540c\u6837\u7684 IP \u5730\u5740\u5206\u914d\uff08\u5982\u6d4b\u8bd5\u548c\u751f\u4ea7\u7684 gateway \u5bf9\u5185\u90fd\u662f 172.31.0.1\uff09</li> </ul> <p>\u540c\u65f6\u6d4b\u8bd5\u73af\u5883\u4e5f\u7528\u4e8e\u8e29\u5751\uff0c\u6240\u4ee5\u5728\u65b0\u8f6f\u4ef6\u6216\u65b0\u7248\u64cd\u4f5c\u7cfb\u7edf\u53d1\u5e03\u65f6\u751a\u81f3\u53d1\u5e03\u524d\uff0c\u6211\u4eec\u4e5f\u4f1a\u66f4\u79ef\u6781\u5730\u5347\u7ea7\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>pv0 \u5728 2021 \u5e74 7 \u6708\u91cd\u88c5\uff0c\u6211\u4eec\u76f4\u63a5\u91c7\u7528\u4e86 Proxmox VE 7 \u7684 iso \u955c\u50cf\u5b89\u88c5\uff0c\u800c\u5f53\u65f6\u7684\u751f\u4ea7\u73af\u5883\u8fd8\u90fd\u5728\u8fd0\u884c PVE 6.4</li> <li>gateway0 \u548c web0 \u4f7f\u7528 Proxmox \u63d0\u4f9b\u7684 Debian 10.10 (buster) \u955c\u50cf\u521b\u5efa\uff0c\u4f46\u521b\u5efa\u540e\u7acb\u523b\u5347\u7ea7\u5230\u4e86 Debian 11.0 (bullseye)</li> </ul>"},{"location":"testing/#\u4e0e\u751f\u4ea7\u73af\u5883\u7684\u8054\u7cfb","title":"\u4e0e\u751f\u4ea7\u73af\u5883\u7684\u8054\u7cfb","text":""},{"location":"testing/#\u767b\u5f55","title":"\u767b\u5f55","text":"<p>\u4e3a\u4e86\u65b9\u4fbf\u590d\u5236\u548c\u4f20\u8f93\u6570\u636e\uff0c\u90e8\u5206\u751f\u4ea7\u73af\u5883\u7684\u4e3b\u673a\u548c\u865a\u62df\u673a\u53ef\u4ee5\u76f4\u63a5 SSH \u767b\u5f55\u90e8\u5206\u6d4b\u8bd5\u73af\u5883\uff08\u5f53\u7136\u4e5f\u5c31\u53ef\u4ee5 rsync \u4e86\uff09\uff1a</p> <ul> <li>root@pv1 \u901a\u8fc7 SSH \u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee pv0</li> <li>root@web \u901a\u8fc7 SSH \u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee web0</li> </ul> <p>\u4ee5\u4e0a\u4e24\u4e2a\u8bbf\u95ee\u90fd\u662f\u76f4\u63a5\u6dfb\u52a0\u7684 <code>~/.ssh/authorized_keys</code>\u3002</p> <p>Warning</p> <p>\u51fa\u4e8e\u5b89\u5168\u8003\u8651\uff0c\u4e0d\u8981\u5728\u6d4b\u8bd5\u73af\u5883\u4e2d\u914d\u7f6e\u751f\u4ea7\u73af\u5883\u7684\u767b\u5f55\u6743\u9650\uff08\u6dfb\u52a0\u516c\u94a5\u7b49\uff09\u3002</p>"},{"location":"testing/#\u914d\u7f6e","title":"\u914d\u7f6e","text":"<p>\u6d4b\u8bd5\u73af\u5883\u548c\u751f\u4ea7\u73af\u5883\u5171\u7528\u540c\u4e00\u5957 Nginx \u914d\u7f6e\u6587\u4ef6\u65b9\u4fbf\u8c03\u8bd5\uff0c\u4f46\u6d4b\u8bd5\u73af\u5883\u7684 /etc/nginx \u4ed3\u5e93\u4e2d\u7684 deploy key \u6ca1\u6709\u5199\u5165\u6743\u9650\uff0c\u8bf7\u81ea\u884c <code>git pull</code> \u540e\u518d <code>git push</code>\u3002</p> <p>\u5176\u4ed6\u914d\u7f6e\u6682\u65f6\u6ca1\u6709\u5171\u4eab\u3002</p>"},{"location":"testing/devvpn/","title":"VPN for Vlab devs","text":"<p>\u4e3a\u4e86\u65b9\u4fbf\u53c2\u4e0e\u5f00\u53d1\u7684\u540c\u5b66\u8fde\u63a5\u6821\u56ed\u7f51\uff0c\u6211\u4eec\u5f00\u8bbe\u4e86\u4e00\u4e2a OpenVPN Server \u8fd0\u884c\u5728 gateway\uff08CT 100\uff09\u4e0a\u3002</p>"},{"location":"testing/devvpn/#\u4f7f\u7528\u65b9\u5f0f","title":"\u4f7f\u7528\u65b9\u5f0f","text":"<p>\u767b\u5f55\u8fdb gateway\uff0c\u5207\u6362\u76ee\u5f55\u81f3 <code>/etc/openvpn/ca</code>\uff0c\u8fd0\u884c <code>./genconf.sh '&lt;Common Name&gt;'</code>\uff0c\u5176\u4e2d <code>&lt;Common Name&gt;</code> \u4e3a\u6807\u8bc6\u5ba2\u6237\u7aef\u7684\u540d\u79f0\uff08X.509 \u8bc1\u4e66\u7684 Common Name \u5b57\u6bb5\uff0c\u5efa\u8bae\u4f7f\u7528\u59d3\u540d\u6216\u6635\u79f0\u7b49\u80fd\u591f\u8fa8\u8ba4\u7684\u540d\u79f0\uff09\u3002\u5982\u679c\u4e00\u5207\u6b63\u5e38\uff0c\u5c31\u80fd\u5728 <code>clients</code> \u76ee\u5f55\u4e2d\u751f\u6210\u4e00\u4e2a <code>&lt;Common Name&gt;.ovpn</code> \u6587\u4ef6\uff0c\u5c06\u8be5\u6587\u4ef6\u5206\u53d1\u7ed9\u7528\u6237\uff0c\u4f7f\u7528 OpenVPN \u5ba2\u6237\u7aef\u5bfc\u5165\u5e76\u8fde\u63a5\u5373\u53ef\u3002</p>"},{"location":"testing/devvpn/#configure","title":"\u914d\u7f6e OpenVPN Server","text":"<p>\u670d\u52a1\u7aef\u53ea\u9700\u914d\u7f6e\u4e00\u6b21\uff0c\u4ee5\u4e0b\u8bb0\u5f55\u4f5c\u4e3a\u53c2\u8003</p> <p>\u5b89\u88c5\u8f6f\u4ef6\u5305\uff1a</p> <pre><code>apt install --no-install-recommends openvpn easy-rsa\n</code></pre>"},{"location":"testing/devvpn/#openvpn-pki","title":"\u8bc1\u4e66\u7cfb\u7edf","text":"<pre><code>cd /etc/openvpn\nmake-cadir ca\ncd ca\n./easyrsa init-pki\n./easyrsa build-ca nopass\n</code></pre> <p>\u81f3\u6b64\u5728 <code>/etc/openvpn/ca/pki</code> \u76ee\u5f55\u4e0b\u5c31\u6709\u4e00\u5806\u51c6\u5907\u597d\u7684\u6587\u4ef6\uff0c\u53ef\u4ee5\u5f00\u59cb\u7b7e\u8bc1\u4e66\u4e86\u3002</p> <p>\u9996\u5148\u7ed9\u670d\u52a1\u7aef\u7b7e\u4e00\u4e2a\u8bc1\u4e66\uff1a</p> <pre><code>./easyrsa build-server-full 'Vlab VPN Server' nopass\n</code></pre> <p>\u7136\u540e\u628a <code>pki/issued/Vlab VPN Server.crt</code> \u548c <code>pki/issued/Vlab VPN Server.key</code> \u590d\u5236\u5230 <code>/etc/openvpn/server</code> \u4e0b\uff0c\u5206\u522b\u547d\u540d\u4e3a <code>server.crt</code> \u548c <code>server.key</code>\u3002</p> <p>\u63a5\u4e0b\u6765\u6bcf\u4e2a\u5ba2\u6237\u7aef\u90fd\u7528\u8fd9\u6837\u7684\u547d\u4ee4\u7b7e\u4e00\u4e2a\u8bc1\u4e66\uff0c\u6ce8\u610f Common Name \u4e0d\u8981\u91cd\u590d\u3002</p> <pre><code>./easyrsa build-client-full '&lt;Client Name&gt;' nopass\n</code></pre> <p>\u73b0\u5728 <code>pki/issued</code> \u4e0b\u548c <code>pki/private</code> \u4e0b\u5c31\u6709\u4e86\u4e00\u5957\u8bc1\u4e66\u548c\u5bc6\u94a5\uff0c\u53ef\u4ee5\u7528\u5b83\u4eec\u6765\u5236\u4f5c\u5ba2\u6237\u7aef\u914d\u7f6e\u6587\u4ef6\u4e86\uff08\u89c1\u4e0b\uff09\u3002</p>"},{"location":"testing/devvpn/#openvpn-server","title":"OpenVPN Server","text":"<p>\u590d\u5236\u4e00\u4efd\u6837\u4f8b <code>server.conf</code>\uff1a</p> <pre><code>cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz /etc/openvpn/server/\ngunzip /etc/openvpn/server/server.conf.gz\n</code></pre> <p>\u7f16\u8f91 <code>server.conf</code>:</p> <pre><code> ;proto tcp\n-proto udp\n+proto udp6\n</code></pre> <p>Note</p> <p>\u4f7f\u7528 <code>proto udp6</code> \u53ef\u4ee5\u8ba9 OpenVPN server \u4f7f\u7528 v4+v6 \u53cc\u6808\u7684 socket\uff0c\u89c1 https://serverfault.com/a/651869/450575\u3002</p> <pre><code> ;dev tap\n-dev tun\n+dev ovpn\n+dev-type tun\n</code></pre> <pre><code>-;topology subnet\n+topology subnet\n</code></pre> <pre><code>-server 10.8.0.0 255.255.255.0\n+server 192.168.254.0 255.255.255.0\n</code></pre> <pre><code>-tls-auth ta.key 0 # This file is secret\n+;tls-auth ta.key 0 # This file is secret\n</code></pre> <pre><code>-;push \"route 192.168.10.0 255.255.255.0\"\n-;push \"route 192.168.20.0 255.255.255.0\"\n+push \"route 172.31.0.0 255.255.0.0\"\n+push \"route 202.38.75.85 255.255.255.255\"\n+push \"route 202.38.75.4 255.255.255.255\"\n+push \"route 202.38.75.24 255.255.255.255\"\n</code></pre> <pre><code>-cipher AES-256-CBC\n+cipher AES-256-GCM\n</code></pre> <pre><code>-;user nobody\n-;group nogroup\n+user nobody\n+group nogroup\n</code></pre> <p>\u751f\u6210 DH \u53c2\u6570\u6587\u4ef6\uff1a</p> <pre><code>openssl dhparam -out /etc/openvpn/server/dh2048.pem 2048\n</code></pre>"},{"location":"testing/devvpn/#openvpn-client-conf","title":"\u7f16\u5199\u5ba2\u6237\u7aef\u914d\u7f6e\u6587\u4ef6","text":"<p>\u4e0e OpenVPN server \u7c7b\u4f3c\uff0c\u4e00\u4e2a\u57fa\u672c\u7684\u5ba2\u6237\u7aef\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\uff1a</p> OpenVPN \u5ba2\u6237\u7aef\u914d\u7f6e\u6587\u4ef6\u6837\u4f8b <pre><code>client\n\nproto udp\n\ndev vlabvpn\ndev-type tun\n\npersist-key\npersist-tun\n\nnobind\nremote &lt;!-- \u670d\u52a1\u5668\u5730\u5740 --&gt;\ncipher AES-256-GCM\n\n&lt;ca&gt;\n&lt;!-- CA \u8bc1\u4e66 --&gt;\n&lt;/ca&gt;\n&lt;cert&gt;\n&lt;!-- \u6b64\u5ba2\u6237\u7aef\u7684\u8bc1\u4e66 --&gt;\n&lt;/cert&gt;\n&lt;key&gt;\n&lt;!-- \u6b64\u5ba2\u6237\u7aef\u7684\u79c1\u94a5 --&gt;\n&lt;/key&gt;\n</code></pre> <p>\u5176\u4e2d <code>&lt;ca&gt;</code> \u53ef\u4ee5\u76f4\u63a5\u586b\u5165 ca.crt \u6587\u4ef6\u7684\u5185\u5bb9\uff0c\u800c <code>&lt;cert&gt;</code> \u548c <code>&lt;key&gt;</code> \u9700\u8981\u4e3a\u6bcf\u4e2a\u5ba2\u6237\u7aef\u7b7e\u53d1\u4e00\u4e2a\uff0c\u56e0\u6b64\u6211\u4eec\u7f16\u5199\u4e86\u4e00\u4e2a\u811a\u672c\uff0c\u8c03\u7528 <code>easyrsa</code> \u7b7e\u53d1\u5ba2\u6237\u7aef\u8bc1\u4e66\uff0c\u5e76\u5229\u7528\u6a21\u677f\u5728 <code>clients/</code> \u76ee\u5f55\u4e0b\u751f\u6210\u5ba2\u6237\u7aef\u914d\u7f6e\u6587\u4ef6\uff1a</p> /etc/openvpn/ca/genconf.sh <pre><code>#!/bin/bash\n\n[ -n \"$BASH_VERSION\" ] || exit 1\ncd \"$(dirname \"$0\")\"\nPKI=\"$(dirname \"$0\")\"/pki\nOUTDIR=\"$(dirname \"$0\")\"/clients\n\ngen_conf() {\nlocal cafile=\"$1\"\nlocal certfile=\"$2\"\nlocal keyfile=\"$3\"\ncat &lt;&lt; EOF\n#!/usr/bin/openvpn\nclient\n\nproto udp\n\ndev vlabvpn\ndev-type tun\n\npersist-key\npersist-tun\n\nnobind\nremote vpn.ibuglab.com\ncipher AES-256-GCM\n\n&lt;ca&gt;\n$(&lt;\"$cafile\")\n&lt;/ca&gt;\n&lt;cert&gt;\n$(&lt;\"$certfile\")\n&lt;/cert&gt;\n&lt;key&gt;\n$(&lt;\"$keyfile\")\n&lt;/key&gt;\nEOF\n}\n\nif [ $# -eq 0 ]; then\necho \"Need an argument!\" &gt;&amp;2\nexit 1\nelif [ $# -gt 1 ]; then\necho \"Too many arguments!\" &gt;&amp;2\nexit 1\nfi\nCN=\"$1\"\nOUTFILE=\"$OUTDIR\"/\"$CN\".ovpn\nif [ -f \"$OUTFILE\" ]; then\necho \"Error: Output file $OUTFILE already exists. Remove it if you want to proceed.\" &gt;&amp;2\nexit 1\nfi\n\nrm -f \"$PKI\"/reqs/\"$CN\".req \"$PKI\"/issued/\"$CN\".crt \"$PKI\"/private/\"$CN\".key\n./easyrsa build-client-full \"$CN\" nopass\ngen_conf \"$PKI\"/ca.crt \"$PKI\"/issued/\"$CN\".crt \"$PKI\"/private/\"$CN\".key &gt; \"$OUTFILE\"\nrm -f \"$PKI\"/reqs/\"$CN\".req \"$PKI\"/issued/\"$CN\".crt \"$PKI\"/private/\"$CN\".key\n</code></pre> <p>\u8be5\u811a\u672c\u7684\u4f7f\u7528\u65b9\u5f0f\u89c1\u672c\u6587\u6700\u4e0a\u65b9\u3002</p>"},{"location":"ui/rdpproxy/","title":"RDP Proxy \u914d\u7f6e","text":"<p>\u53c2\u8003 <code>.rdp</code> \u6587\u4ef6\uff1a</p> <pre><code>connection type:i:7\ndisable wallpaper:i:0\nallow font smoothing:i:1\nallow desktop composition:i:1\ndisable full window drag:i:0\ndisable menu anims:i:0\nfull address:s:vlab.ustc.edu.cn\nloadbalanceinfo:s:Cookie: msts=example_token\n</code></pre>"},{"location":"ui/vncmux/","title":"\u8fdc\u7a0b\u684c\u9762\u914d\u7f6e\u4e0e\u7ba1\u7406","text":"<p>vnc-multiplexer (\u4ee5\u4e0b\u7b80\u79f0 vncmux) \u7528\u4e8e\u5b9e\u73b0 VNC \u7edf\u4e00\u767b\u5f55\u3002vncmux \u7528\u6237\u5728\u767b\u5f55\u4e2d\u8f93\u5165\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801\uff0c\u5c06\u88ab\u7a0b\u5e8f\u901a\u8fc7 API \u53d1\u9001\u7ed9 Django \u540e\u7aef\uff0c\u5e76\u5f97\u5230\u5185\u7f51\u5ba2\u6237\u673a\u7684 VNC \u670d\u52a1\u5668\u8fde\u63a5\u4fe1\u606f\uff0c\u4ee5\u6b64\u5b9e\u73b0\u8f6c\u53d1\u3002\u9664\u4e86\u7b80\u5355\u7684\u8f6c\u53d1\u6570\u636e\uff0cvncmux \u8fd8\u4f1a\u5bf9 VNC \u534f\u8bae\u7684\u6d88\u606f\u8fdb\u884c\u89e3\u6790\u3001\u4fee\u6539\uff0c\u4ee5\u6b64\u5b9e\u73b0\u901a\u77e5\u529f\u80fd\u3002\u4ee5\u4e0b\u7b80\u4ecb vncmux \u7684\u914d\u7f6e\u548c\u7ba1\u7406\u65b9\u6cd5\u3002</p>"},{"location":"ui/vncmux/#\u914d\u7f6e\u6587\u4ef6","title":"\u914d\u7f6e\u6587\u4ef6","text":"<p>vncmux \u7684\u914d\u7f6e\u6587\u4ef6\u5b58\u50a8\u5728 <code>/etc/vnc_multiplexer/config.json</code>\uff0c\u76ee\u524d\u5982\u4e0b\uff1a</p> <pre><code>{\n\"port\": 5900,\n\"api\": \"http://127.0.0.1:8000/vm/vnc/\",\n\"cert_chain_file\": \"/etc/letsencrypt/live/vlab.ustc.edu.cn/fullchain.pem\",\n\"private_key_file\": \"/etc/letsencrypt/live/vlab.ustc.edu.cn/privkey.pem\",\n\"dhparam_file\": \"/etc/vnc_multiplexer/dhparam.pem\",\n\"ra2_private_key_file\": \"/etc/vnc_multiplexer/ra2.pem\",\n\"enabled_protocol\": [\"RA2r_256\", \"RA2r\", \"RA2_256\", \"RA2\", \"VeNCrypt\"],\n\"enable_log\": true,\n\"logger_ip\": \"127.0.0.1\",\n\"logger_port\": 5555,\n\"enable_notification\": true,\n\"notification_file\": \"/etc/vnc_multiplexer/notification.png\",\n\"enable_admin\": true,\n\"admin_path\": \"\",\n\"enable_websocket\": true,\n\"websocket_port\": 5801,\n\"enable_tight_translation\": true,\n\"tight_jpeg_level\": 7,\n\"threads\": 8\n}\n</code></pre> <p>\u5176\u4e2d\u5404\u9879\u610f\u4e49\u5982\u4e0b\uff1a</p> <ul> <li> <p><code>api</code>\uff1a Django \u540e\u7aef API \u7684 URL \uff0c\u8bf7\u6ce8\u610f\u4e0d\u5f97\u4f7f\u7528 HTTPS\u3002</p> </li> <li> <p><code>cert_chain_file</code>\uff1a TLS \u8bc1\u4e66\u6587\u4ef6\uff0c\u4e0d\u7528\u66f4\u6539\u3002</p> </li> <li> <p><code>private_key_file</code>\uff1a TLS \u79c1\u94a5\u6587\u4ef6\uff0c\u4e0d\u7528\u66f4\u6539\u3002</p> </li> <li> <p><code>dhparam_file</code>\uff1a DH \u5bf9\u6587\u4ef6\uff0c\u4e0d\u7528\u66f4\u6539\u3002</p> </li> <li> <p><code>ra2_private_key_file</code>\uff1a RealVNC \u534f\u8bae\u79c1\u94a5\u6587\u4ef6\uff0c\u7528\u4e8e\u8bc1\u660e\u670d\u52a1\u5668\u7684\u8eab\u4efd\u3002\u5fc5\u987b\u4e3a PKCS#8 RSA 2048 \u79c1\u94a5\u6587\u4ef6\u3002</p> </li> <li> <p><code>enabled_protocol</code>\uff1a \u5141\u8bb8\u7684\u534f\u8bae\u3002<code>VeNCrypt</code> \u4e3a TigerVNC \u4f7f\u7528\u7684\u534f\u8bae\u3002 <code>RA2</code>, <code>RA2r</code>, <code>RA2_256</code>, <code>RA2r_256</code> \u5747\u4e3a RealVNC \u7684\u52a0\u5bc6\u534f\u8bae, <code>RA2ne</code>, <code>RA2ne_256</code> \u4e3a RealVNC \u4f7f\u7528\u7684\u975e\u52a0\u5bc6\u534f\u8bae\uff0c\u5efa\u8bae\u5173\u95ed\u3002</p> </li> <li> <p><code>enable_log</code>\uff1a \u662f\u5426\u5f00\u542f\u65e5\u5fd7\u3002\u65e5\u5fd7\u5c06\u5728\u6bcf\u4e2a\u8fde\u63a5\u5173\u95ed\u540e\u901a\u8fc7 UDP \u62a5\u6587\u53d1\u9001\u7ed9\u65e5\u5fd7\u670d\u52a1\u5668\u3002</p> </li> <li> <p><code>logger_ip</code>\uff1a \u65e5\u5fd7\u670d\u52a1\u5668 IP</p> </li> <li> <p><code>logger_port</code>\uff1a \u65e5\u5fd7\u670d\u52a1\u5668\u7aef\u53e3</p> </li> <li> <p><code>enable_notification</code>\uff1a \u662f\u5426\u5f00\u542f\u901a\u77e5\u529f\u80fd\u3002\u82e5\u5f00\u542f\uff0c\u6bcf\u4e2a\u7528\u6237\u8fde\u63a5\u540e vncmux \u90fd\u5c06\u5728\u753b\u9762\u4e0a\u6ce8\u5165\u4e00\u4e2a\u53ef\u5173\u95ed\u7684\u5bf9\u8bdd\u6846\u7528\u4ee5\u663e\u793a\u901a\u77e5\u3002</p> </li> <li> <p><code>notification_file</code>\uff1a \u901a\u77e5\u56fe\u7247\u6587\u4ef6\u3002\u5fc5\u987b\u4e3a PNG \u683c\u5f0f\u3002</p> </li> <li> <p><code>enable_admin</code>\uff1a \u662f\u5426\u5f00\u542f\u7ba1\u7406\u7aef\u53e3\u3002\u82e5\u5f00\u542f\uff0c vncmux \u5c06\u5728\u4e00\u4e2a Unix domain socket \u4e0a\u63a5\u6536\u7ba1\u7406\u547d\u4ee4\uff0c\u4ee5\u6b64\u4e0e vncmux-cli \u5de5\u5177\u8fde\u63a5\u3002</p> </li> <li> <p><code>admin_path</code>\uff1a \u7ba1\u7406\u7aef\u53e3\u7684\u8def\u5f84\uff0c\u7559\u7a7a\u5219\u4e3a\u9ed8\u8ba4\u503c <code>/var/run/vncmux.sock</code></p> </li> <li> <p><code>enable_websocket</code>\uff1a \u662f\u5426\u5f00\u542f WebSocket \u529f\u80fd\u3002noVNC \u5fc5\u987b\u4f7f\u7528\u6b64\u529f\u80fd\uff0c\u56e0\u6b64\u603b\u662f\u5e94\u8be5\u5f00\u542f\u3002\u8fd9\u91cc\u7684 WebSocket \u8fde\u63a5\u662f\u672a\u52a0\u5bc6\u7684\uff0c\u9700\u8981\u4f7f\u7528 Nginx \u53cd\u4ee3\u3002</p> </li> <li> <p><code>websocket_port</code>\uff1a WebSocket \u670d\u52a1\u7aef\u53e3</p> </li> <li> <p><code>enable_tight_translation</code>\uff1a \u662f\u5426\u7ed9 RealVNC \u5f00\u542f\u6709\u635f\u538b\u7f29\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b RealVNC \u8fde\u63a5 TigerVNC \u670d\u52a1\u7aef\u53ea\u652f\u6301\u65e0\u635f\u538b\u7f29\u3002\u6b64\u529f\u80fd\u5c06 TigerVNC \u53d1\u51fa\u7684 Tight \u7f16\u7801\u6570\u636e\u8f6c\u6362\u6210 RealVNC \u53ef\u8bfb\u7684\u683c\u5f0f\uff0c\u4ee5\u6b64\u5b9e\u73b0\u4f7f\u7528 JPEG \u538b\u7f29\u3002\u5f00\u542f\u540e\u53ef\u4ee5\u8ba9 RealVNC \u6d41\u7545\u5f88\u591a\uff0c\u4f46\u662f\u53ef\u80fd\u964d\u4f4e\u753b\u8d28\u3002</p> </li> <li> <p><code>tight_jpeg_level</code>\uff1a RealVNC \u6709\u635f\u538b\u7f29\u7684\u8d28\u91cf\u7b49\u7ea7\u3002\u53d6\u503c\u8303\u56f4\u662f 0 \u5230 9\u3002\u5982\u679c\u4e3a 8 \u63a5\u8fd1\u65e0\u635f\u3002</p> </li> <li> <p><code>threads</code>\uff1a \u5de5\u4f5c\u7ebf\u7a0b\u6570</p> </li> </ul>"},{"location":"ui/vncmux/#vncmux-cli-\u5de5\u5177","title":"vncmux-cli \u5de5\u5177","text":"<p>vncmux-cli \u5de5\u5177\u7528\u4e8e\u7ba1\u7406\u8fd0\u884c\u4e2d\u7684 vncmux \u670d\u52a1\u5668\u3002\u8fde\u63a5\u5230 vncmux \u670d\u52a1\u5668\u7684\u65b9\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>vncmux-cli [path]\n</code></pre> <p>\u8fde\u63a5\u540e\u8f93\u5165 <code>exit</code> \u53ef\u4ee5\u9000\u51fa\uff0c\u8f93\u5165 <code>help</code> \u53ef\u4ee5\u663e\u793a\u5e2e\u52a9\uff0c\u8fd8\u53ef\u4ee5\u8fdb\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a</p>"},{"location":"ui/vncmux/#\u5217\u51fa\u5728\u7ebf\u7528\u6237","title":"\u5217\u51fa\u5728\u7ebf\u7528\u6237","text":"<p>\u8f93\u5165 <code>list</code> \u5373\u53ef\u5217\u51fa\u5728\u7ebf\u7528\u6237\u7684\u4fe1\u606f\uff0c\u5305\u62ec\u8fde\u63a5 ID \u3001\u8fde\u63a5\u65f6\u95f4\u3001\u7528\u6237\u540d\u3001\u4e3b\u673a IP \u3001\u7528\u6237 IP \u3001\u5ba2\u6237\u7aef\u7c7b\u578b\u3002</p>"},{"location":"ui/vncmux/#\u65ad\u5f00\u7528\u6237\u8fde\u63a5","title":"\u65ad\u5f00\u7528\u6237\u8fde\u63a5","text":"<p>\u8f93\u5165 <code>disconnect &lt;id&gt;</code> \u53ef\u4ee5\u628a ID \u5bf9\u5e94\u7684\u8fde\u63a5\u65ad\u5f00\u3002</p>"},{"location":"ui/vncmux/#\u66f4\u6362\u901a\u77e5\u56fe\u7247","title":"\u66f4\u6362\u901a\u77e5\u56fe\u7247","text":"<p>\u8f93\u5165 <code>load-notification &lt;image file&gt;</code> \u53ef\u4ee5\u66f4\u6362\u901a\u77e5\u6587\u4ef6\uff0c\u901a\u77e5\u6587\u4ef6\u6700\u597d\u662f\u7edd\u5bf9\u8def\u5f84\u3002\u5f53\u524d\u5df2\u5728\u7ebf\u7684\u7528\u6237\u5c06\u4e0d\u4f1a\u770b\u5230\u65b0\u7684\u901a\u77e5\u3002</p>"},{"location":"ui/vncmux/#\u53d1\u9001\u56fe\u7247","title":"\u53d1\u9001\u56fe\u7247","text":"<p>\u53ef\u4ee5\u53d1\u9001 PNG \u683c\u5f0f\u7684\u56fe\u7247\u7ed9\u4e00\u4e2a\u6216\u591a\u4e2a\u7528\u6237\u3002\u547d\u4ee4\u683c\u5f0f\u4e3a <code>send-image &lt;image file&gt; &lt;id&gt; [id] ...</code> \uff0c\u5176\u4e2d id \u53ef\u4ee5\u4ece <code>list</code> \u7684\u8f93\u51fa\u5f97\u77e5\u3002</p>"},{"location":"ui/vncmux/#\u6253\u5f00\u548c\u5173\u95ed\u901a\u77e5","title":"\u6253\u5f00\u548c\u5173\u95ed\u901a\u77e5","text":"<p>\u547d\u4ee4\u5206\u522b\u4e3a <code>enable-notification</code> \u548c <code>disable-notification</code></p>"},{"location":"ui/vncmux/#\u6253\u5f00\u548c\u5173\u95ed-realvnc-\u6709\u635f\u538b\u7f29","title":"\u6253\u5f00\u548c\u5173\u95ed RealVNC \u6709\u635f\u538b\u7f29","text":"<p>\u547d\u4ee4\u5206\u522b\u4e3a <code>enable-realvnc-lossy</code> \u548c <code>disable-realvnc-lossy</code></p>"},{"location":"ui/vncmux/#\u8bbe\u5b9a-realvnc-\u6709\u635f\u538b\u7f29\u8d28\u91cf\u7b49\u7ea7","title":"\u8bbe\u5b9a RealVNC \u6709\u635f\u538b\u7f29\u8d28\u91cf\u7b49\u7ea7","text":"<p>\u547d\u4ee4\u4e3a <code>set-realvnc-jpeg-level &lt;0-9&gt;</code></p>"},{"location":"vlab-software/","title":"Vlab \u5b9e\u9a8c\u8f6f\u4ef6\u5957\u88c5","text":"<p>Vlab Software \u662f\u5b58\u653e\u4e8e\u5404\u4e2a\u4e3b\u673a\u4e0a\u7684 <code>/opt/vlab</code> \u7684\u8f6f\u4ef6\u7ec4\u5408\uff0c\u901a\u8fc7 bind mount \u6302\u8f7d\u8fdb\u865a\u62df\u673a\u7684 <code>/opt/vlab</code> \u76ee\u5f55\uff0c\u4e3a\u7528\u6237\u63d0\u4f9b\u9884\u88c5\u7684\u8f6f\u4ef6\u3002\u56e0\u6b64\u6211\u4eec\u4e5f\u7ecf\u5e38\u79f0\u4e3a /opt/vlab\u3002</p> <p>\u4e3a\u4e86\u4fdd\u8bc1\u5404\u7528\u6237\u80fd\u591f\u53ca\u65f6\u7528\u4e0a\u7edf\u4e00\u7248\u672c\u7684 Vlab Software\uff0c\u6211\u4eec\u5728 pv1 \u4e0a\u4f7f\u7528 crontab \u6bcf\u5929\u51cc\u6668\u5c06 <code>/opt/vlab</code> \u540c\u6b65\u81f3 pv2-pv7 \u4e0a\uff0c\u5176\u4e2d crontab \u6761\u76ee\u5982\u4e0b\uff1a</p> <pre><code>47 4 * * * /root/sync-software.sh\n</code></pre> <p>\u5bf9\u5e94\u7684 shell \u811a\u672c\u5982\u4e0b\uff1a</p> <pre><code>#!/bin/bash\n\nexec &gt;/dev/null 2&gt;/dev/null\n\nfor node in pv{2..7}; do\nrsync -avz --delete /opt/vlab/ \"$node\":/opt/vlab/ &amp;\ndone\nwait\n</code></pre> <p>\u5982\u679c\u6709\u5bf9 <code>/opt/vlab</code> \u4fee\u6539\u540e\u9700\u8981\u7acb\u523b\u540c\u6b65\u7684\uff08\u4e00\u822c\u4e0d\u9700\u8981\uff09\uff0c\u624b\u52a8\u6267\u884c <code>/root/sync-software.sh</code> \u5373\u53ef\u3002</p>"},{"location":"vlab-software/#\u4e3a\u865a\u62df\u673a\u914d\u7f6e-vlab-software","title":"\u4e3a\u865a\u62df\u673a\u914d\u7f6e Vlab Software","text":"<p>\u5728 <code>/etc/skel/.config/menus/</code> \u4e0b\u65b0\u5efa <code>mate-applications.menu</code> \u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>&lt;?xml version=\"1.0\" ?&gt;\n&lt;!DOCTYPE Menu\n  PUBLIC '-//freedesktop//DTD Menu 1.0//EN'\n  'http://standards.freedesktop.org/menu-spec/menu-1.0.dtd'&gt;\n&lt;Menu&gt;\n&lt;Name&gt;Applications&lt;/Name&gt;\n&lt;MergeFile type=\"parent\"&gt;/etc/xdg/menus/mate-applications.menu&lt;/MergeFile&gt;\n\n&lt;!-- Vlab --&gt;\n&lt;Menu&gt;\n&lt;Name&gt;Vlab&lt;/Name&gt;\n&lt;Directory&gt;Vlab.directory&lt;/Directory&gt;\n&lt;AppDir&gt;/opt/vlab/applications&lt;/AppDir&gt;\n&lt;Include&gt;&lt;And&gt;&lt;Category&gt;Vlab&lt;/Category&gt;&lt;/And&gt;&lt;/Include&gt;\n&lt;/Menu&gt;\n&lt;/Menu&gt;\n</code></pre> <p>\uff08\u5176\u4ed6\u684c\u9762\u73af\u5883\u4e0b\u6587\u4ef6\u540d\u9700\u8981\u505a\u7c7b\u4f3c\u4fee\u6539\uff09</p> \u65e7\u7684\u76f4\u63a5\u4fee\u6539\u7cfb\u7edf\u6587\u4ef6\u7684\u65b9\u6cd5 <p>\u53d6\u51b3\u4e8e\u6240\u5b89\u88c5\u7684\u684c\u9762\u73af\u5883\uff0c\u5728 <code>/etc/xdg/menus</code> \u4e0b\u7684\u67d0\u4e2a <code>.menu</code> \u6587\u4ef6\u6700\u540e\u7684\u5173\u95ed\u6807\u7b7e\u524d\u63d2\u5165\u5982\u4e0b\u5185\u5bb9\uff0c\u4e5f\u5c31\u662f\u5728\u6700\u5916\u5c42\u7684 <code>&lt;Menu&gt;</code> \u4e0b\u6dfb\u52a0\u4e00\u4e2a\u5b50\u952e\u3002</p> <pre><code>&lt;!-- Vlab --&gt;\n&lt;Menu&gt;\n&lt;Name&gt;Vlab&lt;/Name&gt;\n&lt;Directory&gt;Vlab.directory&lt;/Directory&gt;\n&lt;AppDir&gt;/opt/vlab/applications&lt;/AppDir&gt;\n&lt;Include&gt;&lt;And&gt;&lt;Category&gt;Vlab&lt;/Category&gt;&lt;/And&gt;&lt;/Include&gt;\n&lt;/Menu&gt;\n</code></pre> <p>\u4f8b\u5982\uff0c\u5bf9\u4e8e MATE \u684c\u9762\u73af\u5883\uff0c\u6587\u4ef6\u662f <code>/etc/xdg/menus/mate-applications.menu</code>\uff1b\u5bf9\u4e8e Xfce \u6587\u4ef6\u540d\u662f <code>xfce-applications.menu</code>\u3002</p> <p>\u540c\u65f6\u4e3a\u4e86\u4f7f\u547d\u4ee4\u884c\u73af\u5883\u80fd\u591f\u6b63\u786e\u52a0\u8f7d PATH\uff0c\u9700\u8981\u5728 <code>/etc/profile.d</code> \u4e0b\u521b\u5efa\u4e00\u4e2a\u6587\u4ef6 <code>vlab.sh</code>\uff1a</p> <pre><code>if [ -e /opt/vlab/path.sh ]; then\nsource /opt/vlab/path.sh\nfi\n</code></pre> <p>\u5982\u679c\u6ca1\u6709 <code>/etc/profile.d</code> \u76ee\u5f55\uff0c\u5c31\u5c06\u8fd9\u51e0\u884c\u4ee3\u7801\u52a0\u5728 <code>/etc/profile</code> \u7684\u672b\u5c3e\u3002</p> <p>\u6700\u540e\uff0c\u8bb0\u5f97\u66ff\u6362\u4e0a Vlab \u7684\u4e13\u5c5e\u684c\u9762\uff1ahttps://vlab.ustc.edu.cn/downloads/background.jpg\uff08wget \u4e0b\u6765\u653e\u5728\u5408\u9002\u7684\u4f4d\u7f6e\u914d\u7f6e\u597d\u684c\u9762\u8bbe\u7f6e\uff09</p>"},{"location":"vlab-software/installation/","title":"\u5404\u8f6f\u4ef6\u7684\u5b89\u88c5\u65b9\u5f0f","text":"<p>\u672a\u5b8c\u5f85\u7eed</p>"},{"location":"vlab-software/misc/","title":"Vlab \u5b9e\u9a8c\u8f6f\u4ef6\u5957\u88c5\u76f8\u5173\u8bb0\u5f55","text":""},{"location":"vlab-software/misc/#\u5728-lxc-\u4e2d\u4ee5-ubuntu-1804-docker-\u5bb9\u5668\u8fd0\u884c-vivado-20191","title":"\u5728 LXC \u4e2d\u4ee5 Ubuntu 18.04 Docker \u5bb9\u5668\u8fd0\u884c Vivado 2019.1","text":"<p>\u8fd0\u884c Ubuntu 18.04 \u5bb9\u5668\uff1a</p> <pre><code>sudo docker run -it -e DISPLAY=$DISPLAY -e LANG=\"zh_CN.UTF-8\" -v /tmp/.X11-unix/:/tmp/.X11-unix -v /opt/vlab:/opt/vlab -v /home/ubuntu:/user --rm ustclug/ubuntu:18.04\n</code></pre> <p>\u5728\u542f\u52a8\u7684 Docker \u5bb9\u5668\u4e2d:</p> <ul> <li>\u5b89\u88c5\u76f8\u5173\u4f9d\u8d56</li> <li>\u914d\u7f6e locales\uff08\u5426\u5219\u6d4f\u89c8\u6587\u4ef6\u4e2d\u542b\u4e2d\u6587\u4f1a\u629b\u51fa\u5f02\u5e38\uff09</li> <li>\u6dfb\u52a0\u7528\u6237\uff08\u5426\u5219\u4f1a\u51fa\u73b0\u6743\u9650\u9519\u8bef <code>connect(3, {sa_family=AF_UNIX, sun_path=@\"/tmp/.X11-unix/X0\"}, 20) = -1 ECONNREFUSED (Connection refused)</code>\uff09\uff1a</li> </ul> <pre><code>apt update\napt install libx11-6 libxext6 libxrender1 libxtst6 libxi6 locales\nlocale-gen zh_CN.UTF-8\nadduser vlab  # \u9700\u8981\u8ba9\u5bb9\u5668\u4e2d\u7528\u6237 PID \u4e0e\u5916\u9762\u76f8\u540c\nsu vlab\n/opt/vlab/bin/vivado\n</code></pre>"},{"location":"workflow/miscellaneous/","title":"\u6742\u9879","text":""},{"location":"workflow/miscellaneous/#list-all-vms","title":"\u5217\u51fa\u96c6\u7fa4\u4e2d\u6240\u6709\u5bb9\u5668","text":"<p>\u9996\u5148 <code>apt install jq</code>\uff08\u8fd9\u4e2a\u5de5\u5177\u5f88\u5c0f\uff0c\u4e0d\u7528\u62c5\u5fc3\u5f04\u4e71\u7cfb\u7edf\u73af\u5883\uff09\uff0c\u7136\u540e</p> <pre><code>jq -r '.ids | to_entries[] | select(.value.type == \"lxc\") | .key' /etc/pve/.vmlist\n</code></pre> <p>\u5982\u679c\u8981\u5217\u51fa\u865a\u62df\u673a\u7684\u8bdd\uff0c\u5c06 select type \u6362\u6210 qemu \u5373\u53ef\uff1b\u5982\u679c\u4e24\u8005\u90fd\u8981\u5217\u51fa\u7684\u8bdd\uff0c\u76f4\u63a5\u53bb\u6389 select \u8fd9\u4e2a filter\u3002</p> <p>\u53c2\u8003\u8d44\u6599\uff1a</p> <ul> <li>List all VMID's from command line? | Proxmox Support Forum</li> </ul>"},{"location":"workflow/miscellaneous/#\u4ece\u4e3b\u673a\u4e0a\u5bfb\u627e-pid-\u6240\u5c5e\u7684\u5bb9\u5668","title":"\u4ece\u4e3b\u673a\u4e0a\u5bfb\u627e PID \u6240\u5c5e\u7684\u5bb9\u5668","text":"<p>\u601d\u8def\uff1a\u4ece <code>/proc</code> \u91cc\u4e0d\u65ad\u8bfb\u53d6\u5176\u7236 PID \u76f4\u5230\u627e\u5230\u5bb9\u5668\u91cc\u7684 PID 1\uff0c\u8fd9\u4e2a \"PID 1\" \u7684\u7236\u8fdb\u7a0b <code>lxc-start</code> \u7684\u547d\u4ee4\u884c\u91cc\u53ef\u4ee5\u770b\u5230\u5bb9\u5668 ID\u3002</p> <p>\u53c2\u8003\u4ee3\u7801\uff1a</p> <pre><code>#!/bin/sh\n\nPID=\"$1\"\n\nwhile :; do\nprocfile=\"/proc/$PID/status\"\nname=$(awk '$1==\"Name:\"{print $2}' \"$procfile\")\nppid=$(awk '$1==\"PPid:\"{print $2}' \"$procfile\")\nif [ \"$name\" = \"lxc-start\" ]; then\ntr '\\0' ' ' &lt; \"/proc/$PID/cmdline\" | cut -d' ' -f4\n    break\nelif [ \"$ppid\" -eq 1 ]; then\necho Failed\n    exit 1\nelse\nPID=\"$ppid\"\nfi\ndone\n</code></pre>"},{"location":"workflow/new-host/","title":"\u914d\u7f6e\u65b0\u4e3b\u673a\u5e76\u52a0\u5165\u96c6\u7fa4","text":"<p>\u4f7f\u7528 U \u76d8\u5b89\u88c5\u597d Proxmox VE\uff0c\u4e3b\u673a\u540d\u4e3a <code>pv#.ibuglab.com</code>\uff08Proxmox \u5b89\u88c5\u7a0b\u5e8f\u8981\u6c42\uff0c\u88c5\u597d\u540e\u53ef\u4ee5\u6539\uff09\uff0c\u5176\u4e2d <code>#</code> \u4e3a\u6570\u5b57\u6216\u5176\u4ed6\u6807\u8bb0\uff0c\u624b\u52a8\u9012\u589e\u3002</p>"},{"location":"workflow/new-host/#\u8fdc\u7a0b\u8bbf\u95ee","title":"\u8fdc\u7a0b\u8bbf\u95ee","text":"<p>\u5148\u914d\u597d SSH \u8bbf\u95ee\uff0c\u5bf9 SSH Host Key \u7b7e\u540d\uff0c\u5e76\u52a0\u5165 TrustedUserCAKeys\u3002\u89c1 SSH \u8bc1\u4e66\u8ba4\u8bc1 \u4e00\u9875\u3002</p> <p>\u5728\u52a0\u5165\u73b0\u6709\u7684 Proxmox VE \u96c6\u7fa4\u540e\u5220\u9664 root \u5bc6\u7801\uff08<code>passwd -d root</code>\uff09\uff0c\u65b9\u4fbf\u4ee5\u540e\u7ef4\u62a4\u3002</p>"},{"location":"workflow/new-host/#\u8f6f\u4ef6\u6e90","title":"\u8f6f\u4ef6\u6e90","text":"<p>\u4fee\u6539 <code>/etc/apt/sources.list</code>\uff0c\u5c06\u8f6f\u4ef6\u6e90\u66ff\u6362\u4e3a TUNA\uff1a</p> <pre><code>deb https://mirrors.ustc.edu.cn/debian bullseye main contrib\ndeb https://mirrors.ustc.edu.cn/debian bullseye-updates main contrib\ndeb https://mirrors.ustc.edu.cn/debian-security bullseye-security main contrib\n</code></pre> <p>\u5220\u9664 <code>/etc/apt/sources.list.d/pve-enterprise.list</code>\uff0c\u65b0\u5efa <code>/etc/apt/sources.list.d/pve.list</code>\uff0c\u5199\u5165\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>deb https://mirrors.ustc.edu.cn/proxmox/debian bullseye pve-no-subscription\n</code></pre> <p>\u5237\u65b0\u8f6f\u4ef6\u6e90\u5e76\u5b89\u88c5\u66f4\u65b0\u3002</p>"},{"location":"workflow/new-host/#\u5b89\u88c5\u8f6f\u4ef6\u53ef\u9009","title":"\u5b89\u88c5\u8f6f\u4ef6\uff08\u53ef\u9009\uff09","text":"<p>\u4ece APT \u5b89\u88c5\u4e00\u4e9b\u8f6f\u4ef6\u4ee5\u4fbf\u7ba1\u7406\u548c\u8c03\u8bd5\u3002\u8bf7\u5c3d\u53ef\u80fd\u4fdd\u6301\u4e3b\u673a\u7cfb\u7edf\u7b80\u6d01\u3002</p> <ul> <li>Vim \u5b87\u5b99\u7b2c\u4e00\u6587\u672c\u7f16\u8f91\u5668</li> <li>Htop \u4efb\u52a1\u7ba1\u7406\u5668</li> <li>iptables-persistent \u548c ipset-persistent \u7528\u4e8e\u4fdd\u5b58 iptables \u914d\u7f6e</li> <li>ipmitool \u7528\u4e8e\u7ef4\u62a4 IPMI\uff0c\u4f7f\u7528\u6700\u7b80\u5b89\u88c5\uff08\u5373 <code>--no-install-recommends</code>\uff09</li> </ul>"},{"location":"workflow/new-host/#\u914d\u7f6e\u7f51\u5361","title":"\u914d\u7f6e\u7f51\u5361","text":"<p>\u53c2\u89c1\u4e3b\u673a\u7f51\u5361\u4e00\u9875\u3002</p>"},{"location":"workflow/new-host/#\u914d\u7f6e\u9632\u706b\u5899","title":"\u914d\u7f6e\u9632\u706b\u5899","text":"<p>\u9700\u8981\u5b89\u88c5 <code>iptables-persistent</code> \u548c <code>ipset-persistent</code> \u8f6f\u4ef6\u5305\uff0c\u4ece\u53e6\u4e00\u53f0\u4e3b\u673a\u4e0a\u590d\u5236 <code>/etc/iptables</code> \u76ee\u5f55\uff0c\u4fee\u6539\u76f8\u5173\u6587\u4ef6\u4e2d\u7684\u7f51\u5361\u540d\u79f0\uff08\u5982\u6709\u9700\u8981\uff09\u5e76\u91cd\u542f <code>netfilter-persistent.service</code>\u3002</p>"},{"location":"workflow/new-host/#\u6302\u8f7d\u5b58\u50a8\u670d\u52a1\u5668","title":"\u6302\u8f7d\u5b58\u50a8\u670d\u52a1\u5668","text":"<p>\u4f7f\u7528 iSCSI \u547d\u4ee4\u884c\u7ba1\u7406\u5de5\u5177</p> <pre><code>iscsiadm -m discovery -t sendtargets -p 10.0.0.200\niscsiadm -m node -T iqn.2015-11.com.hpe:storage.msa1050.1840436ed4 -p 10.0.0.200 --login\n</code></pre> <p>\u5b58\u50a8\u670d\u52a1\u5668\u7684\u4f7f\u7528\u5730\u5740\u4e3a 10.0.0.200 \u4e0e 10.0.0.201\uff0c\u5206\u522b\u5f52\u5c5e\u4e24\u4e2a\u63a7\u5236\u5668\uff0c\u5efa\u8bae\u5404\u53f0\u8ba1\u7b97\u670d\u52a1\u5668\u4ea4\u66ff\u8fde\u63a5\u8fd9\u4e24\u4e2a\u5730\u5740\u4ee5\u300c\u8d1f\u8f7d\u5747\u8861\u300d\u3002</p> <p>\u7b2c\u4e00\u6b65\uff08<code>-t sendtargets</code>\uff09\u64cd\u4f5c\u5b8c\u6210\u540e\u9700\u8981\u8fdb\u5165 <code>/etc/iscsi/nodes/iqn.2015-11.com.hpe:storage.msa1050.1840436ed4</code> \u5220\u6389\u591a\u4f59\u7684\u8d44\u6599\uff0c\u53ea\u4fdd\u7559\u7b2c\u4e8c\u6b65\u9009\u5b9a\u7684\u90a3\u4e2a IP \u5bf9\u5e94\u7684\u76ee\u5f55\u3002</p> <p>\u6302\u8f7d\u770b\u5230 iSCSI \u7684\u5377\u4e4b\u540e\uff0c\u8fdb\u5165\u5b58\u50a8\u670d\u52a1\u5668\u7684\u7ba1\u7406\u9875\u9762\uff0c\u9009 Hosts\uff0c\u4e3a\u521a\u624d\u65b0\u589e\u7684\u90a3\u4e2a\u4e3b\u673a\u8865\u4e0a\u540d\u79f0\u3002IQN \u53ef\u4ee5\u770b\u4e3b\u673a\u91cc\u7684 <code>/etc/iscsi/initiatorname.iscsi</code> \u6587\u4ef6\u6765\u786e\u8ba4\u3002</p>"},{"location":"workflow/new-host/#\u66f4\u65b0-open-iscsiservice","title":"\u66f4\u65b0 open-iscsi.service","text":"<p>open-iscsi \u8f6f\u4ef6\u5305\u901a\u8fc7 systemd \u670d\u52a1\u63d0\u4f9b\u4e86\u5f00\u673a\u81ea\u52a8\u6302\u8f7d iSCSI \u7684\u529f\u80fd\uff0c\u4f46\u662f\u7531\u4e8e\u6211\u4eec\u7684\u5b58\u50a8\u8bbe\u65bd\u5728\u4e00\u4e2a\u94fe\u8def\u4e0a\u66b4\u9732\u4e86\u4e24\u4e2a\u7aef\u53e3\uff08IP \u5730\u5740\uff09\uff0c\u76f4\u63a5\u4f7f\u7528\u8be5\u670d\u52a1\u4f1a\u5bfc\u81f4\u5b58\u50a8\u88ab\u6302\u8f7d\u4e24\u904d\uff0c\u540e\u9762 LVM \u4f1a\u4ea7\u751f\u66f4\u591a\u7684\u8b66\u544a\u6216\u9519\u8bef\u4fe1\u606f\u3002</p> <p>\u6211\u4eec\u6ca1\u6709\u627e\u5230\u4e00\u4e2a\u201c\u539f\u751f\u201d\u7684\u89e3\u51b3\u529e\u6cd5\uff0c\u6240\u4ee5\u6211\u4eec\u76f4\u63a5\u4fee\u6539\u670d\u52a1\uff08\u4f7f\u7528 <code>systemctl edit</code> \u6216\u624b\u52a8\u6dfb\u52a0 override.conf \u6587\u4ef6\uff09\uff1a</p> <pre><code>[Service]\nExecStart=\nExecStart=/sbin/iscsiadm -d8 -m node -T iqn.2015-11.com.hpe:storage.msa1050.1840436ed4 -p 10.0.0.200 --login ExecStart=/lib/open-iscsi/activate-storage.sh\n</code></pre> <p>\u6ce8\u610f\u628a\u4e2d\u95f4\u90a3\u884c\u540e\u9762\u7684 IP \u5730\u5740\u6362\u6389\uff08\u5982\u679c\u9700\u8981\uff09\u3002</p> <p>\u8fd9\u662f\u4e00\u4e2a oneshot \u7c7b\u578b\u7684\u670d\u52a1\uff0c\u6240\u4ee5\u4fee\u6539\u4e4b\u540e\u5c31\u653e\u7740\u4e0d\u7528\u52a8\u4e86\uff0c\u4e0b\u6b21\u5f00\u673a\u65f6\u4f1a\u81ea\u52a8\u5e94\u7528\u3002</p>"},{"location":"workflow/new-host/#\u6302\u8f7d-nfs-\u955c\u50cf\u5171\u4eab","title":"\u6302\u8f7d NFS \u955c\u50cf\u5171\u4eab","text":"<p>\u6302\u8f7d NFS \u5171\u4eab\u6240\u7528\u7684 <code>/etc/fstab</code> \u6761\u76ee\uff1a</p> <pre><code>10.0.0.1:/var/lib/vz /mnt/vz nfs rw,async,hard,intr,noexec 0 0\n</code></pre> <p>\u6ce8\u610f\u5148\u5728 pv1 \u4e0a\u7f16\u8f91 <code>/etc/exports</code> \u5e76\u8fd0\u884c <code>exportfs -a</code> \u5237\u65b0\u6302\u8f7d\u6743\u9650\u3002</p>"},{"location":"workflow/new-host/#\u989d\u5916\u7684\u7cfb\u7edf\u8bbe\u7f6e","title":"\u989d\u5916\u7684\u7cfb\u7edf\u8bbe\u7f6e","text":"<p>\u53c2\u89c1 PVE \u670d\u52a1\u5668\u7684\u989d\u5916\u8bbe\u7f6e\u3002</p>"},{"location":"workflow/pack-ct-image/","title":"\u6253\u5305\u5bb9\u5668\u955c\u50cf","text":"<p>Success</p> <p>\u6211\u4eec\u5df2\u5c06\u6b64\u4efb\u52a1\u5b8c\u5168\u81ea\u52a8\u5316\uff0c\u811a\u672c\u548c\u76f8\u5173\u8d44\u6e90\u5728 labstrap \u4ed3\u5e93\u4e2d\u3002</p> <p>\u7ba1\u7406\u5458\uff08\u6709\u4ed3\u5e93\u6743\u9650\u7684\u4eba\uff09\u53ef\u4ee5\u5728 Image Build CI \u9875\u9762\u70b9\u51fb Run workflow \u542f\u52a8\u4e00\u6b21\u6784\u5efa\uff0c\u6784\u5efa\u5b8c\u6210\u540e\u4f1a\u81ea\u52a8\u4e0a\u4f20\u5230 Auto builds \u8fd9\u4e2a release\u3002</p> <p>Tip</p> <p>\u4ee5\u4e0b\u5185\u5bb9\u662f\u6211\u4eec\u5728\u81ea\u52a8\u5316\u4e4b\u524d\u7684\u624b\u52a8\u6253\u5305\u6d41\u7a0b\uff0c\u7559\u4f5c\u53c2\u8003\u3002</p> <p>Proxmox VE \u7684\u5bb9\u5668\u955c\u50cf\u548c LXC \u7565\u6709\u4e0d\u540c\uff0c\u6240\u4ee5\u4ece LXC \u4e0b\u8f7d\u7684\u955c\u50cf\u4e0d\u5b9c\u76f4\u63a5\u7528\u4e8e Proxmox VE\u3002\u57fa\u51c6\u955c\u50cf\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5df2\u6709\u7684 vlab \u955c\u50cf\uff08\u63a8\u8350\uff09\uff0c\u6216\u8005\u4f7f\u7528 <code>pveam</code> \u547d\u4ee4\u4ece Proxmox \u5b98\u65b9\u4e0b\u8f7d\u3002</p> <p>\u540c\u6837\u7531\u4e8e\u955c\u50cf\u5185\u5bb9\u7684\u4e0d\u4e00\u81f4\u4ee5\u53ca\u4e0b\u9762\u63d0\u5230\u7684\u4e00\u4e9b\u4e0e\u7f51\u7edc\u76f8\u5173\u7684\u8bbe\u7f6e\uff0c\u5c1d\u8bd5\u5728\u81ea\u5df1\u7684 LXC / LXD \u73af\u5883\u4e2d\u8fdb\u884c\u955c\u50cf\u7684\u914d\u7f6e\u5de5\u4f5c\u53ef\u80fd\u4f1a\u9047\u5230\u5404\u79cd\u5404\u6837\u7684\u56f0\u96be\uff0c\u4f8b\u5982\u6743\u9650\u95ee\u9898\u3001\u7f51\u7edc\u95ee\u9898\u7b49\uff0c\u56e0\u6b64\u6211\u4eec\u76f4\u63a5\u5728\u73b0\u6709\u7684 Proxmox \u96c6\u7fa4\u4e2d\u64cd\u4f5c\u5c31\u884c\u4e86\u3002</p> <p>\u6253\u5305\u7684\u5bb9\u5668\u955c\u50cf\u5e94\u5f53\u5728\u529f\u80fd\u5b8c\u6574\u3001\u8ffd\u6c42\u5f00\u7bb1\u5373\u7528\u7684\u60c5\u51b5\u4e0b\u5c3d\u53ef\u80fd\u4fdd\u6301\u7cbe\u7b80\uff0c\u4f8b\u5982 build-essential \u53ef\u4ee5\u5b89\u88c5\uff0c\u4f46\u662f Clang / LLVM \u6700\u597d\u4e0d\u8981\uff08</p>"},{"location":"workflow/pack-ct-image/#prepare-ct","title":"\u4e00\u3001\u51c6\u5907\u65b0\u7684\u5bb9\u5668\u73af\u5883","text":"<p>\u767b\u5f55\u96c6\u7fa4\u65b0\u5efa\u4e00\u4e2a\u5bb9\u5668\uff0c\u6311\u4e00\u4e2a\u8d1f\u8f7d\u8f83\u4f4e\u7684\u8282\u70b9\uff08\u4f8b\u5982 pv8\uff09\uff0c\u628a Unprivileged container \u53d6\u6d88\u52fe\u9009\uff08\u9ed8\u8ba4\u662f\u9009\u4e2d\u7684\uff0c\u4e0d\u53d6\u6d88\u7684\u8bdd\u540e\u9762\u6253\u5305\u65f6\u8981\u989d\u5916\u5904\u7406\u4e00\u4e0b\uff09\uff0c\u6a21\u677f\u9009\u4e00\u4e2a\u57fa\u7840\u955c\u50cf\uff0c\u786c\u76d8\u5927\u5c0f\u6839\u636e\u8981\u88c5\u7684\u4e1c\u897f\u4f30\u8ba1\uff0c\u5178\u578b\u7684 Ubuntu 20.04 \u955c\u50cf\u53ea\u8981 4 GB \u5c31\u591f\uff0c\u8fd9\u91cc\u53ef\u4ee5\u9009\u62e9\u5b58\u50a8\u4e3a local-lvm \u4ee5\u83b7\u5f97\u66f4\u597d\u7684\u786c\u76d8\u6027\u80fd\uff08\u4e3b\u673a\u7684 SSD\uff09\u3002CPU \u548c\u5185\u5b58\u53ef\u4ee5\u968f\u610f\uff0c\u53cd\u6b63\u8fd9\u4e2a\u5bb9\u5668\u662f\u4e34\u65f6\u4f7f\u7528\u7684\u3002\u5bb9\u5668\u7f51\u7edc\u8fde\u63a5\u5230 vmbr1\uff0c\u968f\u4fbf\u53d6\u4e00\u4e2a\u6ca1\u7528\u8fc7\u7684 IPv4 \u5730\u5740\uff08\u5efa\u8bae 172.31.0.240 - 172.31.0.255 \u4e4b\u95f4\uff09\uff0c\u63a9\u7801\u662f /16\uff0c\u7f51\u5173\u4e3a 172.31.0.1\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u76f4\u63a5\u4e0b\u4e00\u6b65\u521b\u5efa\u4e86\u3002</p>"},{"location":"workflow/pack-ct-image/#base-works","title":"\u4e8c\u3001\u57fa\u7840\u5de5\u4f5c","text":"<p>\u672c\u8282\u5de5\u4f5c\u53ea\u9700\u8981\u5bf9\u4ece Proxmox \u76f4\u63a5\u4e0b\u8f7d\u7684\u201c\u6700\u539f\u59cb\u201d\u7684\u955c\u50cf\u5904\u7406\u3002</p> <ul> <li>\u6362\u6e90\uff1a\u5c06 apt / yum \u6e90\u6362\u4e3a <code>mirrors.ustc.edu.cn</code></li> <li> <p>\u52a0\u5165 SSH CA \u516c\u94a5\uff1a\u8fd9\u91cc\u8bf7\u52a0\u5165 Vlab User CA\uff08SSH \u8bc1\u4e66\u8ba4\u8bc1\u8fd9\u4e00\u9875\u4e0b\u9762\u90a3\u4e2a\uff09</p> <p>\u5bf9\u4e8e Ubuntu 20.04 \u7cfb\u7edf\uff0c\u5176\u9ed8\u8ba4\u7684 <code>sshd_config</code> \u91cc\u6709\u4e00\u884c Include\uff0c\u6240\u4ee5\u53ef\u4ee5\u5f88\u65b9\u4fbf\u5730\u5728 <code>/etc/ssh/sshd_config.d</code> \u4e0b\u65b0\u5efa\u4e00\u4e2a\u6587\u4ef6\u7528\u6765\u5199 <code>TrustedUserCAKeys</code>\u3002\u5bf9\u4e8e\u5176\u4ed6\u7cfb\u7edf\uff0c\u8fd8\u662f\u5c06\u914d\u7f6e\u76f4\u63a5\u8ffd\u52a0\u81f3\u7cfb\u7edf\u7684 <code>sshd_config</code>\u3002</p> </li> <li> <p>\u8bbe\u7f6e\u7cfb\u7edf\u8bed\u8a00\uff1a\u4f7f\u7528 <code>dpkg-reconfigure locales</code> \u751f\u6210 <code>en_US.UTF-8</code> \u548c <code>zh_CN.UTF-8</code> \u7684\u8bed\u8a00\u5e76\u5c06\u4e2d\u6587\u8bbe\u4e3a\u9ed8\u8ba4\u3002\u4e0d\u8981\u5b89\u88c5 <code>locales-all</code> \u5305\uff0c\u5b83\u592a\u5927\u4e86\uff0c\u6211\u4eec\u7528\u4e0d\u4e0a</p> </li> </ul> <p>\u4e0b\u9762\u8fd9\u4e9b\u5de5\u4f5c\u53ef\u4ee5\u51ed\u81ea\u5df1\u559c\u597d\u9009\u505a\uff1a</p> <ul> <li>\u5b89\u88c5\u8f6f\u4ef6\uff1a\u4f8b\u5982 <code>build-essential</code>, Git, Vim \u7b49\u5e38\u7528\u8f6f\u4ef6\u5de5\u5177\u3002\u8bf7\u5c3d\u91cf\u4fdd\u6301\u7cbe\u7b80</li> <li>\u66f4\u65b0 <code>/etc/skel</code>\uff1a\u4f8b\u5982\uff0c\u5728 <code>.bashrc</code> \u91cc\u9ed8\u8ba4\u542f\u7528\u6709\u989c\u8272\u7684 PS1\uff08\u9650 Ubuntu / Debian\uff09\uff0c\u6216\u8005\u63d0\u4f9b\u9ed8\u8ba4\u7684 rc \u7c7b\u914d\u7f6e\u6587\u4ef6</li> <li>\u66f4\u65b0 <code>/etc/motd</code>\uff1a\u4e5f\u5c31 SSH \u767b\u5f55\u7684\u65f6\u5019\u663e\u793a\u4e00\u4e0b\uff0c\u6539\u4e0d\u6539\u6ca1\u5565\u533a\u522b</li> </ul> <p>\u5982\u679c\u6253\u5305\u7684\u76ee\u6807\u4e0d\u662f\u5e26\u684c\u9762\u73af\u5883\u7684\u955c\u50cf\u7684\u8bdd\uff0c\u7b2c\u4e09\u6b65\u5c31\u53ef\u4ee5\u8df3\u8fc7\u4e86\u3002</p>"},{"location":"workflow/pack-ct-image/#install-desktop-environment","title":"\u4e09\u3001\u5b89\u88c5\u4e0e\u6d4b\u8bd5\u684c\u9762\u73af\u5883","text":"<p>\u684c\u9762\u73af\u5883\u7684\u914d\u7f6e\u8f83\u4e3a\u590d\u6742\uff0c\u56e0\u4e3a\u8981\u8fd0\u884c VNC server \u5e76\u5c06\u5176\u4f5c\u4e3a\u684c\u9762\u7ba1\u7406\u5668\u7684\u4e3b\u663e\u793a\u8f93\u51fa\u3002\u7ecf\u8fc7 pdlan \u7684\u8c03\u8bd5\uff0c\u91c7\u7528 LightDM + TigerVNC server \u7684\u7ec4\u5408\uff0c\u4f7f\u7528\u4e00\u4e2a\u81ea\u5df1\u7f16\u5199\u7684\u542f\u52a8\u811a\u672c\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\u3002\u8fd9\u90e8\u5206\u914d\u7f6e\u5de5\u4f5c\u6211\u4eec\u5df2\u7ecf\u6253\u5305\u6210\u4e86\u4e00\u4e2a Debian package\uff0c\u653e\u5728 https://vlab.ustc.edu.cn/repo/vlab-vnc.deb\uff0c\u53ef\u4ee5\u76f4\u63a5\u5b89\u88c5\uff0c\u6ce8\u610f\u4f7f\u7528 <code>--no-install-recommends</code>\u3002</p> <p>\u7531\u4e8e\u540e\u53f0 VNC server \u91c7\u7528\u4e86\u65e0\u5bc6\u7801\u7684\u8ba4\u8bc1\u65b9\u5f0f\uff0c\u56e0\u6b64\u989d\u5916\u4f7f\u7528 iptables \u9632\u706b\u5899\u6765\u9650\u5236\u53ea\u80fd\u4ece web \u670d\u52a1\u5668\u7684\u5730\u5740\u8fde\u63a5 VNC server\uff0c\u8be5\u90e8\u5206\u5904\u7406\u653e\u5728\u4e86 deb \u7684 postinst \u64cd\u4f5c\u4e2d\uff0c\u4f1a\u52a0\u4e0a\u4e00\u6761 IPv4 \u89c4\u5219\u9650\u5236\u6765\u6e90\u548c\u4e00\u6761 IPv6 \u89c4\u5219\u62d2\u7edd\u6240\u6709\u8fde\u63a5\u3002</p> <p>\u684c\u9762\u73af\u5883\u6211\u4eec\u4e00\u822c\u9009\u7528\u8f7b\u91cf\u7684 Xfce\uff08\u5b89\u88c5 <code>xfce4</code>\uff0c\u4e5f\u8981\u4f7f\u7528 <code>--no-install-recommends</code>\uff09\uff0c\u88c5\u597d\u4e4b\u540e\u542f\u52a8 <code>lightdm.service</code> \u5c31\u53ef\u4ee5\u6d4b\u8bd5\u4e86\u3002</p> <p>\u4e3a\u4e86\u505a\u5230\u201c\u5f00\u7bb1\u5373\u7528\u201d\uff0c\u4e00\u822c\u8fd8\u4f1a\u5b89\u88c5\u4e00\u4e9b\u5e38\u7528\u8f6f\u4ef6\uff0c\u5982\u6d4f\u89c8\u5668\u3001\u6587\u672c\u7f16\u8f91\u5668\u7b49\uff0c\u540c\u65f6\u5b89\u88c5\u5408\u9002\u7684\u5b57\u4f53\u548c\u8f93\u5165\u6cd5\u786e\u4fdd\u4e2d\u6587\u80fd\u591f\u6b63\u5e38\u4f7f\u7528\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u6211\u4eec\u4f1a\u5b89\u88c5\uff1a</p> <ul> <li>Firefox \u6d4f\u89c8\u5668</li> <li>Xfce \u7684\u5c0f\u73a9\u610f <code>xfce-goodies</code>\uff0c\u8fd9\u4e2a\u5305\u4f1a\u5e26\u4e0a\u8bb0\u4e8b\u672c\u8ba1\u7b97\u5668\u7b49\u5c0f\u5de5\u5177</li> <li><code>ibus-pinyin</code> \u6216 <code>fcitx-libpinyin</code> \u5e76\u914d\u7f6e\u597d\uff0c\u4f5c\u4e3a\u9ed8\u8ba4\u7684\u4e2d\u6587\u62fc\u97f3\u8f93\u5165\u6cd5</li> <li><code>fonts-droid-fallback</code> \u6216 <code>fonts-wqy-microhei</code> \u4f5c\u4e3a\u4e2d\u6587\u5b57\u4f53\u3002\u4e0d\u8981\u5b89\u88c5 <code>fonts-noto-sans</code> \u7b49\u5b57\u4f53\uff0c\u5b83\u4eec\u592a\u5927\u4e86</li> <li> <p>\u91cd\u8981\uff1a<code>libncurses5</code>\uff0cVivado \u9700\u8981\u5b83</p> <p>\u53e6\u4e00\u4e2a\u529e\u6cd5\u662f\uff0c\u8fdb\u5165 <code>/lib/x86_64-linux-gnu/</code> \u76ee\u5f55\uff0c\u5c06 <code>libncurses.so.5</code> \u8f6f\u94fe\u63a5\u5230 <code>libncurses.so.6</code>\uff0c\u540c\u6837\u4e5f\u94fe\u63a5\u4e00\u4e0b <code>libtinfo.so.5</code> \u5373\u53ef\u3002</p> <pre><code>cd /lib/x86_64-linux-gnu/\nln -s libncurses.so.6 libncurses.so.5\nln -s libtinfo.so.6 libtinfo.so.5\n</code></pre> </li> </ul> <p>\u7531\u4e8e\u684c\u9762\u73af\u5883\u7ecf\u5e38\u9644\u5e26\u4e00\u5806\u7528\u4e0d\u4e0a\u7684\u4e1c\u897f\uff0c\u6240\u4ee5\u6253\u5305\u524d\u591a\u82b1\u70b9\u65f6\u95f4\u6e05\u7406\u3002</p>"},{"location":"workflow/pack-ct-image/#\u914d\u7f6e-vlab-software","title":"\u914d\u7f6e Vlab Software","text":"<p>\u4e3b\u6587\u7ae0\uff1aVlab Software</p> <p>\u53c2\u8003\u4e3b\u6587\u7ae0\u914d\u7f6e menu\u3002</p> <p>\u521b\u5efa <code>/etc/profile.d/vlab.sh</code>\uff0c\u586b\u5165\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>if [ -e /opt/vlab/path.sh ]; then\n. /opt/vlab/path.sh\nfi\n</code></pre> <p>\u5982\u679c\u6ca1\u6709 <code>/etc/profile.d</code> \u76ee\u5f55\uff0c\u5c31\u5c06\u8fd9\u51e0\u884c\u4ee3\u7801\u52a0\u5728 <code>/etc/profile</code> \u7684\u672b\u5c3e\u3002</p> <p>\u975e Ubuntu \u865a\u62df\u673a\u7684 lightdm \u53ef\u80fd\u4e0d\u4f1a\u52a0\u8f7d profile\uff0c\u6240\u4ee5\u9700\u8981\uff1a</p> <pre><code>ln -s /etc/profile.d/vlab.sh /etc/X11/Xsession.d/99vlab\n</code></pre> <p>\u8ba9 lightdm \u542f\u52a8\u65f6\u66f4\u65b0 vlab \u4fe1\u606f\u3002</p> <p>\u6700\u540e\uff0c\u8bb0\u5f97\u66ff\u6362\u4e0a Vlab \u7684\u4e13\u5c5e\u684c\u9762\uff1ahttps://vlab.ustc.edu.cn/downloads/background.jpg</p>"},{"location":"workflow/pack-ct-image/#test-desktop-environment","title":"\u6d4b\u8bd5\u684c\u9762\u73af\u5883","text":"<p>\u53ea\u63a5\u5165\u5185\u7f51\u7684\u5bb9\u5668\u4e2d\u8f6c\u53d1\u4ec0\u4e48\u7684\u6bd4\u8f83\u9ebb\u70e6\uff08\u5982\u679c\u4f60\u4f1a\u7528 SSH \u8f6c\u53d1 <code>ssh -L</code> \u7684\u8bdd\u5f53\u7136\u4e5f\u53ef\u4ee5\uff09\uff0c\u8fd9\u91cc\u63d0\u4f9b\u4e00\u4e2a\u4f7f\u7528 VNC \u7edf\u4e00\u767b\u5f55\u7684\u529e\u6cd5\uff0c\u5c31\u662f\u81ea\u5df1\u521b\u5efa\u4e00\u4e2a\u865a\u62df\u673a\uff0c\u8bb0\u5f55\u4e0b IP \u4e4b\u540e\u5173\u673a\uff0c\u518d\u628a IP \u5207\u6362\u5230\u6b63\u5728\u5b89\u88c5\u914d\u7f6e\u7684\u8fd9\u4e2a\u5bb9\u5668\u4e0a\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528 VNC \u7edf\u4e00\u767b\u5f55\u4e86\u3002</p> <p>LightDM \u7684\u5173\u673a\u91cd\u542f\u529f\u80fd\u65e0\u6548\u662f\u6b63\u5e38\u73b0\u8c61\uff0c\u653e\u5fc3\u5ffd\u7565\uff0c\u53ea\u8981 Logout \u80fd\u7528\u5c31\u57fa\u672c OK \u4e86\u3002</p>"},{"location":"workflow/pack-ct-image/#pre-packaging","title":"\u56db\u3001\u6253\u5305\u524d\u7684\u5de5\u4f5c","text":"<p>\u5176\u5b9e\u5c31\u662f\u6e05\u7406\u5de5\u4f5c\uff0c\u907f\u514d\u628a\u4e0d\u5fc5\u8981\u7684\u5185\u5bb9\u6253\u5305\u8fdb\u955c\u50cf\u3002\u4e0b\u9762\u662f\u4e00\u4e9b\u9700\u8981\u6e05\u7406\u7684\u4e1c\u897f\uff1a\uff08\u5047\u8bbe\u5bb9\u5668\u955c\u50cf\u7684\u6302\u8f7d\u70b9\u4e3a/\u89e3\u538b\u5230\u4e86 <code>$MOUNT</code>\uff09</p> <ul> <li><code>$MOUNT/etc/ssh</code>\uff1a\u5c06\u751f\u6210\u7684 Host Key \u5168\u90e8\u5220\u6389\uff08\u5982\u679c\u6709\uff09\uff0c\u8fd9\u6837\u521b\u5efa\u65b0\u5bb9\u5668\u7684\u65f6\u5019\u53ef\u4ee5\u751f\u6210\u65b0\u7684\u4e3b\u673a\u5bc6\u94a5\u5bf9</li> <li><code>$MOUNT/run</code>, <code>$MOUNT/tmp</code>, <code>$MOUNT/var/{backups,cache,crash,log,tmp}</code>\uff1a\u5168\u90e8\u6e05\u7a7a\uff0c\u6ce8\u610f <code>$MOUNT/tmp</code>, <code>$MOUNT/var/crash</code> \u548c <code>$MOUNT/var/tmp</code> \u8fd9\u4e09\u4e2a\u76ee\u5f55\u7684\u6743\u9650\u662f 1777 (rwxrwxrwt)\uff0c\u5176\u4ed6\u76ee\u5f55\u6743\u9650\u90fd\u662f 0755 (rwxr-xr-x)\u3002</li> <li><code>$MOUNT/root</code> \u548c <code>$MOUNT/home/&lt;user&gt;</code>\uff1a\u628a <code>.bash_history</code> \u4e4b\u7c7b\u7684\u6587\u4ef6\u90fd\u5220\u6389\uff0c\u53ea\u7559\u4e0b\u6700\u57fa\u672c\u7684\u5185\u5bb9\uff08\u5982\u679c\u914d\u7f6e\u4e86\u684c\u9762\u73af\u5883\uff0c\u8c28\u614e\u6e05\u7406 <code>.config</code>\uff09\u3002</li> <li><code>$MOUNT/var/spool/postfix/dev</code> \u548c <code>$MOUNT/dev</code>\uff1a\u5426\u5219\u65b0\u5efa\u5bb9\u5668\u65f6\u53ef\u80fd\u4f1a\u51fa\u9519\u3002</li> </ul> <p>\u6e05\u7406\u7684\u65f6\u5019\u5207\u6362\u76ee\u5f55\u65f6\u8bf7\u52ff\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\uff0c\u5e76\u4e14\u52a1\u5fc5\u770b\u6e05\u695a\uff0c\u4e0d\u8981\u628a host \u7684\u6587\u4ef6\u5220\u4e86\uff01</p> <p>\u5bf9\u4e8e Ubuntu/Debian \u955c\u50cf\uff0c\u8fd8\uff08\u6700\u597d\uff09\u8981\u6e05\u9664 apt \u7684\u7f13\u5b58\u3002\u53ef\u4ee5\u4f7f\u7528 chroot \u8fdb\u5165\u955c\u50cf\u8fd0\u884c <code>apt-get clean</code>\uff0c\u4e5f\u53ef\u4ee5\u624b\u52a8\u6e05\u7a7a <code>$MOUNT/var/lib/apt/lists</code> \u76ee\u5f55\u3002</p> <p>\u5f53\u7136\u6e05\u7406\u4e4b\u524d\u8981\u628a\u5bb9\u5668\u5173\u673a\u4e86\uff0c\u4e0d\u7136 tmp \u548c cache \u4e4b\u7c7b\u7684\u4e1c\u897f\u8fd8\u4f1a\u6e90\u6e90\u4e0d\u65ad\u5730\u5192\u51fa\u6765\u3002</p>"},{"location":"workflow/pack-ct-image/#packaging","title":"\u4e94\u3001\u6253\u5305","text":"<p>\u6839\u636e\u7b2c\u4e00\u6b65\u521b\u5efa\u5bb9\u5668\u65f6\u9009\u62e9\u7684\u5b58\u50a8\uff0c\u8fd9\u91cc\u6d89\u53ca\u5230\u7684 VG \u53ef\u80fd\u662f <code>user-data</code> \u6216 <code>pve</code>\u3002</p> <p>\u901a\u8fc7\u547d\u4ee4\u884c\u767b\u5f55\u4e3b\u673a\uff0c\u9996\u5148\u6fc0\u6d3b\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7edf\uff1a</p> <pre><code>lvchange -a y {vg}/vm-{id}-disk-0\nmkdir tmp\nmount /dev/{vg}/vm-{id}-disk-0 tmp\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u8fdb\u5165 tmp \u8fdb\u884c\u6e05\u7406\u5de5\u4f5c\u4e86\u3002</p> <p>\u6700\u540e\u6253\u5305\u8981\u5728 tmp \u76ee\u5f55\u4e0b\uff08\u5373\u5bb9\u5668\u7684\u6839\u76ee\u5f55\uff09\u8fdb\u884c\uff0c\u56e0\u4e3a\uff08\u663e\u7136\uff09tar \u538b\u7f29\u5305\u4e2d\u7684\u8def\u5f84\u662f\u6709\u5f71\u54cd\u7684\u3002</p> <pre><code>tar zcvf /mnt/vz/template/cache/vlab99-example.tar.gz .\n</code></pre>"},{"location":"workflow/pack-ct-image/#process-uid-for-unprivileged-containers","title":"Unprivileged container \u6253\u5305\u540e\u7684 UID/GID \u5904\u7406","text":"<p>\u5982\u679c\u5bb9\u5668\u521b\u5efa\u65f6\u8bbe\u7f6e\u4e3a\u4e86 unprivileged\uff0c\u5219\u5176\u5b58\u5728\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684 UID/GID \u7b49\u90fd\u88ab LXC \u6620\u5c04\u5230\u4e86 +100000\uff0810 \u4e07\uff09\u7684\u6570\u503c\uff0c\u6253\u5305\u540e\u9700\u8981\u5c06\u8fd9\u589e\u52a0\u7684\u6570\u503c\u4fee\u6539\u56de\u6765\u3002\u53c2\u8003\u8fd9\u4e2a Stack Overflow \u4e3b\u9898\uff0c\u4f7f\u7528\u8fd9\u4e2a Go \u7a0b\u5e8f\u53ef\u4ee5\u6539\u5199 tar \u4e2d\u7684\u6587\u4ef6\u4fe1\u606f\uff1a</p> Go \u4ee3\u7801 <pre><code>package main\n\nimport (\n\"archive/tar\"\n\"io\"\n\"log\"\n\"os\"\n)\n\nfunc main() {\ntr := tar.NewReader(os.Stdin)\ntw := tar.NewWriter(os.Stdout)\n\nfor {\nhdr, err := tr.Next()\nif err == io.EOF {\nbreak\n} else if err != nil {\nlog.Fatal(err)\n}\n\nhdr.Uid -= 100000\nhdr.Gid -= 100000\nif err := tw.WriteHeader(hdr); err != nil {\nlog.Fatal(err)\n}\n\nif hdr.Typeflag == tar.TypeReg {\nif _, err := io.Copy(tw, tr); err != nil {\nlog.Fatal(err)\n}\n}\n}\n\nif err := tw.Close(); err != nil {\nlog.Fatal(err)\n}\n}\n</code></pre> <p>\u4f7f\u7528 Go \u7a0b\u5e8f\u6539\u5199 tar \u5305</p> <p>\u4e0a\u9762\u7684 Go \u793a\u4f8b\u7a0b\u5e8f\u53ea\u80fd\u5904\u7406\u672a\u538b\u7f29\u7684 tar \u5305\uff0c\u5982\u679c\u4f60\u5728\u6253\u5305\u65f6\u52a0\u5165\u4e86 <code>z</code> \u6216\u5176\u4ed6\u538b\u7f29\u53c2\u6570\uff0c\u9700\u8981\u5148\u89e3\u538b\u518d\u8f93\u5165\u7a0b\u5e8f\uff0c\u4f8b\u5982\uff1a</p> <pre><code>gunzip -c original.tar.gz | go run uidfix.go | gzip -c9 &gt; processed.tar.gz\n</code></pre> <p>\u6253\u5305\u5b8c\u6210\u540e\u8981\u628a Django \u524d\u7aef reload \u4e00\u4e0b\u624d\u80fd\u5728\u201c\u65b0\u5efa\u865a\u62df\u673a\u201d\u7684\u9875\u9762\u770b\u5230\u65b0\u955c\u50cf\u3002</p>"},{"location":"workflow/pack-vm-image/","title":"\u6253\u5305\u865a\u62df\u673a\u955c\u50cf","text":"<p>\u7531\u4e8e Proxmox VE \u4e0a\u7684\u865a\u62df\u673a\u4f7f\u7528 cloud-init \u8fdb\u884c\u5b9a\u5236\uff0c\u6211\u4eec\u63a8\u8350\u4ee5\u53d1\u884c\u7248\u5b98\u65b9\u7684 cloud image \u4e3a\u57fa\u7840\u8fdb\u884c\u989d\u5916\u914d\u7f6e\u3002</p>"},{"location":"workflow/pack-vm-image/#\u4e00\u4ece-ubuntu-cloud-images-\u5f00\u59cb\u51c6\u5907\u865a\u62df\u673a","title":"\u4e00\u3001\u4ece Ubuntu cloud images \u5f00\u59cb\u51c6\u5907\u865a\u62df\u673a","text":"<p>\u4ee5 Ubuntu 20.04 LTS \u4e3a\u4f8b\uff0c\u9996\u5148\u4e0b\u8f7d https://mirrors.ustc.edu.cn/ubuntu-cloud-images/focal/current/focal-server-cloudimg-amd64.img \u5230\u672c\u5730\u3002</p> <p>\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u4e34\u65f6\u865a\u62df\u673a\uff08\u6ce8\u610f\u5c06 ID 910 \u6362\u6210\u4e00\u4e2a\u5408\u9002\u7684\u7a7a\u95f2 ID\uff09</p> <pre><code>qm create 910 --memory 2048 --net0 virtio,bridge=vmbr1\n</code></pre> <p>\u5c06\u521a\u4e0b\u8f7d\u7684\u955c\u50cf\u5bfc\u5165\u65b0\u865a\u62df\u673a\uff08\u8fd9\u4e2a img \u955c\u50cf\u5b9e\u9645\u4e0a\u662f qcow2 \u683c\u5f0f\uff09\u5e76\u6302\u8f7d\u4e3a SCSI \u786c\u76d8\uff0c\u5c06\u65b0\u786c\u76d8\u8bbe\u4e3a\u542f\u52a8\u76d8</p> <pre><code>qm importdisk 910 focal-server-cloudimg-amd64.img local-lvm\nqm set 910 --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-910-disk-1\nqm set 910 --boot c --bootdisk scsi0\n</code></pre>"},{"location":"workflow/pack-vm-image/#\u4e8c\u914d\u7f6e-cloud-init","title":"\u4e8c\u3001\u914d\u7f6e Cloud-init","text":"<p>\u8fd9\u4e00\u6b65\u53ef\u4ee5\u5b8c\u5168\u5728 Proxmox VE web \u754c\u9762\u4e0a\u64cd\u4f5c\uff0c\u4e0b\u9762\u8fd8\u662f\u7ed9\u51fa\u547d\u4ee4\u884c\u6307\u5bfc\u3002</p> <p>\u6dfb\u52a0 Cloud-init \u914d\u7f6e\u76d8\uff08\u5b98\u65b9\u6587\u6863\u91cc\u662f\u6dfb\u52a0\u4e3a IDE \u76d8\uff0c\u5b9e\u9645\u52a0\u6210 SCSI \u7684\u4e5f\u6ca1\u95ee\u9898\uff0c\u8fd9\u91cc\u8ddf\u968f\u5b98\u65b9\uff09</p> <pre><code>qm set 910 --ide2 local-lvm:cloudinit\n</code></pre> <p>\u4e3a\u865a\u62df\u673a\u63d0\u4f9b\u7f51\u7edc\u4fe1\u606f\uff08\u6ce8\u610f\u628a IP \u5730\u5740\u6539\u6389\uff09\uff1a</p> <pre><code>qm set 910 --ipconfig0 ip=172.31.0.256/16,gw=172.31.0.1,ip6=auto\n</code></pre> \u53ef\u9009\u9879\u76ee\uff1a\u5c06 console \u8bbe\u4e3a\u4e32\u53e3 <p>Proxmox VE \u5b98\u65b9\u6587\u6863\u91cc\u7684\u8bf4\u660e\uff1a</p> <p>Many Cloud-Init images rely on this, as it is an requirement for OpenStack images.</p> <pre><code>qm set 910 --serial0 socket --vga serial0\n</code></pre> <p>\u53ef\u9009\u9879\u76ee\uff1a\u5f00\u673a</p> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>qm start 910</code> \u542f\u52a8\u865a\u62df\u673a\u8fdb\u884c\u9ad8\u7ea7\u914d\u7f6e\u4e86\u3002</p> <p>\u770b\u5b8c\u7b2c\u4e09\u7ae0\u548c\u7b2c\u56db\u7ae0\u4e4b\u540e\u4f60\u5c31\u77e5\u9053\u4e3a\u4ec0\u4e48\u5c06\u865a\u62df\u673a\u5f00\u673a\u662f\u53ef\u9009\u7684\u4e86\u3002</p>"},{"location":"workflow/pack-vm-image/#\u4e09\u955c\u50cf\u7684\u5904\u7406","title":"\u4e09\u3001\u955c\u50cf\u7684\u5904\u7406","text":"<p>\u6211\u4eec\u8ba4\u4e3a KVM \u865a\u62df\u673a\u7684\u53d7\u4f17\u662f\u4e0d\u9700\u8981\u684c\u9762\u73af\u5883\u548c Vlab Software \u8fdb\u884c\u8f83\u4e3a\u201c\u901a\u7528\u201d\u7684\u5b9e\u9a8c\u548c\u8ba1\u7b97\u7684\u7528\u6237\uff0c\u56e0\u6b64\u6211\u4eec\u5728 KVM \u955c\u50cf\u4e2d\u4e0d\u63d0\u4f9b\u684c\u9762\u73af\u5883\u548c <code>/opt/vlab</code>\uff08\u5176\u5b9e\u8981\u5f04\u8fd8\u6709\u70b9\u9ebb\u70e6\uff09\uff0c\u6240\u4ee5\u5bf9\u4e8e\u4e0b\u8f7d\u4e0b\u6765\u7684\u5b98\u65b9\u955c\u50cf\uff0c\u6211\u4eec\u53ea\u9700\u8981\u8fdb\u884c\u6700\u57fa\u672c\u7684\u4fee\u6539\u5373\u53ef\u3002</p>"},{"location":"workflow/pack-vm-image/#pre-packaging","title":"\u56db\u3001\u6253\u5305\u524d\u7684\u5de5\u4f5c","text":"<p>\u4e0e\u6253\u5305\u5bb9\u5668\u955c\u50cf\u524d\u7684\u6e05\u7406\u5de5\u4f5c\u4e00\u6837\u3002</p>"},{"location":"workflow/pack-vm-image/#\u6302\u8f7d\u865a\u62df\u673a\u78c1\u76d8","title":"\u6302\u8f7d\u865a\u62df\u673a\u78c1\u76d8","text":"<p>\u6ce8\u610f KVM \u7684\u201c\u5377\u201d\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u78c1\u76d8\uff0c\u800c\u5bb9\u5668\u7684\u201c\u5377\u201d\u53ea\u5305\u542b rootfs \u6240\u5728\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u56e0\u6b64\u8981\u6302\u8f7d KVM \u7684 rootfs \u9700\u8981\u5148\u5904\u7406\u78c1\u76d8\u5206\u533a\u7684\u95ee\u9898\u3002\u6211\u4eec\u63a8\u8350\u4f7f\u7528 kpartx \u5de5\u5177\u3002</p> <pre><code>kpartx -av /dev/pve/vm-910-disk-0\n</code></pre> <p>\u4f60\u4f1a\u770b\u5230\u7c7b\u4f3c\u8fd9\u6837\u7684\u8f93\u51fa\uff1a</p> <pre><code>add map pve-vm--910--disk--0p1 (253:19): 0 4384735 linear 253:14 227328\nadd map pve-vm--910--disk--0p14 (253:23): 0 8192 linear 253:14 2048\nadd map pve-vm--910--disk--0p15 (253:24): 0 217088 linear 253:14 10240\n</code></pre> <p>\u6839\u636e\u5bb9\u91cf\u5224\u65ad\uff0cp1 \u5c31\u662f\u865a\u62df\u673a\u7684 rootfs\uff0c\u6b64\u65f6\u5c31\u53ef\u4ee5\u6302\u8f7d <code>/dev/mapper/pve-vm--910--disk--0p1</code> \u8fdb\u884c\u6e05\u7406\u5de5\u4f5c\u4e86\u3002</p> <p>\u6e05\u7406\u5b8c\u6210\u5e76 umount \u540e\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>kpartx -d /dev/pve/vm-910-disk-0</code> \u5220\u9664\u5206\u533a\u6620\u5c04\u3002</p> <p>\u540c\u6837\u7684\uff0c\u53d6\u51b3\u4e8e\u865a\u62df\u78c1\u76d8\u7684\u4f4d\u7f6e\uff0cPVE \u6709\u53ef\u80fd\u4f1a\u5728\u5173\u673a\u540e\u5c06\u865a\u62df\u78c1\u76d8\u7684 LVM \u5377\u8bbe\u7f6e\u4e3a inactive\uff0c\u9700\u8981\u4f7f\u7528 <code>lvchange</code> \u5148\u6fc0\u6d3b\uff0c\u53c2\u89c1\u6253\u5305\u5bb9\u5668\u955c\u50cf\u7684\u7ae0\u8282\u3002</p>"},{"location":"workflow/pack-vm-image/#packaging","title":"\u4e94\u3001\u6253\u5305","text":"<p>\u5982\u679c\u6253\u5305\u597d\u7684\u955c\u50cf\u8981\u4f5c\u4e3a VM \u6a21\u677f\u4f7f\u7528\uff0c\u9700\u8981\u8fc1\u79fb\u81f3\u5404 pve \u4e3b\u673a\u95f4\u7684\u5171\u4eab\u5b58\u50a8\u4e0a\uff0c\u5982 user-data\u3002</p>"},{"location":"workflow/pack-vm-image/#references","title":"\u53c2\u8003\u8d44\u6599","text":"<ul> <li>Proxmox VE \u5173\u4e8e Cloud-init \u7684\u6587\u6863\uff1ahttps://pve.proxmox.com/wiki/Cloud-Init_Support</li> </ul>"},{"location":"workflow/pack-windows-image/","title":"\u6253\u5305 Windows \u955c\u50cf","text":"<p>\u8b66\u544a</p> <p>\u6253\u5305\u548c\u7ef4\u62a4 Windows \u955c\u50cf\u975e\u5e38\u9ebb\u70e6\u5e76\u4e14\u5f88\u96be debug\uff0c\u5feb\u8dd1\uff01\uff01\uff01</p> <p>You have been warned. Run!!!</p> <p>\u7531\u4e8e Proxmox VE \u4e0a\u7684\u865a\u62df\u673a\u4f7f\u7528 cloud-init \u8fdb\u884c\u5b9a\u5236\uff0c\u5e76\u4e14 Windows \u548c Unix \u4e00\u5957\u4f53\u7cfb\u5b8c\u5168\u4e0d\u5728\u4e00\u4e2a\u9891\u9053\u4e0a\uff0c\u6240\u4ee5\u5236\u4f5c\u53ef\u4ee5\u7528 cloud-init \u5373\u4f7f\u53ea\u662f\u7b80\u5355\u5b9a\u5236\u7684 Windows \u955c\u50cf\u4e5f\u975e\u5e38\u6298\u817e\u3002\u4e0b\u9762\u8ba9\u6211\u4eec\u4e00\u8d77\u6765\u53d7\u7f6a\u5427\uff01</p>"},{"location":"workflow/pack-windows-image/#setup-vm","title":"\u4e00\u3001\u51c6\u5907\u865a\u62df\u673a","text":""},{"location":"workflow/pack-windows-image/#install-vm","title":"\u5b89\u88c5\u865a\u62df\u673a","text":"<p>\u5b66\u6821\u4e70\u4e86\u6b63\u7248\u7684 Windows 10\uff0c\u53ef\u4ee5\u5728\u8f6f\u4ef6\u6b63\u7248\u5316\u7f51\u7ad9\u4e0a\u4e0b\u8f7d\uff0c\u5efa\u8bae\u9009\u4e2d\u6587\u7248\uff08\u56e0\u4e3a\u662f\u9762\u5411\u7528\u6237\u7684\uff09\u3002\u65c1\u8fb9\u7684 KMS \u6ce8\u518c\u6587\u4ef6\u4e0d\u7528\u4e0b\u8f7d\uff0c\u5b9e\u9645\u53ea\u9700\u8981\u4e00\u884c\u547d\u4ee4\u5c31\u80fd\u89e3\u51b3\uff0c\u540e\u9762\u4f1a\u63d0\u5230\u3002</p> <p>\u540c\u65f6\u4e5f\u8981\u4e0b\u8f7d VirtIO Windows \u9a71\u52a8\uff0c\u9009 Stable ISO\u3002</p> <ul> <li>\u521b\u5efa\u4e00\u4e2a\u865a\u62df\u673a\uff0c\u9009\u62e9\u4e00\u4e2a ID \u548c\u540d\u79f0</li> <li>OS \u9875\u9762\u6ce8\u610f\u5728\u53f3\u8fb9\u7684 Guest OS \u6b63\u786e\u9009\u62e9 Windows 10</li> <li>System \u9875\u9762\u52fe\u4e0a Qemu Agent\uff0c\u5c06 SCSI Controller \u6539\u4e3a Default</li> <li>\u786c\u76d8\u603b\u7ebf\u9009 SATA\uff0c\u5b58\u50a8\u548c\u5bb9\u91cf\u81ea\u5b9a\uff0c\u63a8\u8350 32 GB \u5c31\u591f\uff0c\u9664\u975e\u4f60\u8fd8\u8981\u989d\u5916\u5b89\u88c5\u8f6f\u4ef6\uff08\u5efa\u8bae\u522b\u81ea\u627e\u9ebb\u70e6\uff09</li> <li>CPU \u5185\u5b58\u6309\u9700\u5206\u914d\uff0c4 \u6838 8 GB \u7b97\u9ad8\u914d\u4e86</li> <li>\u7f51\u5361\u63a5\u5728 vmbr1 \u4e0a\uff08\u4e5f\u5c31\u662f\u7528\u6237\u5185\u7f51\uff09\uff0c\u4e0d\u7136\u540e\u9762\u8fd8\u6709\u9ebb\u70e6 </li> <li>\u6700\u540e\u7684\u786e\u8ba4\u9875\u9762\u5148\u4e0d\u8981\u52fe\u9009 Start after created\uff0c\u521b\u5efa\u5b8c\u6210\u540e\u53bb\u6dfb\u52a0\u4e00\u4e2a\u4e32\u53e3\u8bbe\u5907\uff08Serial 0\uff09\uff0c\u540e\u9762\u4f1a\u7528\u5230</li> </ul> <p>\u548c\u4e00\u822c\u7684\u865a\u62df\u673a\u5b89\u88c5\u8fc7\u7a0b\u4e00\u6837\uff0c\u5c06 ISO \u6dfb\u52a0\u4e3a CD/DVD Drive\uff0c\u8ddf\u7740\u5b89\u88c5\u7a0b\u5e8f\u8d70\u5b8c\u6d41\u7a0b\u5373\u53ef\uff0c\u7248\u672c\u8bf7\u9009\u62e9\u6559\u80b2\u7248\u3002</p> <p>\u7b2c\u4e00\u6b21\u91cd\u542f\u540e\u8fdb\u5165 Windows \u7684 OOBE\uff0c\u73b0\u5728\u53ef\u4ee5\u5728\u540e\u53f0\u628a\u5149\u9a71\u6362\u6210 VirtIO \u7684\u9a71\u52a8\u76d8\u4e86\u3002</p>"},{"location":"workflow/pack-windows-image/#windows-oobe","title":"Windows OOBE","text":"<p>OOBE \u9636\u6bb5\u53ef\u4ee5\u81ea\u884c\u914d\u7f6e\uff0c\u4e0d\u8fc7\u65e2\u7136\u662f\u8981\u7528\u4f5c\u9762\u5411\u7528\u6237\u7684\u6a21\u677f\uff0c\u9009\u62e9\u4e00\u4e9b\u8bbe\u7f6e\u65f6\u7a0d\u5fae\u8003\u8651\u4e00\u4e0b\u3002</p> <p>\u5730\u533a\u8bed\u8a00\u5f53\u7136\u662f\u4e2d\u6587\u4e86\uff0c\u952e\u76d8\u5fae\u8f6f\u62fc\u97f3\uff08\u8fd9\u662f\u9ed8\u8ba4\uff0c\u4e0b\u4e00\u6b65\uff09\uff0c\u7136\u540e\u4e00\u8def\u5230\u521b\u5efa\u8d26\u6237\u8fd9\u91cc\u4f1a\u6709\u4e2a\u9519\u8bef\u63d0\u793a\u7801 OOBEAADV10\uff0c\u5ffd\u7565\u6389\u5b83\u521b\u5efa\u4e00\u4e2a\u672c\u5730\u8d26\u6237\uff0c\u547d\u540d\u4e3a Vlab\uff0c\u5bc6\u7801\u7559\u7a7a\uff08\u4e0d\u7136\u540e\u9762\u8981\u4f60\u586b\u4e09\u4e2a\u5b89\u5168\u95ee\u9898\uff0cWTF?\uff09\u3002</p> \u9519\u8bef\u7801 OOBEAADV10 <p>\u8fd9\u662f Windows \u5728\u5c1d\u8bd5\u8fde\u63a5\u5230 Azure Active Directory \u65f6\u62a5\u7684\u9519\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u65f6\u5019\u53ea\u6709 IPv6 \u7f51\u7edc\u662f\u901a\u7684\uff08\u6709 SLAAC\uff09\uff0c\u7528\u6237\u5185\u7f51\u6ca1\u6709 DHCP\u3002</p> <p>\u4f4d\u7f6e\u670d\u52a1\u3001\u5e7f\u544a\u6807\u8bc6\u7b26\u8fd9\u4e2a\u9875\u9762\u5168\u90e8\u5173\u6389\uff0cCortana \u4e5f\u522b\u5f00\uff0c\u90fd\u662f\u4e9b\u6d6a\u8d39\u65f6\u95f4\u548c\u8d44\u6e90\u7684\u4e1c\u897f\u3002</p> <p>\u5230\u8fd9\u91cc\u5c31\u5dee\u4e0d\u591a\u8fdb\u5165\u684c\u9762\u4e86\uff0c\u76ee\u524d\u4e3a\u6b62\u6ca1\u6709\u592a\u591a\u5751\uff0c\u9664\u4e86\u5bc6\u7801\u5fc5\u987b\u7559\u7a7a\u4e4b\u5916\uff08\u55ef\uff0c\u8fd9\u79cd\u5730\u65b9\u8981\u6c42\u586b\u5b89\u5168\u95ee\u9898\u662f\u4e2a\u5947\u602a\u7684\u8bbe\u5b9a\uff09\u3002</p>"},{"location":"workflow/pack-windows-image/#configure-vm","title":"\u4e8c\u3001\u914d\u7f6e\u865a\u62df\u673a","text":""},{"location":"workflow/pack-windows-image/#pause-windows-update","title":"\u6682\u505c Windows \u66f4\u65b0","text":"<p>\u4e0d\u7136\u7f51\u7edc\u901a\u7545\u540e\u5f00\u59cb\u81ea\u52a8\u66f4\u65b0\u4e86\uff0c\u540e\u9762\u4f60\u5c31\u9ebb\u70e6\u4e86</p>"},{"location":"workflow/pack-windows-image/#configure-networking","title":"\u8bbe\u7f6e\u7f51\u7edc","text":"<p>\u53f3\u952e\u70b9\u51fb\u53f3\u4e0b\u89d2\u7684\u7f51\u7edc\u56fe\u6807\uff0c\u6253\u5f00\u201c\u7f51\u7edc\u548c Internet\u201d\u8bbe\u7f6e\uff0c\u5728\u4e0b\u9762\u9009\u62e9\u201c\u66f4\u6539\u9002\u914d\u5668\u9009\u9879\u201d\uff0c\u6253\u5f00\u201c\u4ee5\u592a\u7f51\u5b9e\u4f8b 0\u201d\u7684\u5c5e\u6027\uff0c\u518d\u9009\u4e2d Internet \u534f\u8bae\u7248\u672c 4\uff0c\u5728\u8fd9\u91cc\u6307\u5b9a\u4e00\u4e2a\u4e34\u65f6\u7684 IPv4 \u5730\u5740\uff08\u53c2\u8003\u6253\u5305\u5bb9\u5668\u7684\u6d41\u7a0b\uff09\uff0c\u63a9\u7801\u662f <code>255.255.0.0</code>\uff0c\u7f51\u5173\u662f <code>172.31.0.1</code>\uff0cDNS \u670d\u52a1\u5668\u548c\u7f51\u5173\u4e00\u6837\uff0c\u786e\u5b9a\u5b8c\u6210\u540e\u5c31\u80fd\u4e0a\u7f51\u4e86\u3002</p> <p>\u4e0d\u8981\u76f4\u63a5\u5728\u201c\u8bbe\u7f6e\u201d\u5e94\u7528\u91cc\u6539</p> <p>\u201c\u8bbe\u7f6e\u201d\u91cc\u76f4\u63a5\u6539\u7684\u65f6\u5019\uff0c\u6307\u5b9a\u9759\u6001 IPv4 \u7684\u65f6\u5019\u5c31\u6ca1\u6709 IPv6 \u81ea\u52a8\u914d\u7f6e\u4e86\u3002</p>"},{"location":"workflow/pack-windows-image/#activate-windows","title":"\u6fc0\u6d3b Windows","text":"<p>\u53f3\u952e\u70b9\u51fb\u5de6\u4e0b\u89d2\u7684  Windows\uff0c\u6253\u5f00\u4e00\u4e2a\u6709\u7ba1\u7406\u5458\u6743\u9650\u7684 PowerShell \u7a97\u53e3\uff0c\u914d\u7f6e\u5b66\u6821\u7684 KMS \u6fc0\u6d3b\uff1a</p> <pre><code>slmgr.vbs /skms kms.ustc.edu.cn\n</code></pre> <p>\u73b0\u5728\u53ef\u4ee5\u8fdb\u8bbe\u7f6e\u5e94\u7528\u91cc\u67e5\u770b\u6fc0\u6d3b\u72b6\u6001\u4e86\u3002\u5982\u679c\u8fd8\u6ca1\u6fc0\u6d3b\u7684\u8bdd\uff0c\u70b9\u7591\u96be\u89e3\u7b54\uff0c\u7b49\u5b83\u8dd1\u5b8c\u5c31\u4f1a\u544a\u8bc9\u4f60\u5df2\u6fc0\u6d3b\u3002</p>"},{"location":"workflow/pack-windows-image/#install-virtio-drivers","title":"\u5b89\u88c5 VirtIO \u9a71\u52a8","text":"<p>\u6253\u5f00\u5149\u9a71\u8fd0\u884c <code>virtio-win-guest-tools.exe</code>\uff0c\u4e00\u8def\u4e0b\u4e00\u6b65\u5b89\u88c5\u5373\u53ef\u3002</p> <p>\u8fd9\u91cc\u552f\u4e00\u7684\u5751\u70b9\u662f\uff0c\u5982\u679c\u4f60\u5728\u521b\u5efa\u865a\u62df\u673a\u65f6\u6ca1\u6709\u591a\u4e00\u6b65\u6dfb\u52a0\u4e00\u4e2a\u4e32\u53e3\u8bbe\u5907\u7684\u8bdd\uff0c\u90a3\u4e48 VirtIO \u4e32\u53e3\u9a71\u52a8\u5c31\u4e0d\u4f1a\u5b89\u88c5\uff0c\u9700\u8981\u5173\u673a\u52a0\u597d\u8bbe\u5907\u540e\u518d\u91cd\u65b0\u5b89\u88c5\u3002</p> <p>QEMU Guest Agent (Qemu GA) \u4ee5\u540e\u4f1a\u5f88\u6709\u7528\uff0c\u6211\u4eec\u4e5f\u628a\u5b83\u88c5\u4e0a\u5427\u3002</p>"},{"location":"workflow/pack-windows-image/#enable-rdp","title":"\u8bbe\u7f6e RDP","text":"<p>\u8bbe\u7f6e \u2192 \u7cfb\u7edf \u2192 \u8fdc\u7a0b\u684c\u9762\uff0c\u542f\u7528\u8fdc\u7a0b\u684c\u9762\u3002</p> <p>\u914d\u7f6e Windows \u9632\u706b\u5899\u4ec5\u8fd0\u884c\u6765\u81ea web \u670d\u52a1\u5668\u7684\u8fde\u63a5\uff1a</p> <ul> <li>\u6253\u5f00 Windows Defender \u9632\u706b\u5899\u8bbe\u7f6e\uff08\u5f00\u59cb\u83dc\u5355 \u2192 Windows \u7ba1\u7406\u5de5\u5177\uff0c\u6216\u8005\u76f4\u63a5\u8fd0\u884c <code>wf.msc</code>\uff09</li> <li> <p>\u5165\u7ad9\u89c4\u5219\uff0c\u627e\u5230 \u8fdc\u7a0b\u684c\u9762 - \u7528\u6237\u6a21\u5f0f (TCP-In) \u542f\u7528\uff0c\u6253\u5f00\u5c5e\u6027\uff0c\u5207\u6362\u5230\u201c\u4f5c\u7528\u57df\u201d\u9009\u9879\u5361\uff0c\u8bbe\u7f6e\u8fdc\u7a0b IP \u4ec5\u9650 <code>172.31.0.2</code>\uff0c\u5982\u56fe\uff1a</p> <p></p> </li> <li> <p>\uff08\u53ef\u9009\uff0c\u63a8\u8350\uff09\u5165\u7ad9\u89c4\u5219\u91cc\u201c\u6838\u5fc3\u7f51\u7edc\u8bca\u65ad - ICMP \u56de\u663e\u8bf7\u6c42\u201d\u56db\u4e2a\u90fd\u6253\u5f00\uff08Windows \u9ed8\u8ba4\u8fd1\u5e73\u7981 ping\uff0c\u6253\u5f00\u4f1a\u65b9\u4fbf\u4ee5\u540e\u8c03\u8bd5\u7f51\u7edc\u548c\u76d1\u6d4b\u72b6\u6001\uff09</p> </li> </ul>"},{"location":"workflow/pack-windows-image/#extra-customizations","title":"\u5176\u4ed6\u81ea\u5b9a\u4e49\u8bbe\u7f6e","text":"<p>\u4efb\u52a1\u680f\u91cc\u90a3\u5757\u5de8\u5927\u7684\u80f6\u5e03\uff08\u641c\u7d22\u6846\uff09\u53ef\u4ee5\u9690\u85cf\u8d77\u6765\uff0cCortana \u56fe\u6807\u9690\u85cf\u8d77\u6765\uff0cTask View \u7684\u56fe\u6807\u4e5f\u53ef\u4ee5\u9690\u85cf\u8d77\u6765\uff0c\u8fd9\u51e0\u4e2a\u90fd\u662f\u53f3\u952e\u4efb\u52a1\u680f\u5c31\u53ef\u4ee5\u52fe\u9009\u7684\u9009\u9879\u3002</p> <p>\u4efb\u52a1\u680f\u8bbe\u7f6e\u91cc\u7684\u201c\u4f7f\u7528\u2018\u901f\u89c8\u2019\u9884\u89c8\u684c\u9762\u201d\u51fa\u4e8e\u6027\u80fd\u8003\u8651\u5efa\u8bae\u4e0d\u8981\u5f00\uff0c\u5176\u4ed6\u968f\u610f\uff0c\u4f8b\u5982\u201c\u5408\u5e76\u4efb\u52a1\u680f\u6309\u94ae\u201d\u53ef\u4ee5\u6539\u6210\u201c\u4efb\u52a1\u680f\u5df2\u6ee1\u65f6\u201d\u7b49\u7b49\uff0c\u5176\u4ed6\u7684\u684c\u9762\u80cc\u666f\u3001\u989c\u8272\u3001\u5f00\u59cb\u83dc\u5355\u7b49\u90fd\u968f\u610f\u3002</p> <p> \u5f00\u59cb\u83dc\u5355\u91cc\u9884\u88c5\u7684 UWP \u5e94\u7528\u73b0\u5728\u4e0d\u8981\u52a8\uff0c\u5426\u5219\u540e\u9762 Sysprep \u7684\u65f6\u5019\u4f1a\u51fa\u9519\u3002\uff08\u5982\u679c\u4f60\u7279\u522b\u60f3\u5220\u6389\u5176\u4e2d\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u65f6\uff0c\u7b2c\u56db\u8282\u6e05\u7406\u6709\u8be6\u7ec6\u8bf4\u660e\u3002\uff09</p> <p>Windows \u68c0\u6d4b\u7f51\u7edc\u8fde\u63a5\u7684\u529f\u80fd\u7ecf\u5e38\u574f\uff0c\u539f\u56e0\u662f msftconnecttest.com \u670d\u52a1\u5668\u5728\u56fd\u5916\uff0c\u5f88\u6162\u800c\u4e14\u4e0d\u7a33\u5b9a\uff0c\u53ef\u4ee5\u4fee\u6539\u6ce8\u518c\u8868\u5c06\u8fd9\u4e2a\u529f\u80fd\u66ff\u6362\u6210\u4f7f\u7528\u6821\u5185\u7684\u670d\u52a1\u3002</p> \u6ce8\u518c\u8868\u6587\u4ef6 <p>\u4e0b\u8f7d\u76f4\u94fe</p> <pre><code>Windows Registry Editor Version 5.00\n\n[HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\NlaSvc\\Parameters\\Internet]\n\"ActiveDnsProbeContent\"=\"202.38.64.1\"\n\"ActiveDnsProbeContentV6\"=\"2001:da8:d800::1\"\n\"ActiveDnsProbeHost\"=\"ns.ustc.edu.cn\"\n\"ActiveDnsProbeHostV6\"=\"ns.ustc.edu.cn\"\n\"ActiveWebProbeContent\"=\"USTC Mirrors Connect Test\"\n\"ActiveWebProbeContentV6\"=\"USTC Mirrors Connect Test\"\n\"ActiveWebProbeHost\"=\"mirrors.ustc.edu.cn\"\n\"ActiveWebProbeHostV6\"=\"ipv6.mirrors.ustc.edu.cn\"\n\"ActiveWebProbePath\"=\"connecttest.txt\"\n\"ActiveWebProbePathV6\"=\"connecttest.txt\"\n\"EnableActiveProbing\"=dword:00000001\n</code></pre>"},{"location":"workflow/pack-windows-image/#cloudbase-init","title":"\u4e09\u3001\u5b89\u88c5 Cloudbase-init","text":"<p>\u8b66\u544a\uff1a\u524d\u65b9\u96f7\u533a</p> <p>\u4e0b\u8f7d\u5730\u5740 https://cloudbase.it/downloads/CloudbaseInitSetup_Stable_x64.msi\uff0c\u53ef\u4ee5\u6d4f\u89c8\u5668\u4e0b\u8f7d\uff0c\u4e5f\u53ef\u4ee5 PowerShell \u547d\u4ee4\u884c\uff1a</p> <pre><code>Invoke-WebRequest -Uri https://cloudbase.it/downloads/CloudbaseInitSetup_Stable_x64.msi -OutFile C:\\cloudbase-init.msi\n</code></pre> <p>\u987a\u7740 Cloudbase-init \u7684\u6d41\u7a0b\u5b89\u88c5\u5c31\u884c\uff0c\u5728\u9009\u62e9\u7528\u6237\u540d\u7684\u90a3\u4e2a\u754c\u9762\u586b Administrator\uff0c\u4e0b\u9762\u4e32\u53e3\u8bbe\u5907\u9009\u62e9 COM1\uff0c\u7ee7\u7eed\u5b89\u88c5\u5b8c\u6210\u3002\u6700\u540e\u4e00\u4e2a\u754c\u9762\u4e0d\u8981\u9009 Sysprep\uff0c\u76f4\u63a5\u5173\u95ed\u9000\u51fa\uff0c\u7b49\u6539\u5b8c\u8bbe\u7f6e\u540e\u624b\u52a8\u5904\u7406\u3002</p> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u6253\u5f00 <code>C:\\Program Files\\Cloudbase Solutions\\Cloudbase-init\\conf</code>\uff0c\u7f16\u8f91 <code>cloudbase-init-unattend.conf</code>\uff0c\u4fee\u6539\u4ee5\u4e0b\u51e0\u5904\uff1a</p> <ul> <li>\u786e\u4fdd username=Administrator \u548c groups=Administrators</li> <li>\u6dfb\u52a0\u4e00\u884c <code>first_logon_behaviour=no</code></li> <li>\u5220\u9664 <code>config_drive_raw_hhd</code> \u548c <code>config_drive_vfat</code>\uff08\u6216\u8005\u6539\u6210 false \u4e5f\u884c\uff09</li> <li>\u4ece <code>metadata_services</code> \u91cc\u5220\u6389\u5176\u4ed6\u914d\u7f6e\uff0c\u53ea\u4fdd\u7559\u4e00\u4e2a <code>ConfigDriveService</code>\u3002\u6ce8\u610f\u8fd9\u662f\u4e00\u4e2a\u9017\u53f7\u5206\u9694\u7684\u5217\u8868\uff0c\u4e0d\u8981\u770b\u9519\u4e86</li> <li>\u5c06 <code>check_latest_version</code> \u6539\u6210 false</li> </ul> \u53c2\u8003\uff1a\u4fee\u6539\u540e\u7684\u6587\u4ef6\u5185\u5bb9 <pre><code>[DEFAULT]\nusername=Administrator\ngroups=Administrators\ninject_user_password=true\nfirst_logon_behaviour=no\nconfig_drive_cdrom=true\nbsdtar_path=C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\bin\\bsdtar.exe\nmtools_path=C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\bin\\\nverbose=true\ndebug=true\nlogdir=C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\log\\\nlogfile=cloudbase-init-unattend.log\ndefault_log_levels=comtypes=INFO,suds=INFO,iso8601=WARN,requests=WARN\nlogging_serial_port_settings=COM1,115200,N,8\nmtu_use_dhcp_config=true\nntp_use_dhcp_config=true\nlocal_scripts_path=C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\LocalScripts\\\ncheck_latest_version=false\nmetadata_services=cloudbaseinit.metadata.services.configdrive.ConfigDriveService\nplugins=cloudbaseinit.plugins.common.mtu.MTUPlugin,cloudbaseinit.plugins.common.sethostname.SetHostNamePlugin,cloudbaseinit.plugins.windows.extendvolumes.ExtendVolumesPlugin\nallow_reboot=false\nstop_service_on_exit=false\n</code></pre>"},{"location":"workflow/pack-windows-image/#cleanup","title":"\u56db\u3001\u6253\u5305\u524d\u7684\u6e05\u7406\u5de5\u4f5c","text":"<ul> <li> <p> \u542f\u7528 Windows Update</p> <p>\u53ef\u4ee5\u653e\u5728\u6700\u540e\u4e00\u6b65\u5173\u673a\u524d\u518d\u542f\u7528\uff0c\u907f\u514d\u540e\u9762\u6e05\u7406\u65f6\u95f4\u592a\u957f\u5bfc\u81f4 WU \u5f00\u59cb\u8fd0\u884c\uff0c\u6216\u8005\u76f4\u63a5\u65ad\u7f51\u4e5f\u884c\u3002</p> </li> <li> <p>\u6e05\u7406 Windows \u8d44\u6e90\u7ba1\u7406\u5668\u7684\u5386\u53f2\u8bb0\u5f55</p> <p>\u6309  Windows + E \u6253\u5f00 Windows \u8d44\u6e90\u7ba1\u7406\u5668\uff0c\u5220\u6389\u6240\u6709\u201c\u6700\u8fd1\u6587\u4ef6\u201d\u3002\u6ce8\u610f\u4e0d\u662f\u5c06\u6587\u4ef6\u4ece\u78c1\u76d8\u4e0a\u5220\u9664\uff0c\u800c\u662f\u53f3\u952e\u201c\u4ece\u5feb\u901f\u8bbf\u95ee\u4e2d\u5220\u9664\u201d\u3002</p> </li> <li> <p>\u6e05\u7406\u201c\u8fd0\u884c\u2026\u2026\u201d\u7684\u5386\u53f2\u8bb0\u5f55</p> <p>\u6e05\u7a7a\uff08\u4e0d\u662f\u5220\u9664\uff09\u6ce8\u518c\u8868\u9879 <code>HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RunMRU</code> \u4e2d\u7684\u6240\u6709\u5185\u5bb9\u3002</p> </li> <li> <p>\u6e05\u7406\u6d4f\u89c8\u5668\u8bb0\u5f55</p> <p>\u5bf9\u4e8e Internet Explorer\uff1a\u8bf7\u53c2\u8003 Microsoft Docs\uff08\u4e2d\u6587 / English)</p> <p>\u5bf9\u4e8e Microsoft Edge\uff1a\u5220\u9664\u76ee\u5f55 <code>C:\\Users\\Vlab\\AppData\\Local\\Microsoft\\Edge\\User Data</code></p> </li> <li> <p>\u8fdb\u884c\u78c1\u76d8\u6e05\u7406</p> <p>\u6253\u5f00\u201c\u6b64\u7535\u8111\u201d\uff0c\u53f3\u952e\u70b9\u51fb C \u76d8\u9009\u62e9\u201c\u5c5e\u6027\u201d\uff0c\u7136\u540e\u5728\u5bf9\u8bdd\u6846\u4e2d\u627e\u5230\u201c\u78c1\u76d8\u6e05\u7406\u201d\u9009\u9879\u3002\u5148\u70b9\u51fb\u5de6\u4e0b\u89d2\u201c\u6e05\u7406\u7cfb\u7edf\u6587\u4ef6\u201d\uff0c\u7136\u540e\u52fe\u9009\u5168\u90e8\u5185\u5bb9\u786e\u8ba4\u6e05\u7406\u3002</p> </li> <li> <p>\u5173\u95ed\u4f11\u7720\u548c\u5feb\u901f\u542f\u52a8\uff08\u63a8\u8350\uff09</p> <p>\u4ee5\u7ba1\u7406\u5458\u6253\u5f00 PowerShell\uff0c\u8fd0\u884c <code>powercfg /h off</code>\u3002</p> </li> <li> <p>\uff08\u53ef\u9009\uff09\u5220\u9664\u9884\u88c5\u7684 UWP \u5e94\u7528</p> \u8fd9\u662f\u9ad8\u7ea7\u64cd\u4f5c\uff0c\u5efa\u8bae\u4ec5\u5f53\u4f60\u719f\u6089 Windows 10 \u65f6\u8fdb\u884c <p>\u4ee5\u7ba1\u7406\u5458\u6253\u5f00 PowerShell\uff0c\u8fd0\u884c <code>Get-AppxProvisionedPackage -Online</code> \u6765\u5217\u51fa\u5f53\u524d\u7cfb\u7edf\u4e2d\u5df2\u9884\u88c5\u7684 UWP \u5e94\u7528\u3002\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u60f3\u8981\u5220\u9664\u7684\u5e94\u7528\uff0c\u8bb0\u5f55\u4e0b PackageName\u3002</p> <p>\u7ee7\u7eed\u5728 PowerShell \u4e2d\uff0c\u8fd0\u884c <code>Remove-AppxProvisionedPackage -Online -PackageName $PackageName</code>\uff0c\u5176\u4e2d <code>$PackageName</code> \u66ff\u6362\u6210\u521a\u624d\u8bb0\u5f55\u4e0b\u6765\u7684 PackageName\u3002\u5220\u9664\u9884\u88c5\u540e\uff0c\u4e5f\u8981\u540c\u65f6\u5220\u9664\u5f53\u524d\u7528\u6237\u5df2\u5b89\u88c5\u7684\u8fd9\u4e00\u4efd\u76f8\u540c\u5e94\u7528\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 <code>Remove-AppxPackage -PackageName $PackageName</code> \u547d\u4ee4\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5728\u5f00\u59cb\u83dc\u5355\u4e2d\u627e\u5230\u5b83\u9009\u62e9\u201c\u5378\u8f7d\u201d\uff08\u5982\u679c\u4f60\u627e\u5f97\u5230\u7684\u8bdd\uff09\u3002</p> <p>\u4f5c\u4e3a\u7ec3\u4e60\uff0c\u4f60\u53ef\u4ee5\u9009\u62e9\u5220\u9664 Microsoft Solitaire Collection \u548c Skype \u8fd9\u4e24\u4e2a\u5e94\u7528\uff0c\u6216\u8005\u9009\u62e9\u8df3\u8fc7\u8fd9\u4e00\u6b65\u3002</p> </li> </ul>"},{"location":"workflow/pack-windows-image/#sysprep","title":"\u4e94\u3001Sysprep \u548c\u6253\u5305","text":"<p>\u5148\u5173\u673a\u6253\u4e00\u4e2a\u5feb\u7167</p> <p>Sysprep \u540e\u7684\u955c\u50cf\u65e0\u6cd5\u6062\u590d\uff0c\u56e0\u6b64\u6211\u4eec\u63a8\u8350\u5728\u8fd9\u4e00\u6b65\u4e4b\u524d\u5c06\u865a\u62df\u673a\u5173\u673a\uff0c\u5728 Proxmox \u7684\u754c\u9762\u4e2d\u6253\u4e00\u4e2a\u5feb\u7167\uff0c\u65b9\u4fbf\u4ee5\u540e\u4ee5\u5f53\u524d\u72b6\u6001\u4e3a\u57fa\u7840\u8fdb\u4e00\u6b65\u5b9a\u5236\u955c\u50cf\u3002</p> <p>\u8fd8\u662f\u4ee5\u7ba1\u7406\u5458\u6253\u5f00 PowerShell\uff0c\u5b9a\u4f4d\u5230 <code>C:\\Program Files\\Cloudbase Solutions\\Cloudbase-init\\conf</code>\uff0c\u8fd0\u884c Sysprep\uff1a</p> <pre><code>C:\\Windows\\System32\\Sysprep\\sysprep.exe /generalize /oobe /unattend:Unattend.xml\n</code></pre> <p>\u8fd9\u4e2a <code>Unattend.xml</code> \u7531 Cloudbase-init \u63d0\u4f9b\uff0c\u6240\u4ee5\u9700\u8981\u5148 <code>cd</code> \u5230\u4e0a\u8ff0\u76ee\u5f55\u3002</p> <p>\u5982\u679c Sysprep \u51fa\u73b0\u9519\u8bef\uff0c\u8bf7\u68c0\u67e5 <code>C:\\Windows\\System32\\Sysprep\\Panther\\setupact.log</code> \u5e76\u5229\u7528 Google \u6392\u67e5\u3002</p> \u4e0d\u6b63\u786e\u5730\u5378\u8f7d\u9884\u88c5\u7684 UWP \u5e94\u7528\u4f1a\u5bfc\u81f4 Sysprep \u5931\u8d25 <p><code>setupact.log</code> \u4e2d\u80fd\u770b\u5230\u4ee5\u4e0b\u9519\u8bef\u4fe1\u606f\uff0c\u4ee5 Microsoft Solitaire Collection \u4e3a\u4f8b\uff1a</p> <pre><code>Package Microsoft.MicrosoftSolitaireCollection_4.10.7290.0_neutral_~_8wekyb3d8bbwe was installed for a user, but not provisioned for all users. This package will not function properly in the sysprep image.\n</code></pre> <p>\u8bf7\u56de\u5230\u7b2c\u56db\u8282\u6b63\u786e\u5378\u8f7d\u9519\u8bef\u4fe1\u606f\u7ed9\u51fa\u7684\u8f6f\u4ef6\u5305\u3002</p> <p>Sysprep \u8fd0\u884c\u5b8c\u6210\u540e Windows \u4f1a\u81ea\u52a8\u5173\u673a\uff0c\u6b64\u65f6\u5c31\u4e0d\u8981\u518d\u5f00\u673a\u4e86\uff0c\u628a\u5f53\u524d\u7248\u672c\u7684\u865a\u62df\u673a\u955c\u50cf\u63d0\u53d6\u51fa\u6765\uff0c\u5c31\u7b97\u6253\u5305\u5b8c\u6210\u4e86\u3002\u4f60\u4e5f\u53ef\u4ee5\u9009\u62e9\u76f4\u63a5\u5c06\u8fd9\u4e2a\u865a\u62df\u673a\u8f6c\u6362\u4e3a Template\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u4ece\u5b83\u521b\u5efa\u51fa\u65b0\u865a\u62df\u673a\u4e86\u3002</p>"},{"location":"workflow/pack-windows-image/#packaging","title":"\u63d0\u53d6\u865a\u62df\u673a\u955c\u50cf","text":"<p>\u9996\u5148\u8bf7\u53c2\u8003\u6253\u5305\u5bb9\u5668\u955c\u50cf\u5bf9\u5e94\u7684\u4e00\u8282\u6fc0\u6d3b\u865a\u62df\u673a\u5bf9\u5e94\u7684 LVM \u5377\u3002</p> \u63d0\u53d6\u865a\u62df\u673a\u7684\u5feb\u7167 <p>\u5982\u679c\u4f60\u60f3\u63d0\u53d6\u865a\u62df\u673a\u7684\u67d0\u4e2a\u5feb\u7167\uff0c\u800c\u4e0d\u662f\u5176\u5f53\u524d\u72b6\u6001\uff0c\u9700\u8981\u5728 <code>lvchange</code> \u547d\u4ee4\u4e2d\u989d\u5916\u6dfb\u52a0 <code>-Ky</code> \u53c2\u6570\u3002</p> <pre><code>lvchange -ay -Ky /dev/{vg}/{snap-lv}\n</code></pre> <p>\u7136\u540e\uff0c\u4f7f\u7528 QEMU \u7684\u78c1\u76d8\u5de5\u5177\u5c06\u5b58\u50a8\u5728 LVM \u4e2d\u7684\u539f\u59cb\uff08raw\uff09\u78c1\u76d8\u955c\u50cf\u63d0\u53d6\u51fa\u6765\uff1a</p> <pre><code>qemu-img convert -p -f raw -O qcow2 /dev/{vg}/{lv} win10.qcow2\n</code></pre> <p>\u6b64\u65f6 <code>win10.qcow2</code> \u5c31\u53ef\u4ee5\u4f7f\u7528\u4e86\u3002\u5b83\u7684\u5bb9\u91cf\u901a\u5e38\u5728 20 GB \u4ee5\u4e0a\uff0c\u53ef\u80fd\u8fd8\u4e0d\u591f\u65b9\u4fbf\u79fb\u52a8\uff0c\u4e0b\u9762\u63d0\u4f9b\u4e00\u79cd\u7b80\u5355\u7684\u4f18\u5316\u65b9\u6cd5\u3002</p>"},{"location":"workflow/pack-windows-image/#optimize-image","title":"\u4f18\u5316\u865a\u62df\u673a\u955c\u50cf","text":"<p>Linux \u4e0b\u5bf9 NTFS \u6587\u4ef6\u7cfb\u7edf\u5199\u5165\u6ca1\u6709\u5f88\u597d\u7684\u4f18\u5316\uff0c\u5bb9\u6613\u635f\u574f\u6587\u4ef6\u7cfb\u7edf\uff0c\u56e0\u6b64\u8bf7\u5c06\u4e0a\u4e00\u6b65\u63d0\u53d6\u5f97\u5230\u7684 qcow2 \u6587\u4ef6\u4f5c\u4e3a\u53e6\u4e00\u4e2a\u865a\u62df\u78c1\u76d8\u6302\u8f7d\u8fdb Windows \u865a\u62df\u673a\uff0c\u4ece Windows \u4e2d\u64cd\u4f5c\u3002</p> <ul> <li> <p>\u5220\u9664\u9875\u9762\u6587\u4ef6\u548c\u4ea4\u6362\u6587\u4ef6</p> <p>\u6253\u5f00\u521a\u6302\u8f7d\u7684\u78c1\u76d8\u4e2d\u7684\u7cfb\u7edf\u5206\u533a\uff08\u5b83\u7684\u76d8\u7b26\u73b0\u5728\u5e94\u8be5\u4e0d\u662f C \u4e86\uff0c\u6ce8\u610f\u8fa8\u522b\uff09\uff0c\u5220\u9664 <code>pagefile.sys</code> \u548c <code>swapfile.sys</code>\u3002</p> <p>\u4f60\u4e5f\u53ef\u4ee5\u540c\u65f6\u6e05\u7a7a <code>C:\\Windows\\Logs</code> \u548c\u4e00\u4e9b\u5176\u4ed6\u6587\u4ef6\u5939\uff0c\u4f46\u8fd9\u901a\u5e38\u662f\u4e0d\u5fc5\u8981\u7684\uff0c\u5b83\u4eec\u4e0d\u4f1a\u6e05\u7406\u51fa\u51e0\u5341 MB \u7684\u5bb9\u91cf\u3002</p> </li> <li> <p>\u5bf9\u6587\u4ef6\u7cfb\u7edf\u6267\u884c Trim</p> <p>\u518d\u6b21\u4ee5\u7ba1\u7406\u5458\u8eab\u4efd\u6253\u5f00 PowerShell\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>Optimize-Volume -DriveLetter X -ReTrim -Defrag -SlabConsolidate -Verbose\n</code></pre> <p>\uff08\u5982\u679c\u547d\u4ee4\u8fd0\u884c\u5f97\u592a\u6162\u4e86\uff0c\u4f60\u53ef\u4ee5\u53bb\u6389 <code>-SlabConsolidate</code> \u53c2\u6570\u3002\uff09</p> </li> </ul> <p>\u4ee5\u4e0a\u4efb\u52a1\u5b8c\u6210\u540e\uff0c\u5173\u95ed Windows \u865a\u62df\u673a\u5e76\u89e3\u9664\u6302\u8f7d\u786c\u76d8\uff0c\u7136\u540e\u518d\u6b21\u8f6c\u6362\u5e76\u538b\u7f29\u955c\u50cf\uff1a</p> <pre><code>qemu-img convert -p -c -f qcow2 -O qcow2 win10.qcow2 win10-new.qcow2\n</code></pre> <p>\u6b64\u65f6\u7684 <code>win10-new.qcow2</code> \u5bb9\u91cf\u5e94\u8be5\u80fd\u7f29\u51cf\u81f3 10-12 GB\uff0c\u53ef\u4ee5\u4fdd\u5b58\u4f5c\u4e3a\u6b63\u5f0f\u955c\u50cf\u4e86\uff0c\u521a\u624d\u7684 <code>win10.qcow2</code> \u4e5f\u53ef\u4ee5\u5220\u9664\u6216\u8986\u76d6\u6389\u4e86\u3002</p>"},{"location":"workflow/pack-windows-image/#references","title":"\u53c2\u8003\u8d44\u6599","text":"<ul> <li>[TUTORIAL] - windows cloud init working | Proxmox Support Forum</li> </ul>"}]}