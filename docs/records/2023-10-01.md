# 2023 年 10 月 1 日工作总结

今天晚上按照已经规划了一个多月的方案，全面抛弃手搓的 iptables 防火墙规则，并启用了 PVE Firewall。

## 为所有虚拟机启用防火墙

### 虚拟机层面的防火墙 {#vm-firewall}

首先在 PVE Web 上面找一个虚拟机，调好防火墙选项，得到配置文件：

```ini title="/etc/pve/firewall/1095.fw"
[OPTIONS]

enable: 1
macfilter: 1
ipfilter: 1
policy_in: ACCEPT

[RULES]

GROUP vlab-vm
```

然后 ssh 进 PVE 把这份文件复制到所有虚拟机：

```shell
cd /etc/pve/firewall
for id in $(jq -r '.ids | keys | .[]' /etc/pve/.vmlist); do
  [ $id -gt 1000 -a $id -lt 10000 -a $id -ne 1095 ] || continue
  cp 1095.fw $id.fw
done
```

### 网卡层面的防火墙 {#iface-firewall}

为所有虚拟机的网卡（net0）加上 `firewall=1`。经过测试，直接对着 `/etc/pve/nodes/{node}/lxc/{vmid}.conf` 跑 sed 是不会为已经开机的虚拟机真正启用防火墙的，需要通过 API（HTTP 或 `pvesh` 均可）来修改。

```shell
for id in $(jq -r '.ids | keys | .[]' /etc/pve/.vmlist); do
  [ $id -gt 1000 -a $id -lt 10000 ] || continue
  node=$(jq -r ".ids.\"$id\".node" /etc/pve/.vmlist)
  f="/etc/pve/nodes/$node/lxc/$id.conf"
  conf="$(awk '$1=="net0:"{print $2}' "$f")"
  [[ "$conf" == *firewall=1* ]] && continue
  pvesh set /nodes/$node/lxc/$id/config -net0 "$conf,firewall=1"
done
```

## 踩坑 {#traps}

PVE 会将开启了 firewall 的虚拟机网卡额外桥接一次，如图所示：

未开启 firewall 时

:   <!-- -->

    ```mermaid
    flowchart LR
    vmbr{{vmbr0}} ---|"veth100i0 / eth0@vm"| vm([VM])
    ```

开启 firewall 时

:   <!-- -->

    ```mermaid
    flowchart LR
    vmbr{{vmbr0}} ---|"fwpr100i0 / fwln100i0"| fwbr{{fwbr100i0}} ---|"veth100i0 / eth0@vm"| vm([VM])
    ```

与 iptables 规则不同，这个行为不受 Cluster 全局防火墙开关的影响，因此只要为虚拟机网卡开启了防火墙，PVE 就会添加这样一层桥接。

该桥接与我们[手搓的 ebtables 规则](../networking/firewall.md#ebtables)有冲突，导致开启了接口防火墙的虚拟机无法连接。由于我们提前修改并部署了 Django，许多新建的虚拟机都开启了防火墙并遇到这个问题，所以我们立即下线了手搓的 ebtables，等到今天的维护窗口再来解决这个问题。
