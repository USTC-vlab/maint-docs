# 2023 年 3 月 5 日工作总结

今天根据之前发布的通知清理了长期不使用及已毕业半年的用户。

考虑到登录页面的“用户名密码”登录方式过于显眼，以至于部分用户没有使用 CAS 登录，导致我们无法及时获取用户最新的在校状态信息，因此我们在程序列出的“清退用户列表”中根据学号手动排除了可能还在校的同学。具体规则如下：

- 2 月 17 日维护后仍然在使用虚拟机的用户，但是：
    - 由于我们记录用户对虚拟机的访问时并没有判断虚拟机是否开机，因此用户尝试登录失败时也会被认为“访问了虚拟机”
    - 所以此条实际的判断条件是“有虚拟机访问记录，且虚拟机是开机状态”
- 根据学号判断可能还在校的同学，即本科生至少 PB19，硕士研究生至少 SA20，博士研究生至少 BA19

对于同时符合以上规则的用户，我们将其从清退列表中移除，然后删除了列表中剩余的用户及其虚拟机。

根据 Proxmox VE 界面提供的信息，此次清退后“用户数据”分区的使用量从 37.59 TB 下降到了 23.53 TB（-37%），虚拟机数量从 1803 降至 1067（-42%）。

## Django web 更新

- 修复了 Django 权限组，使用 `vm.can_cas_login` 作为“清退白名单”，权限组中的用户不会在“清退列表”中列出。
- 添加了一些 Django command，列出符合清理条件的用户及其虚拟机，使此次及以后的清退工作更加方便进行。
- 更新了登录页面，提供一个巨大、显眼的“统一身份认证”按钮，并将用户名密码登录折叠起来。
