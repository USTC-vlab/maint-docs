# 2021 年 6 月 13 日工作总结

**注意：本页面是草稿**

同时改数据库和 Django 代码，清理掉 `VMID_INCR` 这个历史包袱。

```sql
-- Drop foreign key
-- https://stackoverflow.com/posts/comments/32882353
ALTER TABLE vm_sshkey DROP CONSTRAINT `vm_sshkey_ct_id_8bfb3d03_fk_vm_pvect_id`;

-- Remove auto increment and PK
-- https://stackoverflow.com/a/6741189/5958455
ALTER TABLE vm_pvect MODIFY COLUMN id INT(11);
ALTER TABLE vm_pvect DROP PRIMARY KEY;

-- Work data
UPDATE vm_pvect SET id = id + 1000;
UPDATE vm_sshkey SET ct_id = ct_id + 1000;

-- Add back AI and PK
ALTER TABLE vm_pvect ADD PRIMARY KEY (`id`);
ALTER TABLE vm_pvect MODIFY COLUMN id INT(11) AUTO_INCREMENT;

-- Add back FK
ALTER TABLE vm_sshkey ADD CONSTRAINT `vm_sshkey_ct_id_8bfb3d03_fk_vm_pvect_id` FOREIGN KEY (`ct_id`) REFERENCES `vm_pvect` (`id`);
```

代码部分见 <https://github.com/USTC-vlab/cslab/compare/0f09ca583d0b643b1e1f75966bc80d4695ee4dad...598f196abe44ff2a93caf715c9027dd5f28f86b1>
