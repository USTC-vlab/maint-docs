# 网络配置

与本代 Vlab 集群相关的网络有三个，下面分别介绍。

## 校园网 {#ustcnet}

所有机器都在电三楼 524 机房，通过铜线直接接入电三楼的 VLAN，该 VLAN 有三个 IP 地址段 202.38.75.0/24, 202.38.79.0/24, 202.38.86.0/24。

除 pv1 外所有机器的四个网口做一个 bond，然后将这个 bond 桥接，系统中显示的界面名称为 `vmbr0`。方便起见所有主机的校园网 IP 都从 202.38.75.0/24 网段中取，记录在域名 `pv#.vlab.ibugone.net` 中。

pv1 的 eno3 和 eno4 分别接在存储服务器的两个控制器的管理端口上，不接入校园网，因此 pv1 只有 eno1 和 eno2 两个千兆网口做 bond。

## 光纤内网 {#fibre-intranet}

光纤界面为 `ens1f0` 和 `ens1f1`，通过一个华为光交换机互联，因此只有服务器集群内部连通，由于每台计算服务器各自接入校园网，所以光纤内网只用于互联（包括连接 iSCSI），不用于转发。

IP 分配情况：10.0.0.11 - 10.0.0.18 为各主机的 ens1f0 界面，10.0.0.21 - 10.0.0.28 为 ens1f1 界面，10.0.0.1 分配给 pv1 备用，10.0.0.2 和 10.0.0.3 为存储服务器的管理端口，为避免冲突不分配。

运行在这个网络上的设施有 iSCSI 和 NFS（用于共享容器镜像，LVM 带锁不能直接多机同时挂载）。

## 容器内网 {#overlay-intranet}

容器之间的连接基于 overlay 网络，overlay 实现采用 VXLAN，因此 MTU 为 1450（这个地方有坑）。IP 地址段为 172.31.0.0/16，目前使用情况：

- 172.31.0.1 为内网网关，运行在 CT100 上，该容器同时连接校园网，IP 为 202.38.75.252，提供所有学生机的校园网访问
- 172.31.0.2 为 web 服务器的内网 IP，web 容器为 CT101，校园网界面为 202.38.75.226，也是域名 `vlab.ustc.edu.cn` 指向的地址
- 172.31.0.0/24 保留，用于实验以及主机接入
- 172.31.0.0 和 172.31.255.255 不是单播地址，无法使用
- 172.31.1.0 - 172.31.255.254 分配给学生机使用

## 学生机网络 {#container-network}

CT100 为网关，通过 iptables DNAT 分配入口端口（目前范围为 10001:29999）供学生连接 SSH 及其他服务。该容器上除 SSH 及系统组件外唯一运行的程序是 [iBug/pfserver](https://github.com/iBug/pfserver)，将 iptables 端口转发包装成 HTTP API。

CT101 为 web 服务器，提供 web 界面（Nginx, Django）和 VNC 统一接入（程序在 [pdlan](https://github.com/pdlan) 的一个私有仓库中，由于潜在的版权问题不能公开）。
