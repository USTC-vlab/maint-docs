# 网关机 (CT 100)

网关机顾名思义就是（容器内网的）网关，同时接入了容器内网（`vmbr1` / `eth1` / `172.31.0.1/16`）和校园网（`vmbr0` / `eth0` / `202.38.75.252/24`），通过 NAT 提供内网机器的对外访问以及将内网机器的 SSH 端口转发到公网上。

该容器配置为四核 1G，除了基本系统组件（主要是 iptables）之外仅运行了 [iBug/pfserver](https://github.com/iBug/pfserver)，该程序提供了增减端口转发的 HTTP API，与前端 Django 程序结合。

## 内网上网转发

内网虚拟机（172.31.0.0/16）的所有到外网流量都通过本机转发，转发通过 iptables 设置，由内核完成，因此本容器中的 iptables 规则十分重要。下面解释设置文件 `iptables.sh`（位于 `/root` 下）。

### 防火墙部分

```shell linenums="1"
### IPv4 ###
iptables -P INPUT DROP
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
iptables -F
iptables -X
iptables -N VLAB

iptables -A VLAB -i lo -j ACCEPT
iptables -A VLAB -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A VLAB -p tcp --dport 22 -j ACCEPT
iptables -A VLAB -p tcp --dport 1024 ! -s 202.38.75.226 -j DROP
iptables -A INPUT -j VLAB
```

开头的部分 1-6 行初始化 iptables 设置，注意到转发的流量走的是 FORWARD 链而不是 INPUT 链，所以有 `-P FORWARD ACCEPT`。第 7 行创建 VLAB 链放我们自己的 rules。

9-13 行这部分同[防火墙](../networking/firewall.md#explanations)。下面的 15 行也相同。

### 转发防火墙部分

```shell linenums="14"
#iptables -A FORWARD -p udp -m state --ctstate NEW -j NFLOG --nflog-prefix '[vlab]'
iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -p tcp --dport 25 -j DROP  # Block SMTP
iptables -A FORWARD -i eth0 -o eth1 -p tcp --dport 22 -m state --state NEW -j NFLOG --nflog-prefix '[vlab]'
iptables -A FORWARD -i eth0 -o eth1 -p tcp --dport 22 --tcp-flag FIN FIN -j NFLOG --nflog-prefix '[vlab]'
iptables -A FORWARD -i eth0 -o eth1 -p tcp --dport 22 --tcp-flag RST RST -j NFLOG --nflog-prefix '[vlab]'
iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT
iptables -A FORWARD -d 10.0.0.0/8 -j DROP
iptables -A FORWARD -d 172.16.0.0/12 -j DROP
iptables -A FORWARD -d 192.168.0.0/16 -j DROP
iptables -A FORWARD -d 202.38.64.58/31 -j DROP
iptables -A FORWARD -d 202.38.96.193 -j DROP
iptables -A FORWARD -d 210.45.224.65 -j DROP
iptables -Z
```

16 行屏蔽连接远端 25（SMTP）端口，防止有人发垃圾邮件，这和 LUG VPN 一样。现在的互联网对垃圾邮件很敏感，很容易因此给 IP 地址甚至校园网 AS 带来不好的声誉，所以屏蔽掉。

17-19 行尝试记录每个 TCP 连接，由于 LXC 里的 iptables 无法访问 rsyslog[^1]，我们使用 ulogd2 的办法[^2]。不过情况是，由于数据量太大，`ulogd2.service` 现在被关掉了（LOL...）

21-23 行屏蔽内网访问，虽然这些 IP 段也有一些校园网路由，不过这不是 vlab 的服务目的，所以一起屏蔽掉也无所谓。

24-26 行屏蔽**网络通**，避免我们的出口 IP 设置被改（这个又和 LUG VPN 一样）。网络通一共有 4 个 IP，其中 `202.38.64.{58,59}` 是相邻的，所以合并起来用一个 `/31` 的网段做规则。

### 转发 NAT 部分

```shell linenums="29"
iptables -t nat -F PREROUTING
iptables -t nat -F POSTROUTING
#iptables -t nat -X
iptables -t nat -N VLAB_STUDENT >/dev/null 2>&1
iptables -t nat -A PREROUTING -i eth1 -d 202.38.64.58/31 -j DNAT --to-destination 202.38.75.226
iptables -t nat -A PREROUTING -i eth1 -d 202.38.96.193/32 -j DNAT --to-destination 202.38.75.226
iptables -t nat -A PREROUTING -i eth1 -d 210.45.224.65/32 -j DNAT --to-destination 202.38.75.226
iptables -t nat -A PREROUTING -i eth0 -p tcp -m tcp --dport 10001:29999 -j VLAB_STUDENT
iptables -t nat -A POSTROUTING -s 172.31.0.0/16 -j MASQUERADE
#iptables -t nat -Z
iptables-save -f /etc/iptables/rules.v4
```

NAT 部分我们只用到了 PREROUTING 和 POSTROUTING 两个链（这是典型模式）。

32 行创建 `VLAB_STUDENT` 链给 pfserver 程序用。

33-35 行把尝试访问网络通的流量都劫持到 web 容器中，这样就能显示“网络通被屏蔽”的消息了。

36 行提供 `VLAB_STUDENT` 链的入口，该入口限制了只有 10001:29999 之间（inclusive）的端口能够被转发。

37 是出口 NAT，对于转发出去的流量，根据源地址进行 NAT。（POSTROUTING 链中没有 `-i` 可用）

## pfserver

未完待续


  [^1]: https://lists.linuxcontainers.org/pipermail/lxc-users/2017-February/012852.html
  [^2]: https://forum.proxmox.com/threads/iptables-logging-inside-lxc-containers.25594/