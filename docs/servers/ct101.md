# Web 服务器 (CT 101)

这个容器是 vlab 对外服务的主要场所，上面运行了我们的各种程序。

该容器接入校园网（`vmbr0` / `eth0` / `202.38.75.226/24`，且该 IP 是 `vlab.ustc.edu.cn` 域名指向的）、容器内网（`vmbr1` / `eth1` / `172.31.0.2/16`）和管理内网（`vmbr2` / `eth2` / `172.30.0.2/24`），通过校园网对外提供 Web 服务、VNC 统一登录服务和 SSH 统一登录服务，通过容器内网连接其他虚拟机。尽管本容器接入了三个网络，但是**不用作转发**。

由于这个容器的 22 端口用作 SSH 统一登录了，因此它自己的 sshd 开在 179 端口上。

## Django web 应用与 Nginx {#web}

未完待续

## VNC 统一登录 {#vnc-unified-login}

未完待续

## SSH 统一登录 {#ssh-unified-login}

未完待续

## 网页版 VS Code {#code-server}

网页版 VS Code 实际上是在用户容器内运行的 [cdr/code-server](https://github.com/cdr/code-server)，并在前端通过 Nginx 反代在 `/vscode/` 下。由于所有用户访问的都是 `/vscode/` 这一个路径，因此我们靠 Cookie 来鉴权及区分用户的虚拟机。

由于我们没有使用完整的 OpenResty 套装，在 Lua 脚本里进行 HTTP 请求不太现实，而且这样做性能也十分糟糕，因此我们将用户的虚拟机 IP 和过期时间戳一起存在 Cookie 里，并对 Cookie 签名。当用户访问 Django 后端的“使用 VS Code”这个接口时，接口会为用户设置上这样的一个 Cookie 并跳转到 `/vscode/`：

```text
ngt=172.31.0.1/1612345678+0123456789abcdef0123456789abcdef
```

该 Cookie 取名 ngt（NGinx Target，其实并不是一个很好的命名），格式是 `IP/timestamp+signature`，其中签名值是 `IP/timestamp` 部分的 HMAC-SHA1 值，对应的 secret 分别位于 Django 的配置文件中和 Nginx 的 Lua 脚本中。

负责鉴权及返回 Nginx 参数的 Lua 代码如下：

```lua
--8<-- "user_host.lua"
```

与之对应的这部分 Nginx 配置则是：

```nginx
###########################################################################
## Code-server reverse proxy
###########################################################################
location /vscode/ {
    error_page 502 /_internal/502-vscode.html;

    set_by_lua_file $user_host /etc/nginx/lua/user_host.lua;
    if ($user_host = "missing") { return 302 /vm/; }
    if ($user_host = "invalid") { return 400; }
    if ($user_host = "failed") { return 400; }
    if ($user_host = "expired") { return 302 /vm/; }

    rewrite ^/vscode/(.*)$ /$1 break;
    proxy_pass http://$user_host:1024;
    proxy_http_version 1.1;
    proxy_set_header Host vlab.ustc.edu.cn;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection upgrade;
    proxy_set_header Accept-Encoding gzip;
}
```

用户在虚拟机内使用我们自己编写的 `vscode` 命令来管理 code-server 对应的系统服务，这是一个（粗制滥造的）Bash 脚本，见 [vscode](../assets/vscode)。

## Webhook 与用户文档 {#user-docs}

容器里有一个 webhook 服务器，从 GitHub 接收用户文档仓库 [USTC-vlab/docs][user-docs] 的更新通知并拉取更新。

代码曾经是用 [Ruby Sinatra][sinatra] 写的，后来换成了 Go，参见 `/root/webhook/main.go`（或[这个 Gist](https://gist.github.com/iBug/34caff517617bfd0de2205d2466a3b78)）

由于该 webhook 过于简单，它自己甚至没有一个 Git 仓库做版本管理（

!!! info "注意"

    这个 webhook 前面还是套了一层 Nginx 的，不是直连的

## Grafana 与监控、统计 {#grafana}

未完待续

  [sinatra]: https://sinatrarb.com/
  [user-docs]: https://github.com/USTC-vlab/docs
